<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Evolution Tienda 24/7</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* --- VARIABLES Y ESTILO BASE NEUMÓRFICO --- */
        :root {
            --color-bg-primary: #f0f0f0;
            --color-text-dark: #1F2937;
            --color-accent: #007AFF; /* Azul Minimalista */
            --color-success: #10B981;
            --color-danger: #EF4444;
            --shadow-light: 8px 8px 16px rgba(163, 177, 198, 0.6);
            --shadow-dark: -8px -8px 16px rgba(255, 255, 255, 0.8);
            --shadow-inset-light: inset 5px 5px 10px rgba(163, 177, 198, 0.6);
            --shadow-inset-dark: inset -5px -5px 10px rgba(255, 255, 255, 0.8);
        }

        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: var(--color-bg-primary); 
            color: var(--color-text-dark); 
            -webkit-tap-highlight-color: transparent; 
            transition: background-color 0.3s, color 0.3s;
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- CLASES NEUMÓRFICAS --- */

        .neumo-card {
            background: var(--color-bg-primary);
            border-radius: 20px;
            box-shadow: var(--shadow-light), var(--shadow-dark);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .neumo-button {
            background: var(--color-bg-primary);
            border-radius: 15px;
            box-shadow: var(--shadow-light), var(--shadow-dark);
            transition: all 0.3s ease;
        }
        
        .neumo-button:hover,
        .neumo-card:hover:not(.neumo-inset):not(.neumo-flat),
        .neumo-button:active {
            box-shadow: var(--shadow-inset-light), var(--shadow-inset-dark);
            transform: scale(0.98);
        }

        .neumo-inset {
            box-shadow: var(--shadow-inset-light), var(--shadow-inset-dark);
            background: var(--color-bg-primary);
            border-radius: 15px;
            transition: all 0.3s ease;
        }

        .neumo-flat {
             background: var(--color-bg-primary);
             box-shadow: none;
             border-radius: 0;
        }

        /* --- ANIMACIONES --- */
        .loader-text {
            background: linear-gradient(to right, var(--color-text-dark) 0%, #374151 50%, var(--color-text-dark) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            background-size: 200% auto;
            animation: shine 2.5s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }
        @keyframes shine { to { background-position: 200% center; } }
        
        .pulse-ring { 
            animation: pulse-ring 2.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; 
            border: 1px solid rgba(0, 122, 255, 0.3); 
        }
        @keyframes pulse-ring {
            0% { transform: scale(0.7); opacity: 0.6; box-shadow: 0 0 0 0 rgba(0, 122, 255, 0.5); }
            100% { transform: scale(1.3); opacity: 0; box-shadow: 0 0 0 10px rgba(0, 122, 255, 0); }
        }

        .bounce-enter { animation: bounceIn 0.5s cubic-bezier(0.215, 0.610, 0.355, 1.000) both; }
        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.95); }
            70% { transform: scale(1.02); }
            100% { opacity: 1; transform: scale(1); }
        }

        .slide-up { animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }

        /* Helpers */
        .bg-accent { background-color: var(--color-accent); }
        .text-accent { color: var(--color-accent); }
        .text-success { color: var(--color-success); }
        .bg-success { background-color: var(--color-success); }
        .text-danger { color: var(--color-danger); }
        .bg-danger { background-color: var(--color-danger); }
        .hidden { display: none !important; }     
                /* --- BADGES PREMIUM ANIMADOS (EFECTOS INCREÍBLES) --- */
        .role-badge-premium {
            position: relative;
            overflow: hidden;
            color: white !important; /* Texto blanco para contraste */
            border: 1px solid rgba(255,255,255,0.4); /* Borde sutil */
            background-size: 200% auto;
            animation: gradient-move 3s linear infinite; /* Movimiento de fondo */
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            z-index: 1;
            transition: all 0.3s ease;
        }
        
        /* Efecto de "Destello" que pasa corriendo */
        .role-badge-premium::after {
            content: '';
            position: absolute;
            top: 0;
            left: -200%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.9), transparent);
            transform: skewX(-20deg);
            animation: shine-sweep 3s infinite ease-in-out; /* Repite el brillo cada 3s */
        }

        /* Animación del fondo moviéndose */
        @keyframes gradient-move { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        
        /* Animación del destello */
        @keyframes shine-sweep { 0% { left: -200%; } 20% { left: 200%; } 100% { left: 200%; } }

        /* Colores Específicos Premium */
        /* LIDER: Dorado Intenso + Resplandor Ámbar */
        .badge-lider { 
            background: linear-gradient(45deg, #f59e0b, #fbbf24, #d97706, #f59e0b); 
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.6);
            border-color: #fcd34d;
        }
        
        /* REVENDEDOR: Azul Neón + Resplandor Índigo */
        .badge-reseller { 
            background: linear-gradient(45deg, #4f46e5, #818cf8, #3730a3, #4f46e5); 
            box-shadow: 0 0 15px rgba(79, 70, 229, 0.6);
            border-color: #a5b4fc;
        }

        /* VIP: Púrpura Galáctico + Resplandor Violeta */
        .badge-vip { 
            background: linear-gradient(45deg, #9333ea, #c084fc, #6b21a8, #9333ea); 
            box-shadow: 0 0 15px rgba(147, 51, 234, 0.6); 
            border-color: #d8b4fe;
        }

        /* CLIENTE: Plata Metálica */
        .badge-client { 
            background: linear-gradient(45deg, #4b5563, #9ca3af, #374151, #4b5563); 
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }   
        
        /* Animación Vibración/Latido para el Logo SE */
    @keyframes se-heartbeat {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
        50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); }
    }
    .animate-se-logo {
        animation: se-heartbeat 3s infinite;
    }

    /* Animación Campana (Ring-Ring) */
    @keyframes bell-ring {
        0% { transform: rotate(0); }
        10% { transform: rotate(15deg); }
        20% { transform: rotate(-15deg); }
        30% { transform: rotate(10deg); }
        40% { transform: rotate(-10deg); }
        50% { transform: rotate(5deg); }
        60% { transform: rotate(-5deg); }
        100% { transform: rotate(0); }
    }
    .animate-bell-ring {
        animation: bell-ring 2s infinite ease-in-out;
        transform-origin: top center;
    }
    </style>
</head>
<body class="text-gray-800 overflow-x-hidden min-h-screen relative bg-bg-primary selection:bg-accent">

    <div id="toast-container" class="fixed top-4 right-4 z-[100] flex flex-col gap-2 pointer-events-none"></div>

    <div id="global-loader" class="fixed inset-0 bg-bg-primary z-[90] flex flex-col items-center justify-center transition-opacity duration-700">
        <div class="relative flex items-center justify-center mb-6">
            <div class="absolute w-24 h-24 bg-accent/20 rounded-full pulse-ring"></div>
            <div class="absolute w-16 h-16 bg-accent/40 rounded-full pulse-ring" style="animation-delay: 0.5s;"></div>
            <div class="relative w-12 h-12 bg-gray-900 rounded-2xl shadow-xl flex items-center justify-center text-white font-bold text-xl z-10 neumo-card" style="box-shadow: 5px 5px 10px rgba(0,0,0,0.2);">SE</div>
        </div>
        <div class="text-center space-y-1">
            <h1 class="text-2xl font-black tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-gray-800 via-gray-600 to-gray-800 loader-text">STREAM EVOLUTION</h1>
            <p class="text-[10px] uppercase tracking-[0.3em] text-gray-400 font-medium animate-pulse">Cargando Ecosistema</p>
        </div>
    </div>

    <div id="auth-container" class="min-h-screen flex flex-col items-center justify-center p-6 hidden bg-bg-primary">
        <div class="mb-10 text-center bounce-enter">
            <div class="w-16 h-16 bg-gray-900 rounded-2xl flex items-center justify-center text-white font-bold shadow-2xl text-2xl mx-auto mb-5 transform rotate-3 neumo-card">SE</div>
            <h1 class="text-3xl font-black text-gray-800 tracking-tight">STREAM <span class="text-accent">EVOLUTION</span></h1>
        </div>

        <div class="w-full max-w-sm space-y-6 slide-up" style="animation-delay: 0.1s;">
                        <form id="login-form" class="space-y-4 auth-view">
                <div class="relative group neumo-inset">
                    <i data-lucide="mail" class="absolute left-4 top-3.5 w-5 h-5 text-gray-400 transition-colors group-focus-within:text-accent"></i>
                    <input type="email" id="login-email" class="neumo-inset w-full bg-transparent border-none rounded-2xl py-3.5 pl-12 pr-4 text-gray-700 font-medium placeholder:text-gray-400 focus:ring-0 focus:outline-none" placeholder="Correo electrónico" required>
                </div>
                <div class="relative group neumo-inset">
                    <i data-lucide="lock" class="absolute left-4 top-3.5 w-5 h-5 text-gray-400 transition-colors group-focus-within:text-accent"></i>
                    <input type="password" id="login-password" class="neumo-inset w-full bg-transparent border-none rounded-2xl py-3.5 pl-12 pr-4 text-gray-700 font-medium placeholder:text-gray-400 focus:ring-0 focus:outline-none" placeholder="Contraseña" required>
                </div>
                <div class="text-right">
                    <button type="button" onclick="switchAuthView('forgot')" class="text-xs text-gray-500 font-bold hover:text-accent transition-colors">¿Olvidaste tu contraseña?</button>
                </div>
                
                <button type="submit" class="neumo-button w-full bg-gray-900 text-white font-bold py-4 rounded-2xl shadow-lg hover:bg-gray-800 flex justify-center items-center gap-2 mt-2">
                    <span>Ingresar</span> <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </button>

                <a href="https://www.mediafire.com/file/tweka8kkm1jg5sx/StreamEvolution.apk/file" target="_blank" class="neumo-button w-full bg-emerald-600 text-white font-bold py-3 rounded-2xl shadow-lg hover:bg-emerald-700 flex justify-center items-center gap-2 mt-3 no-underline transition-all active:scale-95">
                    <i data-lucide="smartphone" class="w-5 h-5"></i>
                    <span>Descargar Aplicación Android</span>
                </a>                
            </form>

                        <form id="register-form" class="space-y-4 hidden auth-view">
                <h2 class="text-xl font-bold text-gray-800 mb-2">Registro</h2>
                <div id="referral-badge" class="hidden bg-indigo-50 text-indigo-600 p-3 rounded-xl text-xs font-bold border border-indigo-100 flex items-center gap-2 neumo-card neumo-flat">
                    <i data-lucide="gift" class="w-4 h-4"></i> <span>¡Te han invitado! Recibe $10 de saldo.</span>
                </div>
                
                <input type="text" id="reg-name" class="neumo-inset w-full bg-transparent border-none rounded-2xl py-3.5 px-4" placeholder="Nombre y Apellido" required>

                <input type="email" id="reg-email" class="neumo-inset w-full bg-transparent border-none rounded-2xl py-3.5 px-4" placeholder="Correo electrónico" required>
                <input type="password" id="reg-password" class="neumo-inset w-full bg-transparent border-none rounded-2xl py-3.5 px-4" placeholder="Contraseña" required>
                <input type="password" id="reg-confirm-password" class="neumo-inset w-full bg-transparent border-none rounded-2xl py-3.5 px-4" placeholder="Confirmar contraseña" required>

                <input type="number" id="reg-whatsapp" class="neumo-inset w-full bg-transparent border-none rounded-2xl py-3.5 px-4" placeholder="WhatsApp (Solo números)" required>
                <input type="text" id="reg-city" class="neumo-inset w-full bg-transparent border-none rounded-2xl py-3.5 px-4" placeholder="Ciudad / Municipio" required>

                <button type="submit" class="neumo-button w-full bg-accent text-white font-bold py-4 rounded-2xl shadow-accent">Registrarse</button>
                
                <a href="https://www.mediafire.com/file/tweka8kkm1jg5sx/StreamEvolution.apk/file" target="_blank" class="neumo-button w-full bg-emerald-600 text-white font-bold py-3 rounded-2xl shadow-lg hover:bg-emerald-700 flex justify-center items-center gap-2 mt-3 no-underline transition-all active:scale-95">
                    <i data-lucide="smartphone" class="w-5 h-5"></i>
                    <span>Descargar Aplicación Android</span>
                </a>
                
                <div class="text-center mt-2">
                    <button type="button" onclick="switchAuthView('login')" class="text-xs text-gray-400 font-bold hover:text-gray-600 transition-colors">¿Ya tienes cuenta? Inicia Sesión</button>
                </div>
            </form>
            
             <form id="forgot-form" class="space-y-4 hidden auth-view">
                <button type="button" onclick="switchAuthView('login')" class="text-gray-500 flex items-center gap-1 mb-4 text-xs font-bold hover:text-accent"><i data-lucide="arrow-left" class="w-3 h-3"></i> ATRÁS</button>
                <h2 class="text-xl font-bold text-gray-800">Recuperar Acceso</h2>
                <input type="email" id="forgot-email" class="neumo-inset w-full bg-transparent border-none rounded-2xl py-3.5 px-4" placeholder="Tu correo registrado" required>
                <button type="submit" class="neumo-button w-full bg-gray-900 text-white font-bold py-4 rounded-2xl shadow-lg">Enviar Correo</button>
            </form>
        </div>
    </div>

    <div id="dashboard-container" class="hidden relative min-h-screen pb-20">
        
        <div id="app-modal" class="fixed inset-0 z-[80] hidden items-center justify-center p-4">
            <div class="absolute inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
            <div id="modal-card" class="neumo-card w-full max-w-md p-0 relative shadow-2xl transform transition-all scale-100 opacity-100 max-h-[90vh] flex flex-col overflow-hidden">
                <button onclick="closeModal()" class="neumo-button absolute top-4 right-4 text-gray-400 hover:text-rose-500 z-50 bg-bg-primary rounded-full p-2"><i data-lucide="x" class="w-5 h-5"></i></button>
                <div id="modal-content" class="overflow-y-auto scrollbar-hide p-6 w-full h-full"></div>
            </div>
        </div>
        
        <div id="startup-modal" class="fixed inset-0 z-[150] hidden items-center justify-center p-6 animate-in fade-in duration-500">
    <div class="absolute inset-0 bg-black/80 backdrop-blur-md transition-opacity" onclick="closeStartupModal()"></div>
    
    <div class="relative w-full max-w-sm h-[75vh] md:h-[80vh] rounded-[2.5rem] overflow-hidden shadow-2xl transform transition-all scale-100 bg-gray-900 border border-white/10 ring-4 ring-black/20">

        
        <button onclick="closeStartupModal()" class="absolute top-4 right-4 z-50 bg-black/40 hover:bg-white/20 backdrop-blur-md text-white p-2 rounded-full transition-all border border-white/10 group">
            <i data-lucide="x" class="w-6 h-6 group-hover:scale-110 transition-transform"></i>
        </button>

        <div id="startup-track" class="flex h-full transition-transform duration-500 ease-out will-change-transform">
            </div>

        <div id="startup-indicators" class="absolute bottom-5 left-0 right-0 flex justify-center gap-2 z-40"></div>
        
        <div class="absolute bottom-0 left-0 w-full h-24 bg-gradient-to-t from-black/80 to-transparent pointer-events-none z-30"></div>
    </div>
</div>

        <header id="main-header" class="sticky top-0 z-40 w-full bg-white/80 backdrop-blur-xl border-b border-white/40 px-4 py-3 transition-all duration-500 shadow-sm supports-[backdrop-filter]:bg-white/60">
    <div class="max-w-5xl mx-auto flex items-center justify-between">
        
        <div class="flex items-center gap-4">
            <button onclick="toggleSidebar()" class="relative overflow-hidden p-2.5 rounded-xl text-gray-600 hover:bg-gray-100/80 hover:text-indigo-600 active:scale-90 transition-all focus:outline-none group">
                <i data-lucide="menu" class="w-6 h-6 stroke-[2.5] relative z-10"></i>
                <div class="absolute inset-0 bg-indigo-500/10 scale-0 group-hover:scale-100 rounded-xl transition-transform duration-300"></div>
            </button>

            <div class="flex items-center gap-3 select-none cursor-default group">
                <div class="relative w-10 h-10 animate-se-logo">
                    <div class="absolute inset-0 bg-indigo-500 blur-lg opacity-20 group-hover:opacity-40 transition-opacity duration-500"></div>
                    <div class="relative w-full h-full rounded-xl bg-gradient-to-br from-gray-900 via-slate-800 to-gray-900 flex items-center justify-center text-white font-black text-sm shadow-xl ring-1 ring-white/20 overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1/2 bg-gradient-to-b from-white/10 to-transparent"></div>
                        <span class="relative z-10 tracking-wider group-hover:scale-110 transition-transform duration-300">SE</span>
                    </div>
                </div>
                
                <div class="flex flex-col justify-center">
                    <h1 class="text-sm font-black text-slate-800 tracking-tight leading-none group-hover:tracking-normal transition-all duration-300">
                        STREAM<span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-violet-600">EVO</span>
                    </h1>
                    <span id="header-role-badge" class="text-[9px] font-bold text-gray-400 uppercase tracking-widest leading-none mt-1 pl-0.5">
                        Cargando...
                    </span>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-2">
            
            <div class="hidden md:flex items-center gap-2 px-3 py-1.5 rounded-full bg-emerald-50/80 border border-emerald-100/50 backdrop-blur-sm shadow-sm mr-1 hover:bg-emerald-100/50 transition-colors cursor-help" title="Sistema Operativo">
                <span class="relative flex h-2.5 w-2.5">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.6)]"></span>
                </span>
                <span class="text-[10px] font-bold text-emerald-700 tracking-wide font-mono">ONLINE</span>
            </div>
            
                                                <button id="btn-chat-live" onclick="openChatLiveUser()" class="hidden relative p-2.5 rounded-xl text-indigo-600 bg-indigo-50 hover:bg-indigo-100 border border-indigo-100 transition-all active:scale-95 group mr-2 shadow-sm">
                <div class="transition-transform origin-center group-hover:scale-110 relative">
                    <i data-lucide="headset" class="w-6 h-6 stroke-[2.5]"></i>
                    
                    <span class="absolute -bottom-0.5 -right-0.5 w-2.5 h-2.5 bg-emerald-500 border-2 border-white rounded-full"></span>
                </div>
                
                <span id="chat-badge" class="hidden absolute -top-2 -right-2 min-w-[20px] h-[20px] bg-rose-600 text-white text-[10px] font-black border-2 border-white rounded-full flex items-center justify-center shadow-md transform scale-100 transition-transform z-10">0</span>
            </button>

            <button onclick="openNotifications()" class="relative p-2.5 rounded-xl text-gray-500 hover:bg-gray-100 hover:text-indigo-600 transition-all active:scale-95 group">
                <div id="bell-icon-container" class="transition-transform origin-top">
                    <i data-lucide="bell" class="w-6 h-6 stroke-[2] group-hover:fill-indigo-100/50 transition-colors"></i>
                </div>
                
                <span id="notification-badge-count" class="absolute -top-0.5 -right-0.5 min-w-[18px] h-[18px] bg-rose-500 text-white text-[9px] font-black flex items-center justify-center rounded-full border-2 border-white shadow-sm transform scale-0 transition-transform duration-300 z-10">
                    0
                </span>
            </button>
        </div>
    </div>
    
    <div class="absolute bottom-0 left-0 w-full h-[1px] bg-gradient-to-r from-transparent via-indigo-500/20 to-transparent"></div>
</header>


        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-gray-900/20 backdrop-blur-sm z-50 opacity-0 pointer-events-none transition-opacity duration-300"></div>
          <aside id="sidebar" class="fixed top-0 left-0 h-full w-72 bg-[#f0f0f0] shadow-[10px_0_20px_rgba(163,177,198,0.3)] z-50 transition-transform duration-300 -translate-x-full flex flex-col border-r border-white/50 font-sans">
    
    <div class="p-6 pb-2 relative overflow-hidden">
        <div class="absolute -top-10 -right-10 w-40 h-40 bg-indigo-500/10 rounded-full blur-3xl pointer-events-none"></div>
        <div class="absolute top-10 -left-10 w-32 h-32 bg-purple-500/10 rounded-full blur-3xl pointer-events-none"></div>

        <div class="relative z-10 flex flex-col items-center text-center">
            <div class="w-24 h-24 rounded-full p-1.5 bg-white shadow-lg mb-3 relative group cursor-pointer" onclick="openUserProfile()">
                <div class="absolute inset-0 bg-gradient-to-tr from-indigo-500 to-purple-500 rounded-full opacity-0 group-hover:opacity-20 transition-opacity duration-500"></div>
                <div class="w-full h-full rounded-full bg-gray-100 flex items-center justify-center text-gray-500 font-black text-2xl neumo-inset overflow-hidden">
                    <span id="sidebar-avatar-initials">US</span> 
                </div>
                <div class="absolute bottom-0 right-0 w-7 h-7 bg-white text-indigo-600 rounded-full flex items-center justify-center shadow-md border border-gray-100">
                    <i data-lucide="settings-2" class="w-3.5 h-3.5"></i>
                </div>
            </div>
            
            <h2 id="sidebar-user-name" class="font-black text-gray-800 text-lg tracking-tight leading-tight mb-1 capitalize">Cargando...</h2>
            
            <div id="sidebar-role-tag" class="px-3 py-1 rounded-full bg-white border border-gray-100 text-[10px] font-bold uppercase tracking-widest text-gray-400 shadow-sm mt-1">
                Cliente
            </div>
        </div>
    </div>

    <div class="mx-8 h-px bg-gradient-to-r from-transparent via-gray-300 to-transparent my-2 opacity-50"></div>

    <div id="sidebar-scroll-area" class="px-4 py-2 space-y-2 overflow-y-auto flex-1 scrollbar-hide relative pb-10">
        
        <button id="admin-cocina-btn" onclick="openCocinaExpress(); toggleSidebar();" class="hidden w-full group relative flex items-center gap-4 px-4 py-3 rounded-2xl transition-all duration-300 hover:bg-orange-50 border border-transparent hover:border-orange-100 mb-4 bg-white/50">
            <div class="w-10 h-10 rounded-xl bg-orange-100 text-orange-600 flex items-center justify-center neumo-inset group-hover:scale-110 transition-transform">
                <i data-lucide="chef-hat" class="w-5 h-5"></i>
            </div>
            <div class="text-left">
                <span class="block font-bold text-gray-700 text-sm group-hover:text-orange-700">Cocina Express</span>
                <span class="block text-[9px] text-gray-400 group-hover:text-orange-400 font-medium">Panel de pedidos</span>
            </div>
        </button>

        <div id="user-menu-items" class="space-y-2.5 pb-4">
            
            <button onclick="switchView('user'); toggleSidebar();" class="w-full group flex items-center gap-4 px-4 py-3 rounded-2xl transition-all duration-300 hover:bg-indigo-50/50 border border-transparent hover:border-indigo-100 hover:shadow-sm">
                <div class="w-10 h-10 rounded-xl bg-indigo-50 text-indigo-600 flex items-center justify-center neumo-inset group-hover:scale-110 transition-transform shadow-sm">
                    <i data-lucide="home" class="w-5 h-5"></i>
                </div>
                <span class="font-bold text-gray-600 text-sm group-hover:text-indigo-700">Inicio</span>
            </button>
            
            <button onclick="renderDocumentsView(); toggleSidebar();" class="w-full group flex items-center gap-4 px-4 py-3 rounded-2xl transition-all duration-300 hover:bg-indigo-50/50 border border-transparent hover:border-indigo-100 hover:shadow-sm">
    <div class="w-10 h-10 rounded-xl bg-indigo-50 text-indigo-600 flex items-center justify-center neumo-inset group-hover:scale-110 transition-transform shadow-sm">
        <i data-lucide="file-check" class="w-5 h-5"></i>
    </div>
    <span class="font-bold text-gray-600 text-sm group-hover:text-indigo-700">Documentos</span>
</button>
            
            <button onclick="openClaimModal(); toggleSidebar();" class="w-full group flex items-center gap-4 px-4 py-3 rounded-2xl transition-all duration-300 hover:bg-fuchsia-50/50 border border-transparent hover:border-fuchsia-100 hover:shadow-sm">
    <div class="w-10 h-10 rounded-xl bg-fuchsia-50 text-fuchsia-600 flex items-center justify-center neumo-inset group-hover:scale-110 transition-transform shadow-sm">
        <i data-lucide="ticket-check" class="w-5 h-5"></i>
    </div>
    <span class="font-bold text-gray-600 text-sm group-hover:text-fuchsia-700">Reclamar Membresía</span>
</button>

            <button onclick="openReportModal(); toggleSidebar();" class="w-full group flex items-center gap-4 px-4 py-3 rounded-2xl transition-all duration-300 hover:bg-rose-50/50 border border-transparent hover:border-rose-100 hover:shadow-sm">
                <div class="w-10 h-10 rounded-xl bg-rose-50 text-rose-500 flex items-center justify-center neumo-inset group-hover:scale-110 transition-transform shadow-sm">
                    <i data-lucide="life-buoy" class="w-5 h-5"></i>
                </div>
                <span class="font-bold text-gray-600 text-sm group-hover:text-rose-600">Reportar Fallo</span>
            </button>

            <button onclick="openSupportReplies(); toggleSidebar();" class="w-full group flex items-center gap-4 px-4 py-3 rounded-2xl transition-all duration-300 hover:bg-blue-50/50 border border-transparent hover:border-blue-100 hover:shadow-sm">
                <div class="w-10 h-10 rounded-xl bg-blue-50 text-blue-500 flex items-center justify-center neumo-inset group-hover:scale-110 transition-transform shadow-sm">
                    <i data-lucide="message-circle-question" class="w-5 h-5"></i>
                </div>
                <span class="font-bold text-gray-600 text-sm group-hover:text-blue-600">Respuestas</span>
            </button>

            <button onclick="openNotifications(); toggleSidebar();" class="w-full group flex items-center gap-4 px-4 py-3 rounded-2xl transition-all duration-300 hover:bg-slate-100/50 border border-transparent hover:border-slate-200 hover:shadow-sm">
                <div class="w-10 h-10 rounded-xl bg-slate-100 text-slate-600 flex items-center justify-center neumo-inset group-hover:scale-110 transition-transform shadow-sm">
                    <i data-lucide="clock" class="w-5 h-5"></i>
                </div>
                <span class="font-bold text-gray-600 text-sm group-hover:text-slate-800">Movimientos</span>
            </button>

            <button onclick="openRenewalModal(); toggleSidebar();" class="w-full group flex items-center gap-4 px-4 py-3 rounded-2xl transition-all duration-300 hover:bg-emerald-50/50 border border-transparent hover:border-emerald-100 hover:shadow-sm">
                <div class="w-10 h-10 rounded-xl bg-emerald-50 text-emerald-600 flex items-center justify-center neumo-inset group-hover:scale-110 transition-transform shadow-sm">
                    <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                </div>
                <span class="font-bold text-gray-600 text-sm group-hover:text-emerald-700">Renovar Servicio</span>
            </button>
            
            <button onclick="renderMembershipsView(); toggleSidebar();" class="w-full group flex items-center gap-4 px-4 py-3 rounded-2xl transition-all duration-300 hover:bg-amber-50/50 border border-transparent hover:border-amber-100 hover:shadow-sm">
                <div class="w-10 h-10 rounded-xl bg-amber-50 text-amber-600 flex items-center justify-center neumo-inset group-hover:scale-110 transition-transform shadow-sm">
                    <i data-lucide="crown" class="w-5 h-5"></i>
                </div>
                <span class="font-bold text-gray-600 text-sm group-hover:text-amber-700">Precios Membresías</span>
            </button>

            <button onclick="renderReferralsView(); toggleSidebar();" class="w-full group flex items-center gap-4 px-4 py-3 rounded-2xl transition-all duration-300 hover:bg-purple-50/50 border border-transparent hover:border-purple-100 hover:shadow-sm">
                <div class="w-10 h-10 rounded-xl bg-purple-50 text-purple-600 flex items-center justify-center neumo-inset group-hover:scale-110 transition-transform shadow-sm">
                    <i data-lucide="users" class="w-5 h-5"></i>
                </div>
                <span class="font-bold text-gray-600 text-sm group-hover:text-purple-700">Mis Referidos</span>
            </button>

            <button onclick="openDownloadModal(); toggleSidebar();" class="w-full group flex items-center gap-4 px-4 py-3 rounded-2xl transition-all duration-300 hover:bg-teal-50/50 border border-transparent hover:border-teal-100 hover:shadow-sm">
                <div class="w-10 h-10 rounded-xl bg-teal-50 text-teal-600 flex items-center justify-center neumo-inset group-hover:scale-110 transition-transform shadow-sm">
                    <i data-lucide="smartphone" class="w-5 h-5"></i>
                </div>
                <span class="font-bold text-gray-600 text-sm group-hover:text-teal-700">Descargar App</span>
            </button>
            
            <button id="btn-invite-reseller" onclick="openInviteModal(); toggleSidebar();" class="hidden w-full mt-4 group relative overflow-hidden flex items-center gap-4 px-4 py-3 rounded-2xl bg-white border border-pink-100 shadow-sm transition-all hover:shadow-md hover:border-pink-200">
                 <div class="absolute inset-0 bg-gradient-to-r from-pink-50 to-purple-50 transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left duration-500"></div>
                 <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-pink-500 to-purple-600 text-white flex items-center justify-center shadow-md relative z-10 group-hover:scale-110 transition-transform">
                     <i data-lucide="gift" class="w-5 h-5"></i>
                 </div>
                 <div class="relative z-10 text-left">
                     <span class="block font-black text-gray-700 text-sm group-hover:text-purple-700">Invitar Amigos</span>
                     <span class="block text-[9px] text-pink-500 font-bold group-hover:text-pink-600">¡Gana Comisiones!</span>
                 </div>
            </button>
        </div>

                <div id="admin-menu-items" class="hidden space-y-2.5 pb-4">
            
            <div class="px-4 py-2 mt-2">
                <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest border-b border-gray-200 pb-1">Administración</p>
            </div>

            <button onclick="switchView('admin'); returnToAdminDashboard(); toggleSidebar();" class="w-full group flex items-center gap-4 px-4 py-3 rounded-2xl transition-all duration-300 hover:bg-slate-50/50 border border-transparent hover:border-slate-100 hover:shadow-sm">
                <div class="w-10 h-10 rounded-xl bg-slate-100 text-slate-600 flex items-center justify-center neumo-inset group-hover:scale-110 transition-transform shadow-sm">
                    <i data-lucide="layout-grid" class="w-5 h-5"></i>
                </div>
                <span class="font-bold text-gray-600 text-sm group-hover:text-slate-800">Panel Principal</span>
            </button>

            <button onclick="switchView('user'); toggleSidebar();" class="w-full group flex items-center gap-4 px-4 py-3 rounded-2xl transition-all duration-300 hover:bg-indigo-50/50 border border-transparent hover:border-indigo-100 hover:shadow-sm">
                <div class="w-10 h-10 rounded-xl bg-indigo-50 text-indigo-600 flex items-center justify-center neumo-inset group-hover:scale-110 transition-transform shadow-sm">
                    <i data-lucide="shopping-bag" class="w-5 h-5"></i>
                </div>
                <span class="font-bold text-gray-600 text-sm group-hover:text-indigo-700">Vista Tienda</span>
            </button>
            
            <button onclick="openClaimModal(); toggleSidebar();" class="w-full group flex items-center gap-4 px-4 py-3 rounded-2xl transition-all duration-300 hover:bg-fuchsia-50/50 border border-transparent hover:border-fuchsia-100 hover:shadow-sm">
    <div class="w-10 h-10 rounded-xl bg-fuchsia-50 text-fuchsia-600 flex items-center justify-center neumo-inset group-hover:scale-110 transition-transform shadow-sm">
        <i data-lucide="ticket-check" class="w-5 h-5"></i>
    </div>
    <span class="font-bold text-gray-600 text-sm group-hover:text-fuchsia-700">Reclamar Membresía</span>
</button>

            <button onclick="openDownloadModal(); toggleSidebar();" class="w-full group flex items-center gap-4 px-4 py-3 rounded-2xl transition-all duration-300 hover:bg-teal-50/50 border border-transparent hover:border-teal-100 hover:shadow-sm">
                <div class="w-10 h-10 rounded-xl bg-teal-50 text-teal-600 flex items-center justify-center neumo-inset group-hover:scale-110 transition-transform shadow-sm">
                    <i data-lucide="smartphone" class="w-5 h-5"></i>
                </div>
                <span class="font-bold text-gray-600 text-sm group-hover:text-teal-700">Descargar App</span>
            </button>
            
            <button onclick="renderMembershipsView(); toggleSidebar();" class="w-full group flex items-center gap-4 px-4 py-3 rounded-2xl transition-all duration-300 hover:bg-amber-50/50 border border-transparent hover:border-amber-100 hover:shadow-sm">
                <div class="w-10 h-10 rounded-xl bg-amber-50 text-amber-600 flex items-center justify-center neumo-inset group-hover:scale-110 transition-transform shadow-sm">
                    <i data-lucide="crown" class="w-5 h-5"></i>
                </div>
                <span class="font-bold text-gray-600 text-sm group-hover:text-amber-700">Precios Membresías</span>
            </button>
            
            <button onclick="openInviteModal(); toggleSidebar();" class="w-full group flex items-center gap-4 px-4 py-3 rounded-2xl transition-all duration-300 hover:bg-purple-50/50 border border-transparent hover:border-purple-100 hover:shadow-sm">
                <div class="w-10 h-10 rounded-xl bg-purple-50 text-purple-600 flex items-center justify-center neumo-inset group-hover:scale-110 transition-transform shadow-sm">
                    <i data-lucide="share-2" class="w-5 h-5"></i>
                </div>
                <span class="font-bold text-gray-600 text-sm group-hover:text-purple-700">Invitar Amigos</span>
            </button>
        </div>

    </div>

    <div id="scroll-more-indicator" class="absolute bottom-[110px] left-0 right-0 flex justify-center pointer-events-none z-50 transition-opacity duration-500 opacity-0">
        <div class="bg-indigo-600/95 text-white px-5 py-2 rounded-full shadow-xl shadow-indigo-500/30 flex items-center gap-2 animate-bounce border border-indigo-400/50 backdrop-blur-sm">
            <span class="text-[10px] font-black tracking-wide uppercase">Desliza para ver más</span>
            <i data-lucide="arrow-down" class="w-3.5 h-3.5"></i>
        </div>
    </div>

    <div class="p-6 border-t border-gray-200/50 bg-gray-50/50 backdrop-blur-sm relative z-30">
        <button onclick="handleLogout()" class="w-full flex items-center justify-center gap-3 p-3.5 rounded-2xl text-rose-500 font-bold text-sm bg-white border border-gray-100 shadow-sm hover:bg-rose-50 hover:border-rose-100 hover:shadow-md transition-all active:scale-95 group">
            <div class="w-8 h-8 rounded-lg bg-rose-50 flex items-center justify-center group-hover:bg-white group-hover:text-rose-600 transition-colors">
                <i data-lucide="log-out" class="w-4 h-4"></i>
            </div>
            Cerrar Sesión
        </button>
    </div>
</aside>


        <main id="user-view" class="px-5 py-6 space-y-8 max-w-md mx-auto md:max-w-4xl">
            <section class="flex items-stretch gap-3 mb-2 bounce-enter" style="animation-delay: 0.1s;">
                
                <div class="flex-1 bg-gradient-to-br from-gray-900 to-gray-800 rounded-3xl p-4 relative overflow-hidden shadow-lg flex flex-col justify-center min-w-[130px]">
                    <div class="absolute top-0 right-0 w-16 h-16 bg-white/5 rounded-full blur-xl -mr-4 -mt-4 pointer-events-none"></div>
                    
                    <div class="flex items-center gap-1.5 mb-1 opacity-70">
                        <i data-lucide="wallet" class="w-3 h-3 text-emerald-400"></i>
                        <span class="text-[9px] font-bold text-gray-300 uppercase tracking-widest">Saldo</span>
                    </div>
                    <div class="flex items-baseline gap-0.5">
                        <span class="text-sm font-medium text-gray-400">$</span>
                        <span id="balance-display" class="text-2xl font-black text-white tracking-tight">--</span>
                    </div>
                </div>

                <div onclick="openProfitTransferModal()" class="flex-1 bg-white rounded-3xl p-4 shadow-sm border border-gray-100 flex flex-col justify-center cursor-pointer relative group hover:border-indigo-100 transition-all active:scale-95 min-w-[130px]">
                    <div class="absolute top-2 right-2 w-2 h-2 bg-indigo-500 rounded-full animate-pulse"></div>
                    
                    <div class="flex items-center gap-1.5 mb-1 opacity-60 group-hover:opacity-100 transition-opacity">
                        <i data-lucide="trending-up" class="w-3 h-3 text-indigo-500"></i>
                        <span class="text-[9px] font-bold text-gray-400 uppercase tracking-widest group-hover:text-indigo-500 transition-colors">Ganancias</span>
                    </div>
                    <div class="flex items-baseline gap-0.5">
                        <span class="text-sm font-medium text-gray-300">$</span>
                        <span id="profit-display" class="text-2xl font-black text-gray-800 tracking-tight group-hover:text-indigo-600 transition-colors">--</span>
                    </div>
                </div>

                <button onclick="openChargeInfoModal()" class="flex-none w-[70px] bg-gradient-to-tr from-indigo-600 to-violet-600 text-white rounded-[1.5rem] flex items-center justify-center shadow-lg shadow-indigo-200 hover:shadow-indigo-300 hover:scale-105 active:scale-90 transition-all group">
    <i data-lucide="plus" class="w-8 h-8 stroke-[3] group-hover:rotate-90 transition-transform duration-300"></i>
</button>

            </section>

                        <section id="banner-carousel-container" class="relative w-full h-48 rounded-[2rem] overflow-hidden shadow-lg group cursor-pointer neumo-card transform transition-all hover:scale-[1.01]" style="animation-delay: 0.2s;">
                <div id="banner-track" class="flex h-full transition-transform duration-500 ease-out will-change-transform">
                    <div class="min-w-full h-full flex items-center justify-center bg-gray-200">
                        <span class="animate-pulse text-xs text-gray-400">Cargando destacados...</span>
                    </div>
                </div>
                <div id="banner-indicators" class="absolute bottom-3 left-0 right-0 flex justify-center gap-2 z-20"></div>
                <div class="absolute inset-0 pointer-events-none shadow-[inset_0_0_20px_rgba(0,0,0,0.1)] rounded-[2rem] z-30"></div>
            </section>

            <section class="bounce-enter" style="animation-delay: 0.3s;">
                <div class="flex items-center justify-between mb-5">
                    <h3 class="font-bold text-gray-800 text-lg flex items-center gap-2"><i data-lucide="grid" class="w-4 h-4 text-accent"></i> Servicios</h3>
                </div>
                <div id="categories-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="col-span-2 text-center py-10 text-gray-400 animate-pulse text-xs">Cargando servicios...</div>
                </div>
            </section>
        </main>
        
        <main id="documents-view" class="hidden px-5 py-6 space-y-6 max-w-md mx-auto md:max-w-4xl bounce-enter">
    </main>

        <main id="admin-view" class="hidden px-5 py-6 space-y-6 max-w-md mx-auto md:max-w-4xl bounce-enter">
            <div id="admin-dashboard-grid" class="space-y-6 pb-20">
                
                <div class="relative overflow-hidden rounded-[2.5rem] bg-gray-900 p-8 shadow-2xl group">
                    <div class="absolute inset-0 bg-gradient-to-br from-indigo-600/30 to-purple-600/30 opacity-50 group-hover:opacity-70 transition-opacity duration-500"></div>
                    <div class="absolute -top-24 -right-24 w-64 h-64 bg-indigo-500/20 rounded-full blur-3xl pointer-events-none animate-pulse"></div>
                    
                    <div class="relative z-10 flex justify-between items-center">
                        <div>
                            <h2 class="text-3xl font-black text-white tracking-tight mb-1">Panel de Control</h2>
                            <p class="text-indigo-200 text-sm font-medium">Bienvenido, Administrador</p>
                        </div>
                        <div class="w-12 h-12 bg-white/10 backdrop-blur-md rounded-2xl flex items-center justify-center border border-white/20 shadow-inner">
                            <i data-lucide="layout-dashboard" class="w-6 h-6 text-white"></i>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                
                <div onclick="enterAdminModule('claims')" class="bg-white p-5 rounded-[2rem] shadow-sm hover:shadow-xl border border-gray-100 cursor-pointer group transition-all duration-300 hover:-translate-y-1 relative">
    <div class="flex flex-col items-center justify-center text-center h-full gap-2">
        <div class="w-12 h-12 bg-fuchsia-50 text-fuchsia-600 rounded-full flex items-center justify-center shadow-sm group-hover:bg-fuchsia-600 group-hover:text-white transition-colors duration-300">
            <i data-lucide="ticket" class="w-6 h-6"></i>
        </div>
        <span class="font-bold text-gray-700 text-sm">Reclamaciones</span>
    </div>
    <div id="badge-claims" class="absolute top-3 right-3 bg-rose-500 text-white text-[10px] font-black w-5 h-5 flex items-center justify-center rounded-full shadow-md hidden animate-bounce">0</div>
</div>

<div onclick="enterAdminModule('spotlight')" class="bg-white p-5 rounded-[2rem] shadow-sm hover:shadow-xl border border-gray-100 cursor-pointer group transition-all duration-300 hover:-translate-y-1 relative">
    <div class="flex flex-col items-center justify-center text-center h-full gap-2">
        <div class="w-12 h-12 bg-rose-50 text-rose-600 rounded-full flex items-center justify-center shadow-sm group-hover:bg-rose-600 group-hover:text-white transition-colors duration-300">
            <i data-lucide="megaphone" class="w-6 h-6"></i>
        </div>
        <span class="font-bold text-gray-700 text-sm">Anuncios Inicio</span>
    </div>
</div>
                    
                    <div onclick="enterAdminModule('banners')" class="col-span-2 bg-white p-5 rounded-[2rem] shadow-sm hover:shadow-xl border border-gray-100 cursor-pointer group transition-all duration-300 hover:-translate-y-1 relative overflow-hidden">
                        <div class="absolute right-0 top-0 w-32 h-32 bg-blue-50 rounded-full blur-2xl -mr-10 -mt-10 transition-colors group-hover:bg-blue-100"></div>
                        <div class="relative z-10 flex items-center gap-4">
                            <div class="w-14 h-14 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center shadow-sm group-hover:scale-110 transition-transform duration-300">
                                <i data-lucide="monitor-play" class="w-7 h-7"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-800 text-lg">Publicidad</h3>
                                <p class="text-xs text-gray-400 font-medium">Gestionar Banners</p>
                            </div>
                        </div>
                    </div>

                    <div onclick="enterAdminModule('requests')" class="bg-white p-5 rounded-[2rem] shadow-sm hover:shadow-xl border border-gray-100 cursor-pointer group transition-all duration-300 hover:-translate-y-1 relative">
                        <div class="flex flex-col items-center justify-center text-center h-full gap-2">
                            <div class="w-12 h-12 bg-emerald-50 text-emerald-600 rounded-full flex items-center justify-center shadow-sm group-hover:bg-emerald-600 group-hover:text-white transition-colors duration-300">
                                <i data-lucide="dollar-sign" class="w-6 h-6"></i>
                            </div>
                            <span class="font-bold text-gray-700 text-sm">Pagos</span>
                        </div>
                        <div id="badge-requests" class="absolute top-3 right-3 bg-rose-500 text-white text-[10px] font-black w-5 h-5 flex items-center justify-center rounded-full shadow-md hidden animate-bounce">0</div>
                    </div>
                    
                        <div onclick="openDocumentsPanel()" class="relative bg-white p-5 rounded-[2rem] shadow-sm hover:shadow-xl border border-gray-100 cursor-pointer group transition-all duration-300 hover:-translate-y-1">
    <div class="flex flex-col items-center justify-center text-center h-full gap-2">
        <div class="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center shadow-sm group-hover:bg-indigo-600 group-hover:text-white transition-colors duration-300 relative">
            <i data-lucide="file-text" class="w-6 h-6"></i>
        </div>
        <span class="font-bold text-gray-700 text-sm">Documentos</span>
    </div>
    
    <div id="badge-docs-admin" class="hidden absolute top-2 right-2 bg-red-600 text-white text-[10px] font-bold w-6 h-6 flex items-center justify-center rounded-full shadow-lg border-2 border-white z-20 animate-bounce">
        0
    </div>
</div>



                    <div onclick="openRenewalsPanel()" class="bg-white p-5 rounded-[2rem] shadow-sm hover:shadow-xl border border-gray-100 cursor-pointer group transition-all duration-300 hover:-translate-y-1 relative">
    <div class="flex flex-col items-center justify-center text-center h-full gap-2">
        <div class="w-12 h-12 bg-amber-50 text-amber-600 rounded-full flex items-center justify-center shadow-sm group-hover:bg-amber-600 group-hover:text-white transition-colors duration-300 relative">
            <i data-lucide="refresh-cw" class="w-6 h-6"></i>
        </div>
        <span class="font-bold text-gray-700 text-sm">Renovaciones</span>
    </div>
    <div id="badge-renewals-smart" class="hidden absolute top-2 right-2 bg-red-600 text-white text-[10px] font-bold w-6 h-6 flex items-center justify-center rounded-full shadow-lg border-2 border-white animate-bounce">0</div>
</div>

                    <div onclick="enterAdminModule('support')" class="bg-white p-5 rounded-[2rem] shadow-sm hover:shadow-xl border border-gray-100 cursor-pointer group transition-all duration-300 hover:-translate-y-1 relative">
                        <div class="flex flex-col items-center justify-center text-center h-full gap-2">
                            <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center shadow-sm group-hover:bg-blue-600 group-hover:text-white transition-colors duration-300">
                                <i data-lucide="message-square" class="w-6 h-6"></i>
                            </div>
                            <span class="font-bold text-gray-700 text-sm">Soporte</span>
                        </div>
                        <div id="badge-support" class="absolute top-3 right-3 bg-rose-500 text-white text-[10px] font-black w-5 h-5 flex items-center justify-center rounded-full shadow-md hidden animate-bounce">0</div>
                    </div>

                    <div onclick="enterAdminModule('expirations'); initAdminExpirations()" class="bg-white p-5 rounded-[2rem] shadow-sm hover:shadow-xl border border-gray-100 cursor-pointer group transition-all duration-300 hover:-translate-y-1 relative">
                        <div class="flex flex-col items-center justify-center text-center h-full gap-2">
                            <div class="w-12 h-12 bg-orange-50 text-orange-600 rounded-full flex items-center justify-center shadow-sm group-hover:bg-orange-600 group-hover:text-white transition-colors duration-300">
                                <i data-lucide="calendar-clock" class="w-6 h-6"></i>
                            </div>
                            <span class="font-bold text-gray-700 text-sm">Vencen</span>
                        </div>
                    </div>

                    <div onclick="enterAdminModule('categories')" class="col-span-2 bg-gradient-to-r from-gray-900 to-gray-800 p-5 rounded-[2rem] shadow-lg hover:shadow-2xl cursor-pointer group transition-all duration-300 hover:-translate-y-1 relative overflow-hidden text-white">
                        <div class="absolute right-0 bottom-0 w-32 h-32 bg-white/5 rounded-full blur-2xl -mr-5 -mb-5"></div>
                        <div class="relative z-10 flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-white/10 backdrop-blur-md rounded-2xl flex items-center justify-center shadow-inner">
                                    <i data-lucide="layers" class="w-6 h-6 text-white"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-lg">Servicios</h3>
                                    <p class="text-xs text-gray-400 font-medium">Editar Categorías</p>
                                </div>
                            </div>
                            <div class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center group-hover:bg-white group-hover:text-gray-900 transition-colors">
                                <i data-lucide="arrow-right" class="w-4 h-4"></i>
                            </div>
                        </div>
                    </div>

                    <div onclick="enterAdminModule('users')" class="bg-white p-5 rounded-[2rem] shadow-sm hover:shadow-xl border border-gray-100 cursor-pointer group transition-all duration-300 hover:-translate-y-1 relative">
                        <div class="flex flex-col items-center justify-center text-center h-full gap-2">
                            <div class="w-12 h-12 bg-gray-100 text-gray-600 rounded-full flex items-center justify-center shadow-sm group-hover:bg-gray-800 group-hover:text-white transition-colors duration-300">
                                <i data-lucide="users" class="w-6 h-6"></i>
                            </div>
                            <span class="font-bold text-gray-700 text-sm">Usuarios</span>
                        </div>
                    </div>
                    
                    <div onclick="openGeneralHistory()" class="bg-white p-5 rounded-[2rem] shadow-sm hover:shadow-xl border border-gray-100 cursor-pointer group transition-all duration-300 hover:-translate-y-1 relative">
    <div class="flex flex-col items-center justify-center text-center h-full gap-2">
        <div class="w-12 h-12 bg-teal-50 text-teal-600 rounded-full flex items-center justify-center shadow-sm group-hover:bg-teal-600 group-hover:text-white transition-colors duration-300">
            <i data-lucide="history" class="w-6 h-6"></i>
        </div>
        <span class="font-bold text-gray-700 text-sm">Historial Gral.</span>
    </div>
</div>

                    <div onclick="enterAdminModule('inventory')" class="bg-white p-5 rounded-[2rem] shadow-sm hover:shadow-xl border border-gray-100 cursor-pointer group transition-all duration-300 hover:-translate-y-1 relative">
                        <div class="flex flex-col items-center justify-center text-center h-full gap-2">
                            <div class="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center shadow-sm group-hover:bg-indigo-600 group-hover:text-white transition-colors duration-300">
                                <i data-lucide="archive" class="w-6 h-6"></i>
                            </div>
                            <span class="font-bold text-gray-700 text-sm">Cuentas</span>
                        </div>
                    </div>

                    <div onclick="enterAdminModule('stock')" class="col-span-2 bg-white p-5 rounded-[2rem] shadow-sm hover:shadow-xl border border-gray-100 cursor-pointer group transition-all duration-300 hover:-translate-y-1 relative overflow-hidden">
                        <div class="absolute left-0 bottom-0 w-full h-1 bg-gradient-to-r from-emerald-400 to-teal-500"></div>
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-emerald-50 text-emerald-600 rounded-2xl flex items-center justify-center shadow-sm group-hover:scale-110 transition-transform">
                                <i data-lucide="package" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-800 text-lg">Productos</h3>
                                <p class="text-xs text-gray-400 font-medium">Items en Vitrina</p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <div id="admin-modules-container" class="hidden">
                <button onclick="returnToAdminDashboard()" class="neumo-button mb-6 flex items-center gap-2 text-gray-500 hover:text-gray-800 font-bold text-xs uppercase tracking-wider transition-colors">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i> VOLVER AL PANEL
                </button>

                <section id="admin-categories-section" class="hidden bounce-enter">
                    <div class="flex justify-between items-center mb-6">
                        <div><h3 class="font-bold text-gray-800 text-xl">Mis Servicios</h3><p class="text-xs text-gray-400">Categorías visibles</p></div>
                        <button onclick="openAddCategoryModal()" class="neumo-button bg-gray-900 text-white px-4 py-2.5 rounded-xl text-xs font-bold flex items-center gap-2 shadow-lg"><i data-lucide="plus" class="w-4 h-4"></i> Crear Nueva</button>
                    </div>
                    <div id="admin-categories-list" class="grid grid-cols-2 gap-4"><p class="col-span-2 text-center text-gray-400 py-10">Cargando servicios...</p></div>
                </section>

                <section id="admin-requests-section" class="hidden bounce-enter">
                    <h3 class="font-bold text-gray-800 mb-4 text-xl">Solicitudes de Saldo</h3>
                    <div id="admin-requests-list" class="space-y-3"></div>
                </section>
                
                                <section id="admin-renewal-section" class="hidden bounce-enter">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-gray-800 text-xl">Renovaciones</h3>
                        <span id="renewal-count-badge" class="bg-indigo-100 text-indigo-600 text-xs font-bold px-2 py-1 rounded-lg">0 Pendientes</span>
                    </div>
                    <div id="admin-renewal-list" class="space-y-3 pb-10">
                        <div class="text-center py-10 opacity-50"><p class="text-xs text-gray-400">Cargando...</p></div>
                    </div>
                </section>

                <section id="admin-support-section" class="hidden bounce-enter">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-gray-800 text-xl">Soporte Técnico</h3>
                        <span id="support-count-badge" class="bg-blue-100 text-blue-600 text-xs font-bold px-2 py-1 rounded-lg">0 Tickets</span>
                    </div>
                    <div id="admin-support-list" class="space-y-3 pb-10">
                        <div class="text-center py-10 opacity-50"><p class="text-xs text-gray-400">Cargando...</p></div>
                    </div>
                </section>

                  <section id="admin-users-section" class="hidden bounce-enter">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-gray-800 text-xl">Usuarios</h3>
                        <div class="flex gap-2">
                            <button onclick="cleanDatabaseOrphans()" class="neumo-button bg-orange-50 text-orange-600 px-3 py-2 rounded-xl text-xs font-bold flex items-center gap-1 shadow-sm border border-orange-100 hover:bg-orange-100 transition-colors" title="Borrar datos de usuarios inexistentes">
                                <i data-lucide="trash-2" class="w-4 h-4"></i> Limpiar BD
                            </button>
                            
                            <button onclick="openAddUserModal()" class="neumo-button bg-success text-white px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-1 shadow-accent hover:bg-emerald-600 transition-colors">
                                <i data-lucide="user-plus" class="w-4 h-4"></i> Nuevo
                            </button>
                        </div>
                    </div>
                    
                    <div class="relative mb-4">
                        <i data-lucide="search" class="absolute left-3 top-3 w-4 h-4 text-gray-400"></i>
                        <input type="text" id="admin-user-search" oninput="filterAdminUsers()" class="neumo-inset w-full bg-transparent border-none rounded-xl pl-10 pr-4 py-3 text-sm font-bold text-gray-700 placeholder-gray-400" placeholder="Buscar por Nombre, Correo o WhatsApp...">
                    </div>

                    <div id="admin-users-list" class="space-y-3"></div>
                </section>

                <section id="admin-stock-section" class="hidden bounce-enter">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-gray-800 text-xl">Productos</h3>
                        <button onclick="openAddProductModal()" class="neumo-button bg-gray-900 text-white px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-1 shadow-lg"><i data-lucide="plus" class="w-4 h-4"></i> Agregar</button>
                    </div>
                    <div id="admin-stock-list" class="space-y-3"></div>
                </section>

                <section id="admin-inventory-section" class="hidden bounce-enter">
                    <div class="flex justify-between items-center mb-4">
                        <div><h3 class="font-bold text-gray-800 text-xl">Inventario</h3><p class="text-xs text-gray-400">Cuentas a entregar</p></div>
                        <button onclick="openAddInventoryModal()" class="neumo-button bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-1 shadow-lg"><i data-lucide="archive" class="w-4 h-4"></i> Cargar Item</button>
                    </div>
                    <div id="admin-inventory-list" class="space-y-3"></div>
                </section>
                
                <section id="admin-claims-section" class="hidden bounce-enter">
    <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-gray-800 text-xl">Membresías Reclamadas</h3>
        <span id="claims-count-badge" class="bg-fuchsia-100 text-fuchsia-600 text-xs font-bold px-2 py-1 rounded-lg">0 Pendientes</span>
    </div>
    <div id="admin-claims-list" class="space-y-3 pb-10">
        <div class="text-center py-10 opacity-50"><p class="text-xs text-gray-400">Cargando reclamaciones...</p></div>
    </div>
</section>

                                <section id="admin-banners-section" class="hidden bounce-enter">
                    <div class="flex justify-between items-center mb-6">
                        <div><h3 class="font-bold text-gray-800 text-xl">Publicidad Activa</h3><p class="text-xs text-gray-400">Se desliza automáticamente</p></div>
                        <button onclick="openAddBannerModal()" class="neumo-button bg-blue-600 text-white px-4 py-2.5 rounded-xl text-xs font-bold flex items-center gap-2 shadow-lg"><i data-lucide="plus" class="w-4 h-4"></i> Nuevo Banner</button>
                    </div>
                    <div id="admin-banners-list" class="space-y-3 pb-10"></div>
                </section>
                <section id="admin-spotlight-section" class="hidden bounce-enter">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h3 class="font-bold text-gray-800 text-xl">Anuncios Pop-up</h3>
            <p class="text-xs text-gray-400">Aparecen al abrir la App</p>
        </div>
        <button onclick="openAddSpotlightModal()" class="neumo-button bg-rose-600 text-white px-4 py-2.5 rounded-xl text-xs font-bold flex items-center gap-2 shadow-lg hover:bg-rose-700">
            <i data-lucide="plus" class="w-4 h-4"></i> Nuevo Anuncio
        </button>
    </div>
    
    <div id="admin-spotlight-list" class="grid grid-cols-2 gap-3 pb-10">
        </div>
</section>
                    <section id="admin-expirations-section" class="hidden bounce-enter">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h3 class="font-bold text-gray-800 text-xl">Membresías Activas</h3>
                <p class="text-xs text-gray-400">Control de días restantes en tiempo real</p>
            </div>
            <button onclick="initAdminExpirations()" class="neumo-button bg-gray-100 text-gray-600 px-3 py-2 rounded-xl text-xs font-bold shadow-sm hover:bg-gray-200"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button>
        </div>
        
        <div class="flex gap-2 mb-4 overflow-x-auto pb-2 scrollbar-hide">
            <button onclick="filterExpirations('all')" class="text-xs font-bold bg-gray-800 text-white px-3 py-1 rounded-lg">Todos</button>
            <button onclick="filterExpirations('soon')" class="text-xs font-bold bg-rose-100 text-rose-600 px-3 py-1 rounded-lg">Por Vencer (5 días)</button>
        </div>

        <div id="admin-expirations-list" class="space-y-3 pb-10"></div>
    </section>
    
        <section id="admin-documents-section" class="hidden bounce-enter">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h3 class="font-bold text-gray-800 text-xl">Gestión de Documentos</h3>
            <p class="text-xs text-gray-400">Solicitudes de usuarios</p>
        </div>
        <button onclick="initAdminPanel()" class="neumo-button p-2 text-gray-400 hover:text-indigo-600 rounded-xl transition-colors">
            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
        </button>
    </div>
    
    <div id="admin-documents-list" class="space-y-3 pb-20 min-h-[200px]">
        <div class="text-center py-12">
            <span class="animate-spin inline-block w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full mb-3"></span>
            <p class="text-xs text-gray-400">Conectando...</p>
        </div>
    </div>
</section>


            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, onAuthStateChanged, sendEmailVerification } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, addDoc, query, orderBy, limit, serverTimestamp, setDoc, getDoc, runTransaction, updateDoc, deleteDoc, where, getDocs, increment } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- CONFIGURACIÓN ---
        const firebaseConfig = {
          apiKey: "AIzaSyBYaYm2LDE6QM_K5Dii74sfZCYYd1eQfvY",
          authDomain: "ventasstre-a24b7.firebaseapp.com",
          projectId: "ventasstre-a24b7",
          storageBucket: "ventasstre-a24b7.firebasestorage.app",
          messagingSenderId: "197117622028",
          appId: "1:197117622028:web:ae6380faf72f965a41fb29",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "mi-ecosistema-v1";
        const ADMIN_EMAIL = "mrandroidtutorialeshd@gmail.com";
        const REFERRAL_COMMISSION_RATE = 0.10;
                 // --- INICIO CONFIGURACIÓN JERARQUÍAS ---
        const ROLE_DEFINITIONS = {
            'lider': { label: 'Lider', icon: 'crown', color: 'text-amber-500', bg: 'bg-amber-100', rank: 4 },
            'reseller': { label: 'Revendedor', icon: 'briefcase', color: 'text-indigo-600', bg: 'bg-indigo-100', rank: 3 },
            'vip': { label: 'Cliente Vip', icon: 'star', color: 'text-purple-600', bg: 'bg-purple-100', rank: 2 },
            'client': { label: 'Cliente', icon: 'user', color: 'text-gray-500', bg: 'bg-gray-100', rank: 1 }
        };

        function getRoleData(role) {
            return ROLE_DEFINITIONS[role] || ROLE_DEFINITIONS['client'];
        }
        // --- FIN CONFIGURACIÓN JERARQUÍAS ---


        let currentUser = null;
        let isAdmin = false;
        let currentUserRole = 'client';
        let currentProfit = 0; 
        let timerInterval;

        window.userTransactions = [];
        window.globalNotifications = []; 
        window.adminPendingRequests = []; 
        window.adminPendingReports = [];
        window.adminReportsCache = []; 
        window.categoriesCache = []; 
        window.currentUserHistory = [];
        window.adminPendingRenewals = [];
        window.inventoryCache = [];

                        // --- SONIDO INTELIGENTE POR ROL (VERSIÓN FINAL) ---
        // 1. Sonido para usuarios normales (Clientes, VIP, Revendedores)
        const soundNormal = new Audio("NotificacionUser.mp3");
        
        // 2. Sonido exclusivo para el Administrador
        const soundAdmin = new Audio("DenDenMushi-OnePiece.mp3");

        window.playNotificationSound = () => { 
            try { 
                // Verificamos si el usuario actual es el Admin
                const isAdminUser = currentUser && currentUser.email === "mrandroidtutorialeshd@gmail.com";

                if (isAdminUser) {
                    // --- LÓGICA PARA ADMIN ---
                    soundAdmin.currentTime = 0; 
                    soundAdmin.volume = 0.6; 
                    soundAdmin.play().catch(e => console.log("Audio Admin bloqueado hasta interacción"));
                } else {
                    // --- LÓGICA PARA EL RESTO DE USUARIOS ---
                    soundNormal.currentTime = 0; 
                    soundNormal.volume = 0.6; 
                    soundNormal.play().catch(e => console.log("Audio Normal bloqueado hasta interacción"));
                }
            } catch(e) {
                console.error("Error al reproducir sonido:", e);
            } 
        };


            // --- AUTH OBSERVER (ACTUALIZADO CON ICONOS DE ROL) ---
        onAuthStateChanged(auth, async (user) => {
            const loader = document.getElementById('global-loader');
            const authContainer = document.getElementById('auth-container');
            const dashboardContainer = document.getElementById('dashboard-container');

            if (user) {
                const userStatusRef = doc(db, 'artifacts', appId, 'public', 'data', 'all_users', user.uid);
                const userStatusSnap = await getDoc(userStatusRef);
                
                if (userStatusSnap.exists()) {
                    const userData = userStatusSnap.data();
                    if (userData.suspended === true) {
                        await signOut(auth);
                        showToast('Cuenta suspendida por administración.', 'error');
                        return;
                    }
                    currentUserRole = userData.role || 'client';
                } else {
                    currentUserRole = 'client'; 
                }

                currentUser = user;
                isAdmin = user.email === ADMIN_EMAIL;
                                initChatSystem(); // INICIAR CHAT

                // --- OBTENER DATOS DEL ROL (Icono, Color, Etiqueta) ---
                const roleData = getRoleData(currentUserRole);

                // --- 1. ACTUALIZAR NOMBRE ---
                let displayName = 'Usuario';
                if (userStatusSnap.exists()) {
                    const uData = userStatusSnap.data();
                    displayName = uData.fullName || user.email.split('@')[0];
                }
                const sidebarNameEl = document.getElementById('sidebar-user-name');
                if(sidebarNameEl) sidebarNameEl.textContent = displayName;
                
                // --- 2. ACTUALIZAR AVATAR POR ICONO DE ROL (NUEVO) ---
                const avatarEl = document.getElementById('sidebar-avatar-initials');
                if(avatarEl) {
                    // Limpiamos las letras "US"
                    avatarEl.innerHTML = '';
                    // Insertamos el icono correspondiente al rol con su color
                    // Aumentamos el tamaño (w-8 h-8) para que luzca bien en el círculo
                    avatarEl.innerHTML = `<i data-lucide="${roleData.icon}" class="w-8 h-8 ${roleData.color}"></i>`;
                }

                // --- 3. ACTUALIZAR BADGES (ETIQUETAS) ---
                // Badge del Sidebar
                const sidebarBadge = document.getElementById('sidebar-role-tag');
                const badgeCssMap = { 'lider': 'badge-lider', 'reseller': 'badge-reseller', 'vip': 'badge-vip', 'client': 'badge-client' };
                const specificClass = badgeCssMap[currentUserRole] || 'badge-client';

                sidebarBadge.className = `role-badge-premium ${specificClass} inline-flex items-center gap-1.5 mt-2 text-[10px] px-3 py-1 rounded-full font-black uppercase tracking-widest`;
                sidebarBadge.innerHTML = `<i data-lucide="${roleData.icon}" class="w-3 h-3 text-white fill-white/20"></i> ${roleData.label}`;
                
                // Badge del Header (Arriba derecha)
                const headerBadge = document.getElementById('header-role-badge');
                headerBadge.className = `text-[8px] uppercase font-black tracking-widest leading-none mt-0.5 flex items-center gap-1 ${roleData.color}`;
                headerBadge.innerHTML = `<i data-lucide="${roleData.icon}" class="w-3 h-3"></i> ${roleData.label}`;

                // Botón invitar (Solo visible si NO es cliente normal)
                const btnInvite = document.getElementById('btn-invite-reseller');
                if(currentUserRole !== 'client') btnInvite.classList.remove('hidden');
                else btnInvite.classList.add('hidden');


                // --- INICIALIZACIÓN DE DATOS ---
                await initCategories();
                initBanners();
                
                // --- INICIALIZACIÓN DE DATOS ---
await initCategories();
initBanners();
window.initSpotlight(); // <--- ESTA LÍNEA ES LA QUE HACE QUE TODOS VEAN EL ANUNCIO

                if (isAdmin) {
                    document.getElementById('user-menu-items').classList.add('hidden');
                    document.getElementById('admin-menu-items').classList.remove('hidden');
                    const cocinaBtn = document.getElementById('admin-cocina-btn');
                    if(cocinaBtn) cocinaBtn.classList.remove('hidden');
                    initAdminPanel();
                    switchView('admin'); 
                } else {
                    document.getElementById('user-menu-items').classList.remove('hidden');
                    document.getElementById('admin-menu-items').classList.add('hidden');
                    const cocinaBtn = document.getElementById('admin-cocina-btn');
                    if(cocinaBtn) cocinaBtn.classList.add('hidden');
                    switchView('user');
                }

                await initUserData(user);
                initGlobalNotifications(); 
                
                authContainer.classList.add('hidden');
                dashboardContainer.classList.remove('hidden');
                
                // Refrescamos los iconos recién insertados
                lucide.createIcons();

            } else {
                currentUser = null;
                isAdmin = false;
                dashboardContainer.classList.add('hidden');
                authContainer.classList.remove('hidden');
                document.getElementById('login-email').value = '';
                document.getElementById('login-password').value = '';
                checkReferralParam();
            }
            
            setTimeout(() => {
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 700);
            }, 1500);
        });

                                // --- GATEKEEPER INTELIGENTE CON SEGURIDAD DE TOKEN ---
        async function checkReferralParam() {
            const urlParams = new URLSearchParams(window.location.search);
            const refId = urlParams.get('ref');
            const code = urlParams.get('c') || '1'; 
            const incomingToken = urlParams.get('t'); // El token que trae el enlace

            if(refId) {
                // Bloqueo visual del botón mientras verificamos
                const loginBtn = document.querySelector('#login-form button[type="submit"]');
                const originalBtnText = loginBtn ? loginBtn.innerHTML : '';
                
                if(loginBtn) {
                    loginBtn.innerHTML = '<span class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full"></span> Verificando seguridad...';
                    loginBtn.disabled = true;
                }

                try {
                    // Consultamos datos del Padrino/Líder en tiempo real
                    const refDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'all_users', refId));
                    
                    if(loginBtn) {
                        loginBtn.innerHTML = originalBtnText;
                        loginBtn.disabled = false;
                    }

                    if (refDoc.exists()) {
                        const rData = refDoc.data();
                        const config = rData.referralConfig || {};
                        const realToken = rData.referralToken; // El token válido actualmente en la nube

                        // 1. VALIDACIÓN DE ESTADO: ¿Está encendido el interruptor?
                        const isActive = config[code] === true;

                        // 2. VALIDACIÓN DE SEGURIDAD: ¿Coincide el token del enlace con el de la BD?
                        // Si generaste un nuevo enlace, 'realToken' cambió, por lo que el enlace viejo fallará aquí.
                        // (Si no tienes token en BD aún, asumimos válido por compatibilidad hasta que generes uno)
                        const isValidToken = realToken ? (incomingToken === realToken) : true; 

                        if (isActive && isValidToken) {
                            
                            // --- CÁLCULO DEL MONTO ---
                            let displayAmount = 10; // Base
                            if(code === '2') displayAmount = 50;  
                            if(code === '3') displayAmount = 100; 

                            if (rData.email === 'mrandroidtutorialeshd@gmail.com') {
                                const customAmount = config[`amount_${code}`];
                                if (customAmount !== undefined && customAmount !== null) {
                                    displayAmount = customAmount;
                                }
                            }

                            // === ACCESO CONCEDIDO ===
                            switchAuthView('register');
                            
                            const badge = document.getElementById('referral-badge');
                            if(badge) {
                                badge.classList.remove('hidden');
                                badge.querySelector('span').innerText = `¡Te han invitado! Recibe $${displayAmount} de saldo.`;
                                badge.className = "bg-indigo-50 text-indigo-600 p-3 rounded-xl text-xs font-bold border border-indigo-100 flex items-center gap-2 neumo-card neumo-flat mb-4";
                                const icon = badge.querySelector('i');
                                if(icon) icon.setAttribute('data-lucide', 'gift');
                            }
                            lucide.createIcons();

                        } else {
                            // === ACCESO DENEGADO (Token incorrecto o Interruptor apagado) ===
                            handleAccessDenied();
                        }
                    } else {
                        handleAccessDenied();
                    }
                    
                } catch (e) {
                    console.error("Error checking referral:", e);
                    if(loginBtn) {
                        loginBtn.innerHTML = originalBtnText;
                        loginBtn.disabled = false;
                    }
                }
            }

            function handleAccessDenied() {
                switchAuthView('login');
                const loginForm = document.getElementById('login-form');
                const oldAlert = document.getElementById('access-denied-alert');
                if(oldAlert) oldAlert.remove();

                const alertDiv = document.createElement('div');
                alertDiv.id = 'access-denied-alert';
                alertDiv.className = "bg-rose-50 text-rose-500 p-4 rounded-xl text-xs font-bold border border-rose-100 flex items-center gap-3 neumo-card neumo-flat mb-6 bounce-enter";
                alertDiv.innerHTML = `
                    <i data-lucide="shield-alert" class="w-5 h-5 flex-shrink-0"></i>
                    <span>Este enlace ha caducado por seguridad o no es válido. Pide uno nuevo.</span>
                `;
                if(loginForm) loginForm.insertBefore(alertDiv, loginForm.firstChild);
                lucide.createIcons();
            }
        }



        // --- CATEGORÍAS DINÁMICAS ---
                async function initCategories() {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'categories')); 
            onSnapshot(q, (snapshot) => {
                window.categoriesCache = [];
                snapshot.forEach(doc => window.categoriesCache.push({ id: doc.id, ...doc.data() }));

                // --- LÓGICA DE ORDENAMIENTO ---
                window.categoriesCache.sort((a, b) => {
                    // Si una categoría no tiene número (porque es vieja), le ponemos 999 para que se vaya al final
                    const orderA = (a.order !== undefined && a.order !== null) ? Number(a.order) : 999;
                    const orderB = (b.order !== undefined && b.order !== null) ? Number(b.order) : 999;
                    
                    // Ordena de menor a mayor (1, 2, 3...)
                    return orderA - orderB;
                });
                // -----------------------------

                renderUserCategories();
                if(isAdmin) renderAdminCategories();
            });
        }

         function renderUserCategories() {
            const grid = document.getElementById('categories-grid');
            if (!grid) return;
            if (window.categoriesCache.length === 0) { grid.innerHTML = `<div class="col-span-full text-center text-gray-400 text-sm py-8">No hay servicios disponibles.</div>`; return; }
            
            let html = '';
            window.categoriesCache.forEach(cat => {
                // CAMBIOS REALIZADOS:
                // 1. h-36: Aumentamos la altura de la imagen (antes era h-32).
                // 2. scale-105: Hacemos un pequeño zoom permanente para que llene más visualmente.
                // 3. -mb-2: Un margen negativo pequeño abajo para acercar el texto y ganar espacio.
                const iconContent = cat.imageUrl 
                    ? `<img src="${cat.imageUrl}" class="w-full h-36 object-contain transform scale-105 drop-shadow-lg group-hover:scale-115 transition-transform duration-300 -mb-2" alt="${cat.name}">` 
                    : `<i data-lucide="${cat.icon || 'box'}" class="w-16 h-16 text-${cat.color || 'gray'}-500 group-hover:scale-110 transition-transform duration-300"></i>`;

                html += `
                <div onclick="openCategoryModule('${cat.slug || cat.id}', '${cat.name}')" class="bg-white rounded-[1.5rem] p-2 flex flex-col items-center justify-between cursor-pointer shadow-md hover:shadow-xl transition-all hover:scale-[1.02] group h-48 border border-gray-100 relative overflow-hidden">
                    
                    <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-b from-gray-50 to-transparent opacity-50"></div>
                    
                    <div class="relative z-10 flex-1 flex items-center justify-center w-full overflow-visible">
                        ${iconContent}
                    </div>
                    
                    <span class="relative z-10 font-bold text-gray-800 text-sm text-center tracking-wide mb-2 group-hover:text-indigo-600 transition-colors">${cat.name}</span>
                </div>`;
            });
            grid.innerHTML = html; 
            lucide.createIcons();
        }



        function renderAdminCategories() {
            const list = document.getElementById('admin-categories-list');
            if(!list) return;
            let html = '';
            window.categoriesCache.forEach(cat => {
                html += `<div class="neumo-card p-4 flex flex-col gap-3 relative group">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-${cat.color || 'slate'}-100 flex items-center justify-center text-${cat.color || 'slate'}-600 neumo-inset"><i data-lucide="${cat.icon || 'box'}" class="w-5 h-5"></i></div>
                        <div><p class="font-bold text-gray-700 text-sm">${cat.name}</p><p class="text-[10px] text-gray-400 font-mono">slug: ${cat.slug}</p></div>
                    </div>
                    <div class="absolute top-3 right-3 flex gap-2">
                        <button onclick="openEditCategoryModal('${cat.id}')" class="neumo-button p-1 text-blue-500 hover:text-accent"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                        <button onclick="deleteCategory('${cat.id}')" class="neumo-button p-1 text-rose-500 hover:text-danger"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>`;
            });
            list.innerHTML = html; lucide.createIcons();
        }

        // ======================================================
        // BLOQUE NUEVO: GESTIÓN DE CATEGORÍAS (CON CHECKBOXES)
        // ======================================================
        
        // 1. Helper para dibujar los checkboxes de configuración
        function getFieldsConfigHTML(selected = []) {
            const fields = [
                { id: 'email', label: 'Correo' },
                { id: 'password', label: 'Contraseña' },
                { id: 'profileName', label: 'Nombre Perfil' },
                { id: 'pin', label: 'PIN' },
                { id: 'link', label: 'Enlace / Link' },
                { id: 'folio', label: 'Folio' }, // <--- NUEVO CAMPO AGREGADO
                { id: 'expiryDate', label: 'Fecha Expiración' },
                { id: 'duration', label: 'Duración' },
                { id: 'description', label: 'Descripción / Código' },
                { id: 'terms', label: 'Términos' }
            ];
            
            let html = '<div class="col-span-2 mt-4 bg-gray-50 p-3 rounded-xl border border-gray-100"><p class="text-xs font-black text-gray-500 uppercase mb-3 flex items-center gap-2"><i data-lucide="settings-2" class="w-3 h-3"></i> Datos a solicitar en Inventario:</p><div class="grid grid-cols-2 gap-2">';
            
            fields.forEach(f => {
                const isChecked = selected.includes(f.id) ? 'checked' : '';
                html += `
                    <label class="flex items-center gap-2 p-2 rounded-lg border border-gray-200 bg-white cursor-pointer hover:border-indigo-300 transition-colors">
                        <input type="checkbox" value="${f.id}" class="field-checkbox accent-indigo-600 w-4 h-4" ${isChecked}>
                        <span class="text-xs font-bold text-gray-600">${f.label}</span>
                    </label>`;
            });
            
            html += '</div></div>';
            return html;
        }

         // 2. Modal para Agregar Categoría (ACTUALIZADO CON IMAGEN)
        window.openAddCategoryModal = () => {
            openModal(`
            <div class="text-left bounce-enter">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Nuevo Servicio</h3>
                <form onsubmit="saveCategory(event)" class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Nombre</label><input type="text" id="cat-name" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm" required></div>
                        <div><label class="block text-xs font-bold text-accent uppercase mb-1">Orden</label><input type="number" id="cat-order" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm font-bold" placeholder="Ej: 1" required></div>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-indigo-500 uppercase mb-1">URL Imagen 3D (Opcional)</label>
                        <input type="url" id="cat-image-url" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm" placeholder="https://imgur.com/...">
                        <p class="text-[9px] text-gray-400 mt-1">Si dejas esto vacío, se usará el icono Lucide.</p>
                    </div>

                    <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Slug (ID único)</label><input type="text" id="cat-slug" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm" required placeholder="ej: streaming"></div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Icono (Fallback)</label><input type="text" id="cat-icon" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm" required placeholder="ej: tv" value="box"></div>
                        <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Color</label><select id="cat-color" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm"><option value="slate">Gris</option><option value="blue">Azul</option><option value="indigo">Índigo</option><option value="emerald">Verde</option><option value="rose">Rojo</option><option value="amber">Ambar</option></select></div>
                    </div>
                    
                    ${getFieldsConfigHTML(['email', 'password'])} 

                    <button type="submit" class="neumo-button w-full bg-gray-900 text-white font-bold py-3 rounded-xl shadow-lg mt-2">Crear Categoría</button>
                </form>
            </div>`);
        };


          // 3. Modal para Editar Categoría (ACTUALIZADO)
        window.openEditCategoryModal = (id) => {
            const cat = window.categoriesCache.find(c => c.id === id);
            if (!cat) return showToast('Categoría no encontrada', 'error');
            const colors = ['amber', 'blue', 'emerald', 'rose', 'purple', 'indigo', 'slate'];
            const colorOptions = colors.map(c => `<option value="${c}" ${c === cat.color ? 'selected' : ''}>${c.charAt(0).toUpperCase() + c.slice(1)}</option>`).join('');
            
            const savedFields = cat.fields || [];

            openModal(`
            <div class="text-left bounce-enter">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Editar Servicio</h3>
                <form onsubmit="updateCategory(event, '${id}')" class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Nombre</label><input type="text" id="edit-cat-name" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm" value="${cat.name}" required></div>
                        <div><label class="block text-xs font-bold text-accent uppercase mb-1">Orden</label><input type="number" id="edit-cat-order" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm font-bold" value="${cat.order!==undefined?cat.order:''}" placeholder="Ej: 1" required></div>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-indigo-500 uppercase mb-1">URL Imagen 3D</label>
                        <input type="url" id="edit-cat-image-url" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm" value="${cat.imageUrl || ''}" placeholder="https://...">
                    </div>

                    <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Slug</label><input type="text" id="edit-cat-slug" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm" value="${cat.slug}" required></div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Icono</label><input type="text" id="edit-cat-icon" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm" value="${cat.icon}" required></div>
                        <div><label class="block text-xs font-bold text-gray-400 uppercase mb-1">Color</label><select id="edit-cat-color" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm">${colorOptions}</select></div>
                    </div>
                    
                    ${getFieldsConfigHTML(savedFields)}

                    <button type="submit" class="neumo-button w-full bg-gray-900 text-white font-bold py-3 rounded-xl shadow-lg mt-2">Guardar Cambios</button>
                </form>
            </div>`);
        };


         // 4. Guardar Nueva Categoría (ACTUALIZADO)
        window.saveCategory = async (e) => { 
            e.preventDefault(); 
            const selectedFields = Array.from(document.querySelectorAll('.field-checkbox:checked')).map(cb => cb.value);

            try { 
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'categories'), { 
                    name: document.getElementById('cat-name').value, 
                    slug: document.getElementById('cat-slug').value.toLowerCase().trim(), 
                    imageUrl: document.getElementById('cat-image-url').value, // <--- GUARDAMOS LA IMAGEN
                    icon: document.getElementById('cat-icon').value, 
                    color: document.getElementById('cat-color').value,
                    order: Number(document.getElementById('cat-order').value),
                    fields: selectedFields, 
                    createdAt: serverTimestamp() 
                }); 
                showToast('Categoría creada', 'success'); 
                closeModal(); 
            } catch(err) { showToast('Error', 'error'); } 
        };


            // 5. Actualizar Categoría Existente (ACTUALIZADO)
        window.updateCategory = async (e, id) => {
            e.preventDefault();
            const selectedFields = Array.from(document.querySelectorAll('.field-checkbox:checked')).map(cb => cb.value);

            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', id), {
                    name: document.getElementById('edit-cat-name').value,
                    slug: document.getElementById('edit-cat-slug').value.toLowerCase().trim(),
                    imageUrl: document.getElementById('edit-cat-image-url').value, // <--- GUARDAMOS
                    icon: document.getElementById('edit-cat-icon').value,
                    color: document.getElementById('edit-cat-color').value,
                    order: Number(document.getElementById('edit-cat-order').value),
                    fields: selectedFields 
                });
                showToast('Categoría actualizada', 'success');
                closeModal();
            } catch(err) { showToast('Error al actualizar', 'error'); }
        };

        
        window.deleteCategory = async (id) => { if(confirm("¿Eliminar categoría?")) try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', id)); showToast('Eliminada', 'success'); } catch(err) { showToast('Error', 'error'); } };

        // --- DATOS USUARIO ---
                        // --- FUNCIÓN DE SALDO CORREGIDA Y SEGURA ---
       async function initUserData(user) {
            console.log("Conectando billetera para:", user.uid);

            const walletRef = doc(db, 'artifacts', appId, 'users', user.uid, 'wallet', 'main');

            // Escuchamos en tiempo real (onSnapshot)
            onSnapshot(walletRef, (snapshot) => {
                const balanceLabel = document.getElementById('balance-display');
                const profitLabel = document.getElementById('profit-display');

                if (snapshot.exists()) {
                    const data = snapshot.data();

                    // 1. OBTENER SALDO REAL
                    // Si data.balance existe, lo usamos. Si no, es 0.
                    const realBalance = (data.balance !== undefined && data.balance !== null) ? Number(data.balance) : 0;
                    
                    // 2. OBTENER GANANCIAS REALES
                    const realProfit = (data.profit !== undefined && data.profit !== null) ? Number(data.profit) : 0;

                    // 3. MOSTRAR EN PANTALLA (Actualización inmediata)
                    if (balanceLabel) balanceLabel.textContent = `$${realBalance.toLocaleString()}`;
                    if (profitLabel) profitLabel.textContent = `$${realProfit.toLocaleString()}`;

                    // Actualizamos variable global para que funcione la transferencia de ganancias
                    currentProfit = realProfit;

                } else {
                    // SI NO EXISTE LA BILLETERA AÚN:
                    // NO usamos setDoc aquí para no sobrescribir nada accidentalmente.
                    // Solo mostramos $0 visualmente esperando que el Admin cargue saldo o se cree la cuenta.
                    if (balanceLabel) balanceLabel.textContent = "$0";
                    if (profitLabel) profitLabel.textContent = "$0";
                    currentProfit = 0;
                }
            }, (error) => {
                console.error("Error de conexión:", error);
                // Solo si hay error de red mostramos 0 para evitar el "--"
                if (document.getElementById('balance-display')) document.getElementById('balance-display').textContent = "$0";
            });

            // Carga del historial (Se mantiene igual, no afecta al saldo)
                        // Carga del historial (CON SONIDO PARA NUEVOS MOVIMIENTOS)
            try {
                const txRef = collection(db, 'artifacts', appId, 'users', user.uid, 'transactions');
                let isFirstLoad = true; // Bandera para evitar ruido al recargar página

                onSnapshot(query(txRef, orderBy('timestamp', 'desc'), limit(20)), (snapshot) => {
                    // Detectar cambios
                    if (!isFirstLoad) {
                        snapshot.docChanges().forEach((change) => {
                            if (change.type === "added") {
                                window.playNotificationSound(); // <--- SONIDO AQUÍ
                                showToast('¡Nueva notificación recibida!', 'success');
                            }
                        });
                    }

                    window.userTransactions = [];
                    snapshot.forEach((docSnap) => {
                        window.userTransactions.push({id: docSnap.id, ...docSnap.data()});
                    });
                    
                    if(typeof updateNotificationDot === 'function') updateNotificationDot();
                    isFirstLoad = false; // Ya cargó la primera vez
                });
            } catch(e) { console.log("Error historial", e); }
        }

        function initGlobalNotifications() {
            onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'global_notifications'), orderBy('timestamp', 'desc'), limit(5)), (snapshot) => { window.globalNotifications = []; snapshot.forEach(doc => window.globalNotifications.push({id: doc.id, isGlobal:true, ...doc.data()})); updateNotificationDot(); });
        }
        function updateNotificationDot() { 
            const dot = document.getElementById('notification-dot'); 
            let hasAdmin = (window.adminPendingRequests?.length > 0) || (window.adminPendingReports?.length > 0) || (window.adminPendingRenewals?.length > 0); 
            if (window.userTransactions.length > 0 || window.globalNotifications.length > 0 || (isAdmin && hasAdmin)) dot.style.display = 'block'; 
            else dot.style.display = 'none'; 
        }
        
        // --- MODAL Y FUNCIÓN DE TRANSFERENCIA DE GANANCIAS ---
                window.openProfitTransferModal = () => {
            // Permitir acceso a: VIP, Revendedor y Líder. (Bloqueamos solo a 'client')
            if (currentUserRole === 'client') {
                return showToast('Función exclusiva para VIP, Revendedores y Líderes.', 'info');
            }

            let modalContent;
            
            if (currentProfit > 0) {
                modalContent = `
                    <div class="text-center bounce-enter">
                        <div class="w-16 h-16 bg-indigo-100 text-indigo-500 rounded-full flex items-center justify-center mx-auto mb-4 neumo-card neumo-inset"><i data-lucide="chevrons-up-down" class="w-8 h-8"></i></div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Transferir Ganancias</h3>
                        <p class="text-xs text-gray-400 mb-6">Mueve tus ganancias disponibles a tu Saldo para usarlos en compras.</p>
                        
                        <div class="neumo-card neumo-inset p-4 rounded-xl text-left mb-4">
                            <p class="text-[10px] font-bold text-indigo-600 uppercase">Ganancia Disponible:</p>
                            <p class="text-2xl font-black text-indigo-700">$${(currentProfit).toLocaleString()}</p>
                        </div>

                        <form onsubmit="transferProfitToBalance(event, ${currentProfit})" class="space-y-4">
                            <input type="number" id="transfer-amount" class="neumo-inset w-full bg-transparent border-none rounded-xl px-4 py-3 text-lg font-bold text-center" placeholder="Monto a transferir" min="1" max="${currentProfit}" required>
                            <button type="submit" class="neumo-button w-full bg-gray-900 text-white font-bold py-3.5 rounded-xl shadow-lg">Transferir a Saldo</button>
                        </form>
                    </div>
                `;
            } else {
                modalContent = `
                    <div class="text-center bounce-enter">
                        <div class="w-16 h-16 bg-rose-100 text-rose-500 rounded-full flex items-center justify-center mx-auto mb-4 neumo-card neumo-inset"><i data-lucide="dollar-sign" class="w-8 h-8"></i></div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Sin Ganancias Disponibles</h3>
                        <div class="neumo-card neumo-inset p-4 rounded-xl text-left mb-4">
                            <p class="text-[10px] font-bold text-indigo-600 uppercase">Ganancia Disponible:</p>
                            <p class="text-2xl font-black text-indigo-700">$0</p>
                        </div>
                        <p class="text-sm text-gray-500 mb-6 px-4">Actualmente no tienes ganancias para transferir a tu saldo principal. ¡Sigue invitando amigos!</p>
                        <button onclick="closeModal()" class="neumo-button w-full bg-gray-900 text-white font-bold py-3.5 rounded-xl shadow-lg">Entendido</button>
                    </div>
                `;
            }
            openModal(modalContent);
        };

        window.transferProfitToBalance = async (e, maxAmount) => {
            e.preventDefault();
            const amount = Number(document.getElementById('transfer-amount').value);
            
            if (amount <= 0 || amount > maxAmount) {
                return showToast('Monto inválido o excede la ganancia disponible.', 'error');
            }

            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = 'Procesando...';

            const wRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'wallet', 'main');

            try {
                await runTransaction(db, async (t) => {
                    const s = await t.get(wRef);
                    const currentBal = s.data().balance || 0;
                    const currentProf = s.data().profit || 0;

                    if (currentProf < amount) {
                        throw new Error("Saldo de ganancia insuficiente (Error de concurrencia).");
                    }
                    t.update(wRef, { profit: currentProf - amount });
                    t.update(wRef, { balance: currentBal + amount });
                    
                    const txRef = doc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions'));
                    t.set(txRef, { 
                        type: 'deposit', 
                        amount: amount, 
                        description: 'Transferencia de Ganancias a Saldo', 
                        timestamp: serverTimestamp() 
                    });
                });

                showToast(`¡Transferencia de $${amount} exitosa!`, 'success');
                closeModal();
            } catch (e) {
                showToast('Error en la transferencia: ' + (e.message || 'Inténtalo de nuevo.'), 'error');
                btn.disabled = false;
                btn.innerText = originalText;
            }
        };

        // --- ADMIN PANEL ---
                                                function initAdminPanel() {
            // 1. SOLICITUDES DE SALDO
            let firstLoadRequests = true;
            onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'pending_recharges'), orderBy('timestamp', 'desc'), limit(50)), (snapshot) => {
                
                // Detectar nuevos pagos entrantes
                if (!firstLoadRequests) {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "added") {
                            window.playNotificationSound(); // <--- SONIDO
                            showToast('💰 Nueva solicitud de saldo', 'success');
                        }
                    });
                }

                window.adminPendingRequests = []; 
                let html = '';
                snapshot.forEach(doc => { 
                    const d = doc.data(); 
                    if(d.status === 'pending') { 
                        d.id = doc.id;
                        window.adminPendingRequests.push(d); 
                        // ... (El resto de tu código HTML interno se mantiene igual aquí) ...
                        html += `
                        <div class="neumo-card p-4 flex flex-col md:flex-row justify-between items-center gap-3 slide-up" style="border-left: 4px solid var(--color-accent);">
                            <div class="flex-1">
                                <p class="font-bold text-gray-800 text-sm">${d.email}</p>
                                <span class="bg-accent/10 text-accent text-[10px] font-bold px-2 py-1 rounded-full neumo-flat">Pendiente</span>
                                <p class="text-[10px] text-gray-400 mt-1">Expira: ${d.expiresAt ? d.expiresAt.toDate().toLocaleTimeString() : 'N/A'}</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="font-bold text-lg text-success">$${d.amount.toLocaleString()}</span>
                                <div class="flex gap-2">
                                    <button onclick="event.stopPropagation(); window.approveRecharge('${doc.id}', '${d.uid}', ${d.amount}, '${d.userTxId}')" class="neumo-button bg-success text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-emerald-600 flex items-center gap-1 shadow-lg"><i data-lucide="check" class="w-4 h-4"></i></button>
                                    <button onclick="event.stopPropagation(); window.rejectRecharge('${doc.id}', '${d.uid}', '${d.userTxId}')" class="neumo-button bg-danger text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-red-600 flex items-center gap-1 shadow-lg"><i data-lucide="x" class="w-4 h-4"></i></button>
                                </div>
                            </div>
                        </div>`; 
                    } 
                });
                const list = document.getElementById('admin-requests-list');
                if(list) list.innerHTML = html || '<div class="text-center py-4 text-gray-400">Sin solicitudes</div>';
                const badge = document.getElementById('badge-requests'); 
                if(badge) { if(window.adminPendingRequests.length > 0){badge.textContent=window.adminPendingRequests.length; badge.classList.remove('hidden');} else badge.classList.add('hidden'); }
                lucide.createIcons();
                firstLoadRequests = false;
            });

            // 2. RENOVACIONES
            let firstLoadRenew = true;
            onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'reports'), where('type', '==', 'renewal')), (s) => {
                
                // --- DETECCIÓN DE SONIDO ---
                if(!firstLoadRenew) {
                    s.docChanges().forEach((change) => {
                        if (change.type === "added") {
                            window.playNotificationSound(); 
                            showToast('🔄 Nueva Renovación solicitada', 'info');
                        }
                    });
                }
                // ---------------------------

                const list = document.getElementById('admin-renewal-list');
                const badge = document.getElementById('renewal-count-badge');
                if(!list) return;

                window.adminPendingRenewals = []; 
                let html = '';
                let pendingCount = 0;

                if (s.empty) { html = '<div class="text-center py-10 opacity-50"><p class="text-xs text-gray-400">Sin renovaciones pendientes.</p></div>'; } 
                else {
                    s.forEach(doc => { 
                        const r = doc.data(); r.id = doc.id; 
                        if(r.status === 'unread' || r.status === 'processing' || !r.status) {
                            window.adminPendingRenewals.push(r);
                            pendingCount++;
                            html += `
                            <div onclick="viewRenewalDetail('${doc.id}')" class="neumo-card p-4 rounded-xl shadow-sm mb-3 bg-white relative cursor-pointer hover:bg-gray-50 transition-colors" title="Ver Detalle">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <p class="font-bold text-sm text-gray-800">${r.email}</p>
                                        <p class="text-[10px] text-gray-400">${r.timestamp ? r.timestamp.toDate().toLocaleString() : 'Reciente'}</p>
                                    </div>
                                    <span class="text-[9px] uppercase font-bold px-2 py-1 rounded bg-indigo-50 text-indigo-600 border border-indigo-100">${r.status === 'unread' ? 'Nueva' : 'En Proceso'}</span>
                                </div>
                                <div class="bg-gray-50 p-2 rounded-lg mb-3">
                                    <p class="text-xs text-gray-600 whitespace-pre-wrap font-medium line-clamp-2">${r.description}</p>
                                </div>
                                <div class="flex gap-2 border-t border-gray-100 pt-3 items-center">
                                    <button onclick="event.stopPropagation(); deleteReport('${doc.id}')" class="neumo-button w-8 h-8 flex items-center justify-center text-rose-300 hover:text-rose-600 hover:bg-rose-50 rounded-lg" title="Eliminar"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    <button onclick="event.stopPropagation(); approveRenewal('${doc.id}', '${r.uid}')" class="neumo-button flex-1 bg-success text-white py-2 rounded-lg text-xs font-bold shadow-sm">Aprobar</button>
                                    <button onclick="event.stopPropagation(); rejectRenewal('${doc.id}')" class="neumo-button flex-1 bg-white text-rose-500 border border-rose-100 py-2 rounded-lg text-xs font-bold">Rechazar</button>
                                </div>
                            </div>`;
                        }
                    });
                }
                if (html === '') html = '<div class="text-center py-10 opacity-50"><p class="text-xs text-gray-400">Sin renovaciones pendientes.</p></div>';
                
                list.innerHTML = html;
                if(badge) badge.textContent = `${pendingCount} Pendientes`;
                const navBadge = document.getElementById('badge-renewal'); 
                if(navBadge) { if(pendingCount>0){navBadge.textContent=pendingCount; navBadge.classList.remove('hidden');} else navBadge.classList.add('hidden'); }
                lucide.createIcons();

                firstLoadRenew = false; // Desactivar bandera de primera carga
            });

                                                // 3. SOPORTE TÉCNICO (ORDENADO: NUEVOS ARRIBA)
            let firstLoadSupport = true;
            onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'reports'), where('type', '!=', 'renewal')), (s) => {
                
                if(!firstLoadSupport) {
                    s.docChanges().forEach((change) => {
                        if (change.type === "added") {
                            const d = change.doc.data();
                            if (d.type !== 'claim') {
                                window.playNotificationSound(); 
                                showToast('📩 Nuevo Ticket de Soporte', 'error');
                            }
                        }
                    });
                }

                const list = document.getElementById('admin-support-list');
                const badge = document.getElementById('support-count-badge');
                if(!list) return;

                window.adminPendingReports = []; 
                
                let allReports = [];
                s.forEach(doc => { 
                    const r = doc.data(); 
                    r.id = doc.id; 
                    allReports.push(r);
                    
                    if(!window.adminReportsCache) window.adminReportsCache = [];
                    const existingIdx = window.adminReportsCache.findIndex(x => x.id === r.id);
                    if(existingIdx >= 0) window.adminReportsCache[existingIdx] = r;
                    else window.adminReportsCache.push(r);
                });

                allReports.sort((a, b) => {
                    // Ordenar: Pendientes primero, luego Resueltos/Respondidos al final
                    const isPendingA = (a.status !== 'resolved' && a.status !== 'replied');
                    const isPendingB = (b.status !== 'resolved' && b.status !== 'replied');
                    
                    if (isPendingA && !isPendingB) return -1;
                    if (!isPendingA && isPendingB) return 1;

                    // Si ambos son iguales, por fecha
                    const dateA = a.timestamp ? a.timestamp.toMillis() : 0;
                    const dateB = b.timestamp ? b.timestamp.toMillis() : 0;
                    return dateB - dateA;
                });

                let html = '';
                let pendingCount = 0;

                if (allReports.length === 0) { 
                    html = '<div class="text-center py-10 opacity-50"><p class="text-xs text-gray-400">Sin tickets de soporte.</p></div>'; 
                } else {
                    allReports.forEach(r => { 
                        if (r.type === 'claim') return; 

                        // Contar solo los que NO están resueltos ni respondidos para el badge rojo
                        if(r.status !== 'replied' && r.status !== 'resolved') {
                            window.adminPendingReports.push(r);
                            pendingCount++;
                        }
                        
                        let typeIcon = r.type === 'payment' ? 'dollar-sign' : (r.type === 'bug' ? 'bug' : 'message-circle');
                        let typeColor = r.type === 'payment' ? 'text-green-500' : (r.type === 'bug' ? 'text-rose-500' : 'text-blue-500');

                        // --- TRADUCCIÓN Y COLORES ---
                        let statusBadge = '';
                        let cardStyle = 'bg-white border-gray-100'; // Estilo normal

                        if (r.status === 'resolved') {
                            // VERDE: RESUELTO / REMPLAZADO
                            statusBadge = `<span class="text-[9px] uppercase font-bold px-2 py-0.5 rounded bg-green-100 text-green-600 border border-green-200">Resuelto</span>`;
                            cardStyle = 'bg-green-50/40 border-green-200'; // Fondo verde muy suave y borde verde
                        } else if (r.status === 'replied') {
                            // AZUL: RESPONDIDO
                            statusBadge = `<span onclick="event.stopPropagation(); viewAdminReply('${r.id}')" class="text-[9px] uppercase font-bold px-2 py-0.5 rounded bg-blue-100 text-blue-600 border border-blue-200 cursor-pointer hover:scale-105 transition-transform shadow-sm" title="Ver mi respuesta">Respondido</span>`;
                            cardStyle = 'bg-white border-blue-100';
                        } else {
                            // ROJO: PENDIENTE (UNREAD)
                            statusBadge = `<span class="text-[9px] uppercase font-bold px-2 py-0.5 rounded bg-rose-100 text-rose-600 border border-rose-200 animate-pulse">Pendiente</span>`;
                            cardStyle = 'bg-white border-rose-100 shadow-sm';
                        }
                        // ----------------------------

                        html += `
                        <div onclick="openReportDetails('${r.id}')" class="neumo-card p-4 mb-3 cursor-pointer hover:shadow-md transition-all relative ${cardStyle}" title="Ver Detalle">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center ${typeColor} shadow-sm border border-gray-100 flex-shrink-0"><i data-lucide="${typeIcon}" class="w-5 h-5"></i></div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex justify-between items-start">
                                        <p class="font-bold text-xs text-gray-700 truncate">${r.email}</p>
                                        ${statusBadge}
                                    </div>
                                    <p class="text-[10px] text-gray-400 mb-1">${r.timestamp ? r.timestamp.toDate().toLocaleString() : ''}</p>
                                    <p class="text-xs text-gray-600 line-clamp-2">${r.description}</p>
                                </div>
                            </div>
                            <div class="mt-3 flex justify-between items-center border-t border-black/5 pt-2">
                                <button onclick="event.stopPropagation(); deleteReport('${r.id}')" class="text-gray-300 hover:text-rose-500 transition-colors p-1" title="Eliminar"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                ${ (r.status !== 'replied' && r.status !== 'resolved') ? `<button onclick="event.stopPropagation(); openReplyModal('${r.id}', '${r.uid}')" class="text-xs font-bold text-blue-600 hover:underline flex items-center gap-1"><i data-lucide="corner-down-right" class="w-3 h-3"></i> Responder</button>` : '<span></span>'}
                            </div>
                        </div>`;
                    });
                }
                
                list.innerHTML = html;
                if(badge) badge.textContent = `${pendingCount} Activos`;
                const navBadge = document.getElementById('badge-support'); 
                if(navBadge) { if(pendingCount>0){navBadge.textContent=pendingCount; navBadge.classList.remove('hidden');} else navBadge.classList.add('hidden'); }
                lucide.createIcons();

                firstLoadSupport = false;
            });


            // 4. PRODUCTOS
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'profiles'), (snapshot) => {
                const products = [];
                snapshot.forEach(doc => products.push({ id: doc.id, ...doc.data() }));
                const groupedProducts = products.reduce((acc, product) => {
                    const category = product.category || 'otros';
                    if (!acc[category]) acc[category] = [];
                    acc[category].push(product);
                    return acc;
                }, {});
                const customOrder = ['perfiles', 'cuentas', 'música', 'libros', 'licencias', 'game pass', 'otros'];
                const sortedCategories = Object.keys(groupedProducts).sort((a, b) => {
                    const indexA = customOrder.indexOf(a.toLowerCase());
                    const indexB = customOrder.indexOf(b.toLowerCase());
                    if (indexA !== -1 && indexB !== -1) return indexA - indexB;
                    if (indexA !== -1) return -1;
                    if (indexB !== -1) return 1;
                    return a.localeCompare(b);
                });
                let html = '';
                if (products.length === 0) { html = '<p class="text-center text-gray-400">Sin productos.</p>'; } else {
                    sortedCategories.forEach(category => {
                        const displayName = category.charAt(0).toUpperCase() + category.slice(1).replace('-', ' ');
                        html += `<div class="mt-8 mb-4"><h4 class="font-black text-lg text-gray-800 border-b border-gray-200 pb-1">${displayName}</h4></div><div class="space-y-3">`;
                        groupedProducts[category].forEach(d => {
                            html += `<div class="neumo-card p-3 flex items-center gap-3 slide-up relative overflow-hidden"><img src="${d.imageUrl}" class="w-12 h-12 rounded-lg object-cover bg-gray-100 flex-shrink-0"><div class="flex-1 min-w-0"><div class="flex justify-between items-start"><p class="font-bold text-sm text-gray-800 truncate pr-2">${d.name}</p></div><div class="flex flex-wrap gap-1 mt-1 mb-1"><span class="text-[9px] font-bold text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded border border-gray-200">Cli: $${d.priceClient || 0}</span><span class="text-[9px] font-bold text-purple-600 bg-purple-50 px-1.5 py-0.5 rounded border border-purple-100">Vip: $${d.priceVip || 0}</span><span class="text-[9px] font-bold text-indigo-600 bg-indigo-50 px-1.5 py-0.5 rounded border border-indigo-100">Rev: $${d.priceReseller || 0}</span><span class="text-[9px] font-bold text-amber-600 bg-amber-50 px-1.5 py-0.5 rounded border border-amber-100">Lid: $${d.priceLeader || 0}</span></div><div class="flex justify-between items-end"><p class="text-[10px] text-gray-400 truncate max-w-[100px]">${d.category}</p><div class="text-[10px]">Stock: <b class="${(d.stock||0) < 1 ? 'text-danger' : 'text-gray-800'}">${d.stock||0}</b></div></div></div><div class="flex flex-col gap-1 pl-1 border-l border-gray-100"><button onclick="openEditProductModal('${d.id}')" class="neumo-button p-2 text-blue-500 hover:text-accent"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="deleteProfile('${d.id}')" class="neumo-button p-2 text-rose-500 hover:text-danger"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div>`;
                        });
                        html += `</div>`;
                    });
                }
                const list = document.getElementById('admin-stock-list');
                if(list) list.innerHTML = html; 
                lucide.createIcons();
            });

                                                                        // 5. USUARIOS (CON BUSCADOR Y FILTROS)
            window.allUsersCache = []; // Variable global para guardar usuarios

                        // Función para renderizar la lista (CON BOTÓN BORRAR HISTORIAL)
            window.renderAdminUsersList = (usersList) => {
                let html = ''; 
                
                if (usersList.length === 0) {
                    html = '<div class="text-center py-10 text-gray-400 text-xs">No se encontraron usuarios.</div>';
                } else {
                    usersList.forEach(d => { 
                        const susp = d.suspended === true; 
                        const uRole = d.role || 'client';
                        const displayName = d.fullName || 'Sin Nombre';
                        
                        let roleBadgeColor = 'bg-gray-100 text-gray-500';
                        if(uRole === 'reseller') roleBadgeColor = 'bg-indigo-100 text-indigo-600';
                        if(uRole === 'lider') roleBadgeColor = 'bg-amber-100 text-amber-600';
                        if(uRole === 'vip') roleBadgeColor = 'bg-purple-100 text-purple-600';

                        const dateDisplay = d.createdAt ? d.createdAt.toDate().toLocaleDateString() : 'Antiguo';

                        html += `
                        <div onclick="openUserHistory('${d.uid}', '${d.email}')" class="neumo-card p-3 flex flex-col gap-3 relative cursor-pointer hover:bg-gray-50 transition-colors group slide-up mb-2">
                            <div class="flex items-center gap-3">
                                <div onclick="event.stopPropagation(); showUserDetails('${d.uid}')" class="w-9 h-9 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 font-bold text-xs neumo-inset border border-white cursor-pointer hover:scale-110 transition-transform shadow-sm relative z-10" title="Ver Datos Personales">
                                    ${d.email.substring(0,2).toUpperCase()}
                                </div>
                                <div class="overflow-hidden flex-1">
                                    <div class="flex justify-between items-start">
                                        <div class="min-w-0 flex-1 mr-2">
                                            <p class="font-bold text-sm text-gray-800 truncate capitalize">${displayName}</p>
                                            <p class="text-[10px] text-gray-500 truncate font-mono">${d.email}</p>
                                            ${d.whatsapp ? `<p class="text-[9px] text-green-600 font-mono flex items-center gap-1"><i data-lucide="phone" class="w-2 h-2"></i> ${d.whatsapp}</p>` : ''}
                                        </div>
                                        <span class="text-[9px] text-gray-400 font-mono whitespace-nowrap pt-0.5">${dateDisplay}</span>
                                    </div>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="text-[8px] font-bold uppercase px-1.5 py-0.5 rounded border border-gray-200 ${roleBadgeColor}">${uRole}</span>
                                        <p class="text-[9px] text-gray-400 font-mono">ID: ${d.uid.substring(0,6)}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="flex flex-wrap gap-2 pt-2 border-t border-gray-100" onclick="event.stopPropagation();">
                                <button onclick="openManualBalanceModal('${d.uid}', '${d.email}')" class="neumo-button flex-1 bg-emerald-50 text-emerald-600 py-1.5 rounded-lg text-xs font-bold flex items-center justify-center gap-1 hover:bg-emerald-100 transition-colors" title="Sumar Saldo"><i data-lucide="plus" class="w-3 h-3"></i> Sumar</button>
                                <button onclick="openEditBalanceExact('${d.uid}', '${d.email}')" class="neumo-button w-8 h-8 flex items-center justify-center bg-white text-blue-500 border border-blue-100 rounded-lg hover:bg-blue-50 transition-colors" title="Editar Saldo Exacto"><i data-lucide="pencil" class="w-3.5 h-3.5"></i></button>
                                <button onclick="openChangeRoleModal('${d.id}', '${uRole}', '${d.email}')" class="neumo-button w-8 h-8 flex items-center justify-center bg-white text-indigo-500 border border-indigo-100 rounded-lg hover:bg-indigo-50 transition-colors" title="Cambiar Rol"><i data-lucide="user-cog" class="w-3.5 h-3.5"></i></button>
                                
                                <button onclick="clearUserHistory('${d.uid}', '${d.email}')" class="neumo-button w-8 h-8 flex items-center justify-center bg-orange-50 text-orange-500 border border-orange-100 rounded-lg hover:bg-orange-100 transition-colors" title="Borrar Historial Completo">
                                    <i data-lucide="eraser" class="w-3.5 h-3.5"></i>
                                </button>

                                <button onclick="toggleSuspend('${d.id}', ${!susp})" class="neumo-button w-8 h-8 flex items-center justify-center bg-white ${susp ? 'text-emerald-500 border-emerald-100' : 'text-amber-500 border-amber-100'} rounded-lg hover:bg-gray-50 transition-colors" title="${susp?'Activar':'Suspender'}"><i data-lucide="${susp?'play':'pause'}" class="w-3.5 h-3.5"></i></button>
                                <button onclick="deleteUserSystem('${d.id}', '${d.uid}', '${d.email}')" class="neumo-button w-8 h-8 flex items-center justify-center bg-rose-50 text-rose-500 border border-rose-100 rounded-lg hover:bg-rose-500 hover:text-white transition-colors" title="Eliminar Usuario"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                            </div>
                        </div>`; 
                    });
                }
                
                const list = document.getElementById('admin-users-list');
                if(list) list.innerHTML = html;
                lucide.createIcons();
            };

            // Función del Buscador
            window.filterAdminUsers = () => {
                const query = document.getElementById('admin-user-search')?.value.toLowerCase().trim() || '';
                
                // Filtramos la caché global
                const filtered = window.allUsersCache.filter(u => {
                    const name = (u.fullName || '').toLowerCase();
                    const email = (u.email || '').toLowerCase();
                    const whatsapp = (u.whatsapp || '').toLowerCase();
                    
                    return name.includes(query) || email.includes(query) || whatsapp.includes(query);
                });

                renderAdminUsersList(filtered);
            };

            // Listener de Firebase (Carga inicial y cambios)
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'all_users'), (snapshot) => {
                window.allUsersCache = [];
                snapshot.forEach(doc => { 
                    window.allUsersCache.push({ id: doc.id, ...doc.data() });
                });

                // Ordenar: Nuevos arriba
                window.allUsersCache.sort((a, b) => {
                    const dateA = a.createdAt ? a.createdAt.toMillis() : 0;
                    const dateB = b.createdAt ? b.createdAt.toMillis() : 0;
                    if (dateA > 0 && dateB > 0) return dateB - dateA;
                    if (dateA > 0) return -1;
                    if (dateB > 0) return 1;
                    const loginA = a.lastLogin ? a.lastLogin.toMillis() : 0;
                    const loginB = b.lastLogin ? b.lastLogin.toMillis() : 0;
                    return loginB - loginA;
                });

                // Renderizar lista completa o filtrada si ya había texto
                filterAdminUsers();
            });


            // 6. INVENTARIO
            onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'inventory_items'), where('status', '==', 'available')), (snapshot) => {
                    window.inventoryCache = []; const items = [];
                    snapshot.forEach(doc => { const i = doc.data(); i.id = doc.id; items.push(i); window.inventoryCache.push(i); });
                    const groupedItems = items.reduce((acc, item) => { const cat = item.category || 'varios'; if (!acc[cat]) acc[cat] = []; acc[cat].push(item); return acc; }, {});
                    let html = ''; const sortedCategories = Object.keys(groupedItems).sort();
                    if (items.length === 0) { html = '<div class="text-center py-10 opacity-50"><i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 text-gray-300"></i><p class="text-gray-400 text-sm">El inventario está vacío</p></div>'; } 
                    else {
                        sortedCategories.forEach(cat => {
                            const displayTitle = cat.charAt(0).toUpperCase() + cat.slice(1).replace(/-/g, ' ');
                            html += `<div class="mt-6 mb-3 flex items-center gap-3 slide-up"><div class="h-px bg-gray-300 flex-1"></div><span class="text-[10px] font-black text-gray-400 uppercase tracking-widest bg-bg-primary px-2">${displayTitle}</span><div class="h-px bg-gray-300 flex-1"></div></div><div class="space-y-3">`;
                            groupedItems[cat].forEach(i => {
                            let detailInfo = '';
                            if (i.link) { detailInfo = `<p class="text-[10px] text-indigo-500 mt-1 truncate font-medium bg-indigo-50 inline-block px-2 py-0.5 rounded border border-indigo-100"><i data-lucide="link" class="w-3 h-3 inline align-middle"></i> Digital / Link</p>`; } else if (i.description && !i.email) { detailInfo = `<p class="text-[10px] text-gray-400 mt-1 line-clamp-1 italic">${i.description}</p>`; } else { detailInfo = `<p class="text-[10px] text-gray-400 mt-1 font-mono">Expira: <span class="text-gray-600 font-bold">${i.expiryDate || 'N/A'}</span></p>`; }
                            html += `<div class="neumo-card p-3 flex flex-col gap-2 slide-up relative group hover:scale-[1.01] transition-transform"><div class="flex justify-between items-start"><div class="overflow-hidden pr-2"><p class="font-bold text-gray-800 text-sm truncate">${i.serviceName}</p>${detailInfo}</div><div class="flex gap-2 flex-shrink-0"><button onclick="openEditInventoryModal('${i.id}')" class="neumo-button w-8 h-8 flex items-center justify-center text-blue-500 hover:text-white hover:bg-blue-500 rounded-lg transition-colors shadow-sm"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="deleteInventoryItem('${i.id}')" class="neumo-button w-8 h-8 flex items-center justify-center text-rose-500 hover:text-white hover:bg-rose-500 rounded-lg transition-colors shadow-sm"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div><div class="flex justify-between items-end border-t border-gray-100 pt-2 mt-1"><span class="text-[9px] text-gray-400 uppercase font-bold tracking-wider">Creado: ${i.createdAt ? i.createdAt.toDate().toLocaleDateString() : 'Reciente'}</span></div></div>`; 
                            });
                            html += `</div>`;
                        });
                    }
                    const list = document.getElementById('admin-inventory-list');
                    if(list) list.innerHTML = html; 
                    lucide.createIcons();
            });

            // 7. BANNERS
            function renderBannersAdmin() {
                const list = document.getElementById('admin-banners-list');
                if(!list) return;
                let html = '';
                bannerData.forEach(b => {
                    html += `<div class="neumo-card p-0 rounded-xl overflow-hidden relative h-20 flex mb-3"><div class="w-24 h-full bg-gray-200"><img src="${b.imageUrl}" class="w-full h-full object-cover"></div><div class="flex-1 p-3 flex flex-col justify-center"><h4 class="font-bold text-gray-800 text-xs">${b.title}</h4><p class="text-[10px] text-gray-400">Activo</p></div><button onclick="deleteBanner('${b.id}')" class="absolute top-2 right-2 text-rose-500 bg-white rounded-full p-1 shadow hover:bg-rose-50"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`;
                });
                list.innerHTML = html || '<p class="text-center text-xs text-gray-400 py-4">Sin banners activos</p>';
                lucide.createIcons();
            }
            if(window.bannerData && window.bannerData.length > 0) renderBannersAdmin();
            
                        // 8. LISTENER PARA RECLAMACIONES (Claims)
            let firstLoadClaims = true;
            onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'reports'), where('type', '==', 'claim')), (s) => {
                if(!firstLoadClaims) {
                    s.docChanges().forEach((change) => {
                        if (change.type === "added") {
                            try { window.playNotificationSound(); } catch(e){}
                            showToast('🎟️ Nueva Membresía Reclamada', 'info');
                        }
                    });
                }

                const list = document.getElementById('admin-claims-list');
                const badge = document.getElementById('claims-count-badge');
                const navBadge = document.getElementById('badge-claims');

                if(!list) return;
                
                let claimsList = [];
                s.forEach(doc => {
                    const r = doc.data();
                    r.id = doc.id;
                    if(!window.adminReportsCache) window.adminReportsCache = [];
                    const existingIdx = window.adminReportsCache.findIndex(x => x.id === r.id);
                    if(existingIdx >= 0) window.adminReportsCache[existingIdx] = r;
                    else window.adminReportsCache.push(r);
                    claimsList.push(r);
                });

                claimsList.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));

                let html = '';
                let pendingCount = 0;

                if (claimsList.length === 0) {
                    html = '<div class="text-center py-10 opacity-50"><p class="text-xs text-gray-400">No hay reclamaciones.</p></div>';
                } else {
                    claimsList.forEach(r => {
                        if(r.status === 'unread') pendingCount++;
                        let iconColor = 'text-gray-500';
                        let iconBg = 'bg-gray-100';
                        const sName = (r.serviceName || '').toLowerCase();
                        
                        if(sName.includes('canva')) { iconColor='text-purple-600'; iconBg='bg-purple-100'; }
                        else if(sName.includes('youtube')) { iconColor='text-red-600'; iconBg='bg-red-100'; }
                        else if(sName.includes('amazon')) { iconColor='text-cyan-600'; iconBg='bg-cyan-100'; }
                        else if(sName.includes('game')) { iconColor='text-emerald-600'; iconBg='bg-emerald-100'; }

                        let statusBadge = r.status === 'replied' 
                            ? `<span class="text-[9px] font-bold text-green-600 bg-green-100 px-2 py-0.5 rounded border border-green-200">ATENDIDO</span>`
                            : `<span class="text-[9px] font-bold text-rose-600 bg-rose-100 px-2 py-0.5 rounded border border-rose-200 animate-pulse">NUEVO</span>`;

                        html += `
                        <div onclick="openReportDetails('${r.id}')" class="neumo-card p-4 mb-3 cursor-pointer hover:bg-gray-50 transition-colors relative bg-white group">
                            <div class="flex items-start gap-3">
                                <div class="w-10 h-10 rounded-xl ${iconBg} flex items-center justify-center ${iconColor} neumo-inset flex-shrink-0">
                                    <i data-lucide="ticket" class="w-5 h-5"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex justify-between items-start mb-1">
                                        <h4 class="font-bold text-xs text-gray-800">${r.serviceName}</h4>
                                        ${statusBadge}
                                    </div>
                                    <p class="text-[10px] text-gray-400 mb-1 font-mono">${r.email}</p>
                                    <p class="text-xs text-gray-600 line-clamp-1 bg-gray-50 p-1 rounded border border-gray-100">
                                    ${r.description ? r.description.replace(/\n/g, ' ') : 'Ver detalles...'}
                                    </p>
                                </div>
                            </div>
                            <div class="mt-2 pt-2 border-t border-gray-100 flex justify-end gap-2">
                                <button onclick="event.stopPropagation(); deleteReport('${r.id}')" class="p-1.5 text-rose-400 hover:bg-rose-50 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                <button onclick="event.stopPropagation(); openReplyModal('${r.id}', '${r.uid}')" class="px-3 py-1.5 bg-gray-900 text-white text-[10px] font-bold rounded-lg hover:bg-black flex items-center gap-1 shadow-md">
                                    <i data-lucide="message-square" class="w-3 h-3"></i> Responder
                                </button>
                            </div>
                        </div>`;
                    });
                }

                list.innerHTML = html;
                if(badge) badge.textContent = `${pendingCount} Nuevas`;
                if(navBadge) {
                    if(pendingCount > 0) { navBadge.textContent = pendingCount; navBadge.classList.remove('hidden'); }
                    else { navBadge.classList.add('hidden'); }
                }
                lucide.createIcons();
                firstLoadClaims = false;
            });

                                    // 9. LISTENER DE DOCUMENTOS (SOLUCIÓN DEFINITIVA SIN BLOQUEOS)
            console.log("--> Iniciando carga de documentos...");
            const listDocs = document.getElementById('admin-documents-list');
            
            if (listDocs) {
                // IMPORTANTE: Quitamos 'orderBy' para evitar bloqueo por falta de índices
                const qDocs = query(collection(db, 'artifacts', appId, 'public', 'data', 'document_requests'));
                
                onSnapshot(qDocs, (snapshot) => {
                    const container = document.getElementById('admin-documents-list');
                    if (!container) return;

                    let docs = [];
                    snapshot.forEach(doc => {
                        docs.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // ORDENAMOS EN EL DISPOSITIVO (JavaScript)
                    // Esto evita que Firebase bloquee la petición
                    docs.sort((a, b) => {
                        const tA = a.timestamp ? a.timestamp.seconds : 0;
                        const tB = b.timestamp ? b.timestamp.seconds : 0;
                        return tB - tA; // Más reciente primero
                    });

                    console.log(`--> Documentos cargados: ${docs.length}`);

                    if (docs.length === 0) {
                        container.innerHTML = `
                            <div class="text-center py-10 opacity-50">
                                <p class="text-gray-400 text-sm">No hay solicitudes pendientes</p>
                            </div>`;
                        return; // Salimos si no hay datos
                    }

                    let html = '';
                    let pending = 0;

                    docs.forEach(d => {
                        if (d.status === 'pending') pending++;
                        
                        const isPending = d.status === 'pending';
                        const date = d.timestamp ? new Date(d.timestamp.seconds * 1000).toLocaleString() : 'Fecha desconocida';

                        html += `
                        <div class="neumo-card p-4 rounded-xl bg-white border border-gray-100 mb-3 relative">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h4 class="font-bold text-gray-800 text-sm">${d.serviceName || 'Documento'}</h4>
                                    <p class="text-[10px] text-gray-500">${d.buyerEmail || 'Usuario'}</p>
                                </div>
                                <span class="px-2 py-1 rounded text-[9px] font-bold ${isPending ? 'bg-amber-100 text-amber-600' : 'bg-green-100 text-green-600'}">
                                    ${isPending ? 'PENDIENTE' : 'ENVIADO'}
                                </span>
                            </div>

                            <div class="bg-gray-50 p-2 rounded border border-gray-200 mb-3 flex justify-between items-center">
                                <code class="text-xs font-mono font-bold text-gray-700">${d.curp || 'Sin Dato'}</code>
                                <button onclick="navigator.clipboard.writeText('${d.curp}').then(()=>showToast('Copiado'))" class="text-indigo-500 text-xs">
                                    <i data-lucide="copy" class="w-4 h-4"></i>
                                </button>
                            </div>

                            <div class="flex justify-between items-center pt-2 border-t border-gray-100">
                                <span class="text-[10px] text-gray-400">${date}</span>
                                ${isPending ? `
                                <button onclick="window.adminDeliverDocument('${d.id}', '${d.serviceName}', '${d.uid}')" class="bg-indigo-600 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold shadow hover:bg-indigo-700 flex items-center gap-1">
                                    <i data-lucide="send" class="w-3 h-3"></i> Entregar
                                </button>` : `
                                <span class="text-gray-400 text-[10px] flex items-center gap-1"><i data-lucide="check" class="w-3 h-3"></i> Listo</span>
                                `}
                            </div>
                        </div>`;
                    });

                    container.innerHTML = html;
                    lucide.createIcons();
                    
                    // Actualizar Badge en Menú
                    const badge = document.getElementById('badge-docs-admin');
                    if(badge) {
                        badge.innerText = pending;
                        badge.classList.toggle('hidden', pending === 0);
                    }

                }, (error) => {
                    console.error("Error Firestore:", error);
                    if(listDocs) listDocs.innerHTML = `<p class="text-red-500 text-center text-xs">Error: ${error.message}</p>`;
                });
            }

        }



                // ======================================================
        // BLOQUE NUEVO: INVENTARIO DINÁMICO
        // ======================================================

        // 1. Abrir Modal de Inventario (ACTUALIZADO CON FOLIO)
        window.openAddInventoryModal = async () => {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'profiles')); 
            const querySnapshot = await getDocs(q);
            
            const groupedProducts = {};
            querySnapshot.forEach((doc) => { 
                const data = doc.data(); 
                const cat = data.category || 'otros';
                if (!groupedProducts[cat]) groupedProducts[cat] = [];
                // Guardamos category para leerla luego
                groupedProducts[cat].push({ id: doc.id, name: data.name, category: cat });
            });

            let options = '<option value="" data-category="">Selecciona un Artículo...</option>';
            const sortedCategories = Object.keys(groupedProducts).sort();

            sortedCategories.forEach(categoryName => {
                const displayTitle = categoryName.charAt(0).toUpperCase() + categoryName.slice(1).replace(/-/g, ' ');
                options += `<optgroup label="${displayTitle}">`;
                const productsInCat = groupedProducts[categoryName].sort((a, b) => a.name.localeCompare(b.name));
                productsInCat.forEach(prod => {
                    options += `<option value="${prod.id}" data-category="${prod.category}" data-name="${prod.name}">${prod.name}</option>`;
                });
                options += `</optgroup>`;
            });

            // HTML con TODOS los campos ocultos (hidden)
            openModal(`
                <div class="text-left bounce-enter">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Agregar al Inventario</h3>
                    <form onsubmit="saveInventoryItem(event)" class="space-y-3">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 uppercase">Artículo</label>
                            <select id="inv-product-select" onchange="toggleInventoryFields()" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm" required>
                                ${options}
                            </select>
                        </div>

                        <div id="dynamic-fields-container" class="space-y-3 pt-2">
                            
                            <div id="group-email-pass" class="grid grid-cols-2 gap-2 hidden">
                                <div id="field-email" class="hidden"><label class="block text-[10px] font-bold text-gray-400 uppercase">Correo</label><input type="text" id="inv-email" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm"></div>
                                <div id="field-password" class="hidden"><label class="block text-[10px] font-bold text-gray-400 uppercase">Contraseña</label><input type="text" id="inv-pass" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm"></div>
                            </div>

                            <div id="group-profile-pin" class="grid grid-cols-2 gap-2 hidden">
                                <div id="field-profileName" class="hidden"><label class="block text-[10px] font-bold text-gray-400 uppercase">Nombre Perfil</label><input type="text" id="inv-profile-name" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm"></div>
                                <div id="field-pin" class="hidden"><label class="block text-[10px] font-bold text-gray-400 uppercase">PIN</label><input type="text" id="inv-pin" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm"></div>
                            </div>

                            <div id="field-link" class="hidden">
                                <label class="block text-[10px] font-bold text-gray-400 uppercase">Link / Enlace</label>
                                <input type="url" id="inv-link" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm" placeholder="https://...">
                            </div>
                            
                            <div id="field-folio" class="hidden">
                                <label class="block text-[10px] font-bold text-gray-400 uppercase">Folio / ID Interno</label>
                                <input type="text" id="inv-folio" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm" placeholder="Ej: #12345">
                            </div>

                            <div id="group-dates" class="grid grid-cols-2 gap-2 hidden">
                                <div id="field-expiryDate" class="hidden"><label class="block text-[10px] font-bold text-gray-400 uppercase">Expiración</label><input type="date" id="inv-expiry" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm"></div>
                                <div id="field-duration" class="hidden"><label class="block text-[10px] font-bold text-gray-400 uppercase">Duración</label><select id="inv-duration" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm"><option>1 Mes</option><option>3 Meses</option><option>6 Meses</option><option>1 Año</option><option>Permanente</option></select></div>
                            </div>

                            <div id="field-description" class="hidden">
                                <label class="block text-[10px] font-bold text-accent uppercase">Descripción / Código</label>
                                <textarea id="inv-description" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm h-20 resize-none" placeholder="Ingresa detalles, código o instrucciones"></textarea>
                            </div>
                            
                            <div id="field-terms" class="hidden">
                                <label class="block text-[10px] font-bold text-gray-400 uppercase">Términos y Condiciones</label>
                                <textarea id="inv-terms" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm h-16 resize-none"></textarea>
                            </div>
                        </div>

                        <button type="submit" class="neumo-button w-full bg-indigo-600 text-white font-bold py-3 rounded-xl mt-2 hover:bg-indigo-700">Guardar Item</button>
                    </form>
                </div>
            `);
        };


        // 2. Función lógica que muestra/oculta campos según la categoría
        window.toggleInventoryFields = () => {
            const select = document.getElementById('inv-product-select');
            const selectedOption = select.options[select.selectedIndex];
            if (!selectedOption) return;

            const categorySlug = selectedOption.getAttribute('data-category');
            
            // Buscamos configuración en memoria
            const categoryConfig = window.categoriesCache.find(c => c.slug === categorySlug);
            const fieldsToShow = (categoryConfig && categoryConfig.fields) ? categoryConfig.fields : ['email', 'password'];

            // Ocultar TODO primero (AGREGADO 'folio')
            const allFieldIds = ['email', 'password', 'profileName', 'pin', 'link', 'expiryDate', 'duration', 'description', 'terms', 'folio'];
            allFieldIds.forEach(fid => {
                const el = document.getElementById(`field-${fid}`);
                if(el) el.classList.add('hidden');
            });
            
            document.getElementById('group-email-pass').classList.add('hidden');
            document.getElementById('group-profile-pin').classList.add('hidden');
            document.getElementById('group-dates').classList.add('hidden');

            // Mostrar SOLO lo configurado
            fieldsToShow.forEach(fid => {
                const el = document.getElementById(`field-${fid}`);
                if(el) el.classList.remove('hidden');
            });

            // Lógica visual de grupos
            const showEmail = fieldsToShow.includes('email');
            const showPass = fieldsToShow.includes('password');
            if(showEmail || showPass) {
                const grp = document.getElementById('group-email-pass');
                grp.classList.remove('hidden');
                grp.className = (showEmail && showPass) ? "grid grid-cols-2 gap-2" : "flex flex-col gap-2";
            }

            const showProf = fieldsToShow.includes('profileName');
            const showPin = fieldsToShow.includes('pin');
            if(showProf || showPin) {
                const grp = document.getElementById('group-profile-pin');
                grp.classList.remove('hidden');
                grp.className = (showProf && showPin) ? "grid grid-cols-2 gap-2" : "flex flex-col gap-2";
            }

            const showExp = fieldsToShow.includes('expiryDate');
            const showDur = fieldsToShow.includes('duration');
            if(showExp || showDur) {
                const grp = document.getElementById('group-dates');
                grp.classList.remove('hidden');
                grp.className = (showExp && showDur) ? "grid grid-cols-2 gap-2" : "flex flex-col gap-2";
            }
            
            lucide.createIcons();
        };


        // 3. Guardar Inventario
        window.saveInventoryItem = async (e) => { 
            e.preventDefault(); 
            try { 
                const select = document.getElementById('inv-product-select'); 
                const productId = select.value; 
                const productName = select.options[select.selectedIndex].text; 
                const rawCategory = select.options[select.selectedIndex].getAttribute('data-category');

                let itemData = {
                    productId, 
                    serviceName: productName,
                    category: rawCategory, 
                    createdAt: serverTimestamp(), 
                    status: 'available'
                };

                // Helper para leer valor solo si está visible
                const val = (id) => {
                    const el = document.getElementById(id);
                    if(el && !el.closest('div[id^="field-"]').classList.contains('hidden')) {
                        return el.value;
                    }
                    return null;
                };

                itemData.email = val('inv-email');
                itemData.password = val('inv-pass');
                itemData.profileName = val('inv-profile-name');
                itemData.pin = val('inv-pin');
                itemData.link = val('inv-link');
                itemData.folio = val('inv-folio'); // <--- AQUÍ GUARDAMOS EL FOLIO
                itemData.expiryDate = val('inv-expiry');
                itemData.duration = val('inv-duration');
                itemData.description = val('inv-description');
                itemData.terms = val('inv-terms');

                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'inventory_items'), itemData); 
                
                const productRef = doc(db, 'artifacts', appId, 'public', 'data', 'profiles', productId); 
                await updateDoc(productRef, { stock: increment(1) }); 
                
                showToast('Item agregado correctamente', 'success'); 
                closeModal(); 
            } catch(e) { 
                console.error(e);
                showToast('Error al guardar: ' + e.message, 'error'); 
            } 
        };


        window.deleteInventoryItem = async (id) => { 
            if(confirm("¿Borrar? Reducirá el stock.")) { 
                const itemRef = doc(db, 'artifacts', appId, 'public', 'data', 'inventory_items', id); 
                const s = await getDoc(itemRef); 
                if (s.exists()) { 
                    await deleteDoc(itemRef); 
                    if (s.data().status === 'available') {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'profiles', s.data().productId), { stock: increment(-1) }); 
                    }
                    showToast('Eliminado', 'success'); 
                } 
            } 
        };

                window.openEditInventoryModal = (id) => {
            const item = window.inventoryCache.find(i => i.id === id);
            if (!item) return showToast('Item no encontrado', 'error');

            const durations = ["1 Mes", "3 Meses", "6 Meses", "1 Año", "Permanente"];
            const durationOptions = durations.map(d => `<option value="${d}" ${d === item.duration ? 'selected' : ''}>${d}</option>`).join('');
            
            const cat = (item.category || '').toLowerCase();
            const sName = (item.serviceName || '').toLowerCase();

            // Detectar si es tipo descripción (Game Pass o Liberación)
            const isDescType = (cat === 'game pass' || cat.includes('liberacion') || cat.includes('liberación') || sName.includes('liberacion') || sName.includes('liberación'));

            let profileFields = '';
            if (item.profileName !== undefined || item.pin !== undefined) {
                profileFields = `
                    <div class="grid grid-cols-2 gap-2">
                        <div><label class="block text-[10px] font-bold text-gray-400 uppercase">Nombre Perfil</label><input type="text" id="e-inv-profile-name" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm" value="${item.profileName || ''}"></div>
                        <div><label class="block text-[10px] font-bold text-gray-400 uppercase">PIN</label><input type="text" id="e-inv-pin" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm" value="${item.pin || ''}"></div>
                    </div>`;
            }

            openModal(`
                <div class="text-left bounce-enter"><h3 class="text-lg font-bold text-gray-800 mb-4">Editar Item</h3>
                <form onsubmit="updateInventoryItem(event, '${id}', '${item.category}', '${item.serviceName}')" class="space-y-3">
                    <div class="neumo-card neumo-inset p-2 rounded-lg"><label class="block text-[10px] font-bold text-gray-400 uppercase">Artículo</label><p class="font-bold text-sm text-gray-700">${item.serviceName}</p></div>
                    
                    ${isDescType ? 
                        `<div><label class="block text-[10px] font-bold text-accent uppercase">Descripción / Código</label><textarea id="e-inv-desc" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm h-16 resize-none">${item.description || ''}</textarea></div>`
                        :
                        `<div class="grid grid-cols-2 gap-2">
                            <div><label class="block text-[10px] font-bold text-gray-400 uppercase">Correo / Link</label><input type="text" id="e-inv-email" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm" value="${item.email || item.link || ''}" required></div>
                            <div><label class="block text-[10px] font-bold text-gray-400 uppercase">Contraseña</label><input type="text" id="e-inv-pass" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm" value="${item.password || ''}" required></div>
                        </div>
                        ${profileFields}
                        <div class="grid grid-cols-2 gap-2">
                            <div><label class="block text-[10px] font-bold text-gray-400 uppercase">Expiración</label><input type="date" id="e-inv-expiry" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm" value="${item.expiryDate || ''}"></div>
                            <div><label class="block text-[10px] font-bold text-gray-400 uppercase">Duración</label><select id="e-inv-duration" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm">${durationOptions}</select></div>
                        </div>`
                    }
                    
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 uppercase">Folio</label>
                        <input type="text" id="e-inv-folio" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm" value="${item.folio || ''}">
                    </div>

                    ${!isDescType ? `<div><label class="block text-[10px] font-bold text-gray-400 uppercase">Términos</label><textarea id="e-inv-terms" class="neumo-inset w-full bg-transparent border-none rounded-lg p-2 text-sm h-16 resize-none">${item.terms || ''}</textarea></div>` : ''}
                    
                    <button type="submit" class="neumo-button w-full bg-indigo-600 text-white font-bold py-3 rounded-xl mt-2 hover:bg-indigo-700">Guardar Cambios</button>
                </form></div>
            `);
            lucide.createIcons();
        };

                window.updateInventoryItem = async (e, id, rawCategory, sName) => {
            e.preventDefault();
            const updateData = {};
            const cat = (rawCategory || '').toLowerCase();
            const name = (sName || '').toLowerCase();
            
            // Capturamos siempre el folio
            updateData.folio = document.getElementById('e-inv-folio').value;

            // Validamos si es tipo descripción
            if (cat === 'game pass' || cat.includes('liberacion') || cat.includes('liberación') || name.includes('liberacion') || name.includes('liberación')) {
                const descElement = document.getElementById('e-inv-desc');
                if(descElement) {
                    updateData.description = descElement.value;
                }
            } else {
                const val = document.getElementById('e-inv-email').value;
                const isLink = val.includes('http');
                
                updateData.email = !isLink ? val : null;
                updateData.link = isLink ? val : null;
                updateData.password = document.getElementById('e-inv-pass').value;
                updateData.expiryDate = document.getElementById('e-inv-expiry').value;
                updateData.duration = document.getElementById('e-inv-duration').value;
                updateData.terms = document.getElementById('e-inv-terms').value;

                if (document.getElementById('e-inv-profile-name') && document.getElementById('e-inv-pin')) {
                    updateData.profileName = document.getElementById('e-inv-profile-name').value;
                    updateData.pin = document.getElementById('e-inv-pin').value;
                }
            }

            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'inventory_items', id), updateData);
                showToast('Item actualizado', 'success');
                closeModal();
            } catch(e) {
                console.error(e);
                showToast('Error al actualizar item', 'error');
            }
        };

        // --- FUNCIONES DE RENOVACIÓN DE ADMIN ---
        window.viewRenewalDetail = (id) => {
            const r = window.adminPendingRenewals.find(x => x.id === id) || window.adminReportsCache.find(x => x.id === id);
            if(!r) return showToast('Solicitud no encontrada', 'error');
            
            openModal(`
                <div class="text-left bounce-enter"><h3 class="font-bold text-gray-800 text-lg">Detalle de Renovación</h3>
                <p class="text-xs text-gray-500 mb-4">${r.email}</p>
                <div class="neumo-card neumo-inset p-4 rounded-xl text-sm space-y-2">
                    <p class="font-bold text-gray-700">Descripción:</p>
                    <p class="text-xs text-gray-600 whitespace-pre-wrap">${r.description}</p>
                    ${r.evidenceImage ? `<p class="mt-3 text-xs font-bold text-gray-400">Evidencia:</p><img src="${r.evidenceImage}" class="mt-1 w-full rounded-lg border border-gray-200">` : ''}
                </div>
                <div class="flex gap-2 mt-4">
                    <button onclick="approveRenewal('${r.id}', '${r.uid}')" class="neumo-button flex-1 bg-success text-white py-2 rounded-lg font-bold">Aprobar</button>
                    <button onclick="rejectRenewal('${r.id}')" class="neumo-button flex-1 bg-danger text-white py-2 rounded-lg font-bold">Rechazar</button>
                </div></div>
            `);
        };

        window.approveRenewal = async (id, uid) => {
            if(!confirm("¿Confirmar renovación?")) return;
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reports', id), { 
                    status: 'resolved', 
                    adminReply: 'Renovación APROBADA.',
                    resolvedAt: serverTimestamp() 
                });
                await addDoc(collection(db, 'artifacts', appId, 'users', uid, 'transactions'), { 
                    type: 'support_reply', 
                    amount: 0, 
                    description: 'Renovación Aprobada', 
                    message: 'Su solicitud de renovación ha sido **APROBADA**.', 
                    timestamp: serverTimestamp() 
                });
                showToast('Renovación aprobada', 'success');
                closeModal();
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
            }
        };

        window.rejectRenewal = async (id) => {
            if(!confirm("¿Rechazar solicitud?")) return;
            try {
                const r = window.adminPendingRenewals.find(x => x.id === id);
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reports', id), { 
                    status: 'rejected', 
                    adminReply: 'Renovación RECHAZADA.',
                    rejectedAt: serverTimestamp() 
                });
                 await addDoc(collection(db, 'artifacts', appId, 'users', r.uid, 'transactions'), { 
                    type: 'support_reply', 
                    amount: 0, 
                    description: 'Renovación Rechazada', 
                    message: 'Su solicitud de renovación ha sido **RECHAZADA**.', 
                    timestamp: serverTimestamp() 
                });
                showToast('Renovación rechazada', 'info');
                closeModal();
            } catch (e) {
                showToast('Error', 'error');
            }
        };

                 // ======================================================
        // 1. NUEVO: MENÚ DE SELECCIÓN DE REPORTE (Paso 1)
        // ======================================================
        window.openReportModal = () => {
            openModal(`
            <div class="text-center bounce-enter pt-4">
                <div class="w-16 h-16 bg-rose-100 text-rose-500 rounded-full flex items-center justify-center mx-auto mb-4 neumo-card neumo-inset">
                    <i data-lucide="life-buoy" class="w-8 h-8"></i>
                </div>
                <h3 class="text-xl font-black text-gray-800 mb-2">Centro de Ayuda</h3>
                <p class="text-xs text-gray-400 mb-6">Selecciona el tipo de problema</p>
                
                <div class="space-y-3 text-left">
                    
                    <button onclick="openReportForm('account')" class="w-full bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex items-center gap-4 hover:border-indigo-200 hover:shadow-md transition-all group">
                        <div class="w-12 h-12 rounded-xl bg-indigo-50 text-indigo-600 flex items-center justify-center group-hover:scale-110 transition-transform">
                            <i data-lucide="user-x" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 text-sm">Fallo de Cuenta / Contraseña</h4>
                            <p class="text-[10px] text-gray-400">No puedo acceder, clave incorrecta...</p>
                        </div>
                        <i data-lucide="chevron-right" class="w-5 h-5 text-gray-300 ml-auto group-hover:text-indigo-400"></i>
                    </button>

                    <button onclick="openReportForm('payment')" class="w-full bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex items-center gap-4 hover:border-emerald-200 hover:shadow-md transition-all group">
                        <div class="w-12 h-12 rounded-xl bg-emerald-50 text-emerald-600 flex items-center justify-center group-hover:scale-110 transition-transform">
                            <i data-lucide="credit-card" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 text-sm">Pago no Reflejado</h4>
                            <p class="text-[10px] text-gray-400">Hice transferencia y no tengo saldo...</p>
                        </div>
                        <i data-lucide="chevron-right" class="w-5 h-5 text-gray-300 ml-auto group-hover:text-emerald-400"></i>
                    </button>

                    <button onclick="openReportForm('bug')" class="w-full bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex items-center gap-4 hover:border-amber-200 hover:shadow-md transition-all group">
                        <div class="w-12 h-12 rounded-xl bg-amber-50 text-amber-600 flex items-center justify-center group-hover:scale-110 transition-transform">
                            <i data-lucide="alert-triangle" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 text-sm">Error de la App / Sistema</h4>
                            <p class="text-[10px] text-gray-400">Algo no funciona bien...</p>
                        </div>
                        <i data-lucide="chevron-right" class="w-5 h-5 text-gray-300 ml-auto group-hover:text-amber-400"></i>
                    </button>

                </div>
                
                <button onclick="closeModal()" class="mt-6 text-xs font-bold text-gray-400 hover:text-gray-600">Cancelar</button>
            </div>
            `);
            lucide.createIcons();
        };

   // 2. FORMULARIO MODIFICADO (Con botón de ayuda y validación visual)
window.openReportForm = (selectedType) => { 
    localStorage.removeItem('report_evidence'); 
    
    const services = ["Crunchyroll", "Disney", "Max", "Netflix", "Paramount", "Prime Video", "Universal", "Vix", "IPTV", "YouTube", "Spotify", "Tidal", "Deezer", "Amazon Music", "Game Pass"];
    const servicesOptions = services.map(s => `<option value="${s}">${s}</option>`).join('');

    let title = "Reportar Fallo";
    let subtitle = "Completa los detalles";
    
    if(selectedType === 'account') { title = "Fallo de Cuenta"; subtitle = "Problemas de acceso o contraseña"; }
    if(selectedType === 'payment') { title = "Pago no Reflejado"; subtitle = "Adjunta tu comprobante"; }
    if(selectedType === 'bug') { title = "Reportar Error"; subtitle = "Fallo del sistema"; }

    openModal(`
    <div class="text-left bounce-enter bg-white rounded-3xl overflow-hidden relative">
        
        <div class="bg-gray-900 p-6 pb-8 text-center relative">
            <button onclick="openReportModal()" class="absolute top-4 left-4 text-white/50 hover:text-white transition-colors"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
            <h3 class="text-xl font-black text-white uppercase tracking-wider relative z-10">${title}</h3>
            <p class="text-xs text-white/60 font-medium relative z-10">${subtitle}</p>
        </div>

        <form onsubmit="submitReport(event)" class="px-6 py-6 space-y-5 -mt-4 bg-white rounded-t-3xl relative z-20">
            
            <div class="hidden">
                <select id="report-type">
                    <option value="${selectedType}" selected>${selectedType}</option>
                </select>
            </div>

            <div id="account-failure-section" class="space-y-4 bg-indigo-50/50 p-4 rounded-2xl border border-indigo-100 ${selectedType === 'account' ? '' : 'hidden'}">
                <div class="flex items-center gap-2 mb-1">
                    <i data-lucide="search" class="w-4 h-4 text-indigo-500"></i>
                    <span class="text-xs font-black text-indigo-600 uppercase">Buscar Compra Afectada</span>
                </div>

                <div class="grid grid-cols-1 gap-3">
                    <div>
                        <select id="report-service" onchange="searchPurchasesForReport()" class="w-full bg-white border-none rounded-xl p-3 text-xs font-bold text-gray-600 shadow-sm focus:ring-0">
                            ${servicesOptions}
                        </select>
                    </div>
                    
                    <div class="relative">
                        <input type="email" id="search-account-email" oninput="searchPurchasesForReport()" class="w-full bg-white border-none rounded-xl py-3 pl-4 pr-10 text-sm shadow-sm placeholder:text-gray-400 focus:ring-0" placeholder="Correo de la cuenta...">
                        <div class="absolute right-3 top-3 text-indigo-200"><i data-lucide="at-sign" class="w-4 h-4"></i></div>
                    </div>
                </div>

                <div id="purchase-results-container" class="space-y-2 max-h-48 overflow-y-auto scrollbar-hide empty:hidden pt-1"></div>
                
                <div>
                    <div class="flex justify-between items-end mb-1 ml-1">
                        <label class="block text-[10px] font-bold text-indigo-400 uppercase">Ticket <span class="text-rose-500 text-lg leading-none">*</span></label>
                        <button type="button" onclick="openTicketHelpModal()" class="text-[9px] font-bold text-white bg-indigo-400 hover:bg-indigo-600 px-2 py-1 rounded-lg flex items-center gap-1 transition-colors shadow-sm">
                            <i data-lucide="help-circle" class="w-3 h-3"></i> ¿Qué poner?
                        </button>
                    </div>
                    <textarea id="report-manual-ticket" class="w-full bg-white border border-indigo-100 rounded-xl p-3 text-xs font-mono shadow-sm placeholder:text-gray-400 focus:ring-0 focus:border-indigo-400 resize-none h-24" placeholder="Pega aquí el ticket completo de tu compra..."></textarea>
                </div>

                <input type="hidden" id="selected-tx-id" ${selectedType === 'account' ? 'required' : ''}>
            </div>

            <div>
                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1 ml-1">Detalles del problema</label>
                <textarea id="report-desc" required class="w-full bg-gray-50 border border-gray-200 rounded-xl p-4 text-sm focus:outline-none focus:border-gray-400 transition-colors h-28 resize-none" placeholder="Explícanos brevemente qué paso..."></textarea>
            </div>

            <div>
                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1 ml-1">Evidencia (Opcional)</label>
                <label class="flex flex-col items-center justify-center w-full h-24 border-2 border-dashed border-gray-300 rounded-2xl cursor-pointer hover:bg-gray-50 hover:border-indigo-400 transition-all group relative overflow-hidden">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6 relative z-10" id="upload-placeholder">
                        <i data-lucide="image-plus" class="w-6 h-6 text-gray-300 group-hover:text-indigo-500 mb-1 transition-colors"></i>
                        <p class="text-[10px] text-gray-400 group-hover:text-gray-600">Toca para subir imagen</p>
                    </div>
                    <div id="file-name-display" class="hidden flex-col items-center justify-center z-20">
                        <i data-lucide="check-circle" class="w-6 h-6 text-emerald-500 mb-1"></i>
                        <p class="text-[10px] font-bold text-emerald-600 truncate max-w-[200px]" id="file-name-text"></p>
                    </div>
                    <input type="file" accept="image/*" onchange="handleImageUploadUI(this)" class="hidden">
                </label>
            </div>

            <button type="submit" id="btn-submit-report" class="w-full bg-gray-900 text-white font-bold py-4 rounded-xl shadow-xl hover:bg-gray-800 transform active:scale-95 transition-all flex items-center justify-center gap-2">
                <span>Enviar Reporte</span>
                <i data-lucide="send" class="w-4 h-4"></i>
            </button>
        </form>
    </div>`);
    
    // Validar estado inicial del botón
    if(selectedType === 'account') {
        const btn = document.getElementById('btn-submit-report');
        // Lo dejamos habilitado visualmente para que el usuario pueda hacer clic y recibir la alerta si falta el ticket
        btn.disabled = false; 
    }
    
    lucide.createIcons();
};




        
                // Función UI para actualizar el input de archivo
        window.handleImageUploadUI = (input) => {
            handleImageUpload(input); // Llama a tu función original de lógica
            
            const placeholder = document.getElementById('upload-placeholder');
            const nameDisplay = document.getElementById('file-name-display');
            const nameText = document.getElementById('file-name-text');
            
            if (input.files && input.files[0]) {
                placeholder.classList.add('hidden');
                nameDisplay.classList.remove('hidden');
                nameDisplay.classList.add('flex');
                nameText.textContent = input.files[0].name;
            } else {
                placeholder.classList.remove('hidden');
                nameDisplay.classList.add('hidden');
                nameDisplay.classList.remove('flex');
            }
            lucide.createIcons();
        };

        
                        // ======================================================
        // BLOQUE NUEVO: LÓGICA DE BÚSQUEDA (CON BLOQUEO DE BOTÓN)
        // ======================================================

        window.toggleReportFields = () => {
            const type = document.getElementById('report-type').value;
            const section = document.getElementById('account-failure-section');
            const txInput = document.getElementById('selected-tx-id');
            const btn = document.getElementById('btn-submit-report');

            if (type === 'account') {
                section.classList.remove('hidden');
                txInput.setAttribute('required', 'true');
                
                // Si estamos en 'Fallo de Cuenta' y no hay ID seleccionado, BLOQUEAMOS el botón
                if(!txInput.value) {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            } else {
                section.classList.add('hidden');
                txInput.removeAttribute('required');
                txInput.value = ''; 
                
                // En otros casos (Pago/Bug), el botón siempre está activo
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        };

                   window.searchPurchasesForReport = () => {
            const queryEmail = document.getElementById('search-account-email').value.trim().toLowerCase();
            const selectedPlatform = document.getElementById('report-service').value.toLowerCase();
            const container = document.getElementById('purchase-results-container');
            const hiddenInput = document.getElementById('selected-tx-id');
            const btn = document.getElementById('btn-submit-report');

            // Resetear
            hiddenInput.value = '';
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            
            if (queryEmail.length < 3) {
                container.innerHTML = '';
                return;
            }

            // Filtramos las coincidencias
            const matches = window.userTransactions.filter(t => {
                if (t.type !== 'purchase' || !t.details || !t.details.email) return false;
                const tEmail = t.details.email.toLowerCase();
                const tService = (t.details.serviceName || '').toLowerCase();
                
                // Permitimos coincidencia parcial en el servicio o email
                return tEmail.includes(queryEmail) && tService.includes(selectedPlatform);
            });

            if (matches.length === 0) {
                container.innerHTML = `<div class="p-3 bg-white text-rose-500 text-[10px] font-bold rounded-xl text-center border border-rose-100 shadow-sm">No encontramos cuentas de <b class="uppercase">${selectedPlatform}</b> que coincidan con ese correo.</div>`;
                return;
            }

            let html = '';
            matches.forEach(m => {
                const service = m.details.serviceName || 'Servicio';
                const date = m.timestamp ? m.timestamp.toDate().toLocaleDateString() : '';
                const pName = m.details.profileName;

                // --- LÓGICA DE PERFIL vs COMPLETA ---
                let profileBadge = '';
                
                // Verificamos si existe nombre de perfil y no es nulo/vacío
                if (pName && pName.trim() !== '' && pName !== 'null' && pName !== 'undefined') {
                    // ES PERFIL: Mostramos P1, P2, Juan, etc.
                    profileBadge = `<span class="ml-1 text-[9px] font-black text-indigo-600 bg-indigo-50 px-1.5 py-0.5 rounded border border-indigo-100 whitespace-nowrap"><i data-lucide="user" class="w-2 h-2 inline mb-0.5"></i> ${pName}</span>`;
                } else {
                    // ES CUENTA COMPLETA
                    profileBadge = `<span class="ml-1 text-[9px] font-black text-purple-600 bg-purple-50 px-1.5 py-0.5 rounded border border-purple-100 whitespace-nowrap"><i data-lucide="star" class="w-2 h-2 inline mb-0.5"></i> Completa</span>`;
                }
                // ------------------------------------

                html += `
                <div onclick="selectPurchaseForReport('${m.id}', this)" class="purchase-option bg-white p-3 rounded-xl cursor-pointer border-2 border-transparent hover:border-indigo-200 shadow-sm transition-all relative group mb-2">
                    <div class="flex justify-between items-center pointer-events-none">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="w-9 h-9 flex-shrink-0 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center font-bold text-xs group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                                ${service.substring(0,1)}
                            </div>
                            <div class="min-w-0">
                                <div class="flex items-center flex-wrap gap-1">
                                    <p class="font-bold text-gray-800 text-xs truncate">${service}</p>
                                    ${profileBadge}
                                </div>
                                <p class="text-[10px] text-gray-400 font-mono truncate">${m.details.email}</p>
                            </div>
                        </div>
                        <span class="text-[9px] bg-gray-100 px-2 py-1 rounded-lg text-gray-500 font-bold ml-2 whitespace-nowrap">${date}</span>
                    </div>
                    <div class="absolute top-1/2 right-3 -translate-y-1/2 text-indigo-600 opacity-0 check-icon transition-opacity">
                        <i data-lucide="check-circle-2" class="w-5 h-5"></i>
                    </div>
                </div>`;
            });

            container.innerHTML = html;
            lucide.createIcons();
        };


           window.selectPurchaseForReport = (txId, element) => {
            // 1. Guardar el ID
            document.getElementById('selected-tx-id').value = txId;
            const btn = document.getElementById('btn-submit-report');

            // 2. Limpiar estilos anteriores
            document.querySelectorAll('.purchase-option').forEach(el => {
                el.classList.remove('border-indigo-500', 'bg-indigo-50');
                el.classList.add('bg-white', 'border-transparent');
                el.querySelector('.check-icon').classList.add('opacity-0');
            });

            // 3. Aplicar estilo seleccionado
            element.classList.remove('bg-white', 'border-transparent');
            element.classList.add('bg-indigo-50', 'border-indigo-500');
            element.querySelector('.check-icon').classList.remove('opacity-0');

            // 4. Activar botón
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
        };



                // ======================================================
        // CORRECCIÓN: COMPRESIÓN DE IMAGEN PARA EVITAR ERROR FIRESTORE
        // ======================================================
        window.handleImageUpload = (input) => {
            const file = input.files[0];
            if (!file) return;

            // 1. Lector de archivo
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    // 2. Crear un canvas para redimensionar
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    // 3. Redimensionar si es mayor a 800px (Suficiente para reportes)
                    const MAX_WIDTH = 800;
                    const MAX_HEIGHT = 800;

                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width *= MAX_HEIGHT / height;
                            height = MAX_HEIGHT;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // 4. Convertir a JPEG con calidad 0.7 (Reduce drásticamente el peso)
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);

                    // 5. Verificación de seguridad (Firestore límite ~1MB)
                    // Base64 string length * 0.75 ~= size in bytes
                    const sizeInBytes = dataUrl.length * 0.75;
                    
                    if (sizeInBytes > 950000) { // Si aun comprimida pesa mas de 950KB
                         showToast('La imagen es demasiado compleja, intenta con otra.', 'error');
                         input.value = ""; // Limpiar input
                         localStorage.removeItem('report_evidence');
                    } else {
                        // Guardar la versión comprimida
                        localStorage.setItem('report_evidence', dataUrl);
                        // Opcional: Avisar al usuario que la foto está lista
                        // showToast('Foto adjuntada y comprimida.', 'success'); 
                    }
                };
                img.onerror = () => {
                    showToast('Error al procesar la imagen.', 'error');
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        };

             // 2. ENVIAR REPORTE (Con validación de Ticket Obligatorio)
window.submitReport = async (e) => { 
    e.preventDefault(); 
    
    const type = document.getElementById('report-type').value;
    const desc = document.getElementById('report-desc').value;
    const evidence = localStorage.getItem('report_evidence');
    const btn = document.getElementById('btn-submit-report');
    
    let extraData = {};

    if (type === 'account') {
        const txId = document.getElementById('selected-tx-id').value;
        const service = document.getElementById('report-service').value;
        const accountEmail = document.getElementById('search-account-email').value;
        const manualTicket = document.getElementById('report-manual-ticket').value;

        // --- VALIDACIÓN 1: SELECCIONAR COMPRA DE LA LISTA ---
        if (!txId) {
            showToast('⚠️ Debes buscar y seleccionar una compra de la lista.', 'error');
            return;
        }

        // --- VALIDACIÓN 2: CAMPO TICKET OBLIGATORIO ---
        if (!manualTicket || manualTicket.trim() === '') {
            showToast('Debe ingresar su ticket válido para continuar', 'error');
            // Hacemos focus en el campo para ayudar al usuario
            document.getElementById('report-manual-ticket').focus();
            return; // Detenemos la ejecución aquí
        }

        extraData = {
            relatedTransactionId: txId,
            serviceName: service,
            accountEmail: accountEmail,
            manualTicketData: manualTicket, 
            isAccountFailure: true
        };
    }

    // Si pasa las validaciones, procedemos
    if(btn) { btn.disabled = true; btn.innerText = "Enviando..."; }

    try {
        const reportData = { 
            uid: currentUser.uid, 
            email: currentUser.email, 
            type, 
            description: desc, 
            evidenceImage: evidence, 
            timestamp: serverTimestamp(), 
            status: 'unread',
            ...extraData 
        };

        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'reports'), reportData); 
        
        showToast('Reporte enviado correctamente', 'success'); 
        closeModal(); 

    } catch(err) {
        console.error(err);
        showToast('Error al enviar reporte', 'error');
        if(btn) { btn.disabled = false; btn.innerText = "Enviar Reporte"; }
    }
};

                   // ======================================================
        // 3. VISTA ADMIN (MUESTRA EL TEXTO DEL TICKET)
        // ======================================================
        window.openReportDetails = (id) => {
            const r = window.adminReportsCache.find(x => x.id === id);
            if(!r) return showToast('Reporte no encontrado', 'error');

            let extraInfoHtml = '';

            // --- RECLAMACIONES DE MEMBRESÍA ---
            if (r.type === 'claim' && r.claimData) {
                let rows = '';
                
                if(r.claimData.email) {
                    rows += `<div class="mb-2"><span class="text-[9px] font-bold text-gray-400 uppercase block">Correo proporcionado</span><span class="text-sm font-bold text-gray-800 select-all font-mono bg-white px-2 py-1 rounded border border-indigo-100 inline-block">${r.claimData.email}</span></div>`;
                }
                if(r.claimData.password) {
                    rows += `<div class="mb-2"><span class="text-[9px] font-bold text-gray-400 uppercase block">Contraseña</span><span class="text-sm font-bold text-gray-800 select-all font-mono bg-white px-2 py-1 rounded border border-indigo-100 inline-block">${r.claimData.password}</span></div>`;
                }
                if(r.claimData.whatsapp) {
                    rows += `<div class="mb-2"><span class="text-[9px] font-bold text-gray-400 uppercase block">WhatsApp</span><span class="text-sm font-bold text-green-600 select-all font-mono bg-white px-2 py-1 rounded border border-green-100 inline-block">${r.claimData.whatsapp}</span> <a href="https://wa.me/${r.claimData.whatsapp}" target="_blank" class="text-green-500 text-[10px] underline ml-2 font-bold hover:text-green-700">Abrir Chat</a></div>`;
                }
                // --- NUEVO: VISUALIZACIÓN DE IMEI ---
                if(r.claimData.imei) {
                    rows += `<div class="mb-2"><span class="text-[9px] font-bold text-gray-400 uppercase block">IMEI / Serie</span><span class="text-lg font-black text-indigo-600 select-all font-mono bg-indigo-50 px-2 py-1 rounded border border-indigo-100 inline-block tracking-widest">${r.claimData.imei}</span></div>`;
                }

                extraInfoHtml = `
                <div class="bg-fuchsia-50 border border-fuchsia-100 p-4 rounded-xl mb-4 relative overflow-hidden shadow-sm">
                    <div class="absolute top-0 left-0 w-1 h-full bg-fuchsia-500"></div>
                    <h4 class="text-xs font-black text-fuchsia-600 uppercase mb-3 flex items-center gap-2">
                        <i data-lucide="ticket" class="w-4 h-4"></i> Datos de Membresía
                    </h4>
                    <div class="mb-2">
                        <span class="text-[9px] font-bold text-gray-400 uppercase block">Servicio Solicitado</span>
                        <span class="text-sm font-black text-gray-800 uppercase tracking-wide">${r.serviceName}</span>
                    </div>
                    ${rows}
                </div>`;
            }
            
            // --- SOPORTE O CUENTAS ---
            else if (r.type === 'account' || r.manualTicketData) {
                extraInfoHtml = `
                <div class="bg-indigo-50 border border-indigo-100 p-4 rounded-xl mb-4 relative overflow-hidden shadow-sm">
                    <div class="absolute top-0 left-0 w-1 h-full bg-indigo-500"></div>
                    <h4 class="text-xs font-black text-indigo-600 uppercase mb-3 flex items-center gap-2">
                        <i data-lucide="shield-alert" class="w-4 h-4"></i> Datos de la Cuenta
                    </h4>
                    ${r.serviceName ? `<div class="mb-2"><span class="text-[9px] font-bold text-gray-400 uppercase block">Servicio</span><span class="text-sm font-bold text-gray-800">${r.serviceName}</span></div>` : ''}
                    <div class="mb-2"><span class="text-[9px] font-bold text-gray-400 uppercase block">Correo de la Cuenta</span><div class="flex items-center gap-2"><span class="text-sm font-mono font-bold text-gray-800 bg-white px-2 py-1 rounded border border-indigo-100 select-all">${r.accountEmail || 'No especificado'}</span></div></div>
                    ${r.manualTicketData ? `<div><span class="text-[9px] font-bold text-gray-400 uppercase block">Ticket / Datos</span><div class="bg-white p-2 rounded-lg border border-indigo-100 text-xs text-gray-600 font-mono whitespace-pre-wrap select-all">${r.manualTicketData}</div></div>` : ''}
                </div>`;
            }

            openModal(`
                <div class="text-left bounce-enter flex flex-col h-[85vh]">
                    <div class="flex justify-between items-start mb-4 border-b border-gray-100 pb-2">
                        <div>
                            <h3 class="font-bold text-gray-800 text-xl">Detalle del Ticket</h3>
                            <p class="text-xs text-gray-400 flex items-center gap-1">
                                <i data-lucide="user" class="w-3 h-3"></i> ${r.email}
                            </p>
                        </div>
                        <span class="text-[10px] font-bold uppercase px-2 py-1 rounded bg-gray-100 text-gray-500 border border-gray-200">${r.type === 'claim' ? 'Reclamación' : 'Soporte'}</span>
                    </div>

                    <div class="flex-1 overflow-y-auto scrollbar-hide pr-1">
                        ${extraInfoHtml}
                        ${r.description ? `<div class="mb-4"><label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Texto Original</label><div class="neumo-card neumo-inset p-4 rounded-xl text-sm text-gray-700 whitespace-pre-wrap leading-relaxed border border-gray-100">${r.description}</div></div>` : ''}
                        ${r.evidenceImage ? `<div class="mb-4"><label class="block text-[10px] font-bold text-gray-400 uppercase mb-2">Evidencia</label><img src="${r.evidenceImage}" class="w-full rounded-xl border border-gray-200 shadow-sm cursor-pointer" onclick="window.open(this.src)"></div>` : ''}
                    </div>

                    <div class="pt-4 mt-2 border-t border-gray-100 bg-white z-10 flex gap-3">
                        <button onclick="deleteReport('${id}')" class="neumo-button w-12 flex items-center justify-center text-rose-400 hover:text-rose-600 hover:bg-rose-50 rounded-xl"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                        <button onclick="openReplyModal('${id}', '${r.uid}')" class="neumo-button flex-1 bg-gray-900 text-white py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 hover:bg-black"><i data-lucide="corner-up-left" class="w-4 h-4"></i> Responder</button>
                        <button onclick="closeModal()" class="neumo-button flex-1 bg-gray-100 text-gray-500 py-3 rounded-xl font-bold hover:bg-gray-200">Cerrar</button>
                    </div>
                </div>
            `);
            lucide.createIcons();
        };


                // ======================================================
        // BLOQUE NUEVO: RESPONDER CON FOTO (ADMIN)
        // ======================================================

  // ======================================================
// RESPONDER A USUARIO + GESTIÓN COMPLETA (REEMBOLSOS Y REEMPLAZOS)
// ======================================================
window.openReplyModal = async (rid, uid) => { 
    localStorage.removeItem('admin_reply_evidence');
    
    // Buscamos el reporte en caché
    const r = window.adminReportsCache.find(x => x.id === rid);
    let actionButtonsHTML = '';

    // Solo mostramos botones de acción si el reporte tiene una compra vinculada
    if (r && r.relatedTransactionId) {
        actionButtonsHTML = `
        <div class="mt-4 pt-4 border-t border-gray-100">
            <p class="text-[10px] font-bold text-gray-400 uppercase mb-3">Acciones Rápidas de Compra</p>
            
            <div class="grid grid-cols-2 gap-3 mb-3">
                <button onclick="checkRefundOptions('${rid}', 'full')" class="neumo-button bg-rose-50 text-rose-600 border border-rose-100 py-2 rounded-xl text-xs font-bold hover:bg-rose-100 transition-colors flex items-center justify-center gap-1">
                    <i data-lucide="refresh-ccw" class="w-3 h-3"></i> Reembolso Total
                </button>
                <button onclick="checkRefundOptions('${rid}', 'partial')" class="neumo-button bg-amber-50 text-amber-600 border border-amber-100 py-2 rounded-xl text-xs font-bold hover:bg-amber-100 transition-colors flex items-center justify-center gap-1">
                    <i data-lucide="pie-chart" class="w-3 h-3"></i> Reembolso Parcial
                </button>
            </div>

            <button onclick="showReplacementForm('${rid}', '${uid}')" class="w-full neumo-button bg-indigo-50 text-indigo-600 border border-indigo-100 py-2.5 rounded-xl text-xs font-bold hover:bg-indigo-100 transition-colors flex items-center justify-center gap-2">
                <i data-lucide="repeat" class="w-4 h-4"></i> 🔄 Remplazar Cuenta
            </button>
        </div>`;
    }
    
    openModal(`
    <div class="bounce-enter text-left">
        <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-3 neumo-card neumo-inset"><i data-lucide="reply" class="w-6 h-6"></i></div>
        <h3 class="font-bold text-gray-800 text-center text-lg mb-1">Gestionar Ticket</h3>
        <p class="text-xs text-gray-400 text-center mb-4">Ticket ID: ${rid.substring(0,6)}</p>
        
        <div id="normal-reply-area">
            <textarea id="rep-text" class="neumo-inset w-full border-none bg-transparent rounded-xl p-3 h-24 resize-none text-sm mb-3 focus:ring-0" placeholder="Escribe tu respuesta aquí..."></textarea>
            
            <div class="mb-4 bg-gray-50 p-3 rounded-xl border border-gray-100">
                <label class="block text-[10px] font-bold text-gray-400 uppercase mb-2 ml-1">Adjuntar Evidencia (Opcional)</label>
                <input type="file" accept="image/*" onchange="handleAdminReplyImage(this)" class="block w-full text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-xs file:font-bold file:bg-blue-600 file:text-white hover:file:bg-blue-700 transition-colors">
            </div>

            <button onclick="sendAdminReply('${rid}','${uid}')" class="neumo-button w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-2 hover:bg-blue-700 mt-2">
                <i data-lucide="send" class="w-4 h-4"></i> Enviar Respuesta
            </button>

            ${actionButtonsHTML}
        </div>

        <div id="replacement-form-container" class="hidden animate-in slide-in-from-bottom-4 fade-in duration-300"></div>
    </div>`);
    lucide.createIcons();
};


        window.handleAdminReplyImage = (input) => { 
            if (input.files[0]) { 
                const reader = new FileReader(); 
                reader.onload = (e) => localStorage.setItem('admin_reply_evidence', e.target.result); 
                reader.readAsDataURL(input.files[0]); 
            } 
        };

        // ==========================================
// ENVIAR RESPUESTA ADMIN (ACTUALIZADO)
// ==========================================
window.sendAdminReply = async (rid, uid) => { 
    const msg = document.getElementById('rep-text').value; 
    const img = localStorage.getItem('admin_reply_evidence'); 

    if(!msg && !img) return showToast('Escribe algo o adjunta una foto', 'error');

    const btn = document.querySelector('button[onclick^="sendAdminReply"]');
    btn.disabled = true; btn.innerHTML = "Enviando...";

    try {
        // 1. Obtener datos del reporte para saber qué servicio es (Netflix, etc.)
        const reportRef = doc(db, 'artifacts', appId, 'public', 'data', 'reports', rid);
        const reportSnap = await getDoc(reportRef);
        const reportData = reportSnap.exists() ? reportSnap.data() : {};
        const serviceName = reportData.serviceName || 'Soporte General';

        // 2. Actualizar el reporte
        await updateDoc(reportRef, { 
            status: 'replied', 
            adminReply: msg,
            adminEvidence: img 
        }); 
        
        // 3. Enviar notificación al usuario (INCLUYENDO EL NOMBRE DEL SERVICIO)
        await addDoc(collection(db, 'artifacts', appId, 'users', uid, 'transactions'), { 
            type: 'support_reply', 
            amount: 0, 
            description: 'Respuesta Soporte', 
            message: msg, 
            evidenceImage: img,
            timestamp: serverTimestamp(),
            // --- DATOS NUEVOS PARA IDENTIFICAR EL REPORTE ---
            reportServiceName: serviceName, 
            relatedReportId: rid
        }); 
        
        showToast('Respuesta enviada', 'success'); 
        closeModal(); 
    } catch(e) {
        console.error(e);
        showToast('Error al enviar', 'error');
        btn.disabled = false; btn.innerText = "Reintentar";
    }
};


        // Gestión Usuarios
        window.openAddUserModal = () => { openModal(` <div class="text-left bounce-enter"><h3 class="text-xl font-bold text-gray-800 mb-4">Agregar Usuario</h3><form onsubmit="registerUserByAdmin(event)" class="space-y-4"><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Correo</label><input type="email" id="new-user-email" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm" required></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Contraseña</label><input type="text" id="new-user-pass" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm" required minlength="6"></div><button type="submit" class="neumo-button w-full bg-success text-white font-bold py-3 rounded-xl shadow-lg mt-2">Crear</button></form></div> `); };
        
                // REGISTRO MANUAL POR ADMIN (CON FECHA CORRECTA)
        window.registerUserByAdmin = async (e) => { 
            e.preventDefault(); 
            const email = document.getElementById('new-user-email').value; 
            const password = document.getElementById('new-user-pass').value; 
            try { 
                const secondaryApp = initializeApp(firebaseConfig, "SecondaryApp"); 
                const secondaryAuth = getAuth(secondaryApp); 
                const cred = await createUserWithEmailAndPassword(secondaryAuth, email, password); 
                
                // Guardar billetera
                await setDoc(doc(db, 'artifacts', appId, 'users', cred.user.uid, 'wallet', 'main'), { balance: 0, profit: 0, createdAt: serverTimestamp() }); 
                
                // Guardar usuario con FECHA DE CREACIÓN (createdAt)
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'all_users', cred.user.uid), { 
                    email: email, 
                    uid: cred.user.uid, 
                    role: 'client', 
                    lastLogin: serverTimestamp(),
                    createdAt: serverTimestamp(), // <--- ESTO ORDENARÁ AL USUARIO ARRIBA
                    suspended: false 
                }, { merge: true }); 
                
                await signOut(secondaryAuth); 
                showToast('Usuario creado (Cliente)', 'success'); 
                closeModal(); 
            } catch (error) { 
                showToast('Error: ' + error.message, 'error'); 
            } 
        };
        window.openManualBalanceModal = (uid, email) => { openModal(`<div class="text-center bounce-enter"><h3 class="text-xl font-bold text-gray-800 mb-1">Cargar Saldo Manual</h3><p class="text-xs text-gray-400 mb-4">${email}</p><input type="number" id="manual-amount" class="neumo-inset w-full bg-transparent border-none rounded-xl px-4 py-3 text-lg font-bold text-center mb-4" placeholder="$0"><button onclick="confirmManualBalance('${uid}')" class="neumo-button w-full bg-success text-white font-bold py-3 rounded-xl shadow-lg">Confirmar Recarga</button></div>`); };
                window.confirmManualBalance = async (uid) => { 
            const inputVal = document.getElementById('manual-amount').value;
            const amt = Number(inputVal); 
            
            if(!amt) return showToast('Ingresa un monto válido', 'error'); 
            
            // Referencia a la billetera
            const wRef = doc(db, 'artifacts', appId, 'users', uid, 'wallet', 'main'); 
            
            try {
                await runTransaction(db, async (t) => { 
                    const s = await t.get(wRef); 
                    
                    // Si la billetera NO existe (usuario nuevo), asumimos que tiene $0
                    const currentBal = s.exists() ? (Number(s.data().balance) || 0) : 0;
                    const newBal = currentBal + amt;

                    // TRUCO: Usamos 'set' con { merge: true }. 
                    // Esto CREA la billetera si no existe, o la ACTUALIZA si ya existe.
                    t.set(wRef, { balance: newBal }, { merge: true }); 
                    
                    // Registramos la transacción
                    const txRef = doc(collection(db, 'artifacts', appId, 'users', uid, 'transactions')); 
                    t.set(txRef, { 
                        type: 'deposit', 
                        amount: amt, 
                        description: 'Carga Manual Admin', 
                        timestamp: serverTimestamp(), 
                        prevBalance: currentBal, 
                        newBalance: newBal 
                    }); 
                }); 
                
                showToast('Saldo cargado correctamente', 'success'); 
                closeModal(); 
            } catch(e) {
                console.error(e);
                showToast('Error al cargar: ' + e.message, 'error');
            }
        };
                        // --- REEMPLAZA LA FUNCIÓN toggleUserRole POR ESTAS DOS: ---

        // 1. Abrir modal con selector
        window.openChangeRoleModal = (docId, currentRole, email) => {
            // Generamos las opciones basándonos en tu configuración de roles existente
            let optionsHTML = '';
            for (const [key, val] of Object.entries(ROLE_DEFINITIONS)) {
                const selected = key === currentRole ? 'selected' : '';
                optionsHTML += `<option value="${key}" ${selected}>${val.label}</option>`;
            }

            openModal(`
                <div class="text-left bounce-enter">
                    <h3 class="text-xl font-bold text-gray-800 mb-1">Cambiar Rol</h3>
                    <p class="text-xs text-gray-400 mb-4">Usuario: ${email}</p>
                    
                    <form onsubmit="saveUserRole(event, '${docId}')">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Selecciona el nuevo rol</label>
                        <div class="neumo-inset p-1 rounded-xl mb-6">
                            <select id="role-selector" class="w-full bg-transparent border-none rounded-xl p-3 text-sm font-bold text-gray-700 focus:ring-0">
                                ${optionsHTML}
                            </select>
                        </div>
                        
                        <button type="submit" class="neumo-button w-full bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-indigo-700 transition-all">
                            Guardar Cambio
                        </button>
                    </form>
                </div>
            `);
        };

        // 2. Guardar el cambio
        window.saveUserRole = async (e, docId) => {
            e.preventDefault();
            const newRole = document.getElementById('role-selector').value;
            const roleLabel = ROLE_DEFINITIONS[newRole].label;
            
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'all_users', docId), { role: newRole });
                showToast(`Rol actualizado a ${roleLabel}`, 'success');
                closeModal();
            } catch(error) {
                console.error(error);
                showToast('Error al actualizar el rol', 'error');
            }
        };


        window.toggleSuspend = async (uid, val) => { await updateDoc(doc(db,'artifacts',appId,'public','data','all_users',uid), {suspended: val}); };
                        // 5. USUARIOS: HISTORIAL CON ESTADOS DINÁMICOS
        window.openUserHistory = async (uid, email) => { 
            const walletSnap = await getDoc(doc(db, 'artifacts', appId, 'users', uid, 'wallet', 'main')); 
            const balance = walletSnap.exists() ? walletSnap.data().balance : 0; 
            
            // Renderizar el modal principal
            openModal(`
                <div class="h-[80vh] flex flex-col bounce-enter">
                    <div class="border-b border-gray-100 pb-4 mb-4">
                        <h3 class="font-bold text-xl text-gray-800 mb-1">Expediente de Usuario</h3>
                        <p class="text-sm text-gray-500 font-medium mb-4 flex flex-col gap-1"><span>${email}</span></p>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="neumo-card neumo-inset p-3">
                                <p class="text-[10px] font-bold text-success uppercase tracking-wider">Saldo Actual</p>
                                <p class="text-lg font-black text-success">$${balance.toLocaleString()}</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto scrollbar-hide space-y-2" id="usr-hist-list">
                        <div class="text-center py-10"><div class="animate-spin w-6 h-6 border-2 border-gray-800 border-t-transparent rounded-full mx-auto"></div></div>
                    </div>
                </div>
            `); 
            
            const q = query(collection(db,'artifacts',appId,'users',uid,'transactions'), orderBy('timestamp','desc')); 
            const s = await getDocs(q); 
            let h=''; 
            
            if(s.empty) {
                h='<div class="text-center text-gray-400 py-10 text-xs">Sin movimientos.</div>'; 
            } else { 
                s.forEach(d=>{ 
                    const t = d.data(); 
                    
                    // --- LÓGICA DE VISUALIZACIÓN DINÁMICA ---
                    let displayText = t.description; // Por defecto usamos la descripción original
                    let amountColor = t.amount > 0 ? 'text-success' : 'text-danger'; // Por defecto verde si suma, rojo si resta

                    // Si es una RECARGA (Deposit), cambiamos el texto según el estado
                    if (t.type === 'deposit') {
                        const st = (t.status || '').toLowerCase(); // Convertimos a minúsculas para comparar fácil

                        if (st === 'pending' || st === 'pendiente') {
                            displayText = 'Recarga Pendiente';
                            amountColor = 'text-amber-500'; // Naranja para pendientes
                        } 
                        else if (st === 'approved' || st === 'éxito' || st === 'exito' || st === 'success') {
                            displayText = 'Recarga Exitosa';
                            amountColor = 'text-emerald-600'; // Verde fuerte
                        } 
                        else if (st === 'rejected' || st === 'rechazado' || st === 'cancelled' || st === 'cancelado') {
                            displayText = 'Recarga Cancelada';
                            amountColor = 'text-rose-400 line-through opacity-60'; // Rojo claro y tachado
                        }
                    }
                    // ----------------------------------------

                    h+=`
                    <div onclick="openUserTransactionDetail('${d.id}', '${uid}', '${email}')" class="neumo-card p-3 text-xs cursor-pointer hover:scale-[0.99] transition-transform relative group">
                        <div class="flex justify-between items-center">
                            <p class="font-bold text-gray-700 truncate pr-4">${displayText}</p>
                            <span class="text-[10px] text-gray-400 whitespace-nowrap">${t.timestamp?.toDate().toLocaleDateString()}</span>
                        </div>
                        <p class="font-bold ${amountColor} mt-1">
                            ${t.amount > 0 ? '$'+t.amount.toLocaleString() : (t.amount < 0 ? '-$'+Math.abs(t.amount).toLocaleString() : 'Info')}
                        </p>
                        <div class="absolute right-3 bottom-3 opacity-0 group-hover:opacity-100 transition-opacity">
                            <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400"></i>
                        </div>
                    </div>`;
                }); 
            } 
            document.getElementById('usr-hist-list').innerHTML=h; 
            lucide.createIcons();
        };

                window.openUserTransactionDetail = async (txId, uid, email) => {
            // Obtener datos frescos de la transacción
            const txDoc = await getDoc(doc(db, 'artifacts', appId, 'users', uid, 'transactions', txId));
            if (!txDoc.exists()) return showToast('Transacción no encontrada', 'error');
            const t = txDoc.data();
            
            let modalContent = '';

            // CASO 1: RECARGAS
            if (t.type === 'deposit') {
                let statusColor = 'text-success'; let statusText = 'Éxito';
                if(t.status==='Pending'||t.status==='pending'||t.status==='Pendiente'){ statusColor = 'text-accent'; statusText = 'Pendiente'; } 
                else if (['rejected','cancelled','Rechazado','Cancelado'].includes(t.status)) { statusColor = 'text-danger'; statusText = 'Cancelado'; }
                
                modalContent = `
                <div class="text-center bounce-enter pt-4">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 neumo-card neumo-inset"><i data-lucide="dollar-sign" class="w-8 h-8 text-gray-500"></i></div>
                    <h3 class="text-xl font-bold text-gray-800 mb-1">Detalle de Recarga</h3>
                    <p class="text-xs text-gray-400 mb-6">${t.timestamp?.toDate().toLocaleString()}</p>
                    <div class="neumo-card neumo-inset p-5 space-y-3 text-left">
                        <div class="flex justify-between"><span class="text-xs font-bold text-gray-400 uppercase">Monto</span><span class="font-bold text-success text-lg">$${t.amount.toLocaleString()}</span></div>
                        <div class="flex justify-between"><span class="text-xs font-bold text-gray-400 uppercase">Estado</span><span class="font-bold ${statusColor} uppercase text-sm">${statusText}</span></div>
                        ${t.prevBalance ? `<div class="flex justify-between border-t border-gray-200 pt-2"><span class="text-xs text-gray-400">Saldo Anterior</span><span class="text-xs font-mono">$${t.prevBalance}</span></div>` : ''}
                        <div class="flex justify-between border-t border-gray-200 pt-2"><span class="text-xs font-bold text-gray-400 uppercase">Descripción</span><span class="text-xs font-medium text-gray-700">${t.description}</span></div>
                    </div>
                    <button onclick="openUserHistory('${uid}', '${email}')" class="neumo-button mt-4 w-full bg-gray-900 text-white py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2"><i data-lucide="arrow-left" class="w-4 h-4"></i> Volver al Expediente</button>
                </div>`;

                        // CASO 2: COMPRAS
            } else if (t.type === 'purchase' && t.details) {
                const item = t.details;
                let infoProducto = '';
                
                // --- DETECTAR SI ES REPOSICIÓN ---
                let replacementBadge = '';
                if (item.isReplacement === true) {
                    replacementBadge = `
                    <div class="bg-indigo-50 border border-indigo-100 rounded-lg p-2 mb-3 flex items-center gap-2 animate-pulse">
                        <i data-lucide="refresh-cw" class="w-4 h-4 text-indigo-600"></i>
                        <span class="text-[10px] font-black text-indigo-600 uppercase">Cuenta Repuesta / Actualizada</span>
                    </div>`;
                }
                // ---------------------------------

                // Verificar descripción (GamePass/Liberaciones)
                if (item.description && item.description !== 'null') {
                     infoProducto = `<div class="neumo-card neumo-inset p-3 mb-2"><p class="text-[10px] font-bold text-accent uppercase mb-1">Detalles/Código</p><p class="text-sm font-bold text-gray-800 whitespace-pre-wrap">${item.description}</p></div>`;
                }
                // Verificar si es Link (Libros)
                else if (item.link) {
                    infoProducto = `<div class="neumo-card neumo-inset p-3 mb-2"><p class="text-[10px] font-bold text-gray-400 uppercase mb-1">Enlace</p><a href="${item.link}" target="_blank" class="text-sm font-bold text-blue-600 underline truncate block">${item.link}</a></div>`;
                } 
                // Cuenta Normal (CORREO, PASS, ETC)
                else {
                    infoProducto = `
                    <div class="grid gap-3">
                        <div class="neumo-card neumo-inset p-3"><p class="text-[10px] font-bold text-gray-400 uppercase mb-1">Correo</p><p class="font-mono text-sm text-gray-800 font-bold select-all break-all">${item.email || 'N/A'}</p></div>
                        <div class="neumo-card neumo-inset p-3"><p class="text-[10px] font-bold text-gray-400 uppercase mb-1">Contraseña</p><p class="font-mono text-sm text-gray-800 font-bold select-all">${item.password || 'N/A'}</p></div>
                        ${item.profileName ? `<div class="grid grid-cols-2 gap-2"><div class="neumo-card neumo-inset p-3"><p class="text-[10px] font-bold text-gray-400 uppercase mb-1">Perfil</p><p class="text-sm font-bold text-gray-800">${item.profileName}</p></div><div class="neumo-card neumo-inset p-3"><p class="text-[10px] font-bold text-gray-400 uppercase mb-1">PIN</p><p class="text-sm font-bold text-gray-800">${item.pin}</p></div></div>` : ''}
                    </div>
                    <div class="grid grid-cols-2 gap-4 pt-2">
                        <div><p class="text-[10px] font-bold text-gray-400 uppercase">Expira</p><p class="text-sm font-bold text-gray-700">${item.expiryDate || 'N/A'}</p></div>
                        <div><p class="text-[10px] font-bold text-gray-400 uppercase">Duración</p><p class="text-sm font-bold text-gray-700">${item.duration || 'N/A'}</p></div>
                    </div>`;
                }

                modalContent = `
                <div class="text-center bounce-enter pt-4">
                    <div class="w-16 h-16 bg-success/10 text-success rounded-full flex items-center justify-center mx-auto mb-4 neumo-card neumo-inset"><i data-lucide="shopping-bag" class="w-8 h-8"></i></div>
                    <h3 class="text-xl font-bold text-gray-800 mb-1">Detalle de Compra</h3>
                    <p class="text-xs text-gray-400 mb-6">${t.timestamp?.toDate().toLocaleString()}</p>

                    <div class="neumo-card neumo-inset p-5 text-left space-y-4 relative overflow-hidden mb-4">
                        <div class="absolute top-0 left-0 w-1 h-full bg-success"></div>
                        
                        ${replacementBadge} <div><p class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">Producto</p><p class="text-lg font-black text-gray-800">${item.serviceName || t.description}</p></div>
                        <div class="flex justify-between items-center border-b border-gray-200 pb-2">
                            <span class="text-xs font-bold text-gray-400 uppercase">Costo</span>
                            <span class="font-bold text-gray-800 text-lg">$${t.amount.toLocaleString()}</span>
                        </div>
                        ${infoProducto}
                    </div>
                    <button onclick="openUserHistory('${uid}', '${email}')" class="neumo-button w-full bg-gray-900 text-white py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2"><i data-lucide="arrow-left" class="w-4 h-4"></i> Volver al Expediente</button>
                </div>`;


            // CASO 3: RESPUESTA DE SOPORTE (ESTA ES LA PARTE NUEVA QUE SOLICITASTE)
            } else if (t.type === 'support_reply') {
                 modalContent = `
                <div class="text-left bounce-enter pt-4">
                    <div class="flex items-center gap-3 mb-6 border-b border-gray-100 pb-4">
                        <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center neumo-card neumo-inset flex-shrink-0"><i data-lucide="message-circle" class="w-6 h-6"></i></div>
                        <div>
                            <h3 class="font-bold text-lg text-gray-800 leading-tight">Respuesta Soporte</h3>
                            <p class="text-xs text-gray-400">${t.timestamp ? t.timestamp.toDate().toLocaleString() : 'Reciente'}</p>
                        </div>
                    </div>
                    
                    <div class="neumo-card neumo-inset p-5 rounded-2xl text-sm text-gray-700 whitespace-pre-wrap leading-relaxed font-medium mb-6 min-h-[100px]">
                        ${t.message || "Sin contenido."}
                    </div>

                    <button onclick="openUserHistory('${uid}', '${email}')" class="neumo-button w-full bg-gray-900 text-white py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2">
                        <i data-lucide="arrow-left" class="w-4 h-4"></i> Volver al Expediente
                    </button>
                </div>`;

            // CASO 4: GENÉRICO (Fallback)
            } else {
                modalContent = `<div class="p-5 text-center"><p class="text-gray-600 font-bold mb-2">${t.description}</p><p class="text-sm">$${t.amount}</p><button onclick="openUserHistory('${uid}', '${email}')" class="neumo-button mt-4 w-full bg-gray-900 text-white py-3 rounded-xl">Volver</button></div>`;
            }

            openModal(modalContent);
            lucide.createIcons();
        };
        
                // --- FUNCIÓN DEL INTERRUPTOR (ENCENDER/APAGAR) ---
        window.toggleReferralLink = async (currentState) => {
            const btn = document.getElementById('ref-toggle-btn');
            // Ponemos un spinner mientras carga
            btn.innerHTML = '<span class="animate-spin inline-block w-3 h-3 border-2 border-current border-t-transparent rounded-full"></span>';
            btn.disabled = true;

            const newState = !currentState; // Invertimos el estado (si era true, ahora es false)
            const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'all_users', currentUser.uid);

            try {
                // Guardamos el cambio en Firebase
                await updateDoc(userRef, { isReferralActive: newState });
                
                // Recargamos el modal para que se vea el cambio de color y texto
                openInviteModal();
                showToast(newState ? 'Enlace ACTIVADO' : 'Enlace DESACTIVADO', newState ? 'success' : 'info');
            } catch (e) {
                console.error(e);
                showToast('Error al cambiar estado', 'error');
                openInviteModal(); // Si falla, restauramos la vista
            }
        };
        
                                // ======================================================
        // SISTEMA REFERIDOS PREMIUM (DISEÑO REWARDS + JERARQUÍA + ESTADOS)
        // ======================================================

        // 1. LÓGICA: Control del Interruptor (Genera Token al activar)
        window.toggleCurrentRoleStatus = async () => {
            const btn = document.getElementById('ref-toggle-btn');
            const btnText = document.getElementById('ref-toggle-btn-text');
            const select = document.getElementById('invite-role-select');
            const currentCode = select ? select.value : '1'; 

            // Feedback de carga
            btn.disabled = true;
            btnText.innerText = '...';

            const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'all_users', currentUser.uid);

            try {
                const snap = await getDoc(userRef);
                const currentConfig = snap.data().referralConfig || {}; 
                const currentState = currentConfig[currentCode] === true; 
                const newState = !currentState;

                const updateMap = {};
                updateMap[`referralConfig.${currentCode}`] = newState;

                // Si activamos, generamos un Token de Seguridad Único
                if (newState) {
                    const newToken = Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
                    updateMap['referralToken'] = newToken; 
                }

                // Lógica Admin (Montos personalizados)
                const adminInput = document.getElementById('admin-custom-amount');
                if (adminInput && currentUser.email === 'mrandroidtutorialeshd@gmail.com') {
                    const customValue = Number(adminInput.value);
                    if (customValue >= 0) {
                        updateMap[`referralConfig.amount_${currentCode}`] = customValue;
                    }
                }

                await updateDoc(userRef, updateMap);
                
                if(newState) showToast('¡Enlace activado y seguro!', 'success');
                else showToast('Enlace desactivado', 'info');

                await updateInviteModalVisuals(currentCode);
                
            } catch (e) {
                console.error(e);
                showToast('Error al actualizar', 'error');
                btn.disabled = false;
                btnText.innerText = "Error";
            }
        };

        // 2. MODAL PRINCIPAL
        window.openInviteModal = async () => {
            const myRole = currentUserRole; 
            const isAdmin = currentUser.email === 'mrandroidtutorialeshd@gmail.com'; 
            const inviteLinkBase = `${window.location.origin}`;

            // Opciones del selector (Tu lógica original)
            let roleOptionsHTML = `<option value="1">Cliente (Básico)</option>`;
            if(myRole === 'reseller' || myRole === 'lider' || isAdmin) roleOptionsHTML += `<option value="2">Cliente VIP</option>`;
            if(myRole === 'lider' || isAdmin) roleOptionsHTML += `<option value="3">Revendedor</option>`;

            // Renderizamos el Modal
            openModal(`
            <div class="bg-gray-50 rounded-[2rem] overflow-hidden relative bounce-enter flex flex-col max-h-[85vh]">
                
                <div class="bg-gradient-to-bl from-pink-500 via-rose-500 to-purple-600 p-6 text-center relative flex-shrink-0 shadow-lg z-10 overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-full opacity-20" style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 10px 10px;"></div>
                    
                    <div class="relative w-16 h-16 mx-auto mb-2 group cursor-pointer">
                        <div class="absolute inset-0 bg-white/20 rounded-full blur-md animate-pulse"></div>
                        <div class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center relative z-10 shadow-2xl border border-white/40 transform group-hover:scale-110 transition-transform duration-300">
                            <i data-lucide="gift" class="w-8 h-8 text-white drop-shadow-md"></i>
                        </div>
                    </div>

                    <h3 class="text-xl font-black text-white tracking-tight uppercase relative z-10 mb-1">Invita y Gana</h3>
                    <p class="text-[10px] text-pink-100 font-medium max-w-[250px] mx-auto relative z-10">Configura tus enlaces y gana comisiones.</p>
                </div>

                <div class="p-5 flex-1 overflow-y-auto scrollbar-hide relative z-20 space-y-4">
                    
                    <div class="flex justify-center gap-2 flex-wrap" id="roles-status-badges">
                        <span class="text-[10px] text-gray-400 animate-pulse">Cargando estados...</span>
                    </div>

                    ${ (myRole !== 'client' || isAdmin) ? `
                    <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100">
                        <label class="text-[10px] font-bold text-gray-400 uppercase ml-1 mb-1 block">¿Qué membresía configurar?</label>
                        <select id="invite-role-select" onchange="handleRoleChange()" class="w-full bg-gray-50 border-none rounded-xl p-2.5 text-xs font-bold text-gray-700 focus:ring-2 focus:ring-pink-500 transition-all">
                            ${roleOptionsHTML}
                        </select>
                    </div>
                    ` : '' }

                    <div id="role-status-container" class="flex items-center justify-between p-3 rounded-2xl border transition-colors bg-gray-100 border-gray-200">
                        <div class="flex items-center gap-2">
                            <div id="status-icon-bg" class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-400">
                                <i data-lucide="power" class="w-4 h-4"></i>
                            </div>
                            <div>
                                <p id="role-status-text" class="text-[10px] font-black uppercase text-gray-400">APAGADO</p>
                                <p id="role-status-subtext" class="text-[9px] text-gray-400 leading-none">Activa para generar link</p>
                            </div>
                        </div>
                        <button id="ref-toggle-btn" onclick="toggleCurrentRoleStatus()" class="bg-gray-900 text-white px-4 py-2 rounded-lg text-[10px] font-bold shadow-md hover:scale-105 transition-transform">
                            <span id="ref-toggle-btn-text">Activar</span>
                        </button>
                    </div>

                    <div id="bonus-info-container" class="bg-purple-50 border border-purple-100 p-3 rounded-2xl hidden">
                         ${ isAdmin ? `
                            <p class="text-[10px] text-purple-600 mb-1 font-bold">Admin: Bono Personalizado ($)</p>
                            <input type="number" id="admin-custom-amount" class="w-full bg-white rounded-lg px-3 py-1.5 font-bold text-purple-700 text-xs border border-purple-200" placeholder="0">
                        ` : `
                            <div class="flex items-center gap-2">
                                <i data-lucide="sparkles" class="w-4 h-4 text-purple-500"></i>
                                <p class="text-[10px] text-purple-700 leading-tight">
                                    Al registrarse recibirán <strong id="dynamic-bonus-amount" class="bg-white px-1 rounded text-purple-800 border border-purple-200 shadow-sm">$10</strong> de saldo inicial el cual será descontado de tu saldo, Pero como es tu referido tu ganas el <strong id="dynamic-bonus-amount" class="bg-white px-1 rounded text-purple-800 border border-purple-200 shadow-sm">10%</strong> de todas sus compras realizadas.
                                </p>
                            </div>
                        `}
                    </div>

                    <div id="link-container" class="relative group opacity-50 pointer-events-none transition-all duration-300">
                        <div class="flex items-center gap-2 bg-white border border-gray-200 rounded-2xl p-2 shadow-sm focus-within:ring-2 focus-within:ring-pink-500 focus-within:border-pink-500 transition-all">
                            <div class="pl-2 overflow-hidden flex-1">
                                <span id="real-invite-link" class="hidden"></span>
                                <input type="text" id="invite-link-text" readonly value="Generando..." class="w-full bg-transparent border-none text-xs font-bold text-gray-600 focus:ring-0 truncate font-mono select-all pointer-events-none">
                            </div>
                            <button onclick="copyCurrentInviteLink()" class="bg-gray-100 text-gray-600 p-2 rounded-xl hover:bg-pink-50 hover:text-pink-600 transition-colors">
                                <i data-lucide="copy" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    <div id="share-buttons-container" class="grid grid-cols-2 gap-3 opacity-50 pointer-events-none transition-all duration-300">
                        <button onclick="shareToWhatsAppDynamic()" class="bg-[#25D366] text-white py-3 rounded-xl shadow-md shadow-green-100 hover:bg-[#20bd5a] flex items-center justify-center gap-2 transition-transform active:scale-95">
                            <i data-lucide="message-circle" class="w-4 h-4"></i>
                            <span class="text-[10px] font-bold">WhatsApp</span>
                        </button>
                        <button onclick="nativeShareDynamic()" class="bg-indigo-600 text-white py-3 rounded-xl shadow-md shadow-indigo-100 hover:bg-indigo-700 flex items-center justify-center gap-2 transition-transform active:scale-95">
                            <i data-lucide="share-2" class="w-4 h-4"></i>
                            <span class="text-[10px] font-bold">Más Opciones</span>
                        </button>
                    </div>

                </div>

                <div class="p-4 bg-white border-t border-gray-200 z-30">
                    <button onclick="closeModal()" class="w-full py-3 rounded-xl text-xs font-bold text-gray-400 hover:text-gray-600 hover:bg-gray-50 transition-colors">
                        Cerrar Panel
                    </button>
                </div>
            </div>`);

            // --- LÓGICA INTERNA UI ---
            window.handleRoleChange = () => {
                const code = document.getElementById('invite-role-select').value;
                updateInviteModalVisuals(code);
            };

            window.updateInviteModalVisuals = async (code) => {
                const container = document.getElementById('role-status-container');
                const textLabel = document.getElementById('role-status-text');
                const subTextLabel = document.getElementById('role-status-subtext');
                const iconBg = document.getElementById('status-icon-bg');
                const btn = document.getElementById('ref-toggle-btn');
                const btnText = document.getElementById('ref-toggle-btn-text');
                
                const linkArea = document.getElementById('link-container');
                const shareArea = document.getElementById('share-buttons-container');
                const bonusContainer = document.getElementById('bonus-info-container');
                
                const baseUrl = `${window.location.origin}${window.location.pathname}`;
                
                // Leemos datos frescos
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'all_users', currentUser.uid);
                const snap = await getDoc(userRef);
                const uData = snap.data();
                const config = uData.referralConfig || {};
                const token = uData.referralToken || 'v1'; 

                // [NUEVO] Renderizar Badges de Estado
                const summaryContainer = document.getElementById('roles-status-badges');
                if(summaryContainer) {
                    let summaryHTML = '';
                    const roleMap = { '1': 'Cliente', '2': 'VIP', '3': 'Revendedor' };
                    // Filtramos solo los roles que el usuario puede ver
                    const availableCodes = [];
                    availableCodes.push('1');
                    if(myRole === 'reseller' || myRole === 'lider' || isAdmin) availableCodes.push('2');
                    if(myRole === 'lider' || isAdmin) availableCodes.push('3');

                    availableCodes.forEach(c => {
                        const isOn = config[c] === true;
                        const colorClass = isOn ? 'bg-emerald-100 text-emerald-600 border-emerald-200' : 'bg-gray-100 text-gray-400 border-gray-200 opacity-60 grayscale';
                        const icon = isOn ? 'check' : 'x';
                        summaryHTML += `<span class="text-[9px] font-bold px-2 py-1 rounded-lg border flex items-center gap-1 transition-all ${colorClass}">${roleMap[c]} <i data-lucide="${icon}" class="w-3 h-3"></i></span>`;
                    });
                    summaryContainer.innerHTML = summaryHTML;
                }

                // Construimos el enlace COMPLETO con Token
                const fullLink = `${baseUrl}?ref=${currentUser.uid}&c=${code}&t=${token}`;
                const realLinkSpan = document.getElementById('real-invite-link');
                const visualLinkInput = document.getElementById('invite-link-text');
                if(realLinkSpan) realLinkSpan.innerText = fullLink;
                if(visualLinkInput) visualLinkInput.value = fullLink;

                // Calculamos Bonos
                let bonusAmount = 10;
                if(code === '2') bonusAmount = 50;
                if(code === '3') bonusAmount = 100;
                
                if (!isAdmin) {
                    const amountLabel = document.getElementById('dynamic-bonus-amount');
                    if(amountLabel) amountLabel.innerText = `$${bonusAmount}`;
                }
                if (isAdmin) {
                    const savedAmount = config[`amount_${code}`];
                    const inputAdmin = document.getElementById('admin-custom-amount');
                    if(inputAdmin && inputAdmin.value === '') { 
                         inputAdmin.value = (savedAmount !== undefined) ? savedAmount : bonusAmount;
                    }
                }

                // Estado del Interruptor
                const isActive = config[code] === true; 
                
                btn.disabled = false;

                if(isActive) {
                    // ESTADO: ACTIVO
                    container.className = "flex items-center justify-between p-3 rounded-2xl border transition-colors bg-emerald-50 border-emerald-100";
                    textLabel.innerHTML = `<span class="text-emerald-600">ENLACE ACTIVO</span>`;
                    subTextLabel.innerText = `Bono actual: $${bonusAmount}`;
                    
                    iconBg.className = "w-8 h-8 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-600";
                    iconBg.innerHTML = '<i data-lucide="wifi" class="w-4 h-4"></i>';

                    btn.className = "bg-white text-rose-500 border border-rose-100 px-3 py-1.5 rounded-lg text-[10px] font-bold shadow-sm hover:bg-rose-50";
                    btnText.innerText = "Apagar";
                    
                    bonusContainer.classList.remove('hidden');
                    
                    linkArea.classList.remove('opacity-50', 'pointer-events-none');
                    shareArea.classList.remove('opacity-50', 'pointer-events-none');
                    visualLinkInput.classList.remove('text-gray-600');
                    visualLinkInput.classList.add('text-pink-600');
                } else {
                    // ESTADO: APAGADO
                    container.className = "flex items-center justify-between p-3 rounded-2xl border transition-colors bg-gray-50 border-gray-200";
                    textLabel.innerHTML = `ENLACE APAGADO`;
                    subTextLabel.innerText = "Activa para compartir";
                    
                    iconBg.className = "w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-400";
                    iconBg.innerHTML = '<i data-lucide="power-off" class="w-4 h-4"></i>';

                    btn.className = "bg-gray-900 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold shadow-md hover:scale-105";
                    btnText.innerText = "Activar";
                    
                    bonusContainer.classList.add('hidden');

                    linkArea.classList.add('opacity-50', 'pointer-events-none');
                    shareArea.classList.add('opacity-50', 'pointer-events-none');
                    visualLinkInput.classList.add('text-gray-600');
                    visualLinkInput.classList.remove('text-pink-600');
                }
                lucide.createIcons();
            };

            // Copiar
            window.copyCurrentInviteLink = () => {
                const txt = document.getElementById('real-invite-link').innerText;
                navigator.clipboard.writeText(txt).then(()=>showToast('Enlace copiado al portapapeles','success'));
            };

            // Compartir WhatsApp
            window.shareToWhatsAppDynamic = () => {
                const txt = document.getElementById('real-invite-link').innerText;
                const msg = `¡Hola! Únete a esta plataforma usando mi enlace seguro: ${txt}`;
                window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
            };

            // Compartir Nativo
            window.nativeShareDynamic = async () => {
                const txt = document.getElementById('real-invite-link').innerText;
                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: 'Te invito a unirte',
                            text: 'Regístrate y consigue los mejores servicios.',
                            url: txt,
                        });
                    } catch (err) { console.log('Error', err); }
                } else {
                    window.copyCurrentInviteLink();
                }
            };

            // Inicializar al abrir
            const initialCode = document.getElementById('invite-role-select') ? document.getElementById('invite-role-select').value : '1';
            updateInviteModalVisuals(initialCode);
        };


        // --- MODALES DE PRODUCTO CON DOBLE PRECIO ---
         // ======================================================
// BLOQUE 1 MODIFICADO: AGREGAR PRODUCTO (CON TIEMPO DE ENTREGA)
// ======================================================
window.openAddProductModal = () => { 
    let optionsHTML = window.categoriesCache.length > 0 ? window.categoriesCache.map(c => `<option value="${c.slug}">${c.name}</option>`).join('') : `<option value="" disabled selected>Crea categorías primero</option>`; 
    
    openModal(`
        <div class="text-left bounce-enter">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Agregar Artículo</h3>
            <form onsubmit="saveProduct(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Categoría</label>
                    <select id="p-category" onchange="toggleForbiddenField()" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm" required>${optionsHTML}</select>
                </div>

                <div id="field-delivery" class="hidden bg-blue-50 p-2 rounded-xl border border-blue-100 animate-in fade-in slide-in-from-top-2">
                    <label class="block text-xs font-bold text-blue-600 uppercase mb-1">⏱️ Tiempo de Entrega</label>
                    <input type="text" id="p-delivery-time" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm font-bold text-blue-800" placeholder="Ej: 10 - 20 min">
                </div>
                
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nombre</label><input type="text" id="p-name" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm" required></div>
                
                <div id="field-forbidden" class="hidden bg-rose-50 p-2 rounded-xl border border-rose-100">
                    <label class="block text-xs font-bold text-rose-500 uppercase mb-1">¿Producto Prohibido?</label>
                    <select id="p-forbidden" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm font-bold text-rose-600">
                        <option value="false">No (Normal)</option>
                        <option value="true">Sí (Mostrar alerta)</option>
                    </select>
                </div>

                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">URL Imagen</label><input type="url" id="p-image" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm" required></div>
                
                <div class="neumo-inset p-3 rounded-xl grid grid-cols-2 gap-3">
                    <p class="col-span-2 text-[10px] font-bold text-gray-400 uppercase text-center mb-1">Lista de Precios</p>
                    <div><label class="block text-[10px] font-bold text-gray-500 uppercase">Cliente</label><input type="number" id="p-price-client" class="neumo-flat border border-gray-200 w-full rounded-lg p-2 text-sm" required placeholder="$ Base"></div>
                    <div><label class="block text-[10px] font-bold text-purple-600 uppercase">Vip</label><input type="number" id="p-price-vip" class="neumo-flat border border-purple-200 w-full rounded-lg p-2 text-sm text-purple-700 font-bold" required placeholder="$ Vip"></div>
                    <div><label class="block text-[10px] font-bold text-indigo-600 uppercase">Revendedor</label><input type="number" id="p-price-reseller" class="neumo-flat border border-indigo-200 w-full rounded-lg p-2 text-sm text-indigo-700 font-bold" required placeholder="$ Rev"></div>
                    <div><label class="block text-[10px] font-bold text-amber-600 uppercase">Lider</label><input type="number" id="p-price-leader" class="neumo-flat border border-amber-200 w-full rounded-lg p-2 text-sm text-amber-700 font-bold" required placeholder="$ Lider"></div>
                </div>

                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Descripción</label><textarea id="p-desc" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm h-20 resize-none"></textarea></div>
                <button type="submit" class="neumo-button w-full bg-gray-900 text-white font-bold py-3 rounded-xl shadow-lg mt-2">Guardar Producto</button>
            </form>
        </div>`); 
        
    setTimeout(window.toggleForbiddenField, 100);
};

// Función auxiliar actualizada para mostrar/ocultar campos
window.toggleForbiddenField = () => {
    const cat = document.getElementById('p-category').value.toLowerCase();
    
    // Campo Prohibido (Libros)
    const fieldForbidden = document.getElementById('field-forbidden');
    if(cat.includes('libros')) {
        fieldForbidden.classList.remove('hidden');
    } else {
        fieldForbidden.classList.add('hidden');
        document.getElementById('p-forbidden').value = "false"; 
    }

    // Campo Tiempo de Entrega (Documentos)
    const fieldDelivery = document.getElementById('field-delivery');
    if(cat.includes('documentos')) {
        fieldDelivery.classList.remove('hidden');
    } else {
        fieldDelivery.classList.add('hidden');
        document.getElementById('p-delivery-time').value = ""; // Limpiar si se oculta
    }
};

window.saveProduct = async (e) => { 
    e.preventDefault(); 
    try { 
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'profiles'), { 
            category: document.getElementById('p-category').value, 
            name: document.getElementById('p-name').value, 
            isForbidden: document.getElementById('p-forbidden').value === 'true',
            
            // GUARDAR TIEMPO DE ENTREGA
            deliveryTime: document.getElementById('p-delivery-time').value,

            imageUrl: document.getElementById('p-image').value, 
            priceClient: Number(document.getElementById('p-price-client').value), 
            priceVip: Number(document.getElementById('p-price-vip').value),
            priceReseller: Number(document.getElementById('p-price-reseller').value),
            priceLeader: Number(document.getElementById('p-price-leader').value),
            price: Number(document.getElementById('p-price-client').value), 
            description: document.getElementById('p-desc').value, 
            stock: 0, 
            createdAt: serverTimestamp() 
        }); 
        showToast('Producto agregado correctamente', 'success'); 
        closeModal(); 
    } catch(err) { showToast('Error al guardar', 'error'); } 
};
        // ======================================================
        // FIN BLOQUE 1
        // ======================================================


        
                // Reemplaza la función existente con esta versión mejorada
                // ======================================================
// BLOQUE 2 MODIFICADO: EDITAR PRODUCTO (CON TIEMPO DE ENTREGA)
// ======================================================
window.openEditProductModal = async (pid) => { 
    const docSnap = await getDoc(doc(db,'artifacts',appId,'public','data','profiles',pid));
    if (!docSnap.exists()) return showToast('Producto no encontrado', 'error');
    const d = docSnap.data(); 

    let optionsHTML = window.categoriesCache.map(c => `<option value="${c.slug}" ${c.slug===d.category?'selected':''}>${c.name}</option>`).join(''); 
    const valClient = d.priceClient || d.price || 0;
    const valVip = d.priceVip || valClient || 0;
    const valReseller = d.priceReseller || valClient || 0;
    const valLeader = d.priceLeader || valReseller || 0;

    openModal(`
        <div class="text-left bounce-enter">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Editar Producto</h3>
            <form onsubmit="updateProduct(event, '${pid}')" class="space-y-4">
                
                <div>
                    <label class="text-xs font-bold uppercase text-gray-500">Categoría</label>
                    <select id="e-cat" onchange="toggleEditForbiddenField()" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm">${optionsHTML}</select>
                </div>

                <div id="e-field-delivery" class="hidden bg-blue-50 p-2 rounded-xl border border-blue-100 animate-in fade-in">
                    <label class="block text-xs font-bold text-blue-600 uppercase mb-1">⏱️ Tiempo de Entrega</label>
                    <input type="text" id="e-delivery-time" value="${d.deliveryTime || ''}" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm font-bold text-blue-800" placeholder="Ej: 10 - 20 min">
                </div>

                <div><label class="text-xs font-bold uppercase text-gray-500">Nombre</label><input type="text" id="e-name" value="${d.name}" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm" required></div>

                <div id="e-field-forbidden" class="hidden bg-rose-50 p-2 rounded-xl border border-rose-100">
                    <label class="block text-xs font-bold text-rose-500 uppercase mb-1">¿Producto Prohibido?</label>
                    <select id="e-forbidden" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm font-bold text-rose-600">
                        <option value="false" ${d.isForbidden === false ? 'selected' : ''}>No</option>
                        <option value="true" ${d.isForbidden === true ? 'selected' : ''}>Sí (Alerta Roja)</option>
                    </select>
                </div>

                <div class="neumo-inset p-3 rounded-xl grid grid-cols-2 gap-3">
                    <p class="col-span-2 text-[10px] font-bold text-gray-400 uppercase text-center mb-1">Precios por Jerarquía</p>
                    <div><label class="block text-[10px] font-bold text-gray-500 uppercase">Cliente</label><input type="number" id="e-price-client" value="${valClient}" class="neumo-flat border border-gray-200 w-full rounded-lg p-2 text-sm" required step="0.01"></div>
                    <div><label class="block text-[10px] font-bold text-purple-600 uppercase">Vip</label><input type="number" id="e-price-vip" value="${valVip}" class="neumo-flat border border-purple-200 w-full rounded-lg p-2 text-sm text-purple-700 font-bold" required step="0.01"></div>
                    <div><label class="block text-[10px] font-bold text-indigo-600 uppercase">Revendedor</label><input type="number" id="e-price-reseller" value="${valReseller}" class="neumo-flat border border-indigo-200 w-full rounded-lg p-2 text-sm text-indigo-700 font-bold" required step="0.01"></div>
                    <div><label class="block text-[10px] font-bold text-amber-600 uppercase">Lider</label><input type="number" id="e-price-leader" value="${valLeader}" class="neumo-flat border border-amber-200 w-full rounded-lg p-2 text-sm text-amber-700 font-bold" required step="0.01"></div>
                </div>

                <div><label class="text-xs font-bold uppercase text-gray-500">URL Imagen</label><input type="url" id="e-img" value="${d.imageUrl}" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 text-sm" required></div>
                <div><label class="text-xs font-bold uppercase text-gray-500">Descripción</label><textarea id="e-desc" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 h-24 resize-none">${d.description}</textarea></div>
                
                <button type="submit" class="neumo-button w-full bg-gray-900 text-white font-bold py-3 rounded-xl shadow-lg mt-2">Guardar Cambios</button>
            </form>
        </div>`); 
    
    setTimeout(window.toggleEditForbiddenField, 100);
};

window.toggleEditForbiddenField = () => {
    const cat = document.getElementById('e-cat').value.toLowerCase();
    
    // Campo Prohibido
    const fieldForbidden = document.getElementById('e-field-forbidden');
    if(cat.includes('libros')) fieldForbidden.classList.remove('hidden');
    else fieldForbidden.classList.add('hidden');

    // Campo Tiempo Entrega
    const fieldDelivery = document.getElementById('e-field-delivery');
    if(cat.includes('documentos')) fieldDelivery.classList.remove('hidden');
    else fieldDelivery.classList.add('hidden');
};

window.updateProduct = async (e, pid) => { 
    e.preventDefault(); 
    const btn = e.target.querySelector('button[type="submit"]');
    const originalText = btn.innerText;
    btn.disabled = true; btn.innerText = "Guardando...";

    try {
        await updateDoc(doc(db,'artifacts',appId,'public','data','profiles',pid), { 
            name: document.getElementById('e-name').value, 
            isForbidden: document.getElementById('e-forbidden').value === 'true',
            
            // ACTUALIZAR TIEMPO ENTREGA
            deliveryTime: document.getElementById('e-delivery-time').value,

            priceClient: Number(document.getElementById('e-price-client').value),
            priceVip: Number(document.getElementById('e-price-vip').value),
            priceReseller: Number(document.getElementById('e-price-reseller').value),
            priceLeader: Number(document.getElementById('e-price-leader').value),
            price: Number(document.getElementById('e-price-client').value), 
            category: document.getElementById('e-cat').value, 
            imageUrl: document.getElementById('e-img').value, 
            description: document.getElementById('e-desc').value,
            updatedAt: serverTimestamp()
        }); 
        showToast('Producto actualizado correctamente', 'success'); 
        closeModal(); 
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
        btn.disabled = false; btn.innerText = originalText;
    }
};
        // ======================================================
        // FIN BLOQUE 2
        // ======================================================


             // ======================================================
        // VISTA TIENDA: SOFT MODERN + CINTA ROJA DE AGOTADO
        // ======================================================
       // 1. Esta es la función "Gatekeeper" (Portero) que decide si mostrar alerta o no
window.openCategoryModule = (categorySlug, title) => {
    // Convertimos a minúsculas para comparar fácil
    const slug = categorySlug.toLowerCase();

    // MODIFICADO: Ahora detecta "perfil" O "tv" (para que funcione en Tv Digital)
    if (slug.includes('perfil') || slug.includes('tv')) {
        // Mostramos la alerta roja primero
        showProfilesWarning(categorySlug, title);
    } else {
        // Si es cualquier otra cosa (Netflix, Música, etc), abrimos directo
        renderCategoryView(categorySlug, title);
    }
};

// ======================================================
// VISTA TIENDA: FINAL (CON TIEMPO DE ENTREGA RESTAURADO)
// ======================================================
window.renderCategoryView = (categorySlug, title) => {
    const m = document.getElementById('app-modal');
    const mc = document.getElementById('modal-card');
    const content = document.getElementById('modal-content');

    // 1. Configuración Visual
    if (mc) { mc.className = "w-full max-w-5xl h-[90vh] md:h-[85vh] bg-white md:rounded-[2rem] rounded-t-3xl relative shadow-2xl flex flex-col overflow-hidden slide-up"; }
    
    if (content) {
        content.className = "w-full h-full p-0 overflow-hidden flex flex-col";
        content.innerHTML = `
        <div class="relative h-full flex flex-col bg-[#F8F9FA]">
            <div class="bg-white border-b border-gray-100 px-8 py-5 flex items-center justify-between shadow-sm flex-shrink-0 z-30 relative">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-xl bg-indigo-50 text-indigo-600 flex items-center justify-center shadow-sm">
                        <i data-lucide="grid" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-black text-gray-800 tracking-tight leading-none">${title}</h3>
                        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mt-0.5">Catálogo Oficial</p>
                    </div>
                </div>
                <button onclick="closeModal()" class="w-10 h-10 rounded-full bg-gray-50 text-gray-400 flex items-center justify-center hover:bg-rose-50 hover:text-rose-500 transition-all border border-gray-100 shadow-sm active:scale-95">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto scrollbar-hide p-4 md:p-6 bg-gray-50/50">
                <div id="products-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6 pb-24">
                    <div class="col-span-full py-24 flex flex-col items-center justify-center opacity-50 space-y-4">
                        <span class="animate-spin inline-block w-8 h-8 border-4 border-indigo-200 border-t-indigo-600 rounded-full"></span>
                        <span class="text-xs font-bold text-gray-400 tracking-widest uppercase animate-pulse">Cargando precios...</span>
                    </div>
                </div>
            </div>
        </div>`;
    }

    m.classList.remove('hidden');
    m.classList.add('flex'); 
    m.classList.remove('items-center', 'justify-center', 'p-4');
    m.classList.add('items-end', 'justify-center', 'p-0', 'md:p-4', 'md:items-center');
    lucide.createIcons();

    // 2. Consulta en Tiempo Real
    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'profiles'), where('category', '==', categorySlug));
    
    onSnapshot(q, (snapshot) => {
        const grid = document.getElementById('products-grid');
        if (!grid) return;

        const products = [];
        snapshot.forEach(doc => products.push({ id: doc.id, ...doc.data() }));
        products.sort((a, b) => a.name.localeCompare(b.name));

        const cleanText = (str) => str ? str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") : "";
        const cleanSlug = cleanText(categorySlug);
        
        // Categorías especiales
        const isInfiniteCat = cleanSlug.includes('document') || cleanSlug.includes('tramite') || cleanSlug.includes('liberacion') || cleanSlug.includes('movil') || cleanSlug.includes('libro');
        const isPromotions = cleanSlug.includes('promocion');

        grid.innerHTML = '';
        let rawRole = 'client';
        if (typeof currentUserRole !== 'undefined' && currentUserRole) rawRole = currentUserRole;
        let myRole = rawRole.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

        let visibleCount = 0;

        products.forEach((p, index) => {
            const stock = p.stock || 0;
            const safeDesc = encodeURIComponent(p.description || '');
            const hasStock = isInfiniteCat || stock > 0;

            // Filtro Promociones Agotadas
            if (isPromotions && !hasStock) return;
            visibleCount++;

            // --- Precios por Rol ---
            const pClient = Number(p.priceClient || p.price || 0);
            const pVip = Number(p.priceVip || 0);
            const pReseller = Number(p.priceReseller || 0);
            const pLeader = Number(p.priceLeader || 0);

            let finalPrice = pClient;
            if (myRole === 'lider') { finalPrice = pLeader > 0 ? pLeader : (pReseller > 0 ? pReseller : (pVip > 0 ? pVip : pClient)); }
            else if (myRole === 'reseller') { finalPrice = pReseller > 0 ? pReseller : (pVip > 0 ? pVip : pClient); }
            else if (myRole === 'vip') { finalPrice = pVip > 0 ? pVip : pClient; }

            // --- Etiquetas ---
            let labelText = 'CLIENTE', labelBg = 'bg-gray-100 text-gray-500 border-gray-200', priceColor = 'text-gray-800';
            if (myRole === 'lider') { labelText = 'PRECIO LÍDER'; labelBg = 'bg-amber-100 text-amber-700 border-amber-200'; priceColor = 'text-amber-600'; }
            else if (myRole === 'reseller') { labelText = 'PRECIO REVENDEDOR'; labelBg = 'bg-indigo-100 text-indigo-700 border-indigo-200'; priceColor = 'text-indigo-600'; }
            else if (myRole === 'vip') { labelText = 'PRECIO VIP'; labelBg = 'bg-purple-100 text-purple-700 border-purple-200'; priceColor = 'text-purple-600'; }

            // --- Footer de Stock ---
            let stockFooterHtml = '';
            let imageOverlayHtml = '';

            if (isInfiniteCat) {
                stockFooterHtml = `<span class="text-[9px] font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded border border-blue-100 uppercase">∞ Ilimitado</span>`;
            } else if (!hasStock) {
                imageOverlayHtml = `<div class="absolute inset-0 z-20 flex items-center justify-center"><div class="absolute inset-0 bg-white/60 backdrop-blur-[1px]"></div><span class="relative bg-rose-600 text-white text-[10px] font-black px-3 py-1 rounded shadow-lg -rotate-6 border-2 border-white tracking-widest">AGOTADO</span></div>`;
                stockFooterHtml = `<span class="text-[9px] font-bold text-rose-400 uppercase">Sin Stock</span>`;
            } else {
                stockFooterHtml = `<span class="text-[9px] font-bold text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded border border-emerald-100 uppercase">Stock: ${stock}</span>`;
            }

            // --- AQUÍ ESTÁ EL CAMBIO: TIEMPO DE ENTREGA ---
            let deliveryHtml = '';
            if (p.deliveryTime && p.deliveryTime.trim() !== '') {
                deliveryHtml = `
                <div class="mb-2">
                    <span class="inline-flex items-center gap-1 text-[10px] font-bold text-indigo-600 bg-indigo-50 border border-indigo-100 px-2 py-0.5 rounded-md">
                        <i data-lucide="clock" class="w-3 h-3"></i> ${p.deliveryTime}
                    </span>
                </div>`;
            }

            const opacityClass = !hasStock ? 'opacity-90 grayscale-[0.5]' : '';
            const card = document.createElement('div');
            card.className = `${opacityClass} bg-white p-3 rounded-3xl shadow-sm hover:shadow-xl hover:shadow-indigo-100/50 border border-gray-100 transition-all duration-300 cursor-pointer group flex flex-col justify-between`;
            
            card.innerHTML = `
                <div onclick="buyProduct('${p.id}', '${p.name}', ${finalPrice}, ${stock}, '${safeDesc}', '${p.imageUrl}', '${p.category}', '${p.deliveryTime || ''}')" class="h-full flex flex-col">
                    <div class="relative w-full aspect-[4/3] bg-gray-50 rounded-2xl overflow-hidden mb-3 border border-gray-50 group-hover:border-indigo-100 transition-colors">
                        ${imageOverlayHtml}
                        <img src="${p.imageUrl}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" loading="lazy">
                    </div>
                    <div class="px-1 flex-1 flex flex-col">
                        <h4 class="font-bold text-gray-800 text-xs leading-snug line-clamp-2 mb-1 group-hover:text-indigo-600 transition-colors pr-2">${p.name}</h4>
                        <p class="text-[10px] text-gray-400 line-clamp-1 mb-2">${p.description || 'Entrega automática'}</p>
                        
                        ${deliveryHtml}
                        
                        <div class="mt-auto pt-3 border-t border-gray-50 flex items-center justify-between">
                            <div class="flex flex-col items-start">
                                ${stockFooterHtml}
                                <div class="mt-1.5">
                                    <span class="text-[7px] font-black uppercase px-1.5 py-0.5 rounded border ${labelBg} mb-0.5 inline-block tracking-wider">${labelText}</span>
                                    <div class="text-lg font-black ${priceColor}">$${finalPrice}</div>
                                </div>
                            </div>
                            <button class="w-10 h-10 rounded-full bg-gray-50 text-indigo-600 flex items-center justify-center group-hover:bg-indigo-600 group-hover:text-white transition-all shadow-sm">
                                <i data-lucide="shopping-cart" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>`;
            grid.appendChild(card);
        });

        if(visibleCount === 0) {
            grid.innerHTML = `
                <div class="col-span-full py-20 text-center text-gray-400 font-bold text-sm flex flex-col items-center">
                    <i data-lucide="package-open" class="w-10 h-10 mb-2 opacity-50"></i>
                    <p>No hay productos disponibles por ahora.</p>
                </div>`;
        }
        lucide.createIcons();
    });
};


  // ======================================================
        // FIN BLOQUE 3
        // ======================================================


// ======================================================
// FUNCIÓN PUENTE DE COMPRA (PERMISO, ANTECEDENTES, COVID, ETC)
// ======================================================
window.buyProduct = (id, name, price, stock, description, imageUrl, category, deliveryTime) => {
    const desc = decodeURIComponent(description);
    
    // 1. Categorías Infinitas
    const safeCategory = (category || 'general').toLowerCase();
    const isDoc = safeCategory.includes('document') || safeCategory.includes('tramite');
    const isLib = safeCategory.includes('liberacion') || safeCategory.includes('movil');
    const isBook = safeCategory.includes('libro');
    const isInfinite = isDoc || isLib || isBook;
    const isStock = isInfinite || stock > 0;

    const btnClass = isStock ? "bg-gray-900 text-white hover:bg-black shadow-xl shadow-gray-200 hover:shadow-gray-300 active:scale-95" : "bg-gray-100 text-gray-400 cursor-not-allowed border border-gray-200";
    const btnText = isStock ? "Confirmar Compra" : "Agotado";

    // 2. DETECCIÓN INTELIGENTE DE PRODUCTO
    const lowerName = name.toLowerCase();
    
    // Casos especiales
    const isCFE = lowerName.includes("cfe") || lowerName.includes("luz");
    const isSemanas = lowerName.includes("semanas") && lowerName.includes("cotizadas");
    const isCovid = lowerName.includes("covid") || lowerName.includes("vacunacion");
    const isAntecedentes = lowerName.includes("antecedentes") || lowerName.includes("penales");
    const isPermiso = lowerName.includes("permiso") && (lowerName.includes("circular") || lowerName.includes("placas")); // NUEVO CASO PERMISO

    // ¿Requiere input simple?
    const needsSimpleInput = (lowerName.includes("acta") || lowerName.includes("curp") || lowerName.includes("rfc") || lowerName.includes("constancia") || isLib || lowerName.includes("imei") || isCFE) && !isSemanas && !isCovid && !isAntecedentes && !isPermiso;

    // Configuración del Botón
    let btnAction = "";
    if (isStock) {
        if (isPermiso) {
            btnAction = `validatePermisoCirculacionAndPurchase('${id}', '${name}', ${price}, '${category}')`; // ACCIÓN PERMISO
        } else if (isAntecedentes) {
            btnAction = `validateAntecedentesAndPurchase('${id}', '${name}', ${price}, '${category}')`;
        } else if (isSemanas) {
            btnAction = `validateSemanasAndPurchase('${id}', '${name}', ${price}, '${category}')`;
        } else if (isCovid) {
            btnAction = `validateCovidAndPurchase('${id}', '${name}', ${price}, '${category}')`;
        } else if (needsSimpleInput) {
            btnAction = `validateCurpAndPurchase('${id}', '${name}', ${price}, '${category}')`;
        } else {
            btnAction = `processPurchase('${id}', '${name}', ${price}, '${category}')`;
        }
    }

    // 3. GENERACIÓN DEL HTML DE LOS INPUTS
    let specialInputHtml = '';

    // A) CASO PERMISO PARA CIRCULAR (8 CAMPOS)
    if (isPermiso) {
        specialInputHtml = `
        <div class="mt-4 animate-in fade-in slide-in-from-bottom-2 space-y-3">
            <input type="hidden" id="purchase-curp">
            
            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest border-b border-gray-100 pb-1 mb-2">Datos del Vehículo</p>
            
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">No. Serie (VIN)</label>
                    <input type="text" id="input-permiso-serie" class="neumo-inset w-full bg-gray-50 border-gray-100 rounded-lg p-2.5 text-xs font-bold uppercase text-gray-700 focus:ring-1 focus:ring-indigo-500" required>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">No. Motor</label>
                    <input type="text" id="input-permiso-motor" class="neumo-inset w-full bg-gray-50 border-gray-100 rounded-lg p-2.5 text-xs font-bold uppercase text-gray-700" required>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Marca</label>
                    <input type="text" id="input-permiso-marca" class="neumo-inset w-full bg-gray-50 border-gray-100 rounded-lg p-2.5 text-xs font-bold uppercase text-gray-700" placeholder="Ej: Nissan" required>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Modelo (Año)</label>
                    <input type="text" id="input-permiso-modelo" class="neumo-inset w-full bg-gray-50 border-gray-100 rounded-lg p-2.5 text-xs font-bold uppercase text-gray-700" placeholder="Ej: 2015" required>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Línea</label>
                    <input type="text" id="input-permiso-linea" class="neumo-inset w-full bg-gray-50 border-gray-100 rounded-lg p-2.5 text-xs font-bold uppercase text-gray-700" placeholder="Ej: Versa" required>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Color</label>
                    <input type="text" id="input-permiso-color" class="neumo-inset w-full bg-gray-50 border-gray-100 rounded-lg p-2.5 text-xs font-bold uppercase text-gray-700" placeholder="Ej: Rojo" required>
                </div>
            </div>

            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest border-b border-gray-100 pb-1 mb-2 mt-2">Datos del Propietario</p>

            <div>
                <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Nombre Dueño / Conductor</label>
                <input type="text" id="input-permiso-nombre" class="neumo-inset w-full bg-gray-50 border-gray-100 rounded-lg p-2.5 text-xs font-bold uppercase text-gray-700" required>
            </div>

            <div>
                <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Dirección Completa</label>
                <input type="text" id="input-permiso-direccion" class="neumo-inset w-full bg-gray-50 border-gray-100 rounded-lg p-2.5 text-xs font-bold uppercase text-gray-700" placeholder="Calle, Número, Colonia, Ciudad, Estado" required>
            </div>
            
            <p class="text-[9px] text-gray-400 italic mt-1 text-center">Verifica los datos del vehículo.</p>
        </div>`;
    }
    // B) CASO ANTECEDENTES (7 CAMPOS)
    else if (isAntecedentes) {
        specialInputHtml = `
        <div class="mt-4 animate-in fade-in slide-in-from-bottom-2 space-y-3">
            <input type="hidden" id="purchase-curp">
            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest border-b border-gray-100 pb-1 mb-2">Datos Personales</p>
            <div><label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Nombres</label><input type="text" id="input-ant-nombres" class="neumo-inset w-full bg-gray-50 border-gray-100 rounded-lg p-2.5 text-xs font-bold uppercase text-gray-700" required></div>
            <div class="grid grid-cols-2 gap-3"><div><label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Apellido Paterno</label><input type="text" id="input-ant-paterno" class="neumo-inset w-full bg-gray-50 border-gray-100 rounded-lg p-2.5 text-xs font-bold uppercase text-gray-700" required></div><div><label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Apellido Materno</label><input type="text" id="input-ant-materno" class="neumo-inset w-full bg-gray-50 border-gray-100 rounded-lg p-2.5 text-xs font-bold uppercase text-gray-700"></div></div>
            <div class="grid grid-cols-2 gap-3"><div><label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Fecha Nacimiento</label><input type="text" id="input-ant-fecha" class="neumo-inset w-full bg-gray-50 border-gray-100 rounded-lg p-2.5 text-xs font-bold text-gray-700" placeholder="DD/MM/AAAA" required></div><div><label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Clave Elector (INE)</label><input type="text" id="input-ant-clave" class="neumo-inset w-full bg-gray-50 border-gray-100 rounded-lg p-2.5 text-xs font-bold uppercase text-gray-700"></div></div>
            <div><label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">CURP</label><input type="text" id="input-ant-curp" class="neumo-inset w-full bg-indigo-50/50 border-indigo-100 rounded-lg p-2.5 text-xs font-bold uppercase text-indigo-800" required></div>
            <div><label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Domicilio Completo</label><input type="text" id="input-ant-domicilio" class="neumo-inset w-full bg-gray-50 border-gray-100 rounded-lg p-2.5 text-xs font-bold uppercase text-gray-700" required></div>
        </div>`;
    } 
    // C) CASO SEMANAS (CURP + NSS)
    else if (isSemanas) {
        specialInputHtml = `
        <div class="mt-4 animate-in fade-in slide-in-from-bottom-2 space-y-3">
            <input type="hidden" id="purchase-curp">
            <div><label class="block text-xs font-bold text-indigo-600 uppercase mb-1">CURP</label><input type="text" id="input-sem-curp" class="neumo-inset w-full bg-indigo-50/50 border-indigo-100 rounded-xl p-3 text-sm font-bold uppercase text-gray-700 placeholder-indigo-300 focus:ring-2 focus:ring-indigo-500 transition-all" required></div>
            <div><label class="block text-xs font-bold text-indigo-600 uppercase mb-1">NSS (Seguro Social)</label><input type="number" id="input-sem-nss" class="neumo-inset w-full bg-indigo-50/50 border-indigo-100 rounded-xl p-3 text-sm font-bold uppercase text-gray-700 placeholder-indigo-300 focus:ring-2 focus:ring-indigo-500 transition-all" required></div>
            <p class="text-[9px] text-gray-400 ml-1">Ambos datos son obligatorios.</p>
        </div>`;
    } 
    // D) CASO COVID
    else if (isCovid) {
        specialInputHtml = `
        <div class="mt-4 animate-in fade-in slide-in-from-bottom-2 space-y-3">
            <input type="hidden" id="purchase-curp">
            <div><label class="block text-xs font-bold text-indigo-600 uppercase mb-1">Nombre Completo</label><input type="text" id="input-covid-nombre" class="neumo-inset w-full bg-indigo-50/50 border-indigo-100 rounded-xl p-3 text-sm font-bold uppercase text-gray-700" required></div>
            <div><label class="block text-xs font-bold text-indigo-600 uppercase mb-1">CURP</label><input type="text" id="input-covid-curp" class="neumo-inset w-full bg-indigo-50/50 border-indigo-100 rounded-xl p-3 text-sm font-bold uppercase text-gray-700" required></div>
        </div>`;
    }
    // E) CASO NORMAL
    else if (needsSimpleInput) {
        let inputLabel = "Dato / CURP";
        let placeholderText = "Escribe aquí...";
        if (isLib || lowerName.includes("imei")) { inputLabel = "Código IMEI / Serie"; placeholderText = "Ej: 352..."; } 
        else if (isCFE) { inputLabel = "Número de Servicio"; placeholderText = "Ej: 123456789012"; }

        specialInputHtml = `
        <div class="mt-4 animate-in fade-in slide-in-from-bottom-2">
            <label class="block text-xs font-bold text-indigo-600 uppercase mb-1">${inputLabel} (Obligatorio)</label>
            <input type="text" id="purchase-curp" class="neumo-inset w-full bg-indigo-50/50 border-indigo-100 rounded-xl p-3 text-sm font-bold uppercase text-gray-700 placeholder-indigo-300 focus:ring-2 focus:ring-indigo-500 transition-all" placeholder="${placeholderText}" required>
            <p class="text-[9px] text-gray-400 mt-1 ml-1">Requerido para el servicio.</p>
        </div>`;
    }

    const html = `
    <div class="flex flex-col md:flex-row h-full w-full bg-white overflow-hidden relative">
        <div class="relative w-full md:w-5/12 h-48 md:h-auto bg-gray-50 flex-shrink-0 group overflow-hidden">
            <img src="${imageUrl}" class="w-full h-full object-cover transition-transform hover:scale-105 duration-700">
            <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent md:bg-gradient-to-r md:from-transparent md:to-black/10 opacity-60"></div>
            <button onclick="closeModal()" class="md:hidden absolute top-4 right-4 bg-black/20 backdrop-blur-md p-2.5 rounded-full text-white border border-white/10 shadow-lg active:scale-90 z-20"><i data-lucide="x" class="w-5 h-5"></i></button>
            <div class="absolute bottom-4 left-4">
                <span class="bg-white/90 backdrop-blur text-gray-900 text-[10px] font-black uppercase tracking-widest px-3 py-1 rounded-lg shadow-sm border border-white/50">${category || 'Digital'}</span>
            </div>
        </div>
        <div class="flex-1 p-6 md:p-8 flex flex-col relative">
            <button onclick="closeModal()" class="hidden md:flex absolute top-6 right-6 text-gray-400 hover:text-rose-500 hover:bg-rose-50 transition-all p-2.5 rounded-full z-10"><i data-lucide="x" class="w-6 h-6"></i></button>
            
            <div class="mb-2 text-center md:text-left md:mt-4">
                <h2 class="text-xl md:text-2xl font-black text-gray-800 leading-tight mb-2 line-clamp-2">${name}</h2>
                <div class="flex items-center justify-center md:justify-start gap-2">
                    <div class="w-2 h-2 rounded-full ${isStock ? 'bg-emerald-500' : 'bg-rose-500'}"></div>
                    <span class="text-[11px] font-bold ${isStock ? 'text-emerald-600' : 'text-rose-500'} uppercase tracking-wide">
                        ${isInfinite ? 'Disponibilidad Ilimitada' : (isStock ? `Disponible (${stock})` : 'Agotado')}
                    </span>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto scrollbar-hide mb-2 pr-2 text-center md:text-left mt-2 max-h-[250px]">
                <p class="text-xs text-gray-500 font-medium leading-relaxed">${desc || 'Producto verificado.'}</p>
                ${specialInputHtml}
            </div>

            <div class="py-5 border-t border-gray-50 flex flex-col items-center justify-center mt-4">
                <div class="flex items-baseline gap-1 mb-5">
                    <span class="text-xl font-bold text-[var(--color-accent)] opacity-70 mr-1">$</span>
                    <span class="text-4xl font-black tracking-tight text-[var(--color-accent)]">${price}</span>
                    <span class="text-xs font-bold text-gray-400 self-end mb-1 ml-1">MXN</span>
                </div>
                <button onclick="${btnAction}" ${!isStock ? 'disabled' : ''} class="w-full py-3.5 rounded-xl font-bold text-sm tracking-wide uppercase transition-all flex items-center justify-center gap-2 ${btnClass}">
                    <i data-lucide="${isStock ? 'check-circle' : 'ban'}" class="w-4 h-4"></i> ${btnText}
                </button>
            </div>
        </div>
    </div>`;

    const m = document.getElementById('app-modal');
    const content = document.getElementById('modal-content');
    content.innerHTML = html;
    m.classList.remove('hidden');
    lucide.createIcons();
};


  // ==========================================
// VALIDAR CURP ANTES DE COMPRAR
// ==========================================
window.validateCurpAndPurchase = (id, name, price, category) => {
    const curpInput = document.getElementById('purchase-curp');
    if (!curpInput) return;
    
    const curpValue = curpInput.value.trim().toUpperCase();
    
    // Validación básica: que no esté vacío
    if (curpValue.length < 5) {
        showToast('⚠️ Ingresa un dato válido.', 'error');
        curpInput.focus();
        curpInput.classList.add('ring-2', 'ring-rose-500', 'bg-rose-50');
        setTimeout(() => curpInput.classList.remove('ring-2', 'ring-rose-500', 'bg-rose-50'), 2000);
        return;
    }

    // Pasamos category a la función final
    window.processPurchase(id, name, price, category);
};





                     // ==========================================
// PROCESAR COMPRA (LÓGICA FINAL CORREGIDA)
// ==========================================
window.processPurchase = async (pid, name, price, categoryRaw) => {
    const btn = document.querySelector('button[onclick*="processPurchase"]');
    const inputValue = document.getElementById('purchase-curp')?.value; // CURP o IMEI
    
    if(btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></span> Procesando...';
    }

    try {
        const cat = (categoryRaw || '').toLowerCase();
        
        // --- 1. CLASIFICACIÓN DEL PRODUCTO ---
        // A) Documentos para Panel Admin (Sin ticket inmediato)
        const isDocPanel = cat.includes('document') || cat.includes('tramite') || name.toLowerCase().includes('acta');
        
        // B) Liberaciones (Ticket inmediato + Stock Infinito + Datos Reales)
        const isLib = cat.includes('liberacion') || cat.includes('movil') || name.toLowerCase().includes('imei');

        let itemId = null;
        let itemDetails = {};

        // --- 2. OBTENCIÓN DE DATOS (CORRECCIÓN TICKET LIBERACIÓN) ---
        // Si NO es un documento de panel, NECESITAMOS datos reales del inventario para el ticket.
        // Esto aplica tanto para productos normales como para Liberaciones.
        if (!isDocPanel) {
            // Buscamos el primer ítem disponible que haya puesto el admin
            const qInv = query(collection(db, 'artifacts', appId, 'public', 'data', 'inventory_items'), where('productId', '==', pid), where('status', '==', 'available'), limit(1));
            const invSnap = await getDocs(qInv);

            // Si el admin no ha puesto nada en el inventario (ni siquiera las instrucciones genéricas)
            if(invSnap.empty) {
                 throw new Error("Producto no disponible temporalmente para entrega inmediata.");
            }
            
            // ¡Aquí obtenemos los datos reales (cuentas, instrucciones)!
            const itemDoc = invSnap.docs[0];
            itemId = itemDoc.id;
            itemDetails = itemDoc.data();

        } else {
            // Datos dummy solo para Documentos de Panel (porque no llevan ticket)
            itemDetails = { 
                serviceName: name, 
                isDocumentRequest: true
            };
        }

        await runTransaction(db, async (t) => {
            // --- 3. COBRO (Igual que siempre) ---
            const wRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'wallet', 'main');
            const wSnap = await t.get(wRef);
            const currentBalance = Number(wSnap.data().balance) || 0;
            const cost = Number(price);

            if(currentBalance < cost) throw new Error("Saldo insuficiente. Por favor recarga.");
            t.update(wRef, { balance: (currentBalance - cost) });

            // --- 4. ACTUALIZACIÓN DE STOCK (LA CLAVE DEL INFINITO) ---
            // Solo descontamos stock si es producto NORMAL (Ni DocPanel, Ni Liberación)
            if (!isDocPanel && !isLib && itemId) {
                // Marcar como vendido (se gasta)
                t.update(doc(db, 'artifacts', appId, 'public', 'data', 'inventory_items', itemId), { 
                    status: 'sold', 
                    soldTo: currentUser.uid, 
                    soldAt: serverTimestamp(),
                    soldPrice: cost 
                });
                // Restar 1 al contador visual
                const pRef = doc(db, 'artifacts', appId, 'public', 'data', 'profiles', pid);
                t.update(pRef, { stock: increment(-1) });
            }
            // NOTA IMPORTANTE: Si es 'isLib', usamos los datos de 'itemId' para el ticket, 
            // pero NO ejecutamos el bloque de arriba, por lo que el stock NO baja.

            // --- 5. REGISTRO DE TRANSACCIÓN ---
            // Preparamos los detalles para el historial y el ticket
            const finalDetails = { 
                serviceName: name, 
                category: categoryRaw,
                userInputStr: inputValue || null, // El IMEI o CURP que escribió el cliente
                ...itemDetails // Los datos reales del admin (instrucciones, cuentas, etc.)
            };
            
            t.set(doc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions')), {
                type: 'purchase',
                amount: cost,
                description: `Compra: ${name}`,
                details: finalDetails,
                timestamp: serverTimestamp(),
                status: isDocPanel ? 'pending' : 'completed' 
            });

            // --- 6. SOLO SI ES DOC PANEL: ENVIAR AL ADMIN ---
            if (isDocPanel) {
                const reqRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'document_requests'));
                t.set(reqRef, {
                    uid: currentUser.uid,
                    buyerEmail: currentUser.email,
                    serviceName: name,
                    curp: inputValue || 'Sin dato',
                    pricePaid: cost,
                    status: 'pending',
                    timestamp: serverTimestamp(),
                    downloadUrl: ''
                });
            }
        });

        // Comisión Referido
        try { await processReferralCommission(currentUser.uid, price); } catch(e){}

        showToast('¡Procesado exitosamente!', 'success');
        closeModal();
        
        // --- 7. DECISIÓN FINAL DE UI ---
        if (isDocPanel) {
            // Si es Acta/Trámite -> Aviso de espera
            showToast('Solicitud enviada. Revisa "Mis Documentos".', 'info');
        } else {
            // Si es Liberación o Normal -> TICKET CON DATOS REALES
            // Ahora 'itemDetails' sí trae la info del admin.
            showTicketModal({
                serviceName: name,
                category: categoryRaw,
                userInputStr: inputValue, // Para mostrar el IMEI en el ticket
                ...itemDetails
            });
        }

    } catch (e) {
        let m = e.message || "Error desconocido";
        if(m.includes("Saldo") || m.includes("insuficiente")) openChargeModal();
        else showToast(m, 'error');
        
        if(btn) {
            btn.disabled = false;
            btn.innerHTML = "Confirmar Compra";
        }
    }
};
    

                window.showTicketModal = (item) => {
            // Datos seguros (si no existen, quedan como string vacío)
            const srv = item.serviceName || item.name || 'Servicio';
            const folio = item.folio || '';
            const email = item.email || '';
            const pass = item.password || '';
            const profile = item.profileName || '';
            const pin = item.pin || '';
            const link = item.link || '';
            const exp = item.expiryDate || '';
            const dur = item.duration || '';
            
            const termsEnc = item.terms ? encodeURIComponent(item.terms) : '';
            const descEnc = item.description ? encodeURIComponent(item.description) : '';

            // Construir HTML fila por fila (Solo si hay datos)
            let detailsHtml = '';

            if (folio) detailsHtml += `
                <div class="flex justify-between items-center py-2 border-b border-gray-100">
                    <span class="text-xs font-bold text-gray-400 uppercase">Folio / ID</span>
                    <span class="text-sm font-bold text-indigo-600 font-mono select-all">${folio}</span>
                </div>`;

            if (email) detailsHtml += `
                <div class="flex justify-between items-center py-2 border-b border-gray-100">
                    <span class="text-xs font-bold text-gray-400 uppercase">Correo / Usuario</span>
                    <span class="text-sm font-bold text-gray-800 select-all text-right break-all">${email}</span>
                </div>`;

            if (pass) detailsHtml += `
                <div class="flex justify-between items-center py-2 border-b border-gray-100">
                    <span class="text-xs font-bold text-gray-400 uppercase">Contraseña</span>
                    <span class="text-sm font-bold text-gray-800 select-all font-mono">${pass}</span>
                </div>`;

            if (profile) detailsHtml += `
                <div class="flex justify-between items-center py-2 border-b border-gray-100">
                    <span class="text-xs font-bold text-gray-400 uppercase">Perfil</span>
                    <span class="text-sm font-bold text-gray-800">${profile}</span>
                </div>`;

            if (pin) detailsHtml += `
                <div class="flex justify-between items-center py-2 border-b border-gray-100">
                    <span class="text-xs font-bold text-gray-400 uppercase">PIN</span>
                    <span class="text-sm font-bold text-gray-800 font-mono">${pin}</span>
                </div>`;

            if (link) detailsHtml += `
                <div class="flex flex-col py-2 border-b border-gray-100 gap-1">
                    <span class="text-xs font-bold text-gray-400 uppercase">Enlace / Link</span>
                    <a href="${link}" target="_blank" class="text-sm font-bold text-blue-500 truncate hover:underline">${link}</a>
                </div>`;

            if (item.description) detailsHtml += `
                <div class="flex flex-col py-2 border-b border-gray-100 gap-1">
                    <span class="text-xs font-bold text-gray-400 uppercase">Instrucciones / Código</span>
                    <div class="bg-gray-50 p-2 rounded-lg border border-gray-100">
                        <p class="text-xs text-gray-700 whitespace-pre-wrap font-mono select-all">${item.description}</p>
                    </div>
                </div>`;

            openModal(`
                <div class="text-center bounce-enter pt-4">
                    <div class="w-16 h-16 bg-success/10 text-success rounded-full flex items-center justify-center mx-auto mb-4 neumo-card neumo-inset">
                        <i data-lucide="check-circle-2" class="w-8 h-8"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">¡Entrega Exitosa!</h3>
                    <p class="text-xs text-gray-400 mb-6">Guarda tu comprobante</p>
                    
                    <div class="neumo-card neumo-inset p-5 text-left mb-6 max-h-[55vh] overflow-y-auto">
                        <p class="text-center font-black text-lg text-gray-800 mb-4 border-b border-gray-200 pb-2">${srv}</p>
                        
                        ${detailsHtml}

                        ${(exp || dur) ? `
                        <div class="grid grid-cols-2 gap-4 mt-4 pt-2">
                            <div><span class="block text-[10px] font-bold text-gray-400 uppercase">Duración</span><span class="text-xs font-bold text-gray-700">${dur || '-'}</span></div>
                            <div class="text-right"><span class="block text-[10px] font-bold text-gray-400 uppercase">Expiración</span><span class="text-xs font-bold text-rose-500">${exp || '-'}</span></div>
                        </div>` : ''}
                    </div>

                    <div class="flex gap-2">
                        <button onclick="closeModal()" class="flex-1 neumo-button bg-gray-100 text-gray-500 font-bold py-3 rounded-xl hover:bg-gray-200 text-xs">Cerrar</button>
                        <button onclick="copyTicketData('${srv}', '${folio}', '${email}', '${pass}', '${profile}', '${pin}', '${link}', '${exp}', '${dur}', '${termsEnc}', '${descEnc}')" class="flex-1 neumo-button bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700 flex items-center justify-center gap-2 text-xs">
                            <i data-lucide="copy" class="w-4 h-4"></i> Copiar Todo
                        </button>
                    </div>
                </div>
            `);
            lucide.createIcons();
        };

        window.copyTicketData = (srv, folio, email, pass, profile, pin, link, exp, dur, terms, desc) => {
            let text = `📦 *COMPRA EXITOSA - STREAM EVOLUTION*\n\n`;
            text += `📌 *Producto:* ${srv}\n`;

            if (folio && folio !== 'null' && folio !== '') text += `🆔 *Folio:* ${folio}\n`;
            if (email && email !== 'null' && email !== '') text += `📧 *Correo/User:* ${email}\n`;
            if (pass && pass !== 'null' && pass !== '') text += `🔑 *Contraseña:* ${pass}\n`;
            if (profile && profile !== 'null' && profile !== '') text += `👤 *Perfil:* ${profile}\n`;
            if (pin && pin !== 'null' && pin !== '') text += `🔒 *PIN:* ${pin}\n`;
            if (link && link !== 'null' && link.includes('http')) text += `🔗 *Enlace:* ${link}\n`;
            
            if (desc && desc !== 'null' && desc !== '') text += `📝 *Detalles:* ${decodeURIComponent(desc)}\n`;
            
            if (exp && exp !== 'null') text += `\n📅 *Expiración:* ${exp}`;
            if (dur && dur !== 'null') text += `\n⏳ *Duración:* ${dur}`;
            
            if (terms && terms !== 'null') text += `\n\n⚠️ *Términos:* ${decodeURIComponent(terms)}`;

            text += `\n\n✅ *Gracias por tu preferencia*`;

            navigator.clipboard.writeText(text).then(() => {
                showToast('Ticket copiado al portapapeles', 'success');
            });
        };



                 // ==========================================
        // NUEVA FUNCIÓN: MARCAR COMO LEÍDO (Paso 1)
        // ==========================================
        window.markAsRead = async (id) => {
            try {
                // 1. Buscamos si ya está leída localmente para no gastar recursos
                const t = window.userTransactions.find(x => x.id === id);
                if (t && t.isRead) return; 

                // 2. Si es nueva, la marcamos como leída en la Base de Datos
                const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions', id);
                await updateDoc(docRef, { isRead: true });
                
                // (El sistema detectará el cambio y bajará el contador solo)
            } catch (e) {
                console.log("Error al marcar visto", e);
            }
        };
         
           // ======================================================
        // MOVIMIENTOS: DISEÑO PREMIUM (ESTILO BANCARIO)
        // ======================================================
        window.openNotifications = () => { 
            // 1. Ocultar punto rojo
            const dot = document.getElementById('notification-dot'); 
            if(dot) dot.style.display='none'; 

            // 2. Recopilar todos los datos
            let all = [...window.globalNotifications, ...window.userTransactions]; 
            
            // Si es admin, agregamos las pendientes también
            if(isAdmin){
                all = [...all, ...window.adminPendingRequests, ...window.adminPendingReports, ...window.adminPendingRenewals];
            } 
            
            // 3. Ordenar por fecha (más reciente arriba)
            all.sort((a,b)=>(b.timestamp?.toMillis()||0)-(a.timestamp?.toMillis()||0)); 

            let listHtml = '';

            if(all.length === 0) {
                listHtml = `
                    <div class="flex flex-col items-center justify-center py-16 opacity-60 text-center">
                        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4 neumo-inset">
                            <i data-lucide="clock" class="w-8 h-8 text-gray-400"></i>
                        </div>
                        <h3 class="text-sm font-bold text-gray-500">Sin movimientos</h3>
                        <p class="text-xs text-gray-400 mt-1">Tu actividad aparecerá aquí.</p>
                    </div>`; 
            } else {
                all.forEach(t => { 
                    // --- LÓGICA DE APARIENCIA SEGÚN TIPO ---
                    let icon='circle', iconColor='text-gray-400', iconBg='bg-gray-100';
                    let title = t.title || t.description || t.email || 'Detalle';
                    let amountDisplay = '';
                    let statusBadge = '';

                    // A. DEPÓSITOS (Recargas)
                    if(t.type === 'deposit'){
                        const status = (t.status || '').toLowerCase();
                        if(status === 'pending' || status === 'pendiente'){ 
                            icon='clock'; iconColor='text-amber-600'; iconBg='bg-amber-100'; 
                            title = 'Recarga Pendiente';
                            statusBadge = `<span class="text-[9px] font-bold text-amber-600 bg-amber-50 px-1.5 py-0.5 rounded border border-amber-100 ml-2">En Revisión</span>`;
                        } else if (['rejected', 'cancelled', 'rechazado', 'cancelado'].includes(status)) { 
                            icon='x'; iconColor='text-rose-500'; iconBg='bg-rose-100'; 
                            title = 'Recarga Cancelada';
                            amountDisplay = `<span class="text-xs font-bold text-gray-400 line-through">$${t.amount}</span>`;
                        } else { 
                            icon='arrow-down-left'; iconColor='text-emerald-600'; iconBg='bg-emerald-100'; 
                            title = 'Recarga Exitosa';
                            amountDisplay = `<span class="text-sm font-black text-emerald-600">+$${Number(t.amount).toLocaleString()}</span>`;
                        }
                    
                    // B. COMPRAS
                    } else if(t.type === 'purchase'){ 
                        icon='shopping-bag'; iconColor='text-indigo-600'; iconBg='bg-indigo-100';
                        title = t.description.replace('Compra: ', ''); // Limpiamos el texto
                        amountDisplay = `<span class="text-sm font-bold text-gray-800">-$${Number(t.amount).toLocaleString()}</span>`;
                    
                    // C. CARGOS / MULTAS
                    } else if(t.type === 'charge'){ 
                        icon='alert-octagon'; iconColor='text-rose-600'; iconBg='bg-rose-100'; 
                        amountDisplay = `<span class="text-sm font-bold text-rose-600">-$${Math.abs(t.amount).toLocaleString()}</span>`;
                    
                                // D. SOPORTE / RESPUESTAS
            } else if(t.type === 'support_reply'){
                icon='message-circle';
                iconColor='text-blue-600';
                iconBg='bg-blue-100';
                
                // AQUÍ ESTÁ EL CAMBIO: Si hay nombre de servicio, lo usamos en el título
                title = t.reportServiceName ? `Respuesta: ${t.reportServiceName}` : 'Respuesta Soporte';
                
                amountDisplay = `<span class="text-[10px] font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded">LEER</span>`;
                    
                    // E. RENOVACIONES
                    } else if(t.type === 'renewal'){ 
                        icon='refresh-cw'; iconColor='text-purple-600'; iconBg='bg-purple-100'; 
                        title = 'Solicitud Renovación';
                        statusBadge = `<span class="text-[9px] font-bold text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded border border-gray-200 ml-2">Enviada</span>`;
                        
                        // NUEVO TIPO DE NOTIFICACIÓN: DOCUMENTO LISTO
} else if (t.type === 'document_ready') {
    icon = 'file-check';
    iconColor = 'text-indigo-600';
    iconBg = 'bg-indigo-50';
    title = '¡Tu documento está listo!';
    amountDisplay = `
    <button onclick="window.open('${t.details?.downloadUrl}', '_blank')" class="text-[10px] bg-indigo-600 text-white px-3 py-1.5 rounded-lg font-bold shadow-sm hover:bg-indigo-700 flex items-center gap-1 transition-colors">
        <i data-lucide="download" class="w-3 h-3"></i> Descargar
    </button>`;
                    
                    // F. NOTIFICACIONES GLOBALES
                    } else if(t.isGlobal){ 
                        icon='bell'; iconColor='text-orange-500'; iconBg='bg-orange-100'; 
                    }

                    // Formato Fecha
                    const dateStr = t.timestamp ? t.timestamp.toDate().toLocaleString([], {month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit'}) : 'Reciente';

                    // HTML DE LA TARJETA
                    listHtml += `
                    <div onclick="openTransactionDetail('${t.id}')" class="bg-white p-3.5 rounded-2xl shadow-sm border border-gray-100 mb-3 flex items-center gap-3 cursor-pointer hover:bg-gray-50 hover:shadow-md transition-all active:scale-95 group relative overflow-hidden">
                        <div class="w-10 h-10 rounded-full ${iconBg} ${iconColor} flex items-center justify-center flex-shrink-0 shadow-sm border border-white">
                            <i data-lucide="${icon}" class="w-5 h-5"></i>
                        </div>
                        
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start">
                                <h4 class="font-bold text-sm text-gray-800 truncate pr-2">${title}</h4>
                                <div class="flex-shrink-0 pl-1">${amountDisplay}</div>
                            </div>
                            <div class="flex items-center mt-0.5">
                                <span class="text-[10px] text-gray-400 font-medium tracking-wide">${dateStr}</span>
                                ${statusBadge}
                            </div>
                        </div>

                        <div class="absolute right-2 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity text-gray-300">
                            <i data-lucide="chevron-right" class="w-4 h-4"></i>
                        </div>
                    </div>`;
                }); 
            }

            // --- RENDERIZAR MODAL COMPLETO ---
            openModal(`
                <div class="bg-gray-50 rounded-[2rem] overflow-hidden relative bounce-enter flex flex-col h-[80vh]">
                    
                    <div class="bg-gradient-to-br from-indigo-600 to-violet-700 p-6 pb-12 text-center relative flex-shrink-0 shadow-lg z-10">
                        <div class="absolute top-0 left-0 w-full h-full opacity-20" style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 10px 10px;"></div>
                        
                        <div class="w-12 h-12 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center mx-auto mb-3 text-white shadow-xl border border-white/30 transform rotate-3">
                            <i data-lucide="activity" class="w-6 h-6"></i>
                        </div>
                        <h3 class="text-xl font-black text-white tracking-tight uppercase">Historial</h3>
                        <p class="text-[10px] text-indigo-200 font-medium uppercase tracking-widest">Tus movimientos recientes</p>
                    </div>

                    <div class="flex-1 overflow-y-auto scrollbar-hide px-4 pt-6 -mt-6 relative z-20">
                        ${listHtml}
                    </div>

                    <div class="p-4 bg-white border-t border-gray-200 z-30">
                        <button onclick="closeModal()" class="neumo-button w-full bg-gray-100 text-gray-500 font-bold py-3.5 rounded-xl hover:bg-gray-200 transition-colors">
                            Cerrar
                        </button>
                    </div>
                </div>
            `); 
            
            lucide.createIcons(); 
        };

                // ======================================================
        // DETALLE TRANSACCIÓN (Paso 3: Marca como leído al abrir)
        // ======================================================
        window.openTransactionDetail = (id) => {
            // 1. MARCAR COMO LEÍDO (Esto baja el contador inmediatamente)
            markAsRead(id);

            let t = window.userTransactions.find(x => x.id === id) || window.globalNotifications.find(x => x.id === id) || window.adminPendingRequests.find(x => x.id === id) || window.adminPendingRenewals.find(x => x.id === id); 
            if(!t) return;

            if(t.type === 'deposit') {
                let statusColor = 'text-success'; let statusText = 'Éxito';
                if(t.status==='Pending'||t.status==='pending'||t.status==='Pendiente'){ statusColor = 'text-accent'; statusText = 'Pendiente'; } 
                else if (['rejected','cancelled','Rechazado','Cancelado'].includes(t.status)) { statusColor = 'text-danger'; statusText = 'Cancelado'; }
                
                openModal(` <div class="text-center bounce-enter pt-4"> <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 neumo-card neumo-inset"><i data-lucide="dollar-sign" class="w-8 h-8 text-gray-500"></i></div> <h3 class="text-xl font-bold text-gray-800 mb-1">Detalle de Recarga</h3> <p class="text-xs text-gray-400 mb-6">${t.timestamp?.toDate().toLocaleString()}</p> <div class="neumo-card neumo-inset p-5 space-y-3 text-left"> <div class="flex justify-between"><span class="text-xs font-bold text-gray-400 uppercase">Monto</span><span class="font-bold text-success text-lg">$${t.amount.toLocaleString()}</span></div> <div class="flex justify-between"><span class="text-xs font-bold text-gray-400 uppercase">Estado</span><span class="font-bold ${statusColor} uppercase text-sm">${statusText}</span></div> ${t.prevBalance ? `<div class="flex justify-between border-t border-gray-200 pt-2"><span class="text-xs text-gray-400">Saldo Anterior</span><span class="text-xs font-mono">$${t.prevBalance}</span></div>` : ''} <div class="flex justify-between border-t border-gray-200 pt-2"><span class="text-xs font-bold text-gray-400 uppercase">Descripción</span><span class="text-xs font-medium text-gray-700">${t.description}</span></div> </div> <button onclick="openNotifications()" class="neumo-button mt-4 w-full bg-gray-900 text-white py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2"><i data-lucide="arrow-left" class="w-4 h-4"></i> Volver</button> </div> `);
            
            } else if (t.type === 'purchase' && t.details) { 
                showTicketModal({...t.details, serviceName: t.description}); 
            } else if (t.type === 'support_reply') { 
                openSupportReplyDetail(t.id); 
            } else if (t.type === 'renewal') { 
                if (isAdmin) { viewRenewalDetail(t.id); } else { openModal(`<div class="p-4 text-center"><p class="text-gray-500">Solicitud de Renovación enviada al administrador.</p><p class="text-xs text-gray-400 mt-2">${t.description}</p></div>`); } 
            } else { 
                openModal(`<div class="p-4 text-center"><p class="text-gray-500">${t.description || t.message || t.title}</p></div>`); 
            }
            lucide.createIcons();
        };
        
                // ======================================================
        // NUEVA FUNCIÓN: MODAL INFORMATIVO DE HORARIOS
        // ======================================================
        window.openChargeInfoModal = () => {
            openModal(`
            <div class="bounce-enter relative overflow-hidden bg-white rounded-[2rem]">
                
                <div class="bg-gray-900 p-6 pb-10 text-center relative z-10">
                    <div class="absolute top-0 left-0 w-full h-full opacity-20" style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 10px 10px;"></div>
                    
                    <div class="w-16 h-16 bg-white/10 backdrop-blur-md rounded-2xl flex items-center justify-center mx-auto mb-3 border border-white/20 shadow-lg">
                        <i data-lucide="clock" class="w-8 h-8 text-white"></i>
                    </div>
                    <h3 class="text-xl font-black text-white tracking-wide">Horarios de Recarga</h3>
                    <p class="text-[10px] text-gray-400 font-medium uppercase tracking-widest">Servicio Automático</p>
                </div>

                <div class="p-6 -mt-6 bg-white rounded-t-[2rem] relative z-20">
                    
                    <div class="space-y-3 mb-6">
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl border border-gray-100 hover:border-indigo-100 transition-colors">
                            <div class="flex items-center gap-2">
                                <i data-lucide="calendar-days" class="w-4 h-4 text-indigo-500"></i>
                                <span class="text-xs font-bold text-gray-600">Lun - Vie</span>
                            </div>
                            <span class="text-xs font-black text-gray-800 bg-white px-2 py-1 rounded border border-gray-200 shadow-sm">08:00 am - 11:00 pm</span>
                        </div>

                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl border border-gray-100 hover:border-indigo-100 transition-colors">
                            <div class="flex items-center gap-2">
                                <i data-lucide="calendar" class="w-4 h-4 text-indigo-500"></i>
                                <span class="text-xs font-bold text-gray-600">Sábados</span>
                            </div>
                            <span class="text-xs font-black text-gray-800 bg-white px-2 py-1 rounded border border-gray-200 shadow-sm">09:00 am - 10:30 pm</span>
                        </div>

                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl border border-gray-100 hover:border-indigo-100 transition-colors">
                            <div class="flex items-center gap-2">
                                <i data-lucide="sun" class="w-4 h-4 text-orange-500"></i>
                                <span class="text-xs font-bold text-gray-600">Domingos</span>
                            </div>
                            <span class="text-xs font-black text-gray-800 bg-white px-2 py-1 rounded border border-gray-200 shadow-sm">09:30 am - 10:00 pm</span>
                        </div>
                    </div>

                    <div class="bg-amber-50 border border-amber-100 p-4 rounded-xl flex gap-3 mb-6 relative overflow-hidden">
                        <div class="absolute left-0 top-0 bottom-0 w-1 bg-amber-400"></div>
                        <i data-lucide="alert-circle" class="w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5"></i>
                        <p class="text-[11px] text-amber-800 leading-relaxed font-medium">
                            Si realizas tu recarga fuera de estos horarios, tu saldo será asignado al <strong>día siguiente</strong> dentro de los horarios de servicio establecidos.
                        </p>
                    </div>

                    <button onclick="openChargeModal()" class="w-full bg-gray-900 text-white font-bold py-4 rounded-xl shadow-lg shadow-gray-200 hover:bg-black transform active:scale-95 transition-all flex items-center justify-center gap-2">
                        <span>Recargar</span>
                        <i data-lucide="arrow-right" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            `); 
            lucide.createIcons();
        };


            // ======================================================
        // MODAL CARGAR SALDO (DISEÑO PREMIUM + NOTA IMPORTANTE)
        // ======================================================
        window.openChargeModal = () => { 
            openModal(`
            <div class="bounce-enter relative overflow-hidden bg-white rounded-[2rem]">
                
                <div class="bg-gray-900 p-6 pb-8 text-center relative z-10">
                    <div class="absolute top-0 left-0 w-full h-full opacity-20" style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 10px 10px;"></div>
                    
                    <div class="w-16 h-16 bg-white/10 backdrop-blur-md rounded-2xl flex items-center justify-center mx-auto mb-3 border border-white/20 shadow-lg">
                        <i data-lucide="wallet" class="w-8 h-8 text-white"></i>
                    </div>
                    <h3 class="text-xl font-black text-white tracking-wide">Cargar Saldo</h3>
                    <p class="text-[10px] text-gray-400 font-medium uppercase tracking-widest">Añade fondos a tu cuenta</p>
                </div>

                <div class="p-6 -mt-4 bg-white rounded-t-[2rem] relative z-20">
                    
                    <div class="mb-6 relative text-center">
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-3">Ingresa el monto a recargar</label>
                        <div class="relative max-w-[200px] mx-auto group">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-2xl font-black text-gray-300 group-focus-within:text-indigo-500 transition-colors">$</span>
                            <input type="number" id="charge-amount" class="w-full bg-gray-50 border-2 border-gray-100 rounded-2xl py-4 pl-8 pr-4 text-4xl font-black text-center text-gray-800 focus:outline-none focus:border-indigo-500 focus:ring-0 transition-all placeholder:text-gray-200 shadow-inner" placeholder="0">
                        </div>
                    </div>

                    <button id="confirm-btn" onclick="processRecharge(document.getElementById('charge-amount').value)" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-200 hover:bg-indigo-700 hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-2 mb-6">
                        <span>Generar Solicitud</span>
                        <i data-lucide="arrow-right" class="w-5 h-5"></i>
                    </button>
                    
                    <div class="bg-amber-50 border border-amber-100 p-4 rounded-2xl text-left relative overflow-hidden">
                         <div class="absolute top-0 left-0 w-1 h-full bg-amber-400"></div>
                         <p class="text-xs text-amber-800 font-black uppercase flex items-center gap-2 mb-2">
                            <i data-lucide="alert-triangle" class="w-4 h-4 text-amber-500"></i> Nota Importante
                        </p>
                        <p class="text-[11px] text-amber-700 font-medium leading-relaxed">
                            La recarga mínima es de <strong class="text-amber-900 bg-amber-100 px-1 rounded border border-amber-200">$100</strong>. 
                            Si recargan menos de <strong class="text-amber-900 bg-amber-100 px-1 rounded border border-amber-200">$100</strong> el banco les cobrará una comisión de <strong class="text-rose-600 bg-rose-50 px-1 rounded border border-rose-100">$20</strong> el cual se descontará automáticamente de su saldo.
                        </p>
                    </div>

                    <div id="payment-info-container"></div>
                </div>
            </div>
            `); 
            lucide.createIcons();
        };


        window.processRecharge = async (amt) => {
            if (!amt) return;
            const btn = document.getElementById('confirm-btn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `<div class="w-4 h-4 border-2 border-gray-900 border-t-transparent rounded-full animate-spin"></div>`;
            btn.disabled = true;

            try {
                // 1. Verificar sanciones previas (opcional, resetear contador si es otro día)
                const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'all_users', currentUser.uid);
                const userSnap = await getDoc(userDocRef);
                let strikes = userSnap.data().rechargeStrikes || 0;
                let lastStrike = userSnap.data().lastStrikeDate ? userSnap.data().lastStrikeDate.toDate() : new Date();
                
                // Resetear strikes si es un día nuevo
                const today = new Date();
                if(lastStrike.getDate() !== today.getDate() || lastStrike.getMonth() !== today.getMonth()) {
                    strikes = 0;
                    await updateDoc(userDocRef, { rechargeStrikes: 0 });
                }

                // 2. Crear la solicitud
                const txRef = await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions'), {
                    type: 'deposit',
                    amount: Number(amt),
                    description: 'Recarga Pendiente (En proceso)',
                    timestamp: serverTimestamp(),
                    status: 'Pending'
                });

                const reqRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'pending_recharges'), {
                    uid: currentUser.uid,
                    email: currentUser.email,
                    amount: Number(amt),
                    status: 'pending',
                    timestamp: serverTimestamp(),
                    userTxId: txRef.id,
                    expiresAt: new Date(Date.now() + 10 * 60 * 1000) // 10 minutos futuro
                });

                showToast('Solicitud iniciada. Tienes 10 minutos.', 'info');
                
                // 3. Abrir Modal con Timer
                showPaymentModalWithTimer(reqRef.id, txRef.id, Number(amt), strikes);

            } catch (e) {
                console.error(e);
                showToast('Error al procesar solicitud', 'error');
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        };

                // ======================================================
        // MODAL COMPLETAR PAGO (DISEÑO PREMIUM + TIMER)
        // ======================================================
        window.showPaymentModalWithTimer = (reqId, txId, amount, strikes) => {
            const refCode = `RW${Math.floor(Math.random() * 10000)}`;
            
            // Advertencia dinámica de strikes
            const strikeWarning = strikes >= 2 
                ? `<div class="mt-2 p-2 bg-rose-100 rounded-lg border border-rose-200"><p class="text-rose-600 font-bold text-[10px] animate-pulse flex items-center gap-1"><i data-lucide="alert-octagon" class="w-3 h-3"></i> ⚠️ ADVERTENCIA: Llevas ${strikes} intentos fallidos hoy.</p></div>` 
                : `<p class="text-gray-400 text-[10px] mt-2 font-medium">Intentos fallidos hoy: ${strikes}/3</p>`;

            openModal(`
            <div class="bounce-enter relative overflow-hidden bg-white rounded-[2rem]">
                
                <div class="bg-gray-900 p-6 pb-10 text-center relative z-10">
                    <div class="absolute top-0 left-0 w-full h-full opacity-20" style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 10px 10px;"></div>
                    
                    <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mb-1">Tiempo Restante</p>
                    <div id="countdown-timer" class="text-4xl font-black text-white font-mono tracking-wider tabular-nums drop-shadow-lg">10:00</div>
                    <p class="text-[10px] text-gray-500 font-medium mt-1">Para realizar la transferencia</p>
                </div>

                <div class="p-6 -mt-6 bg-white rounded-t-[2rem] relative z-20">
                    
                    <div class="bg-gray-50 border border-gray-100 rounded-2xl p-1 mb-5 shadow-sm relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 to-violet-500"></div>
                        
                        <div class="p-4 space-y-3">
                            <div class="flex items-center gap-2 mb-3">
                                <div class="w-8 h-8 rounded-lg bg-white flex items-center justify-center text-indigo-600 shadow-sm border border-gray-100">
                                    <i data-lucide="landmark" class="w-4 h-4"></i>
                                </div>
                                <span class="text-xs font-black text-gray-700 uppercase tracking-wide">Datos de Transferencia</span>
                            </div>

                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between items-center border-b border-gray-200/50 pb-2">
                                    <span class="text-gray-400 text-xs font-medium">Banco</span>
                                    <span class="font-bold text-gray-800">STP / Transferencia</span>
                                </div>
                                
                                <div class="flex justify-between items-center border-b border-gray-200/50 pb-2">
                                    <span class="text-gray-400 text-xs font-medium">Cuenta CLABE</span>
                                    <div class="flex items-center gap-2">
                                        <span class="font-mono font-bold text-gray-800 tracking-tight select-all">646180402324335362</span>
                                        <button onclick="navigator.clipboard.writeText('646180402324335362'); showToast('Copiado','success')" class="text-indigo-500 hover:text-indigo-700 bg-indigo-50 p-1 rounded transition-colors">
                                            <i data-lucide="copy" class="w-3 h-3"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="flex justify-between items-center border-b border-gray-200/50 pb-2">
                                    <span class="text-gray-400 text-xs font-medium">Beneficiario</span>
                                    <span class="font-bold text-gray-800">AXLL</span>
                                </div>

                                <div class="flex justify-between items-center border-b border-gray-200/50 pb-2">
                                    <span class="text-gray-400 text-xs font-medium">Monto Exacto</span>
                                    <span class="font-black text-emerald-600 text-lg">$${amount.toLocaleString()}</span>
                                </div>

                                <div class="flex justify-between items-center pt-1">
                                    <span class="text-gray-400 text-xs font-medium">Concepto/Ref</span>
                                    <span class="font-mono font-bold text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded select-all">${refCode}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-amber-50 border border-amber-100 p-4 rounded-xl text-left mb-6 relative">
                        <div class="flex gap-3">
                            <i data-lucide="alert-circle" class="w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5"></i>
                            <div>
                                <p class="text-xs text-amber-800 font-bold mb-1">Instrucciones</p>
                                <p class="text-[10px] text-amber-700 leading-snug">
                                    Realiza la transferencia con el monto <strong>EXACTO</strong>. Tu pago debe llevar <strong>NOMBRE</strong> Y <strong>CONCEPTO</strong> que aparece, Una vez hecha, presiona el botón negro de abajo "Ya Realice el pago". Si el tiempo expira, esta solicitud se cancelará y su pago podría no verse reflejado.
                                </p>
                                ${strikeWarning}
                            </div>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <button onclick="closeModal()" class="w-full bg-gray-900 text-white font-bold py-4 rounded-xl shadow-lg shadow-gray-200 hover:bg-black transform active:scale-95 transition-all flex items-center justify-center gap-2">
                            <i data-lucide="check-circle" class="w-5 h-5"></i>
                            <span>Ya realicé el pago</span>
                        </button>
                        
                        <button onclick="cancelRechargeRequest('${reqId}', '${txId}', false)" class="w-full py-3 rounded-xl text-xs font-bold text-rose-500 hover:bg-rose-50 border border-transparent hover:border-rose-100 transition-all">
                            Cancelar Solicitud
                        </button>
                    </div>
                </div>
            </div>
            `);
            lucide.createIcons();
            startPaymentTimer(reqId, txId);
        };


        window.startPaymentTimer = (reqId, txId) => {
            let timeLeft = 600; // 10 minutos en segundos
            const display = document.getElementById('countdown-timer');
            
            if (timerInterval) clearInterval(timerInterval);

            timerInterval = setInterval(() => {
                if (!document.getElementById('countdown-timer')) {
                    clearInterval(timerInterval); // Detener si el modal se cierra
                    return;
                }

                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                display.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    display.textContent = "00:00";
                    cancelRechargeRequest(reqId, txId, true); // true = fue por timeout
                }
            }, 1000);
        };

        window.cancelRechargeRequest = async (reqId, txId, isTimeout) => {
            if (!isTimeout && !confirm("¿Seguro que deseas cancelar? Esto contará como intento fallido.")) return;

            try {
                // 1. Marcar como cancelada en BD
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'pending_recharges', reqId), { status: 'cancelled' });
                await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions', txId), { status: 'Cancelado', description: isTimeout ? 'Recarga Expirada (Timeout)' : 'Recarga Cancelada por Usuario' });

                // 2. Lógica de Sanción
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'all_users', currentUser.uid);
                
                await runTransaction(db, async (t) => {
                    const userDoc = await t.get(userRef);
                    let newStrikes = (userDoc.data().rechargeStrikes || 0) + 1;
                    
                    // Actualizar contador
                    t.update(userRef, { 
                        rechargeStrikes: newStrikes,
                        lastStrikeDate: serverTimestamp()
                    });

                    // Aplicar multa si llega a 3
                    if (newStrikes >= 3) {
                        const walletRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'wallet', 'main');
                        const walletSnap = await t.get(walletRef);
                        const currentBal = walletSnap.data().balance || 0;

                        t.update(walletRef, { balance: currentBal - 50 });
                        
                        // Registrar transacción de multa
                        const penaltyTx = doc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions'));
                        t.set(penaltyTx, {
                            type: 'charge',
                            amount: 50,
                            description: 'MULTA: 3 Recargas Fallidas/Canceladas',
                            timestamp: serverTimestamp()
                        });
                        
                        // Resetear strikes tras multa (opcional, o dejar que sufra hoy)
                         t.update(userRef, { rechargeStrikes: 0 }); 
                    }
                });

                if (isTimeout) {
                    alert("⏳ Tiempo agotado. La solicitud ha sido cancelada.");
                } else {
                    showToast("Solicitud cancelada.", "info");
                }
                closeModal();

            } catch (e) {
                console.error("Error al cancelar:", e);
            }
        };

     // ======================================================
// BANDEJA DE RESPUESTAS (CON NOMBRE DE REPORTE)
// ======================================================
window.openSupportReplies = () => {
    // 1. Obtener respuestas
    const replies = window.userTransactions.filter(t => t.type === 'support_reply');
    replies.sort((a,b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
    
    let listHtml = '';

    if (replies.length === 0) {
        listHtml = `
        <div class="flex flex-col items-center justify-center py-16 opacity-50">
            <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mb-3 neumo-inset"><i data-lucide="message-circle-off" class="w-8 h-8 text-gray-400"></i></div>
            <p class="text-sm text-gray-400 font-bold">Sin respuestas nuevas</p>
        </div>`;
    } else {
        listHtml = `<div class="space-y-3 pb-4">`;
        replies.forEach(r => {
            const time = r.timestamp ? r.timestamp.toDate().toLocaleString() : 'Reciente';
            
            // LOGICA VISUAL: Mostrar el nombre del servicio (Ej: Netflix)
            const serviceTag = r.reportServiceName 
                ? `<span class="bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded text-[9px] font-black uppercase tracking-wider border border-indigo-100">${r.reportServiceName}</span>` 
                : `<span class="bg-gray-100 text-gray-500 px-2 py-0.5 rounded text-[9px] font-bold uppercase">General</span>`;

            listHtml += `
            <div onclick="openSupportReplyDetail('${r.id}')" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 cursor-pointer hover:border-blue-300 hover:shadow-md transition-all group relative">
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center gap-2">
                        <i data-lucide="mail-open" class="w-4 h-4 text-blue-500"></i>
                        ${serviceTag} </div>
                    <span class="text-[9px] text-gray-400 font-medium">${time}</span>
                </div>
                <p class="text-xs text-gray-600 line-clamp-2 font-medium leading-relaxed pl-1">${r.message}</p>
                <div class="absolute right-3 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity">
                    <i data-lucide="chevron-right" class="w-4 h-4 text-blue-400"></i>
                </div>
            </div>`;
        });
        listHtml += `</div>`;
    }

    openModal(`
        <div class="bg-gray-50 rounded-[2rem] overflow-hidden relative bounce-enter flex flex-col max-h-[85vh]">
            <div class="bg-gradient-to-r from-blue-500 to-cyan-500 p-6 pb-12 text-center relative flex-shrink-0 shadow-lg z-10">
                <div class="absolute top-0 left-0 w-full h-full opacity-10" style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 10px 10px;"></div>
                <div class="w-12 h-12 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center mx-auto mb-2 text-white shadow-lg border border-white/30">
                    <i data-lucide="inbox" class="w-6 h-6"></i>
                </div>
                <h3 class="text-xl font-black text-white uppercase tracking-tight relative z-10">Bandeja Soporte</h3>
                <p class="text-[10px] text-blue-100 font-medium uppercase tracking-widest relative z-10">Tus tickets resueltos</p>
            </div>
            <div class="flex-1 overflow-y-auto scrollbar-hide px-4 pt-6 relative z-20 -mt-6">
                ${listHtml}
            </div>
            <div class="p-4 bg-white border-t border-gray-200 z-30">
                <button onclick="closeModal()" class="neumo-button w-full bg-gray-100 text-gray-500 font-bold py-3.5 rounded-xl hover:bg-gray-200 transition-colors">Cerrar Bandeja</button>
            </div>
        </div>
    `);
    lucide.createIcons();
};

              // ======================================================
        // DETALLE SOPORTE (Paso 4: Marca como leído al ver respuesta)
        // ======================================================
        window.openSupportReplyDetail = (id) => {
            // 1. MARCAR COMO LEÍDO (Solo al entrar aquí se elimina la notificación pendiente)
            markAsRead(id);

            const r = window.userTransactions.find(t => t.id === id); 
            if(!r) return;
            
            const dateStr = r.timestamp ? r.timestamp.toDate().toLocaleString() : 'Reciente';
            const evidenceHtml = r.evidenceImage 
                ? `<div class="mt-4 ml-14">
                     <p class="text-[10px] font-bold text-gray-400 uppercase mb-2 flex items-center gap-1"><i data-lucide="paperclip" class="w-3 h-3"></i> Archivo Adjunto</p>
                     <div class="relative group cursor-pointer overflow-hidden rounded-2xl border border-gray-200 shadow-sm w-full max-w-xs">
                        <img src="${r.evidenceImage}" class="w-full h-auto object-cover group-hover:scale-105 transition-transform duration-500" onclick="window.open(this.src, '_blank')">
                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"></div>
                     </div>
                   </div>` 
                : '';

            openModal(` 
            <div class="bg-white rounded-[2rem] overflow-hidden relative bounce-enter flex flex-col max-h-[85vh]">
                
                <div class="bg-gradient-to-r from-blue-600 to-cyan-500 p-6 pb-10 text-center relative flex-shrink-0">
                     <div class="absolute top-0 left-0 w-full h-full opacity-10" style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 10px 10px;"></div>
                     
                     <div class="w-12 h-12 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center mx-auto mb-2 text-white shadow-lg border border-white/30">
                        <i data-lucide="headset" class="w-6 h-6"></i>
                     </div>
                     <h3 class="text-lg font-black text-white uppercase tracking-wider relative z-10">Soporte Técnico</h3>
                     <p class="text-[10px] text-blue-50 font-medium relative z-10 uppercase tracking-widest">Respuesta Oficial</p>
                </div>

                <div class="flex-1 overflow-y-auto scrollbar-hide px-6 py-6 bg-white -mt-6 rounded-t-[2rem] relative z-20">
                    
                    <div class="flex gap-3 animate-in fade-in slide-in-from-bottom-4 duration-500">
                        <div class="flex-shrink-0">
                             <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-blue-600 border border-blue-100 shadow-sm relative">
                                <span class="font-black text-[10px]">ADMIN</span>
                                <div class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-white rounded-full"></div>
                             </div>
                        </div>
                        
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between mb-1 px-1">
                                <span class="text-xs font-bold text-gray-900">Agente de Soporte</span>
                                <span class="text-[9px] text-gray-400">${dateStr}</span>
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-2xl rounded-tl-none border border-gray-100 text-sm text-gray-700 leading-relaxed shadow-sm whitespace-pre-wrap text-left">
                                ${r.message || '<i class="text-gray-400">Sin contenido de texto...</i>'}
                            </div>
                        </div>
                    </div>

                    ${evidenceHtml}

                </div>

                <div class="p-4 border-t border-gray-100 bg-gray-50/50 flex-shrink-0 z-30">
                    <button onclick="openSupportReplies()" class="neumo-button w-full bg-gray-900 text-white font-bold py-3.5 rounded-xl shadow-lg flex items-center justify-center gap-2 hover:bg-gray-800 transition-colors active:scale-95">
                        <i data-lucide="arrow-left" class="w-4 h-4"></i>
                        <span>Volver a Mis Respuestas</span>
                    </button>
                </div>

            </div> `);
            lucide.createIcons();
        };



            // ======================================================
        // RENOVAR SERVICIO: DISEÑO PREMIUM
        // ======================================================
        window.openRenewalModal = () => {
            openModal(`
            <div class="bg-white rounded-[2rem] overflow-hidden relative bounce-enter flex flex-col max-h-[85vh]">
                
                <div class="bg-gradient-to-br from-violet-600 to-fuchsia-600 p-8 text-center relative flex-shrink-0 shadow-lg z-10">
                    <div class="absolute top-0 left-0 w-full h-full opacity-20" style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 10px 10px;"></div>
                    
                    <div class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center mx-auto mb-3 text-white shadow-xl border border-white/30 transform -rotate-6">
                        <i data-lucide="refresh-cw" class="w-8 h-8"></i>
                    </div>
                    <h3 class="text-xl font-black text-white tracking-tight uppercase relative z-10">Renovar Servicio</h3>
                    <p class="text-[10px] text-violet-100 font-medium uppercase tracking-widest relative z-10">Extiende tu suscripción al instante</p>
                </div>

                <div class="p-6 flex-1 overflow-y-auto scrollbar-hide bg-gray-50 relative z-0">
                    
                    <div class="bg-white border border-gray-100 p-5 rounded-[1.5rem] shadow-sm mb-6 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-violet-500"></div>
                        <p class="text-xs text-gray-800 font-bold mb-3 flex items-center gap-2 uppercase tracking-wide">
                            <i data-lucide="search" class="w-4 h-4 text-violet-500"></i> Buscar Cuenta
                        </p>
                        
                        <form onsubmit="searchRenewal(event)" class="relative">
                            <input type="email" id="renew-email" class="w-full bg-gray-50 border border-gray-200 rounded-xl py-3.5 pl-4 pr-12 text-sm font-bold text-gray-700 shadow-inner focus:outline-none focus:border-violet-500 focus:ring-1 focus:ring-violet-500 transition-all placeholder:text-gray-400" placeholder="Ingresa el correo de la cuenta..." required>
                            
                            <button type="submit" class="absolute right-2 top-2 p-1.5 bg-gray-900 text-white rounded-lg hover:bg-violet-600 hover:scale-105 transition-all shadow-md group">
                                <i data-lucide="arrow-right" class="w-4 h-4 group-hover:translate-x-0.5 transition-transform"></i>
                            </button>
                        </form>
                        <p class="text-[9px] text-gray-400 mt-2 ml-1 font-medium">Busca por el correo exacto de la cuenta que compraste.</p>
                    </div>

                    <div id="renewal-results" class="space-y-3 empty:hidden min-h-[100px]">
                        <div class="text-center py-8 opacity-40 select-none">
                            <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-3 neumo-inset">
                                <i data-lucide="history" class="w-8 h-8 text-gray-400"></i>
                            </div>
                            <p class="text-xs text-gray-400 font-medium">Tus resultados aparecerán aquí</p>
                        </div>
                    </div>
                </div>

                <div class="p-4 bg-white border-t border-gray-200 z-20">
                    <button onclick="closeModal()" class="w-full py-3.5 rounded-xl text-xs font-bold text-gray-400 hover:text-gray-600 hover:bg-gray-50 transition-colors">
                        Cancelar Operación
                    </button>
                </div>
            </div>
            `);
            lucide.createIcons();
        };

                // ======================================================
        // BÚSQUEDA DE RENOVACIÓN (LÓGICA + UI MEJORADA)
        // ======================================================
        window.searchRenewal = (e) => {
            e.preventDefault();
            const emailQuery = document.getElementById('renew-email').value.trim().toLowerCase();
            const container = document.getElementById('renewal-results');
            
            // Loader Moderno
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center py-10 animate-in fade-in duration-300">
                    <div class="w-10 h-10 border-4 border-violet-100 border-t-violet-600 rounded-full animate-spin mb-3"></div>
                    <span class="text-[10px] font-bold text-violet-400 uppercase tracking-wider">Buscando coincidencias...</span>
                </div>`;

            // Pequeño delay para suavidad visual
            setTimeout(() => {
                // Filtramos las compras del historial
                const matches = window.userTransactions.filter(t => t.type === 'purchase' && t.details && t.details.email && t.details.email.toLowerCase() === emailQuery);

                if (matches.length === 0) {
                    container.innerHTML = `
                    <div class="bg-rose-50 border border-rose-100 p-5 rounded-[1.5rem] text-center animate-in fade-in zoom-in duration-300 shadow-sm">
                        <div class="w-12 h-12 bg-white text-rose-500 rounded-full flex items-center justify-center mx-auto mb-3 shadow-sm border border-rose-100">
                            <i data-lucide="search-x" class="w-6 h-6"></i>
                        </div>
                        <p class="text-sm font-black text-rose-600 mb-1">Sin Resultados</p>
                        <p class="text-[10px] text-rose-400 px-4">No encontramos compras activas registradas con ese correo en tu historial.</p>
                    </div>`;
                } else {
                    let html = '';
                    matches.forEach((m, index) => {
                        const platformName = m.details.serviceName || m.description.replace('Compra: ', '');
                        const date = m.timestamp ? m.timestamp.toDate().toLocaleDateString() : 'Reciente';
                        const delay = index * 100; // Efecto cascada

                        html += `
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col gap-3 relative group hover:border-violet-200 hover:shadow-md transition-all animate-in slide-in-from-bottom-4 duration-500" style="animation-delay: ${delay}ms;">
                            
                            <div class="flex justify-between items-start">
                                <div class="flex items-center gap-3">
                                    <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-violet-100 to-fuchsia-50 text-violet-600 flex items-center justify-center font-black text-lg shadow-inner border border-white">
                                        ${platformName.charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-gray-800 text-sm leading-tight">${platformName}</h4>
                                        <p class="text-[10px] text-gray-400 font-mono mt-0.5 select-all">${m.details.email}</p>
                                    </div>
                                </div>
                                <span class="text-[8px] font-black bg-emerald-50 text-emerald-600 px-2 py-1 rounded-lg border border-emerald-100 uppercase tracking-widest">Disponible</span>
                            </div>

                            <div class="flex items-center justify-between pt-3 border-t border-gray-50 mt-1">
                                <span class="text-[10px] text-gray-400 font-bold flex items-center gap-1 bg-gray-50 px-2 py-1 rounded-md">
                                    <i data-lucide="calendar" class="w-3 h-3"></i> ${date}
                                </span>
                                
                                <button onclick="requestRenewal('${m.id}', '${platformName}', '${m.details.email}')" class="bg-gray-900 text-white px-4 py-2.5 rounded-xl text-[10px] font-bold shadow-lg hover:bg-violet-600 hover:shadow-violet-200 hover:-translate-y-0.5 transition-all flex items-center gap-2 active:scale-95">
                                    <span>Solicitar</span>
                                    <i data-lucide="check-circle-2" class="w-3.5 h-3.5"></i>
                                </button>
                            </div>
                        </div>`;
                    });
                    container.innerHTML = html;
                }
                lucide.createIcons();
            }, 600);
        };

        window.requestRenewal = async (txId, platform, email) => { if(!confirm(`¿Solicitar renovación para ${platform}?`)) return; try { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'reports'), { uid: currentUser.uid, email: currentUser.email, type: 'renewal', description: `Solicitud de renovación para: ${platform}\nCuenta: ${email}\nID Compra Original: ${txId}`, timestamp: serverTimestamp(), status: 'unread' }); showToast('Solicitud enviada al administrador', 'success'); closeModal(); } catch (e) { showToast('Error al solicitar', 'error'); } };

        // --- UTILIDADES UI ---
        window.toggleSidebar = () => { const s=document.getElementById('sidebar'); const o=document.getElementById('sidebar-overlay'); if(s.classList.contains('-translate-x-full')){s.classList.remove('-translate-x-full');o.classList.remove('opacity-0','pointer-events-none');}else{s.classList.add('-translate-x-full');o.classList.add('opacity-0','pointer-events-none');} } 
        window.switchView = (v) => { 
    // 1. Ocultar siempre la vista de documentos
    const docView = document.getElementById('documents-view');
    if(docView) docView.classList.add('hidden');

    // 2. Lógica original
    const u=document.getElementById('user-view'); 
    const a=document.getElementById('admin-view'); 
    if(v==='admin'){
        u.classList.add('hidden');
        a.classList.remove('hidden');
    } else {
        a.classList.add('hidden');
        u.classList.remove('hidden');
    } 
}

        window.showToast = (m,t='info') => {const c=document.getElementById('toast-container');const el=document.createElement('div');const col={success:'bg-success text-white',error:'bg-danger text-white',info:'bg-gray-800 text-white'};el.className=`${col[t]} px-4 py-3 rounded-xl shadow-xl flex items-center gap-3 text-sm font-bold transform transition-all duration-300 translate-x-full pointer-events-auto border border-white/10 backdrop-blur-md`;el.innerHTML=`<span>${m}</span>`;c.appendChild(el);requestAnimationFrame(()=>el.classList.remove('translate-x-full'));setTimeout(()=>{el.classList.add('translate-x-full','opacity-0');setTimeout(()=>el.remove(),300);},3000);}
        window.closeModal = () => { const m=document.getElementById('app-modal'); m.classList.add('hidden'); m.classList.remove('flex'); };
        // --- FUNCIÓN CORREGIDA: OPEN MODAL (Resetea posición siempre) ---
window.openModal = (h) => { 
    const m = document.getElementById('app-modal'); 
    const mc = document.getElementById('modal-card'); 
    const content = document.getElementById('modal-content');

    // 1. REINICIO TOTAL DE CLASES DEL CONTENEDOR PRINCIPAL
    // Esto fuerza que siempre arranque centrado (items-center) y quite el (items-end) que dejan los productos
    m.className = "fixed inset-0 z-[80] hidden items-center justify-center p-4";
    
    // 2. REINICIO TOTAL DE LA TARJETA BLANCA
    // Esto asegura que tenga fondo blanco y sombra, por si la alerta roja lo dejó transparente
    mc.className = "neumo-card w-full max-w-md p-0 relative shadow-2xl transform transition-all scale-100 opacity-100 max-h-[90vh] flex flex-col overflow-hidden bg-white";
    
    // 3. REINICIO DEL CONTENIDO INTERNO
    content.className = "overflow-y-auto scrollbar-hide p-6 w-full h-full";

    // 4. Restaurar botón cerrar por si se ocultó
    const closeBtn = document.querySelector('#modal-card > button');
    if(closeBtn) closeBtn.classList.remove('hidden');

    // Inyectar y mostrar
    content.innerHTML = h; 
    m.classList.remove('hidden'); 
    m.classList.add('flex'); 
    
    // Restaurar fondo oscuro si se había quitado
    const backdrop = m.querySelector('div.absolute');
    if(backdrop) backdrop.className = "absolute inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity";

    lucide.createIcons(); 
};

        window.enterAdminModule = (m) => { document.getElementById('admin-dashboard-grid').classList.add('hidden'); document.getElementById('admin-modules-container').classList.remove('hidden'); document.querySelectorAll('section[id^="admin-"]').forEach(s=>s.classList.add('hidden')); document.getElementById(`admin-${m}-section`).classList.remove('hidden'); };
        window.returnToAdminDashboard = () => { document.getElementById('admin-dashboard-grid').classList.remove('hidden'); document.getElementById('admin-modules-container').classList.add('hidden'); };
        window.switchAuthView = (v) => { document.querySelectorAll('.auth-view').forEach(x=>x.classList.add('hidden')); document.getElementById(`${v==='login'?'login':v==='register'?'register':'forgot'}-form`).classList.remove('hidden'); };
        
        window.approveRecharge = async (reqId, uid, amt, txId) => { 
            if(!confirm('¿Aprobar saldo de $' + amt + '?')) return; 
            const wRef = doc(db, 'artifacts', appId, 'users', uid, 'wallet', 'main'); 
            try {
                await runTransaction(db, async (t) => { 
                    const s = await t.get(wRef); 
                    const currentBal = Number(s.exists() ? s.data().balance : 0) || 0;
                    t.update(wRef, { balance: currentBal + Number(amt) }); 
                }); 
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'pending_recharges', reqId), { status: 'approved' }); 
                if(txId) { await updateDoc(doc(db, 'artifacts', appId, 'users', uid, 'transactions', txId), { status: 'Éxito' }); }
                showToast('Saldo cargado correctamente', 'success'); 
            } catch(e) { console.error(e); showToast('Error al aprobar', 'error'); }
        };
        
        // --- RECHAZAR RECARGA (NUEVO) ---
        window.rejectRecharge = async (reqId, uid, txId) => {
            if(!confirm('¿Rechazar esta solicitud de recarga?')) return;
            try {
                // Actualizar solicitud pública
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'pending_recharges', reqId), { status: 'rejected' });
                
                // Actualizar transacción del usuario
                if(txId) { 
                    await updateDoc(doc(db, 'artifacts', appId, 'users', uid, 'transactions', txId), { 
                        status: 'Rechazado',
                        description: 'Recarga Rechazada por Admin'
                    }); 
                }
                showToast('Solicitud rechazada', 'info');
            } catch(e) { 
                console.error(e); 
                showToast('Error al rechazar', 'error'); 
            }
        };

        window.deleteProfile = async (id) => { if(confirm("¿Borrar producto?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'profiles', id)); };

                document.getElementById('login-form').addEventListener('submit', async(e)=>{
            e.preventDefault(); 
            
            // 1. Efecto visual de carga en el botón
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full"></span> Ingresando...';

            try {
                const email = document.getElementById('login-email').value;
                const pass = document.getElementById('login-password').value;

                // 2. Intentar Login
                const credential = await signInWithEmailAndPassword(auth, email, pass); 
                
                // 3. Verificar si confirmó el correo
                if (!credential.user.emailVerified) { 
                    await signOut(auth); 
                    showToast('📧 Tu correo no está verificado. Revisa tu bandeja de entrada o Spam.', 'error'); 
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    return; 
                }
                
                showToast('¡Bienvenido de nuevo!', 'success');
                // El onAuthStateChanged se encargará de cambiar la pantalla
            } catch(error) { 
                console.error("Error Login:", error); // Esto imprime el error técnico en la consola
                
                // 4. Traducir el error de Firebase a Español para el usuario
                let msg = 'Ocurrió un error inesperado.';
                
                if(error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password') {
                    msg = 'Contraseña incorrecta o correo no registrado.';
                } else if(error.code === 'auth/user-not-found') {
                    msg = 'No existe una cuenta con este correo.';
                } else if(error.code === 'auth/too-many-requests') {
                    msg = 'Demasiados intentos fallidos. Tu cuenta se bloqueó temporalmente por seguridad. Espera unos minutos.';
                } else if(error.code === 'auth/user-disabled') {
                    msg = 'Esta cuenta ha sido inhabilitada por administración.';
                } else if(error.code === 'auth/invalid-email') {
                    msg = 'El formato del correo electrónico no es válido.';
                } else if(error.code === 'auth/network-request-failed') {
                    msg = 'Error de conexión. Revisa tu internet.';
                } else {
                    msg = error.code || error.message; // Si es otro error, muestra el código
                }

                showToast(msg, 'error'); 
                
                // 5. Restaurar el botón
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });
        
                // REGISTRO PÚBLICO (CON AUTO-APAGADO DE LINK + SEGURIDAD)
        document.getElementById('register-form').addEventListener('submit', async(e)=>{
            e.preventDefault(); 
            const btn = document.querySelector('#register-form button'); const originalText = btn.innerText; btn.disabled = true; btn.innerText = 'Guardando datos...';
            
            // 1. OBTENER VALORES DEL FORMULARIO
            const p1 = document.getElementById('reg-password').value; 
            const p2 = document.getElementById('reg-confirm-password').value; 
            const email = document.getElementById('reg-email').value;
            const fullName = document.getElementById('reg-name').value;       
            const whatsapp = document.getElementById('reg-whatsapp').value;   
            const city = document.getElementById('reg-city').value;           

            // 2. VALIDACIONES
            if(p1 !== p2) { btn.disabled=false; btn.innerText=originalText; return showToast('Contraseñas no coinciden','error'); }
            if(!fullName || !whatsapp || !city) { btn.disabled=false; btn.innerText=originalText; return showToast('Todos los campos son obligatorios','error'); }

            const urlParams = new URLSearchParams(window.location.search); const referrerId = urlParams.get('ref');

            try{
                const c = await createUserWithEmailAndPassword(auth, email, p1); 
                const uid = c.user.uid;
                await sendEmailVerification(c.user);

                if(referrerId) {
                    try {
                        await runTransaction(db, async (t) => {
                            const referrerRef = doc(db, 'artifacts', appId, 'public', 'data', 'all_users', referrerId);
                            const referrerSnap = await t.get(referrerRef);
                            
                            if (!referrerSnap.exists()) throw new Error("Referido inválido");
                            
                            const rData = referrerSnap.data();
                            const config = rData.referralConfig || {};
                            const urlParams = new URLSearchParams(window.location.search);
                            const code = urlParams.get('c') || '1'; 
                            
                            if (config[code] !== true) throw new Error("ENLACE_APAGADO"); 

                            let requestedRole = 'client';
                            let bonusAmount = 10; 
                            if (code === '2') { requestedRole = 'vip'; bonusAmount = 50; }
                            if (code === '3') { requestedRole = 'reseller'; bonusAmount = 100; }

                            if (rData.email === 'mrandroidtutorialeshd@gmail.com') {
                                const customAdminAmount = config[`amount_${code}`];
                                if (customAdminAmount !== undefined && customAdminAmount !== null) bonusAmount = Number(customAdminAmount);
                            }

                            const referrerRole = rData.role || 'client';
                            let finalRole = 'client'; 
                            let finalBonus = 10; 

                            if (referrerRole === 'lider' || rData.email === 'mrandroidtutorialeshd@gmail.com') {
                                if(['client', 'vip', 'reseller'].includes(requestedRole)) { finalRole = requestedRole; finalBonus = bonusAmount; }
                            } else if (referrerRole === 'reseller') {
                                if(['client', 'vip'].includes(requestedRole)) { finalRole = requestedRole; finalBonus = bonusAmount; }
                            }

                            const resellerWalletRef = doc(db, 'artifacts', appId, 'users', referrerId, 'wallet', 'main');
                            const resellerSnap = await t.get(resellerWalletRef);
                            if (!resellerSnap.exists()) throw new Error("Revendedor inválido");
                            const resellerBalance = resellerSnap.data().balance || 0;
                            if (resellerBalance < finalBonus) throw new Error("SIN_SALDO");

                            // 1. Descontar saldo al patrocinador
                            t.update(resellerWalletRef, { balance: resellerBalance - finalBonus });
                            
                                    // ======================================================
        // RECUPERAR CONTRASEÑA (FUNCIONALIDAD COMPLETA)
        // ======================================================
        const forgotForm = document.getElementById('forgot-form');
        if(forgotForm) {
            forgotForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // 1. Efecto visual de carga en el botón
                const btn = e.target.querySelector('button[type="submit"]');
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<span class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full"></span> Enviando...';

                const emailInput = document.getElementById('forgot-email');
                const email = emailInput.value.trim();

                try {
                    // 2. Solicitar a Firebase el correo de restablecimiento
                    await sendPasswordResetEmail(auth, email);

                    // 3. Éxito: Notificación y regreso al Login
                    showToast('📩 ¡Correo enviado! Revisa tu bandeja de entrada (y Spam).', 'success');
                    
                    // Limpiamos el campo y volvemos al login después de 2 segundos
                    setTimeout(() => {
                        emailInput.value = ''; 
                        switchAuthView('login');
                    }, 2500);

                } catch (error) {
                    console.error("Error Reset Password:", error);
                    
                    // 4. Manejo de Errores (Mensajes específicos)
                    let msg = 'Ocurrió un error al intentar enviar el correo.';

                    if (error.code === 'auth/user-not-found') {
                        msg = '⚠️ Este correo NO está registrado en nuestra base de datos.';
                    } else if (error.code === 'auth/invalid-email') {
                        msg = 'El formato del correo electrónico no es válido.';
                    } else if (error.code === 'auth/network-request-failed') {
                        msg = 'Revisa tu conexión a internet.';
                    }

                    showToast(msg, 'error');
                } finally {
                    // 5. Restaurar botón
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            });
        }

                            
                            // [NUEVO] APAGAR ENLACE AUTOMÁTICAMENTE PARA EVITAR MULTI-CUENTAS
                            // Esto pone el interruptor en 'false' en la base de datos inmediatamente
                            const linkUpdate = {};
                            linkUpdate[`referralConfig.${code}`] = false;
                            t.update(referrerRef, linkUpdate);
                            // -------------------------------------------------------------

                            // 2. Crear billetera del nuevo usuario
                            t.set(doc(db,'artifacts',appId,'users',uid,'wallet','main'), { balance: finalBonus, profit: 0, createdAt: serverTimestamp() });
                            
                            // 3. GUARDAR DATOS COMPLETOS EN FIRESTORE
                            t.set(doc(db, 'artifacts', appId, 'public', 'data', 'all_users', uid), { 
                                email: email, 
                                uid: uid, 
                                role: finalRole, 
                                fullName: fullName,  
                                whatsapp: whatsapp,  
                                city: city,          
                                referredBy: referrerId, 
                                suspended: false, 
                                lastLogin: serverTimestamp(),
                                createdAt: serverTimestamp()
                            }, {merge: true});
                            
                            const resellerTx = doc(collection(db, 'artifacts', appId, 'users', referrerId, 'transactions'));
                            t.set(resellerTx, { type: 'charge', amount: -finalBonus, description: `Bono regalo (${finalRole}): ${email}`, timestamp: serverTimestamp() });
                            
                            const newUserTx = doc(collection(db, 'artifacts', appId, 'users', uid, 'transactions'));
                            t.set(newUserTx, { type: 'deposit', amount: finalBonus, description: 'Bono de Bienvenida', timestamp: serverTimestamp(), status: 'approved' });
                        });
                    } catch (txError) {
                        console.log("Registro sin bono:", txError.message);
                        await setDoc(doc(db,'artifacts',appId,'users',uid,'wallet','main'),{balance:0,profit:0}); 
                        // FALLBACK SIN BONO
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'all_users', uid), { 
                            email: email, uid: uid, role: 'client', suspended: false, 
                            fullName: fullName, whatsapp: whatsapp, city: city, 
                            lastLogin: serverTimestamp(), createdAt: serverTimestamp() 
                        }, {merge: true});
                    }
                } else {
                    // REGISTRO DIRECTO (SIN REFERIDO)
                    await setDoc(doc(db,'artifacts',appId,'users',uid,'wallet','main'),{balance:0,profit:0}); 
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'all_users', uid), { 
                        email: email, uid: uid, role: 'client', suspended: false, 
                        fullName: fullName, whatsapp: whatsapp, city: city, 
                        lastLogin: serverTimestamp(), createdAt: serverTimestamp() 
                    }, {merge: true});
                }
                
                await signOut(auth);
                // Limpiar campos
                document.getElementById('reg-name').value = ''; 
                document.getElementById('reg-email').value = ''; 
                document.getElementById('reg-password').value = ''; 
                document.getElementById('reg-confirm-password').value = '';
                document.getElementById('reg-whatsapp').value = ''; 
                document.getElementById('reg-city').value = '';

                showToast('¡Registro exitoso! 📩 Verifica tu correo.', 'success');
                switchAuthView('login');
                btn.disabled=false; btn.innerText=originalText;

            } catch (e) {
                console.error("Error registro:", e);
                let msg = 'Ocurrió un error al registrarse.';

                // DETECCIÓN DE ERRORES (Mantenemos tu código corregido anterior)
                if (e.code === 'auth/weak-password' || e.code === 'auth/password-does-not-meet-requirements' || e.message.includes('password')) {
                    msg = '⚠️ Contraseña poco segura. Te recomendamos usar una Mayúscula, números y un punto (.)';
                } 
                else if (e.code === 'auth/email-already-in-use') {
                    msg = '📧 Este correo ya está registrado. Por favor inicia sesión.';
                } 
                else if (e.code === 'auth/invalid-email') {
                    msg = 'El correo electrónico no tiene un formato válido.';
                } 
                else {
                    msg = 'Error: ' + e.message;
                }

                showToast(msg, 'error');
                btn.disabled = false; 
                btn.innerText = originalText; 
            }
        });
        
        window.handleLogout = async () => { await signOut(auth); document.getElementById('sidebar').classList.add('-translate-x-full'); document.getElementById('login-email').value = ''; document.getElementById('login-password').value = ''; };
        document.addEventListener('DOMContentLoaded', () => { lucide.createIcons(); checkReferralParam(); });
        
                // --- SISTEMA DE BANNERS ---
        let bannerInterval;
        let currentBannerIndex = 0;
        let bannerData = [];
        let touchStartX = 0;
        let touchEndX = 0;

        function initBanners() {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'banners'), orderBy('createdAt', 'desc'));
            onSnapshot(q, (snapshot) => {
                bannerData = [];
                snapshot.forEach(doc => bannerData.push({ id: doc.id, ...doc.data() }));
                renderBannersUser();
                if(isAdmin) renderBannersAdmin();
            });
        }
        
                        // --- INICIO DEL BLOQUE DE BANNERS CORREGIDO ---

        function renderBannersUser() {
            const track = document.getElementById('banner-track');
            const indicators = document.getElementById('banner-indicators');
            if(!track) return;

            // 1. Limpiamos los indicadores (bolitas) para que no se vean
            if(indicators) indicators.innerHTML = '';

            if (bannerData.length === 0) {
                track.innerHTML = `<div class="min-w-full h-full relative"><div class="absolute inset-0 bg-gray-900 flex items-center justify-center"><p class="text-white text-xs">Sin publicidad</p></div></div>`;
                return;
            }

            let html = '';
            
            // 2. Renderizamos los banners originales
            bannerData.forEach((b) => {
                html += `
                <div class="min-w-full h-full relative flex-shrink-0">
                    <div class="absolute inset-0 bg-cover bg-center" style="background-image: url('${b.imageUrl}');"></div>
                </div>`;
            });

            // 3. CLONACIÓN: Si hay más de 1 imagen, clonamos la primera y la ponemos al final
            // Esto permite el efecto "infinito" sin rebobinar
            if (bannerData.length > 1) {
                const first = bannerData[0];
                html += `
                <div class="min-w-full h-full relative flex-shrink-0">
                    <div class="absolute inset-0 bg-cover bg-center" style="background-image: url('${first.imageUrl}');"></div>
                </div>`;
            }

            track.innerHTML = html;
            
            // Reiniciamos al principio
            currentBannerIndex = 0;
            track.style.transition = 'none';
            track.style.transform = 'translateX(0)';
            
            startAutoSlide();
            
            // Reiniciamos eventos táctiles (Swipe)
            const container = document.getElementById('banner-carousel-container');
            const newContainer = container.cloneNode(true);
            container.parentNode.replaceChild(newContainer, container);
            
            newContainer.addEventListener('touchstart', (e) => { touchStartX = e.changedTouches[0].screenX; clearInterval(bannerInterval); }, {passive: true});
            newContainer.addEventListener('touchend', (e) => { touchEndX = e.changedTouches[0].screenX; handleSwipe(); startAutoSlide(); }, {passive: true});
        }

        function updateSlider() {
            const track = document.getElementById('banner-track');
            if(track) {
                track.style.transition = 'transform 0.5s ease-out';
                track.style.transform = `translateX(-${currentBannerIndex * 100}%)`;
            }
        }

        function nextBanner() {
            if (bannerData.length < 2) return;
            
            const track = document.getElementById('banner-track');
            
            // Avanzamos uno
            currentBannerIndex++;
            
            // Animación suave
            track.style.transition = 'transform 0.5s ease-out';
            track.style.transform = `translateX(-${currentBannerIndex * 100}%)`;

            // SI LLEGAMOS AL FINAL (EL CLON)
            if (currentBannerIndex === bannerData.length) {
                // Esperamos 500ms a que termine la animación
                setTimeout(() => {
                    // Quitamos la transición para saltar invisiblemente
                    track.style.transition = 'none';
                    // Saltamos al inicio real (índice 0)
                    currentBannerIndex = 0;
                    track.style.transform = `translateX(0%)`;
                }, 500);
            }
        }

        function prevBanner() { 
            if (bannerData.length < 2) return;
            
            const track = document.getElementById('banner-track');
            
            if (currentBannerIndex === 0) {
                // Si estamos en el inicio y damos atrás, vamos a la última imagen real
                currentBannerIndex = bannerData.length - 1;
            } else {
                currentBannerIndex--;
            }
            
            track.style.transition = 'transform 0.5s ease-out';
            track.style.transform = `translateX(-${currentBannerIndex * 100}%)`;
        }

        function startAutoSlide() { 
            clearInterval(bannerInterval); 
            bannerInterval = setInterval(nextBanner, 4000); 
        }

        function handleSwipe() { 
            if (touchStartX - touchEndX > 50) nextBanner(); 
            if (touchEndX - touchStartX > 50) prevBanner(); 
        }

        // --- FIN DEL BLOQUE DE BANNERS ---

        window.openAddBannerModal = () => {
            openModal(`<div class="text-left bounce-enter"><h3 class="text-lg font-bold text-gray-800 mb-4">Nuevo Banner</h3><form onsubmit="saveBanner(event)" class="space-y-3"><div><label class="block text-xs font-bold text-gray-500">Título</label><input type="text" id="ban-title" class="neumo-inset w-full rounded-xl p-2 text-sm" required></div><div><label class="block text-xs font-bold text-gray-500">Subtítulo</label><input type="text" id="ban-sub" class="neumo-inset w-full rounded-xl p-2 text-sm" required></div><div><label class="block text-xs font-bold text-gray-500">URL Imagen</label><input type="url" id="ban-img" class="neumo-inset w-full rounded-xl p-2 text-sm" required></div><button type="submit" class="neumo-button w-full bg-blue-600 text-white font-bold py-3 rounded-xl mt-2">Guardar</button></form></div>`);
        };

        window.saveBanner = async (e) => {
    e.preventDefault();
    try { 
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'banners'), { 
            title: document.getElementById('ban-title').value, 
            // CAMBIO: Se eliminó subtitle: document.getElementById('ban-sub').value
            imageUrl: document.getElementById('ban-img').value, 
            createdAt: serverTimestamp() 
        }); 
        showToast('Publicado', 'success'); 
        closeModal(); 
    } catch (err) { 
        showToast('Error', 'error'); 
    }
};

        window.deleteBanner = async (id) => { if(confirm("¿Eliminar banner?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'banners', id)); };
        // --- LÓGICA DE VENCIMIENTOS ---

window.initAdminExpirations = async () => {
    const list = document.getElementById('admin-expirations-list');
    list.innerHTML = '<div class="text-center py-10 opacity-50"><span class="animate-spin inline-block w-6 h-6 border-2 border-gray-800 border-t-transparent rounded-full"></span><p class="text-xs text-gray-400 mt-2">Calculando fechas...</p></div>';

    try {
        // 1. Obtener items vendidos
        const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'inventory_items'), where('status', '==', 'sold'));
        const snapshot = await getDocs(q);
        const items = [];
        const userIds = new Set(); 

        snapshot.forEach(doc => {
            const data = doc.data();
            // Filtramos solo items que tengan fecha de expiración y dueño
            if (data.expiryDate && data.soldTo) {
                items.push({ id: doc.id, ...data });
                userIds.add(data.soldTo);
            }
        });

        // 2. Obtener emails de los compradores
        const userMap = {};
        const uniqueIds = Array.from(userIds);
        if(uniqueIds.length > 0) {
            const userPromises = uniqueIds.map(uid => getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'all_users', uid)));
            const userSnaps = await Promise.all(userPromises);
            userSnaps.forEach(snap => {
                if(snap.exists()) userMap[snap.id] = snap.data().email;
            });
        }

        // 3. Calcular días restantes
        const processedItems = items.map(item => {
            const now = new Date();
            const expDate = new Date(item.expiryDate + 'T23:59:59'); 
            const diffTime = expDate - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            return {
                ...item,
                buyerEmail: userMap[item.soldTo] || 'Desconocido',
                daysLeft: diffDays
            };
        });

        // 4. Ordenar por urgencia
        processedItems.sort((a, b) => a.daysLeft - b.daysLeft);
        window.expirationCache = processedItems; 
        renderExpirationList(processedItems);

    } catch (e) {
        console.error(e);
        list.innerHTML = `<div class="text-center py-10 text-rose-500 text-sm">Error al cargar datos.</div>`;
    }
};

window.renderExpirationList = (items) => {
    const list = document.getElementById('admin-expirations-list');
    
    if (items.length === 0) {
        list.innerHTML = `<div class="text-center py-10 opacity-50"><p class="text-gray-400 text-sm">No hay membresías activas.</p></div>`;
        return;
    }

    let html = '';
    items.forEach(item => {
        let daysColor = 'text-emerald-600 bg-emerald-50 border-emerald-100';
        
        if (item.daysLeft <= 0) daysColor = 'text-gray-400 bg-gray-100 border-gray-200'; 
        else if (item.daysLeft <= 5) daysColor = 'text-rose-600 bg-rose-50 border-rose-100 animate-pulse'; 
        else if (item.daysLeft <= 10) daysColor = 'text-amber-600 bg-amber-50 border-amber-100'; 

        const purchaseDate = item.soldAt ? item.soldAt.toDate().toLocaleDateString() : 'N/A';

        html += `
        <div onclick="openExpirationDetail('${item.id}')" class="neumo-card p-4 rounded-xl relative slide-up hover:bg-gray-50 transition-all mb-3 cursor-pointer group hover:scale-[0.99]">
            <div class="flex justify-between items-start mb-2">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-gray-200 flex items-center justify-center font-bold text-gray-500 text-xs neumo-inset">
                        ${(item.category || 'SR').substring(0,2).toUpperCase()}
                    </div>
                    <div>
                        <h4 class="font-bold text-gray-800 text-sm leading-tight">${item.serviceName}</h4>
                        <p class="text-[10px] text-gray-400 font-mono mt-0.5 uppercase">${item.category}</p>
                    </div>
                </div>
                <div class="text-right">
                    <span class="text-xs font-black px-2 py-1 rounded-lg border ${daysColor} block mb-1">
                        ${item.daysLeft <= 0 ? 'VENCIDO' : `${item.daysLeft} Días`}
                    </span>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-2 text-[10px] border-t border-gray-100 pt-2 mt-2">
                <div class="col-span-2">
                    <span class="font-bold text-gray-400 uppercase">Cliente:</span>
                    <span class="font-bold text-indigo-600 ml-1 select-all">${item.buyerEmail}</span>
                </div>
                <div><span class="font-bold text-gray-400 uppercase block">Compra:</span><span class="font-medium text-gray-600">${purchaseDate}</span></div>
                <div><span class="font-bold text-gray-400 uppercase block">Vence:</span><span class="font-bold text-gray-800">${item.expiryDate}</span></div>
            </div>

            <div class="mt-3 flex gap-2 items-center">
                <div class="flex-1 bg-gray-50 p-2 rounded border border-gray-100 flex justify-between items-center group-hover:bg-white transition-colors">
                    <div class="overflow-hidden">
                        <p class="text-[9px] text-gray-400 font-bold uppercase">Cuenta:</p>
                        <p class="text-[10px] font-mono text-gray-600 truncate max-w-[180px]">${item.email || 'Ver Detalles'}</p>
                    </div>
                    <button onclick="event.stopPropagation(); navigator.clipboard.writeText('${item.email||''} ${item.password||''}').then(()=>showToast('Copiado'))" class="text-gray-400 hover:text-gray-800 p-1">
                        <i data-lucide="copy" class="w-3 h-3"></i>
                    </button>
                </div>
                
                <button onclick="event.stopPropagation(); deleteActiveMembership('${item.id}')" class="neumo-button w-10 h-full flex items-center justify-center text-rose-300 hover:text-rose-600 hover:bg-rose-50 rounded-lg border border-gray-100 shadow-sm" title="Eliminar Membresía">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </div>
        </div>`;
    });
    list.innerHTML = html;
    lucide.createIcons();
};

window.openExpirationDetail = (id) => {
    // 1. Buscamos el item en la memoria caché
    const item = window.expirationCache.find(x => x.id === id);
    if (!item) return;

    // 2. Preparamos la información adicional (Pines, perfiles, links, etc)
    let extraDetails = '';

    // Si tiene link (Libros/Apps)
    if (item.link) {
        extraDetails += `
        <div class="neumo-card neumo-inset p-3 mb-2">
            <p class="text-[10px] font-bold text-gray-400 uppercase mb-1">Enlace / Link</p>
            <a href="${item.link}" target="_blank" class="text-sm font-bold text-blue-600 underline break-all">${item.link}</a>
        </div>`;
    }

    // Si tiene perfil y pin
    if (item.profileName || item.pin) {
        extraDetails += `
        <div class="grid grid-cols-2 gap-3 mt-2">
            <div class="neumo-card neumo-inset p-3">
                <p class="text-[10px] font-bold text-gray-400 uppercase mb-1">Perfil</p>
                <p class="text-sm font-bold text-gray-800">${item.profileName || 'N/A'}</p>
            </div>
            <div class="neumo-card neumo-inset p-3">
                <p class="text-[10px] font-bold text-gray-400 uppercase mb-1">PIN</p>
                <p class="text-sm font-bold text-gray-800">${item.pin || 'N/A'}</p>
            </div>
        </div>`;
    }

    // Si es Game Pass o tiene descripción larga
    if (item.description) {
        extraDetails += `
        <div class="neumo-card neumo-inset p-3 mt-2">
            <p class="text-[10px] font-bold text-accent uppercase mb-1">Notas / Código</p>
            <p class="text-xs text-gray-600 whitespace-pre-wrap">${item.description}</p>
        </div>`;
    }

    // 3. Abrimos el modal con el diseño completo
    openModal(`
        <div class="text-left bounce-enter pt-2">
            <div class="flex items-center gap-3 mb-4 border-b border-gray-100 pb-3">
                <div class="w-12 h-12 bg-gray-900 text-white rounded-xl flex items-center justify-center shadow-lg">
                    <i data-lucide="package-search" class="w-6 h-6"></i>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-gray-800 leading-tight">${item.serviceName}</h3>
                    <p class="text-xs text-gray-500">Detalle completo de la venta</p>
                </div>
            </div>

            <div class="space-y-3">
                <div class="bg-indigo-50 border border-indigo-100 p-3 rounded-xl">
                    <p class="text-[10px] font-bold text-indigo-400 uppercase mb-1">Cliente Comprador</p>
                    <p class="font-bold text-indigo-700 text-sm select-all">${item.buyerEmail}</p>
                </div>

                <div class="neumo-card neumo-inset p-4 rounded-xl">
                    <div class="mb-3">
                        <p class="text-[10px] font-bold text-gray-400 uppercase mb-1">Correo de la Cuenta</p>
                        <div class="flex justify-between items-center">
                            <p class="font-mono text-sm font-bold text-gray-800 select-all break-all">${item.email || 'N/A'}</p>
                            <button onclick="navigator.clipboard.writeText('${item.email}').then(()=>showToast('Correo copiado'))" class="text-gray-400 hover:text-gray-600"><i data-lucide="copy" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <div class="border-t border-gray-200 pt-3">
                        <p class="text-[10px] font-bold text-gray-400 uppercase mb-1">Contraseña</p>
                        <div class="flex justify-between items-center">
                            <p class="font-mono text-lg font-black text-gray-800 select-all">${item.password || 'N/A'}</p>
                            <button onclick="navigator.clipboard.writeText('${item.password}').then(()=>showToast('Pass copiada'))" class="text-gray-400 hover:text-gray-600"><i data-lucide="copy" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                </div>

                ${extraDetails}

                <div class="grid grid-cols-2 gap-3 pt-2">
                    <div class="text-center bg-gray-50 rounded-lg p-2">
                        <p class="text-[9px] uppercase font-bold text-gray-400">Comprado</p>
                        <p class="font-bold text-gray-600 text-xs">${item.soldAt ? item.soldAt.toDate().toLocaleDateString() : '-'}</p>
                    </div>
                    <div class="text-center bg-gray-50 rounded-lg p-2">
                        <p class="text-[9px] uppercase font-bold text-gray-400">Vence</p>
                        <p class="font-bold text-gray-800 text-xs">${item.expiryDate}</p>
                    </div>
                </div>
            </div>

            <button onclick="closeModal()" class="neumo-button w-full bg-gray-900 text-white font-bold py-3 rounded-xl mt-6 shadow-lg">Cerrar Detalle</button>
        </div>
    `);
    lucide.createIcons();
};

window.filterExpirations = (mode) => {
    if (!window.expirationCache) return;
    let filtered = (mode === 'soon') ? window.expirationCache.filter(x => x.daysLeft <= 5 && x.daysLeft >= 0) : window.expirationCache;
    renderExpirationList(filtered);
};
        // --- 👇 PEGA AQUÍ EL BLOQUE DE CÓDIGO DEL ADMINISTRADOR 👇 ---

        function renderBannersAdmin() {
            const list = document.getElementById('admin-banners-list');
            if(!list) return;
            
            let html = '';
            bannerData.forEach(b => {
                html += `
                <div class="neumo-card p-0 rounded-xl overflow-hidden relative h-20 flex mb-3">
                    <div class="w-24 h-full bg-gray-200">
                        <img src="${b.imageUrl}" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1 p-3 flex flex-col justify-center">
                        <h4 class="font-bold text-gray-800 text-xs">${b.title}</h4>
                        <p class="text-[10px] text-gray-400">Activo</p>
                    </div>
                    <button onclick="deleteBanner('${b.id}')" class="absolute top-2 right-2 text-rose-500 bg-white rounded-full p-1 shadow hover:bg-rose-50">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>`;
            });
            
            list.innerHTML = html || '<p class="text-center text-xs text-gray-400 py-4">Sin banners activos</p>';
            lucide.createIcons();
        }

        window.openAddBannerModal = () => {
            openModal(`
            <div class="text-left bounce-enter">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Nuevo Banner</h3>
                <form onsubmit="saveBanner(event)" class="space-y-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500">Título (Referencia interna)</label>
                        <input type="text" id="ban-title" class="neumo-inset w-full rounded-xl p-2 text-sm" placeholder="Ej: Promo Navidad" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500">URL Imagen</label>
                        <input type="url" id="ban-img" class="neumo-inset w-full rounded-xl p-2 text-sm" required>
                    </div>
                    <button type="submit" class="neumo-button w-full bg-blue-600 text-white font-bold py-3 rounded-xl mt-2">Guardar</button>
                </form>
            </div>`);
        };

        window.saveBanner = async (e) => {
            e.preventDefault();
            try { 
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'banners'), { 
                    title: document.getElementById('ban-title').value, 
                    imageUrl: document.getElementById('ban-img').value, 
                    createdAt: serverTimestamp() 
                }); 
                showToast('Publicado', 'success'); 
                closeModal(); 
            } catch (err) { 
                showToast('Error al guardar', 'error'); 
            }
        };

        window.deleteBanner = async (id) => { 
            if(confirm("¿Eliminar este banner?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'banners', id)); 
            }
        };
        
                       // ======================================================
        // FUNCIÓN: COCINA EXPRESS (PANTALLA COMPLETA REAL)
        // ======================================================
        window.openCocinaExpress = () => {
            // Eliminamos si ya existe para evitar duplicados
            const old = document.getElementById('cocina-full-screen');
            if(old) old.remove();

            // Creamos un contenedor que cubra TODA la pantalla (encima del sidebar y header)
            const overlay = document.createElement('div');
            overlay.id = 'cocina-full-screen';
            // z-[99999] asegura que esté hasta el frente tapando todo.
            overlay.className = "fixed inset-0 z-[99999] bg-white flex flex-col animate-in fade-in duration-300";
            
            overlay.innerHTML = `
                <div class="flex items-center gap-4 px-4 py-3 border-b border-gray-200 bg-white shadow-sm flex-shrink-0">
                    <button onclick="document.getElementById('cocina-full-screen').remove()" class="neumo-button px-4 py-2 rounded-xl text-gray-700 font-bold flex items-center gap-2 hover:bg-gray-100 transition-colors border border-gray-100">
                        <i data-lucide="arrow-left" class="w-6 h-6"></i> 
                        <span>Regresar</span>
                    </button>
                    
                    <h3 class="font-bold text-lg text-gray-800 flex items-center gap-2">
                        <i data-lucide="chef-hat" class="w-5 h-5 text-orange-500"></i> Cocina Express
                    </h3>
                </div>
                
                <iframe src="https://cocina-express.pages.dev/Inicio" class="w-full flex-1 border-none bg-gray-50" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"></iframe>
            `;
            
            document.body.appendChild(overlay);
            lucide.createIcons();
        };

            // --- FUNCIÓN PARA ELIMINAR REPORTES (SOPORTE Y RENOVACIONES) ---
        window.deleteReport = async (id) => {
            if(confirm("¿Estás seguro de ELIMINAR este ticket permanentemente? No se podrá recuperar.")) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reports', id));
                    showToast('Ticket eliminado de la lista', 'success');
                } catch(e) {
                    console.error(e);
                    showToast('Error al eliminar', 'error');
                }
            }
        };
        
                        // ======================================================
        // BLOQUE NUEVO: VER MI RESPUESTA ENVIADA (ADMIN)
        // ======================================================
        window.viewAdminReply = (id) => {
            const r = window.adminReportsCache.find(x => x.id === id);
            
            if (!r || (!r.adminReply && !r.adminEvidence)) {
                return showToast('No hay contenido en la respuesta.', 'info');
            }
            
            const evidenceHtml = r.adminEvidence 
                ? `<div class="mt-4 border-t border-gray-100 pt-3"><p class="text-[10px] font-bold text-gray-400 uppercase mb-2">Imagen enviada:</p><img src="${r.adminEvidence}" class="w-full rounded-xl border border-gray-200 shadow-sm"></div>` 
                : '';
            
            openModal(`
                <div class="text-center bounce-enter pt-2 h-[70vh] flex flex-col">
                    <div class="w-14 h-14 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-3 border border-green-200 flex-shrink-0">
                        <i data-lucide="check-circle-2" class="w-7 h-7"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-1 flex-shrink-0">Respuesta Enviada</h3>
                    <p class="text-xs text-gray-400 mb-4 flex-shrink-0">Lo que le respondiste al usuario:</p>
                    
                    <div class="flex-1 overflow-y-auto scrollbar-hide text-left px-1">
                        <div class="neumo-card neumo-inset p-4 text-sm text-gray-700 rounded-xl whitespace-pre-wrap font-medium border border-gray-100 shadow-inner">
                            ${r.adminReply || '<i class="text-gray-400">Sin texto...</i>'}
                        </div>
                        ${evidenceHtml}
                    </div>
                    
                    <button onclick="closeModal()" class="neumo-button w-full bg-gray-900 text-white font-bold py-3 rounded-xl shadow-lg mt-4 flex-shrink-0">Cerrar</button>
                </div>
            `);
            lucide.createIcons();
        };

        window.deleteActiveMembership = async (id) => {
    // 1. Confirmación de seguridad
    if(!confirm("⚠️ ¿Eliminar esta membresía del registro?\n\nAl hacerlo, desaparecerá de esta lista y del historial. Esta acción no se puede deshacer.")) return;

    try {
        // 2. Eliminar documento de Firebase
        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'inventory_items', id));
        
        // 3. Eliminar visualmente de la lista (sin recargar todo)
        window.expirationCache = window.expirationCache.filter(item => item.id !== id);
        renderExpirationList(window.expirationCache);
        
        showToast('Membresía eliminada correctamente', 'success');
    } catch (e) {
        console.error(e);
        showToast('Error al eliminar: ' + e.message, 'error');
    }
};

       // ======================================================
// MIS REFERIDOS: DISEÑO PREMIUM (CON AUTOGENERACIÓN)
// ======================================================
window.renderReferralsView = async () => {
    // 1. Loader de inicio
    openModal(`
        <div class="flex flex-col items-center justify-center h-[50vh] bounce-enter">
            <div class="relative w-16 h-16 mb-4">
                <div class="absolute inset-0 border-4 border-indigo-100 rounded-full"></div>
                <div class="absolute inset-0 border-4 border-indigo-600 rounded-full border-t-transparent animate-spin"></div>
                <i data-lucide="users" class="absolute inset-0 m-auto w-6 h-6 text-indigo-600"></i>
            </div>
            <p class="text-xs font-bold text-indigo-400 uppercase tracking-widest animate-pulse">Cargando tu red...</p>
        </div>
    `);

    try {
        const uid = auth.currentUser.uid;
        const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'all_users', uid);
        
        // --- PASO A: VERIFICAR Y GENERAR CÓDIGO SI FALTA ---
        const userSnap = await getDoc(userRef);
        const userData = userSnap.data();
        let myCode = userData.myReferralCode;

        if (!myCode) {
            // Generamos código único: REF + 4 caracteres aleatorios
            myCode = 'REF-' + Math.random().toString(36).substr(2, 5).toUpperCase();
            await updateDoc(userRef, { myReferralCode: myCode }, { merge: true });
        }
        // --------------------------------------------------

        // --- PASO B: BUSCAR REFERIDOS (DOBLE BÚSQUEDA: UID Y CÓDIGO) ---
        // Esto asegura que aparezcan tanto los viejos (por UID) como los nuevos (por Código)
        const usersCollection = collection(db, 'artifacts', appId, 'public', 'data', 'all_users');
        
        // Consulta 1: Por UID (Sistema Antiguo/Actual)
        const q1 = query(usersCollection, where('referredBy', '==', uid));
        const snap1 = await getDocs(q1);
        
        // Consulta 2: Por Código (Sistema Nuevo/Futuro)
        const q2 = query(usersCollection, where('referredBy', '==', myCode));
        const snap2 = await getDocs(q2);

        // Unificar resultados sin duplicados
        const referralsMap = new Map();
        snap1.forEach(doc => referralsMap.set(doc.id, doc.data()));
        snap2.forEach(doc => referralsMap.set(doc.id, doc.data()));

        // --- CASO C: NO TIENES REFERIDOS ---
        if (referralsMap.size === 0) {
            openModal(`
            <div class="bg-white rounded-[2rem] overflow-hidden relative bounce-enter flex flex-col max-h-[85vh]">
                <div class="bg-gradient-to-br from-gray-100 to-gray-200 p-8 text-center relative">
                    <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mx-auto mb-3 shadow-lg neumo-inset">
                        <i data-lucide="user-plus" class="w-8 h-8 text-gray-400"></i>
                    </div>
                    <h3 class="text-xl font-black text-gray-700 tracking-tight">¡Empieza a Ganar!</h3>
                    <p class="text-xs text-gray-500 mt-1 max-w-[200px] mx-auto">Aún no tienes socios. Tu código es: <span class="font-bold text-indigo-600">${myCode}</span></p>
                </div>
                <div class="p-6 bg-white space-y-4">
                    <div class="bg-indigo-50 border border-indigo-100 p-4 rounded-2xl flex items-start gap-3">
                        <div class="bg-white p-2 rounded-lg text-indigo-600 shadow-sm"><i data-lucide="gift" class="w-5 h-5"></i></div>
                        <div>
                            <p class="font-bold text-indigo-700 text-sm">Beneficio Exclusivo</p>
                            <p class="text-[10px] text-indigo-500 mt-0.5">Gana saldo por cada recarga o compra que hagan tus referidos.</p>
                        </div>
                    </div>
                    <button onclick="openInviteModal()" class="neumo-button w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-xl hover:bg-indigo-700 hover:scale-[1.02] transition-all flex items-center justify-center gap-2">
                        <i data-lucide="share-2" class="w-5 h-5"></i> <span>Invitar Amigos Ahora</span>
                    </button>
                    <button onclick="closeModal()" class="w-full py-3 text-xs font-bold text-gray-400 hover:text-gray-600">Cerrar</button>
                </div>
            </div>`);
            lucide.createIcons();
            return;
        }

        // --- CASO D: SÍ TIENES REFERIDOS (Construir Lista) ---
        const userPromises = Array.from(referralsMap.values()).map(async (uData) => {
            let balanceTxt = '$--';
            let balanceClass = 'text-gray-400';
            let joinDate = 'Reciente';

            try {
                // Obtener saldo de cada referido para mostrarlo (Solo si eres admin o líder, opcional)
                const walletSnap = await getDoc(doc(db, 'artifacts', appId, 'users', uData.uid, 'wallet', 'main'));
                if(walletSnap.exists()) {
                    const bal = walletSnap.data().balance || 0;
                    balanceTxt = '$' + bal.toLocaleString();
                    balanceClass = bal > 0 ? 'text-emerald-600' : 'text-gray-400';
                    if(uData.createdAt) joinDate = uData.createdAt.toDate().toLocaleDateString();
                } else {
                    balanceTxt = '$0';
                }
            } catch(err) { balanceTxt = 'Privado'; }

            const initials = (uData.email || 'U').substring(0,2).toUpperCase();
            
            return `
            <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between group hover:border-indigo-200 transition-colors animate-in slide-in-from-bottom-2 duration-500 mb-2">
                <div class="flex items-center gap-3 overflow-hidden">
                    <div class="w-12 h-12 rounded-2xl bg-indigo-50 text-indigo-600 flex items-center justify-center font-black text-sm border border-indigo-100 shadow-sm flex-shrink-0">
                        ${initials}
                    </div>
                    <div class="min-w-0">
                        <p class="font-bold text-sm text-gray-800 truncate">${uData.fullName || 'Usuario'}</p>
                        <p class="text-[10px] text-gray-400 truncate font-mono">${uData.email}</p>
                        <div class="flex items-center gap-1 mt-0.5">
                            <i data-lucide="calendar-days" class="w-3 h-3 text-gray-300"></i>
                            <span class="text-[9px] text-gray-400 font-medium">Unido: ${joinDate}</span>
                        </div>
                    </div>
                </div>
                <div class="text-right pl-2">
                    <p class="text-[8px] font-bold text-gray-400 uppercase tracking-wider mb-0.5">Saldo</p>
                    <p class="font-black text-sm ${balanceClass}">${balanceTxt}</p>
                </div>
            </div>`;
        });

        const itemsHtmlArray = await Promise.all(userPromises);
        const listHtml = itemsHtmlArray.join('');

        // Renderizar Modal Final
        openModal(`
        <div class="bg-gray-50 rounded-[2rem] overflow-hidden relative bounce-enter flex flex-col max-h-[85vh]">
            <div class="bg-gradient-to-r from-indigo-600 to-blue-600 p-6 pb-12 text-center relative flex-shrink-0 shadow-lg z-10">
                <div class="absolute top-0 left-0 w-full h-full opacity-10" style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 10px 10px;"></div>
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h3 class="text-xl font-black text-white tracking-tight text-left">Mis Referidos</h3>
                        <p class="text-[10px] text-indigo-200 font-medium text-left uppercase tracking-widest">Código: ${myCode}</p>
                    </div>
                    <div class="bg-white/20 backdrop-blur-md rounded-xl px-3 py-1.5 flex items-center gap-2 border border-white/20">
                        <i data-lucide="users" class="w-4 h-4 text-white"></i>
                        <span class="text-lg font-bold text-white">${referralsMap.size}</span>
                    </div>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto scrollbar-hide px-4 -mt-6 relative z-20 pb-4">
                <div class="bg-white p-1 rounded-2xl shadow-md mb-4 flex items-center justify-between pl-4 pr-1 py-1 border border-indigo-100">
                    <span class="text-xs font-bold text-indigo-900">¿Quieres más ganancias?</span>
                    <button onclick="openInviteModal()" class="bg-indigo-600 text-white text-[10px] font-bold px-3 py-2 rounded-xl hover:bg-indigo-700 transition-colors flex items-center gap-1 shadow-md">
                        <i data-lucide="plus" class="w-3 h-3"></i> Invitar
                    </button>
                </div>
                <div class="space-y-1">
                    ${listHtml}
                </div>
            </div>
            
            <div class="p-4 bg-white border-t border-gray-200 z-30">
                <button onclick="closeModal()" class="neumo-button w-full bg-gray-100 text-gray-500 font-bold py-3.5 rounded-xl hover:bg-gray-200 transition-colors">
                    Cerrar Panel
                </button>
            </div>
        </div>`);
        lucide.createIcons();

    } catch (error) {
        console.error(error);
        showToast("Error al cargar referidos: " + error.message, "error");
        closeModal();
    }
};

        
                // --- FUNCIONES ADMIN: ELIMINAR Y EDITAR SALDO EXACTO ---

                // ======================================================
        // ELIMINAR USUARIO (LIMPIEZA PROFUNDA DE BD)
        // ======================================================
        window.deleteUserSystem = async (docId, uid, email) => {
            if(!confirm(`⚠️ ¿ELIMINAR A ${email}?\n\nEsta acción borrará:\n1. Su perfil de usuario.\n2. Su billetera de saldo.\n3. TODO su historial de transacciones.\n\n¿Estás seguro?`)) return;

            const btn = document.activeElement; 
            if(btn) btn.disabled = true;

            try {
                // 1. Borrar todas las transacciones (Limpieza del historial)
                // Es necesario borrar uno por uno los documentos de la subcolección
                const txRef = collection(db, 'artifacts', appId, 'users', uid, 'transactions');
                const txSnap = await getDocs(txRef);
                const deletePromises = txSnap.docs.map(d => deleteDoc(d.ref));
                await Promise.all(deletePromises);

                // 2. Borrar Billetera
                await deleteDoc(doc(db, 'artifacts', appId, 'users', uid, 'wallet', 'main'));

                // 3. Borrar Documento de Usuario (Perfil)
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'all_users', docId));
                
                // MENSAJE IMPORTANTE SOBRE EL CORREO
                alert(`✅ ¡Base de Datos Limpia!\n\nSe eliminaron todos los registros, saldo e historial de ${email}.\n\n⚠️ IMPORTANTE:\nPara que este usuario pueda registrarse de nuevo con el mismo correo, DEBES borrarlo manualmente en la sección "Authentication" de tu consola de Firebase.`);
                
            } catch (e) {
                console.error(e);
                showToast('Error al eliminar: ' + e.message, 'error');
                if(btn) btn.disabled = false;
            }
        };


        // 2. Abrir Modal Editar Saldo
        window.openEditBalanceExact = async (uid, email) => {
            const wRef = doc(db, 'artifacts', appId, 'users', uid, 'wallet', 'main');
            const snap = await getDoc(wRef);
            const currentBal = snap.exists() ? (snap.data().balance || 0) : 0;

            openModal(`
                <div class="text-center bounce-enter">
                    <div class="w-14 h-14 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-3 neumo-card neumo-inset">
                        <i data-lucide="pencil" class="w-7 h-7"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-1">Editar Saldo Exacto</h3>
                    <p class="text-xs text-gray-400 mb-4">${email}</p>
                    
                    <div class="bg-gray-50 p-3 rounded-xl border border-gray-100 mb-4 text-sm">
                        <span class="text-gray-500">Saldo Actual:</span>
                        <strong class="text-gray-800 text-lg ml-2">$${currentBal}</strong>
                    </div>

                    <label class="block text-[10px] font-bold text-gray-400 uppercase text-left ml-1 mb-1">Nuevo Saldo Final</label>
                    <input type="number" id="exact-balance-input" value="${currentBal}" class="neumo-inset w-full bg-transparent border-none rounded-xl px-4 py-3 text-lg font-bold text-center text-blue-600 mb-6">
                    
                    <button onclick="confirmEditBalance('${uid}', ${currentBal})" class="neumo-button w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-blue-700">
                        Guardar Nuevo Saldo
                    </button>
                </div>
            `);
            lucide.createIcons();
        };

        // 3. Confirmar Edición
        window.confirmEditBalance = async (uid, oldBalance) => {
            const val = document.getElementById('exact-balance-input').value;
            const newBalance = Number(val);

            if (val === '' || isNaN(newBalance)) return showToast('Número inválido', 'error');

            try {
                // Sobrescribir saldo
                await setDoc(doc(db, 'artifacts', appId, 'users', uid, 'wallet', 'main'), { 
                    balance: newBalance 
                }, { merge: true });

                // Registrar en historial
                await addDoc(collection(db, 'artifacts', appId, 'users', uid, 'transactions'), {
                    type: 'charge', 
                    amount: Math.abs(newBalance - oldBalance), 
                    description: `Ajuste Manual Admin (Edición)`,
                    details: { old: oldBalance, new: newBalance },
                    timestamp: serverTimestamp(),
                    status: 'approved'
                });

                showToast('Saldo actualizado', 'success');
                closeModal();
            } catch (e) {
                showToast('Error', 'error');
            }
        };
        
                                          // ======================================================
        // VISTA DE MEMBRESÍAS (MODO POP-UP / MODAL UNIFICADO)
        // ======================================================
        window.renderMembershipsView = async () => {
            // 1. Loader estilo Modal (mismo tema que Reportar/Perfil)
            openModal(`
                <div class="flex flex-col items-center justify-center h-[50vh] bounce-enter">
                    <div class="relative w-16 h-16 mb-4">
                        <div class="absolute inset-0 border-4 border-gray-100 rounded-full"></div>
                        <div class="absolute inset-0 border-4 border-amber-500 rounded-full border-t-transparent animate-spin"></div>
                        <i data-lucide="crown" class="absolute inset-0 m-auto w-6 h-6 text-amber-500"></i>
                    </div>
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-widest animate-pulse">Cargando catálogo...</p>
                </div>
            `);

            try {
                const snapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'profiles'));
                
                if (snapshot.empty) {
                    openModal(`
                        <div class="p-10 text-center bounce-enter">
                            <i data-lucide="package-open" class="w-12 h-12 mx-auto text-gray-300 mb-3"></i>
                            <p class="text-gray-400 font-bold text-sm">No hay productos disponibles.</p>
                            <button onclick="closeModal()" class="mt-4 neumo-button px-6 py-2 rounded-xl text-xs font-bold bg-gray-100 text-gray-500">Cerrar</button>
                        </div>
                    `);
                    lucide.createIcons();
                    return;
                }

                window.cachedMembershipProducts = []; 
                const categoriesSet = new Set();

                snapshot.forEach(doc => {
                    const d = doc.data();
                    const cat = d.category || 'Otros';
                    categoriesSet.add(cat); 
                    window.cachedMembershipProducts.push({ id: doc.id, ...d, categoryRaw: cat });
                });

                // Crear opciones para el select
                let categoryOptions = `<option value="all">Ver Todo</option>`;
                Array.from(categoriesSet).sort().forEach(cat => {
                    const displayCat = cat.charAt(0).toUpperCase() + cat.slice(1).replace(/-/g, ' ');
                    categoryOptions += `<option value="${cat}">${displayCat}</option>`;
                });

                // 2. Renderizar Modal Final (Diseño estándar del sistema con color Amber)
                openModal(`
                    <div class="bg-white rounded-[2rem] overflow-hidden relative bounce-enter flex flex-col max-h-[85vh]">
                        
                        <div class="bg-gradient-to-r from-amber-500 to-orange-500 p-6 pb-10 text-center relative flex-shrink-0 shadow-lg z-10">
                            <div class="absolute top-0 left-0 w-full h-full opacity-10" style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 10px 10px;"></div>
                            
                            <div class="w-12 h-12 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center mx-auto mb-2 text-white shadow-lg border border-white/30">
                                <i data-lucide="tag" class="w-6 h-6"></i>
                            </div>
                            <h3 class="text-xl font-black text-white uppercase tracking-tight relative z-10">Lista de Precios</h3>
                            <p class="text-[10px] text-amber-100 font-medium uppercase tracking-widest relative z-10">Catálogo actualizado</p>
                        </div>

                        <div class="px-5 py-4 bg-gray-50 border-b border-gray-200 flex gap-2 relative z-20 -mt-4 rounded-t-[1.5rem]">
                             <div class="relative flex-1">
                                <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
                                <input type="text" id="mem-search" oninput="filterMembershipList()" class="neumo-inset w-full pl-9 pr-4 py-2 rounded-xl text-xs font-bold bg-white border-none focus:ring-0 placeholder:text-gray-400" placeholder="Buscar servicio...">
                            </div>
                            <select id="mem-filter" onchange="document.getElementById('mem-search').value=''; filterMembershipList()" class="neumo-inset px-3 py-2 rounded-xl text-[10px] font-bold text-gray-600 bg-white border-none w-1/3 truncate focus:ring-0">
                                ${categoryOptions}
                            </select>
                        </div>

                        <div class="flex-1 overflow-y-auto scrollbar-hide px-4 py-4 bg-gray-50 relative z-10">
                            
                            <div class="flex flex-wrap justify-center gap-2 mb-4 opacity-70">
                                <span class="text-[9px] font-bold text-gray-500 flex items-center gap-1 bg-white px-2 py-1 rounded border border-gray-100"><div class="w-1.5 h-1.5 rounded-full bg-gray-500"></div> Cliente</span>
                                <span class="text-[9px] font-bold text-indigo-500 flex items-center gap-1 bg-white px-2 py-1 rounded border border-gray-100"><div class="w-1.5 h-1.5 rounded-full bg-indigo-500"></div> VIP</span>
                                <span class="text-[9px] font-bold text-amber-500 flex items-center gap-1 bg-white px-2 py-1 rounded border border-gray-100"><div class="w-1.5 h-1.5 rounded-full bg-amber-500"></div> Rev.</span>
                                <span class="text-[9px] font-bold text-rose-500 flex items-center gap-1 bg-white px-2 py-1 rounded border border-gray-100"><div class="w-1.5 h-1.5 rounded-full bg-rose-500"></div> Líder</span>
                            </div>

                            <div id="memberships-results-container" class="space-y-3 pb-4">
                                </div>
                        </div>

                        <div class="p-4 bg-white border-t border-gray-200 z-30">
                            <button onclick="closeModal()" class="neumo-button w-full bg-gray-100 text-gray-500 font-bold py-3.5 rounded-xl hover:bg-gray-200 transition-colors">
                                Cerrar Lista
                            </button>
                        </div>
                    </div>
                `);
                
                // Cargar lista inicial
                filterMembershipList();
                lucide.createIcons();

            } catch (error) {
                console.error(error);
                showToast("Error al cargar lista", "error");
                closeModal();
            }
        };

        // ======================================================
        // FUNCIÓN DE FILTRADO (ADAPTADA AL NUEVO MODAL)
        // ======================================================
        window.filterMembershipList = () => {
            const searchVal = document.getElementById('mem-search')?.value.toLowerCase().trim() || '';
            const catFilter = document.getElementById('mem-filter')?.value || 'all';
            const container = document.getElementById('memberships-results-container');
            
            if (!container || !window.cachedMembershipProducts) return;

            const filtered = window.cachedMembershipProducts.filter(p => {
                const matchesCat = catFilter === 'all' || p.categoryRaw === catFilter;
                const matchesSearch = p.name.toLowerCase().includes(searchVal);
                return matchesCat && matchesSearch;
            });

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-10 opacity-50">
                        <i data-lucide="search-x" class="w-10 h-10 mx-auto mb-2 text-gray-300"></i>
                        <p class="text-xs text-gray-400">Sin resultados.</p>
                    </div>`;
                lucide.createIcons();
                return;
            }

            let html = '';
            
            filtered.forEach(p => {
                // Precios
                const priceClient = p.priceClient || p.price || 0;
                const priceReseller = p.priceReseller || (priceClient * 0.8);
                const priceVip = p.priceVip || Math.round((priceClient + priceReseller) / 2);
                const priceLeader = p.priceLeader || (priceReseller * 0.9); 
                
                const fmt = (v) => v === 0 ? 'Free' : `$${Math.round(v)}`;

                let iconHtml = p.imageUrl 
                    ? `<img src="${p.imageUrl}" class="w-full h-full object-cover" alt="${p.name}">` 
                    : `<span class="text-lg font-black text-gray-400">${p.name.charAt(0)}</span>`;

                html += `
                    <div class="neumo-card p-3 flex flex-col bg-white relative overflow-hidden group hover:scale-[1.01] transition-transform border border-gray-100">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-10 h-10 rounded-xl bg-gray-50 flex items-center justify-center overflow-hidden neumo-inset border border-white flex-shrink-0">
                                ${iconHtml}
                            </div>
                            <div class="min-w-0">
                                <h4 class="font-bold text-gray-800 text-xs leading-tight truncate pr-2">${p.name}</h4>
                                <p class="text-[9px] text-gray-400 font-bold uppercase mt-0.5">${p.categoryRaw}</p>
                            </div>
                        </div>
                        
                        <div class="flex divide-x divide-gray-100 bg-gray-50 rounded-lg border border-gray-100 overflow-hidden">
                            <div class="flex-1 py-1.5 text-center">
                                <p class="text-[7px] text-gray-400 font-black uppercase">Cli</p>
                                <p class="text-[10px] font-black text-gray-600">${fmt(priceClient)}</p>
                            </div>
                            <div class="flex-1 py-1.5 text-center bg-indigo-50/30">
                                <p class="text-[7px] text-indigo-400 font-black uppercase">VIP</p>
                                <p class="text-[10px] font-black text-indigo-600">${fmt(priceVip)}</p>
                            </div>
                            <div class="flex-1 py-1.5 text-center bg-amber-50/30">
                                <p class="text-[7px] text-amber-500 font-black uppercase">Rev</p>
                                <p class="text-[10px] font-black text-amber-600">${fmt(priceReseller)}</p>
                            </div>
                            <div class="flex-1 py-1.5 text-center bg-rose-50/30">
                                <p class="text-[7px] text-rose-500 font-black uppercase">Lid</p>
                                <p class="text-[10px] font-black text-rose-600">${fmt(priceLeader)}</p>
                            </div>
                        </div>
                    </div>`;
            });

            container.innerHTML = html;
            lucide.createIcons();
        };

        
                // ==========================================
        // HELPER: TOKEN DE SEGURIDAD
        // ==========================================
        const generateSecureToken = () => {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        };
        
                // ======================================================
        // LÓGICA AVANZADA DE REEMBOLSOS (TOTAL Y PARCIAL)
        // ======================================================

        // 1. Calcular y mostrar confirmación
        window.checkRefundOptions = async (reportId, type) => {
            const report = window.adminReportsCache.find(x => x.id === reportId);
            if (!report || !report.relatedTransactionId) return showToast('Error: No hay transacción asociada.', 'error');

            const btnText = type === 'full' ? 'Calculando Total...' : 'Calculando Parcial...';
            showToast(btnText, 'info');

            try {
                // Obtenemos la transacción original de compra
                const txSnap = await getDoc(doc(db, 'artifacts', appId, 'users', report.uid, 'transactions', report.relatedTransactionId));
                if (!txSnap.exists()) throw new Error("Transacción original no encontrada");
                
                const txData = txSnap.data();
                const paidAmount = Number(txData.amount);
                const purchaseDate = txData.timestamp.toDate();
                const now = new Date();

                let refundAmount = 0;
                let modalTitle = "";
                let modalDesc = "";

                if (type === 'full') {
                    refundAmount = paidAmount;
                    modalTitle = "Reembolso Total";
                    modalDesc = `Se devolverá el 100% del monto pagado por el usuario.`;
                } else {
                    // CÁLCULO PARCIAL
                    modalTitle = "Reembolso Parcial";
                    const durationStr = txData.details.duration || "1 Mes"; // Default 1 mes si no hay dato
                    const totalDays = getDaysFromDurationString(durationStr);
                    
                    // Días trascurridos
                    const diffTime = Math.abs(now - purchaseDate);
                    const daysUsed = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    const daysRemaining = totalDays - daysUsed;

                    if (daysRemaining <= 0) throw new Error("La membresía ya venció, no hay días para reembolsar.");

                    const costPerDay = paidAmount / totalDays;
                    refundAmount = Math.floor(costPerDay * daysRemaining); // Redondeamos hacia abajo para no perder centavos

                    modalDesc = `
                        <div class="bg-gray-50 p-2 rounded border border-gray-200 text-left text-xs space-y-1 mb-2">
                            <div class="flex justify-between"><span>Costo Original:</span> <b>$${paidAmount}</b></div>
                            <div class="flex justify-between"><span>Duración:</span> <span>${durationStr} (${totalDays} días)</span></div>
                            <div class="flex justify-between"><span>Días Usados:</span> <span>${daysUsed} días</span></div>
                            <div class="flex justify-between text-indigo-600"><span>Días Restantes:</span> <b>${daysRemaining} días</b></div>
                        </div>
                        Se devolverá el monto proporcional a los días no utilizados.
                    `;
                }

                // Confirmación
                openModal(`
                    <div class="text-center bounce-enter pt-4">
                        <div class="w-16 h-16 bg-${type==='full'?'rose':'amber'}-100 text-${type==='full'?'rose':'amber'}-600 rounded-full flex items-center justify-center mx-auto mb-3 neumo-card neumo-inset">
                            <i data-lucide="${type==='full'?'refresh-ccw':'pie-chart'}" class="w-8 h-8"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">${modalTitle}</h3>
                        <p class="text-3xl font-black text-gray-800 mb-4">$${refundAmount}</p>
                        
                        <div class="text-sm text-gray-500 mb-6 px-4">
                            ${modalDesc}
                            <p class="text-[10px] text-rose-500 mt-3 font-bold bg-rose-50 p-2 rounded border border-rose-100">
                                ⚠️ ALERTA: Si el usuario fue invitado, se descontará automáticamente la comisión ($${(refundAmount * 0.10).toFixed(1)}) al patrocinador, incluso si queda en saldo negativo.
                            </p>
                        </div>

                        <button onclick="executeRefund('${reportId}', ${refundAmount}, ${paidAmount})" class="neumo-button w-full bg-gray-900 text-white font-bold py-3 rounded-xl shadow-lg mb-2">
                            Confirmar Reembolso
                        </button>
                        <button onclick="openReplyModal('${reportId}', '${report.uid}')" class="neumo-button w-full text-gray-500 font-bold text-xs py-2">Cancelar</button>
                    </div>
                `);
                lucide.createIcons();

            } catch (e) {
                console.error(e);
                showToast(e.message, 'error');
            }
        };

        // 2. Ejecutar Reembolso en BD
        window.executeRefund = async (reportId, amountToRefund, originalAmount) => {
            const btn = document.querySelector('button[onclick^="executeRefund"]');
            btn.disabled = true; 
            btn.innerHTML = '<span class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full"></span> Procesando...';

            try {
                const report = window.adminReportsCache.find(x => x.id === reportId);
                const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'all_users', report.uid);
                
                await runTransaction(db, async (t) => {
                    // A. Leer datos del usuario (para ver si tiene referido)
                    const userSnap = await t.get(userDocRef);
                    const referrerId = userSnap.exists() ? userSnap.data().referredBy : null;

                    // B. Leer billetera del usuario
                    const userWalletRef = doc(db, 'artifacts', appId, 'users', report.uid, 'wallet', 'main');
                    const userWalletSnap = await t.get(userWalletRef);
                    const currentUserBal = userWalletSnap.exists() ? (userWalletSnap.data().balance || 0) : 0;

                    // C. Leer billetera del patrocinador (si existe)
                    let refWalletRef = null;
                    let refWalletSnap = null;
                    if (referrerId) {
                        refWalletRef = doc(db, 'artifacts', appId, 'users', referrerId, 'wallet', 'main');
                        refWalletSnap = await t.get(refWalletRef);
                    }

                    // --- OPERACIONES ---

                    // 1. Devolver dinero al usuario
                    t.set(userWalletRef, { balance: currentUserBal + amountToRefund }, { merge: true });
                    
                    const userTx = doc(collection(db, 'artifacts', appId, 'users', report.uid, 'transactions'));
                    t.set(userTx, {
                        type: 'deposit',
                        amount: amountToRefund,
                        description: 'Reembolso por Soporte',
                        timestamp: serverTimestamp(),
                        status: 'approved'
                    });

                    // 2. Descontar al patrocinador (Si existe)
                    // NOTA: Se descuenta el 10% del monto reembolsado (Proporcional)
                    if (referrerId && refWalletSnap) {
                        const commissionToReverse = amountToRefund * 0.10; 
                        const currentRefBal = refWalletSnap.exists() ? (refWalletSnap.data().balance || 0) : 0;
                        const currentRefProfit = refWalletSnap.exists() ? (refWalletSnap.data().profit || 0) : 0;

                        // Restamos de las ganancias acumuladas y del saldo (permitiendo negativo)
                        t.set(refWalletRef, { 
                            balance: currentRefBal - commissionToReverse,
                            profit: currentRefProfit - commissionToReverse
                        }, { merge: true });

                        const refTx = doc(collection(db, 'artifacts', appId, 'users', referrerId, 'transactions'));
                        t.set(refTx, {
                            type: 'charge',
                            amount: -commissionToReverse, // Negativo visualmente
                            description: `Ajuste: Reembolso de referido (${report.email})`,
                            timestamp: serverTimestamp()
                        });
                    }

                    // 3. Actualizar Reporte
                    const reportRef = doc(db, 'artifacts', appId, 'public', 'data', 'reports', reportId);
                    t.update(reportRef, { 
                        status: 'resolved', 
                        adminReply: `Se ha realizado un reembolso de $${amountToRefund} a tu saldo.`,
                        resolvedAt: serverTimestamp()
                    });
                });

                showToast('Reembolso aplicado correctamente', 'success');
                closeModal();

            } catch (e) {
                console.error(e);
                showToast('Error en reembolso: ' + e.message, 'error');
                btn.disabled = false; btn.innerText = "Reintentar";
            }
        };

        // 3. Helper para convertir texto a días
        window.getDaysFromDurationString = (str) => {
            if (!str) return 30;
            const s = str.toLowerCase();
            if (s.includes('año') || s.includes('ano') || s.includes('anual')) return 365;
            if (s.includes('semana')) return 7;
            if (s.includes('dia') || s.includes('día')) return parseInt(s) || 1;
            
            // Meses
            if (s.includes('mes')) {
                const num = parseInt(s);
                return (num || 1) * 30;
            }
            return 30; // Default
        };
        
        // ======================================================
        // MOSTRAR FICHA DE DATOS (CON BOTÓN DE EDICIÓN)
        // ======================================================
        window.showUserDetails = async (uid) => {
            // Buscamos datos frescos
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'all_users', uid);
            const snap = await getDoc(docRef);
            
            if(!snap.exists()) return showToast('Usuario no encontrado', 'error');
            const u = snap.data();

            openModal(`
                <div class="text-center bounce-enter pt-4 relative">
                    <button onclick="editUserDetails('${uid}')" class="absolute top-0 right-2 p-2.5 text-gray-400 hover:text-indigo-600 transition-colors bg-white rounded-xl hover:bg-indigo-50 border border-gray-100 shadow-sm z-20 group" title="Editar Información">
                        <i data-lucide="pencil" class="w-4 h-4 group-hover:scale-110 transition-transform"></i>
                    </button>

                    <div class="w-20 h-20 bg-gradient-to-tr from-blue-500 to-indigo-600 rounded-full flex items-center justify-center mx-auto mb-3 shadow-lg text-white font-black text-2xl border-4 border-white">
                        ${(u.email||'??').substring(0,2).toUpperCase()}
                    </div>
                    
                    <h3 class="text-xl font-bold text-gray-800 mb-1">${u.fullName || 'Sin Nombre'}</h3>
                    <p class="text-xs text-gray-500 mb-6 font-mono bg-gray-100 inline-block px-2 py-1 rounded">${u.email}</p>

                    <div class="space-y-3 text-left max-w-xs mx-auto">
                        <div class="neumo-card neumo-inset p-3 flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-green-100 text-green-600 flex items-center justify-center flex-shrink-0"><i data-lucide="phone" class="w-5 h-5"></i></div>
                            <div class="overflow-hidden flex-1">
                                <p class="text-[10px] font-bold text-gray-400 uppercase">WhatsApp</p>
                                <p class="font-bold text-gray-700 text-sm truncate">${u.whatsapp || 'No registrado'}</p>
                            </div>
                            ${u.whatsapp ? `<button onclick="window.open('https://wa.me/${u.whatsapp}','_blank')" class="text-green-500 hover:text-green-700 bg-white p-2 rounded-lg shadow-sm border border-green-100"><i data-lucide="message-circle" class="w-4 h-4"></i></button>` : ''}
                        </div>
                        
                        <div class="neumo-card neumo-inset p-3 flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-orange-100 text-orange-600 flex items-center justify-center flex-shrink-0"><i data-lucide="map-pin" class="w-5 h-5"></i></div>
                            <div class="overflow-hidden">
                                <p class="text-[10px] font-bold text-gray-400 uppercase">Ciudad</p>
                                <p class="font-bold text-gray-700 text-sm truncate">${u.city || 'No registrada'}</p>
                            </div>
                        </div>
                    </div>

                    <button onclick="closeModal()" class="neumo-button w-full bg-gray-900 text-white font-bold py-3 rounded-xl mt-6 shadow-lg">Cerrar Ficha</button>
                </div>
            `);
            lucide.createIcons();
        };

        // --- FUNCIÓN NUEVA: MODO EDICIÓN ---
        window.editUserDetails = async (uid) => {
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'all_users', uid);
            const snap = await getDoc(docRef);
            if(!snap.exists()) return;
            const u = snap.data();

            openModal(`
                <div class="text-left bounce-enter pt-2">
                    <div class="text-center mb-6">
                        <div class="w-12 h-12 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-2 neumo-card neumo-inset"><i data-lucide="user-cog" class="w-6 h-6"></i></div>
                        <h3 class="text-lg font-bold text-gray-800">Editar Información</h3>
                        <p class="text-xs text-gray-400">${u.email}</p>
                    </div>
                    
                    <form onsubmit="saveUserDetails(event, '${uid}')" class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">Nombre y Apellido</label>
                            <div class="relative">
                                <i data-lucide="user" class="absolute left-3 top-3 w-4 h-4 text-gray-400"></i>
                                <input type="text" id="edit-u-name" value="${u.fullName || ''}" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 pl-10 text-sm font-bold text-gray-700" placeholder="Nombre completo">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-green-600 uppercase mb-1 ml-1">WhatsApp</label>
                            <div class="relative">
                                <i data-lucide="phone" class="absolute left-3 top-3 w-4 h-4 text-green-500"></i>
                                <input type="number" id="edit-u-whatsapp" value="${u.whatsapp || ''}" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 pl-10 text-sm font-bold text-gray-700" placeholder="Solo números">
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-orange-500 uppercase mb-1 ml-1">Ciudad / Municipio</label>
                            <div class="relative">
                                <i data-lucide="map-pin" class="absolute left-3 top-3 w-4 h-4 text-orange-500"></i>
                                <input type="text" id="edit-u-city" value="${u.city || ''}" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 pl-10 text-sm font-bold text-gray-700" placeholder="Ciudad">
                            </div>
                        </div>

                        <div class="flex gap-3 mt-6 pt-2">
                            <button type="button" onclick="showUserDetails('${uid}')" class="neumo-button flex-1 bg-white text-gray-500 border border-gray-200 font-bold py-3 rounded-xl hover:bg-gray-50 transition-colors">Cancelar</button>
                            <button type="submit" class="neumo-button flex-1 bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-indigo-700 transition-transform active:scale-95 flex items-center justify-center gap-2">
                                <i data-lucide="save" class="w-4 h-4"></i> Guardar
                            </button>
                        </div>
                    </form>
                </div>
            `);
            lucide.createIcons();
        };

        // --- FUNCIÓN NUEVA: GUARDAR CAMBIOS ---
        window.saveUserDetails = async (e, uid) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.disabled = true; 
            btn.innerHTML = '<span class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full"></span>';

            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'all_users', uid), {
                    fullName: document.getElementById('edit-u-name').value,
                    whatsapp: document.getElementById('edit-u-whatsapp').value,
                    city: document.getElementById('edit-u-city').value
                });
                
                showToast('Datos actualizados correctamente', 'success');
                showUserDetails(uid); // Regresamos a la ficha ya actualizada
            } catch(err) {
                console.error(err);
                showToast('Error al actualizar: ' + err.message, 'error');
                btn.disabled = false; 
                btn.innerHTML = originalText;
            }
        };
        
                // ======================================================
        // FUNCIÓN: ELIMINAR HISTORIAL DE USUARIO (CON REPORTE DETALLADO)
        // ======================================================
        window.clearUserHistory = async (uid, email) => {
            // 1. Confirmación de Seguridad
            if(!confirm(`⚠️ ¿ATENCIÓN?\n\nEstás a punto de borrar TODO el historial de transacciones de:\n${email}\n\nEsto eliminará registros de compras, recargas y movimientos.\nEl saldo actual NO se verá afectado.\n\n¿Estás seguro de continuar?`)) return;

            try {
                // 2. Referencia a la subcolección de transacciones
                const transactionsRef = collection(db, 'artifacts', appId, 'users', uid, 'transactions');
                
                // 3. Obtenemos todos los documentos
                const snapshot = await getDocs(transactionsRef);

                if (snapshot.empty) {
                    return showToast('El historial de este usuario ya está vacío.', 'info');
                }

                // 4. Contamos cuántos archivos vamos a borrar
                const totalRecords = snapshot.size;

                // 5. Borrado masivo (Promise.all para velocidad)
                const deletePromises = snapshot.docs.map(doc => deleteDoc(doc.ref));
                await Promise.all(deletePromises);

                // MENSAJE PERSONALIZADO CON CANTIDAD Y USUARIO
                showToast(`Eliminado: Se borraron ${totalRecords} registros del historial de ${email}`, 'success');

            } catch (e) {
                console.error(e);
                showToast('Error al eliminar historial: ' + e.message, 'error');
            }
        };
        
           // ======================================================
        // MI PERFIL: DISEÑO PREMIUM (MODERNO)
        // ======================================================
        window.openUserProfile = async () => {
            if(!currentUser) return;
            
            // 1. Cargar datos del perfil
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'all_users', currentUser.uid);
            const snap = await getDoc(docRef);
            const u = snap.exists() ? snap.data() : {};

            // 2. Cargar billetera
            const walletRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'wallet', 'main');
            const walletSnap = await getDoc(walletRef);
            const currentProfit = walletSnap.exists() ? (walletSnap.data().profit || 0) : 0;

            // 3. Calcular Totales Históricos
            let totalDeposited = 0;
            let totalSpent = 0;

            try {
                const txRef = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions');
                const txSnaps = await getDocs(txRef);
                
                txSnaps.forEach(doc => {
                    const t = doc.data();
                    if (t.type === 'deposit') {
                        const status = (t.status || '').toLowerCase();
                        if (status !== 'rejected' && status !== 'cancelled' && status !== 'cancelado' && status !== 'pending') {
                            totalDeposited += (Number(t.amount) || 0);
                        }
                    }
                    if (t.type === 'purchase') {
                        totalSpent += (Number(t.amount) || 0);
                    }
                });
            } catch (e) { console.log("Error calculando totales", e); }

            // 4. Renderizar Modal (NUEVO DISEÑO)
            openModal(`
            <div class="relative w-full bg-white rounded-[2rem] overflow-hidden bounce-enter">
                
                <div class="absolute top-0 left-0 w-full h-32 bg-gradient-to-br from-indigo-600 via-purple-600 to-blue-600"></div>
                
                <div class="absolute top-0 right-0 p-4 opacity-10">
                    <i data-lucide="circuit-board" class="w-32 h-32 text-white"></i>
                </div>

                <button onclick="enableMyProfileEdit()" class="absolute top-4 right-4 z-20 bg-white/20 backdrop-blur-md border border-white/30 text-white p-2 rounded-xl hover:bg-white hover:text-indigo-600 transition-all shadow-lg group">
                    <i data-lucide="pencil" class="w-4 h-4 group-hover:scale-110 transition-transform"></i>
                </button>

                <div class="relative pt-16 px-6 pb-6 flex flex-col items-center">
                    
                    <div class="relative mb-3">
                        <div class="absolute inset-0 bg-indigo-500 rounded-full blur-md opacity-50 translate-y-2"></div>
                        <div class="w-24 h-24 rounded-full p-1 bg-white relative z-10 shadow-xl">
                            <div class="w-full h-full rounded-full bg-gradient-to-tr from-gray-100 to-gray-200 flex items-center justify-center text-3xl font-black text-gray-400 uppercase">
                                ${(currentUser.email||'??').substring(0,2)}
                            </div>
                        </div>
                        <div class="absolute bottom-1 right-1 z-20 bg-emerald-500 w-6 h-6 rounded-full border-4 border-white"></div>
                    </div>
                    
                    <h3 class="text-2xl font-black text-gray-800 capitalize tracking-tight mb-1 text-center">${u.fullName || 'Usuario'}</h3>
                    <p class="text-xs font-medium text-gray-400 bg-gray-100 px-3 py-1 rounded-full mb-6">${currentUser.email}</p>

                    <div class="grid grid-cols-2 gap-3 w-full mb-6">
                        <div class="p-3 rounded-2xl bg-gray-50 border border-gray-100 flex flex-col items-center gap-1 group hover:bg-green-50 hover:border-green-100 transition-colors">
                            <i data-lucide="phone" class="w-5 h-5 text-gray-400 group-hover:text-green-500 mb-1 transition-colors"></i>
                            <span class="text-[10px] font-bold text-gray-400 uppercase">WhatsApp</span>
                            <span class="text-xs font-bold text-gray-700 truncate max-w-full">${u.whatsapp || '--'}</span>
                        </div>
                        <div class="p-3 rounded-2xl bg-gray-50 border border-gray-100 flex flex-col items-center gap-1 group hover:bg-orange-50 hover:border-orange-100 transition-colors">
                            <i data-lucide="map-pin" class="w-5 h-5 text-gray-400 group-hover:text-orange-500 mb-1 transition-colors"></i>
                            <span class="text-[10px] font-bold text-gray-400 uppercase">Ciudad</span>
                            <span class="text-xs font-bold text-gray-700 truncate max-w-full">${u.city || '--'}</span>
                        </div>
                    </div>

                    <div class="w-full space-y-3">
                        
                        <div class="flex items-center justify-between p-4 rounded-2xl bg-white border border-gray-100 shadow-sm relative overflow-hidden">
                            <div class="absolute left-0 top-0 bottom-0 w-1 bg-emerald-500"></div>
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center">
                                    <i data-lucide="trending-up" class="w-5 h-5"></i>
                                </div>
                                <div>
                                    <p class="text-[10px] font-bold text-gray-400 uppercase">Recargas</p>
                                    <p class="text-xs text-gray-500">Histórico</p>
                                </div>
                            </div>
                            <span class="text-lg font-black text-gray-800">$${totalDeposited.toLocaleString()}</span>
                        </div>

                        <div class="flex items-center justify-between p-4 rounded-2xl bg-white border border-gray-100 shadow-sm relative overflow-hidden">
                            <div class="absolute left-0 top-0 bottom-0 w-1 bg-rose-500"></div>
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-rose-50 text-rose-600 flex items-center justify-center">
                                    <i data-lucide="shopping-bag" class="w-5 h-5"></i>
                                </div>
                                <div>
                                    <p class="text-[10px] font-bold text-gray-400 uppercase">Compras</p>
                                    <p class="text-xs text-gray-500">Total gastado</p>
                                </div>
                            </div>
                            <span class="text-lg font-black text-gray-800">$${totalSpent.toLocaleString()}</span>
                        </div>

                        <div class="flex items-center justify-between p-4 rounded-2xl bg-gray-900 text-white shadow-lg relative overflow-hidden">
                            <div class="flex items-center gap-3 relative z-10">
                                <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center">
                                    <i data-lucide="wallet" class="w-5 h-5 text-indigo-400"></i>
                                </div>
                                <div>
                                    <p class="text-[10px] font-bold text-gray-400 uppercase">Ganancias</p>
                                    <p class="text-xs text-gray-300">Disponible</p>
                                </div>
                            </div>
                            <span class="text-2xl font-black text-white relative z-10">$${currentProfit.toLocaleString()}</span>
                            <i data-lucide="sparkles" class="absolute -bottom-2 -right-2 w-16 h-16 text-white/5"></i>
                        </div>
                    </div>

                    <button onclick="closeModal()" class="mt-6 text-xs font-bold text-gray-400 hover:text-gray-600 transition-colors">Cerrar</button>
                </div>
            </div>`);
            lucide.createIcons();
        };
        
                // ======================================================
        // 2. MI PERFIL: MODO EDICIÓN
        // ======================================================
        window.enableMyProfileEdit = async () => {
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'all_users', currentUser.uid);
            const snap = await getDoc(docRef);
            const u = snap.exists() ? snap.data() : {};

            openModal(`
                <div class="text-left bounce-enter">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-12 h-12 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center neumo-card neumo-inset">
                            <i data-lucide="user-cog" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 leading-tight">Editar Perfil</h3>
                            <p class="text-xs text-gray-400">Modifica tus datos</p>
                        </div>
                    </div>
                    
                    <form onsubmit="saveMyProfile(event)" class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">Nombre y Apellido</label>
                            <div class="relative">
                                <i data-lucide="user" class="absolute left-3 top-3 w-4 h-4 text-gray-400"></i>
                                <input type="text" id="my-profile-name" value="${u.fullName || ''}" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 pl-10 text-sm font-bold text-gray-700 placeholder-gray-300" required placeholder="Tu nombre completo">
                            </div>
                            <p class="text-[9px] text-orange-400 mt-1 ml-1">* Solo puedes cambiar el nombre cada 28 días.</p>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold text-green-600 uppercase mb-1 ml-1">WhatsApp</label>
                                <div class="relative">
                                    <i data-lucide="phone" class="absolute left-3 top-3 w-4 h-4 text-green-500"></i>
                                    <input type="number" id="my-profile-whatsapp" value="${u.whatsapp || ''}" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 pl-10 text-sm font-bold text-gray-700 placeholder-gray-300" placeholder="Número">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-orange-500 uppercase mb-1 ml-1">Ciudad</label>
                                <div class="relative">
                                    <i data-lucide="map-pin" class="absolute left-3 top-3 w-4 h-4 text-orange-500"></i>
                                    <input type="text" id="my-profile-city" value="${u.city || ''}" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 pl-10 text-sm font-bold text-gray-700 placeholder-gray-300" placeholder="Ciudad">
                                </div>
                            </div>
                        </div>

                        <div class="flex gap-3 mt-4">
                            <button type="button" onclick="openUserProfile()" class="neumo-button flex-1 bg-gray-100 text-gray-500 font-bold py-3 rounded-xl hover:bg-gray-200">Cancelar</button>
                            <button type="submit" class="neumo-button flex-[2] bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-indigo-700 transition-transform active:scale-95 flex items-center justify-center gap-2">
                                <i data-lucide="save" class="w-4 h-4"></i> Guardar
                            </button>
                        </div>
                    </form>
                </div>
            `);
            lucide.createIcons();
        };

          // ======================================================
        // 3. GUARDAR PERFIL (CON RESTRICCIÓN Y RETORNO A VISTA)
        // ======================================================
        window.saveMyProfile = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalHTML = btn.innerHTML;
            btn.disabled = true; 
            btn.innerHTML = '<span class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full"></span>';

            try {
                const newName = document.getElementById('my-profile-name').value.trim();
                const newWhatsapp = document.getElementById('my-profile-whatsapp').value.trim();
                const newCity = document.getElementById('my-profile-city').value.trim();

                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'all_users', currentUser.uid);
                
                const snap = await getDoc(userRef);
                const currentData = snap.data();
                const currentName = currentData.fullName || '';

                let updateData = {
                    whatsapp: newWhatsapp,
                    city: newCity
                };

                if (newName !== currentName) {
                    if (!isAdmin) {
                        const lastUpdate = currentData.lastFullNameUpdate ? currentData.lastFullNameUpdate.toDate() : null;
                        if (lastUpdate) {
                            const now = new Date();
                            const nextAllowedDate = new Date(lastUpdate);
                            nextAllowedDate.setDate(nextAllowedDate.getDate() + 28);

                            if (now < nextAllowedDate) {
                                const diffTime = Math.abs(nextAllowedDate - now);
                                const daysRemaining = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                throw new Error(`⚠️ Solo puedes cambiar tu nombre cada 28 días. Espera ${daysRemaining} días más.`);
                            }
                        }
                    }
                    updateData.fullName = newName;
                    updateData.lastFullNameUpdate = serverTimestamp();
                }

                await updateDoc(userRef, updateData);
                
                // Actualizar sidebar visualmente
                const sidebarNameEl = document.getElementById('sidebar-user-name');
                if(sidebarNameEl && updateData.fullName) sidebarNameEl.textContent = updateData.fullName;
                
                showToast('Perfil actualizado correctamente', 'success');
                
                // VOLVER A LA VISTA DE LECTURA PARA VER LOS CAMBIOS
                openUserProfile(); 

            } catch (err) {
                console.error(err);
                showToast(err.message, 'error');
                btn.disabled = false; 
                btn.innerHTML = originalHTML;
            }
        };
        
                // ======================================================
        // FUNCIÓN DE MANTENIMIENTO: LIMPIAR BD (USUARIOS FANTASMA)
        // ======================================================
        window.cleanOrphanedData = async () => {
            if(!confirm("⚠️ MANTENIMIENTO DE BASE DE DATOS\n\nEsta función buscará residuos (billeteras, historiales) de usuarios que ya eliminaste anteriormente y los borrará definitivamente.\n\n¿Deseas proceder?")) return;

            const btn = document.querySelector('button[onclick="cleanOrphanedData()"]');
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-spin inline-block w-4 h-4 border-2 border-orange-600 border-t-transparent rounded-full"></span>';

            try {
                showToast('Analizando base de datos...', 'info');

                // 1. Obtener lista de Usuarios Válidos (Los que SI existen en la lista 'Usuarios')
                const validUsersSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'all_users'));
                const validUserIds = new Set();
                validUsersSnap.forEach(doc => validUserIds.add(doc.id));

                // 2. Obtener lista de carpetas de datos ocultos (Billeteras y Transacciones)
                const dataCollectionRef = collection(db, 'artifacts', appId, 'users');
                const dataSnap = await getDocs(dataCollectionRef);

                let deletedCount = 0;
                const promises = [];

                for (const docSnapshot of dataSnap.docs) {
                    const uid = docSnapshot.id;

                    // Si el ID de esta carpeta NO está en la lista de usuarios válidos... ES BASURA
                    if (!validUserIds.has(uid)) {
                        deletedCount++;
                        console.log(`Eliminando residuos de: ${uid}`);

                        // A. Borrar Billetera
                        promises.push(deleteDoc(doc(db, 'artifacts', appId, 'users', uid, 'wallet', 'main')));

                        // B. Borrar Transacciones (Leemos y borramos una por una)
                        const txRef = collection(db, 'artifacts', appId, 'users', uid, 'transactions');
                        const txSnap = await getDocs(txRef);
                        txSnap.forEach(tx => {
                            promises.push(deleteDoc(tx.ref));
                        });

                        // C. Borrar la carpeta contenedora
                        promises.push(deleteDoc(docSnapshot.ref));
                    }
                }

                if (deletedCount === 0) {
                    showToast('La base de datos está limpia. No se encontraron residuos.', 'success');
                } else {
                    await Promise.all(promises);
                    showToast(`Limpieza completada: Se eliminaron datos de ${deletedCount} usuarios antiguos.`, 'success');
                }

            } catch (e) {
                console.error(e);
                showToast('Error en limpieza: ' + e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        };
        
                // ======================================================
        // FUNCIÓN: LIMPIEZA DE DATOS HUÉRFANOS (Borra basura de BD)
        // ======================================================
        window.cleanDatabaseOrphans = async () => {
            if(!confirm("⚠️ MANTENIMIENTO DE BASE DE DATOS\n\nEsta función buscará carpetas de datos (billeteras, historiales) que pertenecen a usuarios que YA NO EXISTEN en tu lista de 'Usuarios'.\n\nSi borraste un usuario y quedó basura en la BD, esto lo eliminará.\n\n¿Deseas escanear y limpiar?")) return;

            const btn = document.querySelector('button[onclick="cleanDatabaseOrphans()"]');
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="animate-spin inline-block w-4 h-4 border-2 border-orange-600 border-t-transparent rounded-full"></span>';

            try {
                showToast('Escaneando usuarios activos...', 'info');

                // 1. Obtener la lista OFICIAL de usuarios activos (all_users)
                // Estos son los que SÍ existen y ves en tu panel.
                const activeUsersSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'all_users'));
                const activeUserIds = new Set();
                activeUsersSnap.forEach(doc => activeUserIds.add(doc.id));

                // 2. Obtener TODAS las carpetas de datos (users)
                // Aquí están las billeteras y transacciones (incluyendo las de usuarios borrados)
                const dataCollectionRef = collection(db, 'artifacts', appId, 'users');
                const dataSnap = await getDocs(dataCollectionRef);

                let deletedCount = 0;
                const promises = [];

                // 3. Comparar y Borrar
                for (const docSnapshot of dataSnap.docs) {
                    const uid = docSnapshot.id;

                    // Si el ID de esta carpeta NO está en la lista de activos... ¡ES BASURA!
                    if (!activeUserIds.has(uid)) {
                        console.log(`Encontrado residuo de usuario eliminado: ${uid}`);
                        deletedCount++;

                        // A. Borrar su Billetera
                        promises.push(deleteDoc(doc(db, 'artifacts', appId, 'users', uid, 'wallet', 'main')));

                        // B. Borrar sus Transacciones (una por una porque es subcolección)
                        const txRef = collection(db, 'artifacts', appId, 'users', uid, 'transactions');
                        const txSnap = await getDocs(txRef);
                        txSnap.forEach(tx => {
                            promises.push(deleteDoc(tx.ref));
                        });

                        // C. Borrar la carpeta principal del usuario fantasma
                        promises.push(deleteDoc(docSnapshot.ref));
                    }
                }

                if (promises.length > 0) {
                    await Promise.all(promises);
                    alert(`✅ LIMPIEZA COMPLETADA\n\nSe eliminaron los datos residuales de ${deletedCount} usuarios que ya no existían en tu lista.`);
                } else {
                    showToast('Tu base de datos ya está limpia. No hay residuos.', 'success');
                }

            } catch (e) {
                console.error(e);
                alert('Error durante la limpieza: ' + e.message + '\n\nVerifica que tengas los permisos de Administrador configurados en Firebase Rules.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        };
        
                // ======================================================
        // MODAL DE DESCARGA DE APP (ANDROID)
        // ======================================================
        window.openDownloadModal = () => {
            const appLink = "https://www.mediafire.com/file/tweka8kkm1jg5sx/StreamEvolution.apk/file";
            
            openModal(`
            <div class="bg-gray-50 rounded-[2rem] overflow-hidden relative bounce-enter flex flex-col max-h-[85vh]">
                
                <div class="bg-gradient-to-bl from-emerald-500 to-teal-600 p-6 text-center relative flex-shrink-0 shadow-lg z-10 overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-full opacity-20" style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 10px 10px;"></div>
                    
                    <div class="relative w-16 h-16 mx-auto mb-2 group cursor-pointer">
                        <div class="absolute inset-0 bg-white/20 rounded-full blur-md animate-pulse"></div>
                        <div class="w-16 h-16 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center relative z-10 shadow-2xl border border-white/40 transform group-hover:scale-110 transition-transform duration-300">
                            <i data-lucide="smartphone" class="w-8 h-8 text-white drop-shadow-md"></i>
                        </div>
                    </div>

                    <h3 class="text-xl font-black text-white tracking-tight uppercase relative z-10 mb-1">Descargar App</h3>
                    <p class="text-[10px] text-emerald-100 font-medium max-w-[250px] mx-auto relative z-10">Instala nuestra aplicación oficial en tu Android.</p>
                </div>

                <div class="p-5 flex-1 overflow-y-auto scrollbar-hide relative z-20 space-y-4">
                    
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 text-center">
                        <p class="text-xs font-bold text-gray-700 mb-2">Enlace de Descarga</p>
                        <div class="flex items-center gap-2 bg-gray-50 border border-gray-200 rounded-xl p-2 shadow-inner">
                            <input type="text" readonly value="${appLink}" class="w-full bg-transparent border-none text-[10px] font-bold text-gray-500 focus:ring-0 truncate font-mono select-all">
                            <button onclick="navigator.clipboard.writeText('${appLink}').then(()=>showToast('Enlace copiado','success'))" class="bg-white text-gray-600 p-2 rounded-lg border border-gray-200 hover:text-emerald-600 hover:border-emerald-200 transition-colors">
                                <i data-lucide="copy" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="window.open('https://wa.me/?text=${encodeURIComponent('Descarga la App aquí: ' + appLink)}', '_blank')" class="bg-[#25D366] text-white py-3 rounded-xl shadow-md shadow-green-100 hover:bg-[#20bd5a] flex items-center justify-center gap-2 transition-transform active:scale-95">
                            <i data-lucide="message-circle" class="w-4 h-4"></i>
                            <span class="text-[10px] font-bold">WhatsApp</span>
                        </button>
                        <button onclick="navigator.share ? navigator.share({title: 'Descargar App', text: 'Instala la app oficial', url: '${appLink}'}) : showToast('Opción no soportada', 'info')" class="bg-indigo-600 text-white py-3 rounded-xl shadow-md shadow-indigo-100 hover:bg-indigo-700 flex items-center justify-center gap-2 transition-transform active:scale-95">
                            <i data-lucide="share-2" class="w-4 h-4"></i>
                            <span class="text-[10px] font-bold">Más Opciones</span>
                        </button>
                    </div>

                    <a href="${appLink}" target="_blank" class="neumo-button w-full bg-gray-900 text-white font-bold py-4 rounded-2xl shadow-xl hover:bg-gray-800 transform active:scale-95 transition-all flex items-center justify-center gap-2 no-underline">
                        <i data-lucide="download-cloud" class="w-5 h-5"></i>
                        <span>Descarga Directa</span>
                    </a>

                </div>

                <div class="p-4 bg-white border-t border-gray-200 z-30">
                    <button onclick="closeModal()" class="w-full py-3 rounded-xl text-xs font-bold text-gray-400 hover:text-gray-600 hover:bg-gray-50 transition-colors">
                        Cerrar Ventana
                    </button>
                </div>
            </div>`);
            lucide.createIcons();
        };
        
                  // ==========================================
        // CONTROL DEL INDICADOR DE SCROLL SIDEBAR (MEJORADO)
        // ==========================================
        document.addEventListener("DOMContentLoaded", () => {
            const scrollArea = document.getElementById('sidebar-scroll-area');
            const indicator = document.getElementById('scroll-more-indicator');

            if (scrollArea && indicator) {
                // Función maestra para verificar visibilidad
                const checkScroll = () => {
                    // 1. ¿Hay contenido suficiente para scrollear?
                    const hasScrollableContent = scrollArea.scrollHeight > scrollArea.clientHeight;
                    
                    // 2. ¿Ya llegamos al fondo? (con margen de 10px)
                    const isAtBottom = scrollArea.scrollTop + scrollArea.clientHeight >= scrollArea.scrollHeight - 10;

                    // LÓGICA: Mostrar SI hay scroll Y NO estamos al fondo
                    if (hasScrollableContent && !isAtBottom) {
                        indicator.style.opacity = '1';
                    } else {
                        indicator.style.opacity = '0';
                    }
                };

                // Listeners para detectar movimiento
                scrollArea.addEventListener('scroll', checkScroll);
                window.addEventListener('resize', checkScroll);
                
                // Ejecutar inmediatamente al cargar para que aparezca desde el principio
                setTimeout(checkScroll, 500); // Pequeño delay para asegurar renderizado
                setTimeout(checkScroll, 1500); // Segundo check por si cargan iconos tarde

                // Observador para detectar cambios en el contenido (ej: botones que aparecen por rol)
                const observer = new MutationObserver(() => {
                    setTimeout(checkScroll, 300);
                });
                observer.observe(scrollArea, { childList: true, subtree: true, attributes: true });
            }
        });
        
                // ==========================================
        // EFECTO SCROLL EN HEADER (APP BAR)
        // ==========================================
        window.addEventListener('scroll', () => {
            const header = document.getElementById('main-header');
            if (!header) return;

            if (window.scrollY > 10) {
                // Al bajar: Sombra suave y fondo blanco translúcido
                header.classList.add('shadow-md', 'bg-white/95');
                header.classList.remove('bg-white/80', 'border-b');
            } else {
                // Arriba del todo: Transparente y plano
                header.classList.remove('shadow-md', 'bg-white/95');
                header.classList.add('bg-white/80', 'border-b');
            }
        });
        
                  // ==========================================
        // CONTROL DE NOTIFICACIONES: SOLO NO LEÍDAS (Paso 2)
        // ==========================================
        window.updateNotificationBadge = () => {
            const badge = document.getElementById('notification-badge-count');
            const bellContainer = document.getElementById('bell-icon-container');
            
            // CAMBIO CLAVE: Filtramos solo las que NO tienen 'isRead: true'
            // Esto hace que las revisadas ya no sumen al número rojo.
            const unreadCount = window.userTransactions ? window.userTransactions.filter(t => t.isRead !== true).length : 0;
            
            if (badge && bellContainer) {
                if (unreadCount > 0) {
                    badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                    badge.classList.remove('scale-0');
                    badge.classList.add('scale-100');
                    
                    // Animación de campana solo si hay nuevas
                    bellContainer.classList.add('animate-bell-ring');
                    bellContainer.querySelector('i').classList.add('text-indigo-600', 'fill-indigo-50');
                } else {
                    // Si todo está leído, escondemos la burbuja
                    badge.classList.remove('scale-100');
                    badge.classList.add('scale-0');
                    
                    bellContainer.classList.remove('animate-bell-ring');
                    bellContainer.querySelector('i').classList.remove('text-indigo-600', 'fill-indigo-50');
                }
            }
        };


        // INTEGRACIÓN: Llamar a esta función cada vez que se carguen datos
        // Busca donde tienes "window.userTransactions = ..." y agrega updateNotificationBadge()
        // O simplemente usa este observador para hacerlo automático:
        
        const notificationObserver = setInterval(() => {
            if(window.userTransactions) {
                updateNotificationBadge();
                // Si quieres que deje de comprobar una vez cargado, usa clearInterval(notificationObserver);
                // Pero dejarlo activo asegura que se actualice si llegan nuevas.
            }
        }, 2000); 
        
                // ======================================================
        // RECUPERAR CONTRASEÑA (CORREGIDO)
        // ======================================================
        // 1. Buscamos el formulario
        const fForm = document.getElementById('forgot-form');

        // 2. Verificamos que exista para evitar errores
        if (fForm) {
            fForm.addEventListener('submit', async (e) => {
                // ESTA LÍNEA ES LA QUE EVITA QUE SE RECARGUE LA PÁGINA
                e.preventDefault();
                console.log("Botón presionado: Intentando recuperar contraseña...");

                const btn = fForm.querySelector('button[type="submit"]');
                const originalText = btn.innerHTML;
                
                // Bloquear botón visualmente
                btn.disabled = true;
                btn.innerHTML = '<span class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full"></span> Enviando...';

                const emailVal = document.getElementById('forgot-email').value.trim();

                try {
                    // Llamada a Firebase
                    await sendPasswordResetEmail(auth, emailVal);

                    // Éxito
                    showToast('📩 ¡Correo enviado! Revisa tu bandeja.', 'success');
                    console.log("Correo enviado con éxito");
                    
                    setTimeout(() => {
                        document.getElementById('forgot-email').value = ''; 
                        switchAuthView('login');
                    }, 2500);

                } catch (error) {
                    console.error("Error Reset:", error);
                    
                    let msg = 'Error al enviar correo.';
                    if (error.code === 'auth/user-not-found') msg = '⚠️ Correo no registrado.';
                    if (error.code === 'auth/invalid-email') msg = 'Formato de correo inválido.';
                    
                    showToast(msg, 'error');
                } finally {
                    // Restaurar botón
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            });
        } else {
            console.error("Error: No se encontró el formulario con ID 'forgot-form'");
        }
        
       // --- FUNCIÓN ACTUALIZADA: ALERTA CON OJOS ANIMADOS (GIF) ---
window.showProfilesWarning = (slug, title) => {
    // NUEVA URL: GIF animado de ojos parpadeando
    const eyesImg = "https://i.pinimg.com/originals/6e/86/28/6e8628ab32d6e1b522f2c783c1dbf71b.gif";
    
    // URL del icono de alerta inferior
    const alertImg = "https://cdn-icons-png.flaticon.com/512/1055/1055644.png";

    // HTML de la alerta
    const html = `
    <div class="w-full h-full flex items-center justify-center">
        <div class="bg-[#FF0000] rounded-[2rem] p-6 text-center text-white shadow-2xl relative overflow-hidden border-4 border-white ring-4 ring-red-200 w-full max-w-sm mx-auto bounce-enter">
            
            <div class="relative w-28 h-28 mx-auto mb-1">
                <img src="${eyesImg}" class="w-full h-full object-contain drop-shadow-md scale-125">
            </div>

            <h2 class="text-4xl font-black uppercase mb-2 drop-shadow-md tracking-tighter" style="font-family: 'Arial Black', sans-serif;">¡OJO!</h2>
            
            <div class="bg-black/10 rounded-xl p-4 backdrop-blur-sm border border-white/20 mb-4 text-left">
                <p class="text-xs font-bold leading-relaxed mb-3 text-center uppercase tracking-wide">
                    ⚠️ REGLAS ESTRICTAS DE USO ⚠️
                </p>
                <p class="text-[11px] font-medium leading-relaxed mb-2">
                    El servicio de <b>PERFILES</b> es de uso exclusivo para <b class="text-yellow-300 text-sm">1 SOLO DISPOSITIVO</b>.
                </p>
                <p class="text-[11px] font-medium leading-relaxed">
                    🚫 <b>ESTÁ PROHIBIDO</b> alternar sesiones (Ej: Cerrar en celular para abrir en TV). El perfil debe permanecer fijo donde se inició.
                </p>
            </div>

            <div class="mb-5">
                <p class="text-[10px] font-bold bg-white/20 p-2 rounded-lg leading-snug border border-white/10">
                    Si su cliente utiliza más de 1 dispositivo, soporte lo detectará y <span class="text-yellow-300">PERDERÁ SU GARANTÍA Y EL SERVICIO</span> sin derecho a reembolso. Recuerde que somos calidad.
                </p>
            </div>

            <div class="flex flex-col items-center justify-center mb-5">
                <img src="${alertImg}" class="w-12 h-12 mb-1 animate-pulse">
                <h3 class="text-2xl font-black uppercase text-yellow-400 drop-shadow-md tracking-wide">¡ALERTA!</h3>
            </div>

            <button onclick="renderCategoryView('${slug}', '${title}')" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-xl shadow-[0_4px_0_rgb(30,58,138)] active:shadow-none active:translate-y-[4px] transition-all uppercase tracking-widest text-sm flex items-center justify-center gap-2">
                <span>Confirmar y Continuar</span>
                <i data-lucide="check-circle-2" class="w-5 h-5"></i>
            </button>
        </div>
    </div>
    `;

    // 1. Abrimos el modal (Usando la función openModal corregida del paso anterior)
    openModal(html);

    // 2. APLICAMOS EL TRUCO VISUAL (Transparencia)
    const mc = document.getElementById('modal-card');
    const content = document.getElementById('modal-content');
    const closeBtn = document.querySelector('#modal-card > button');

    if(mc) {
        mc.className = "w-full max-w-md mx-auto bg-transparent shadow-none relative flex flex-col items-center justify-center";
    }
    if(content) {
        content.className = "p-0 w-full flex items-center justify-center";
    }
    if(closeBtn) closeBtn.classList.add('hidden');

    lucide.createIcons();
};

    // --- MODAL DE AYUDA PARA EL TICKET ---
window.openTicketHelpModal = () => {
    // Creamos un div temporal para el overlay superior (Z-Index alto)
    const helpOverlayId = 'ticket-help-overlay';
    
    // Si ya existe (por si acaso), lo borramos
    const existing = document.getElementById(helpOverlayId);
    if(existing) existing.remove();

    const html = `
    <div id="${helpOverlayId}" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in duration-200">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl relative overflow-hidden bounce-enter">
            
            <div class="bg-gray-900 px-4 py-3 flex justify-between items-center">
                <h3 class="text-white font-bold text-xs uppercase tracking-wider flex items-center gap-2">
                    <i data-lucide="info" class="w-4 h-4 text-indigo-400"></i> Ejemplo de Ticket
                </h3>
                <button onclick="document.getElementById('${helpOverlayId}').remove()" class="text-white/50 hover:text-white transition-colors bg-white/10 rounded-full p-1">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>

            <div class="p-5 max-h-[60vh] overflow-y-auto scrollbar-hide bg-gray-50">
                <div class="bg-white border border-gray-200 rounded-xl p-4 text-[11px] text-gray-700 font-mono leading-relaxed shadow-sm select-all">
                    <p class="font-bold text-gray-900 mb-2">Esto es un ticket:</p>
                    
                    <p class="mb-1">📦 *COMPRA EXITOSA - STREAM EVOLUTION*</p>
                    <p class="mb-1">📌 *Producto:* tu compra</p>
                    <p class="mb-1">📧 *Correo:* tu correo</p>
                    <p class="mb-1">🔑 *Contraseña:* tu contraseña</p>
                    <p class="mb-1">👤 *Perfil:* tu perfil</p>
                    <p class="mb-1">🔒 *PIN:* tu pin</p>
                    <p class="mb-1">📅 *Expira:* tu expiración</p>
                    <p class="mb-3">⏳ *Duración:* tu duración</p>

                    <p class="mb-2">📜 *Términos:* Terminos y condiciones</p>
                    
                    <p class="text-gray-500 italic text-[10px]">
                        Recuerda no se debe cambiar ni correo ni contraseña, use la cantidad de dispositivos comprados (1), no manipule otros servicios diferentes al suyo, en caso que el servicio corte antes de tiempo no se da garantia por horas ya que el servicio se disfruto en mas de un 97%, Incumplir los terminos podria ocasionar perdida de la cuenta sin devolucion alguna.
                    </p>
                    
                    <p class="mt-2 font-bold text-indigo-600">¡Gracias por tu preferencia!</p>
                </div>
                
                <button onclick="document.getElementById('${helpOverlayId}').remove()" class="w-full mt-4 bg-gray-200 text-gray-600 font-bold py-2 rounded-lg text-xs hover:bg-gray-300 transition-colors">
                    Entendido, Cerrar
                </button>
            </div>
        </div>
    </div>
    `;

    // Inyectamos directamente en el body para que quede ENCIMA del otro modal
    document.body.insertAdjacentHTML('beforeend', html);
    lucide.createIcons();
};

        // ======================================================
        // LÓGICA: RECLAMAR MEMBRESÍA (VALIDACIÓN DE FOLIO)
        // ======================================================
        const CLAIM_CATALOG = [
            // GRUPO: INVITACIÓN
            { id: 'canva-1m', name: 'Canva Pro 1M', type: 'invite', icon: 'palette', color: 'text-purple-500', bg: 'bg-purple-50' },
            { id: 'canva-2m', name: 'Canva Pro 2M', type: 'invite', icon: 'palette', color: 'text-purple-500', bg: 'bg-purple-50' },
            { id: 'canva-6m', name: 'Canva Pro 6M', type: 'invite', icon: 'palette', color: 'text-purple-500', bg: 'bg-purple-50' },
            { id: 'canva-12m', name: 'Canva Pro 12M', type: 'invite', icon: 'palette', color: 'text-purple-500', bg: 'bg-purple-50' },
            { id: 'yt-inv-1m', name: 'YouTube + YouTube Music 1M Invitación', type: 'invite', icon: 'youtube', color: 'text-red-500', bg: 'bg-red-50' },
            { id: 'yt-inv-3m', name: 'YouTube + YouTube Músic 3M Invitación', type: 'invite', icon: 'youtube', color: 'text-red-500', bg: 'bg-red-50' },
            { id: 'amz-1m', name: 'Amazon Music 1M (Invitación)', type: 'invite', icon: 'music', color: 'text-cyan-500', bg: 'bg-cyan-50' },
            { id: 'amz-3m', name: 'Amazon Music 3M (Invitación)', type: 'invite', icon: 'music', color: 'text-cyan-500', bg: 'bg-cyan-50' },
            
            // GRUPO: LOGIN
            { id: 'yt-fam', name: 'YouTube Familiar MX', type: 'login', icon: 'users', color: 'text-red-600', bg: 'bg-red-100' },
            { id: 'gemini-1m', name: 'Gémini AI Pro 1 Mes', type: 'login', icon: 'sparkles', color: 'text-blue-500', bg: 'bg-blue-50' },

            // GRUPO: WHATSAPP
            { id: 'gp-1m', name: 'Game Pass Últimate 1 Mes', type: 'whatsapp', icon: 'gamepad-2', color: 'text-emerald-500', bg: 'bg-emerald-50' },
            { id: 'gp-2m', name: 'Game Pass Últimate 2 Meses', type: 'whatsapp', icon: 'gamepad-2', color: 'text-emerald-500', bg: 'bg-emerald-50' },
            { id: 'gp-6m', name: 'Game Pass Últimate 6 Meses', type: 'whatsapp', icon: 'gamepad-2', color: 'text-emerald-500', bg: 'bg-emerald-50' },
            { id: 'gp-12m', name: 'Game Pass Últimate 12 Meses', type: 'whatsapp', icon: 'gamepad-2', color: 'text-emerald-500', bg: 'bg-emerald-50' },
            
            // --- MODIFICADO: TIPO IMEI ---
            { id: 'lib-movil', name: 'Liberación Móvil', type: 'imei', icon: 'smartphone', color: 'text-indigo-600', bg: 'bg-indigo-50' },
        ];


window.openClaimModal = () => {
    let optionsHtml = '';
    CLAIM_CATALOG.forEach(item => {
        optionsHtml += `
        <div onclick="openClaimForm('${item.id}')" class="neumo-card p-3 flex flex-col items-center justify-center gap-2 cursor-pointer hover:bg-gray-50 transition-colors group h-28 border border-transparent hover:border-gray-200">
            <div class="w-10 h-10 rounded-full ${item.bg} ${item.color} flex items-center justify-center neumo-inset shadow-sm group-hover:scale-110 transition-transform">
                <i data-lucide="${item.icon}" class="w-5 h-5"></i>
            </div>
            <p class="text-[10px] font-bold text-gray-700 text-center leading-tight group-hover:text-gray-900">${item.name}</p>
        </div>`;
    });

    openModal(`
        <div class="text-center bounce-enter pt-4">
            <div class="w-16 h-16 bg-fuchsia-100 text-fuchsia-600 rounded-full flex items-center justify-center mx-auto mb-4 neumo-card neumo-inset">
                <i data-lucide="ticket-check" class="w-8 h-8"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-1">Reclamar Membresía</h3>
            <p class="text-xs text-gray-400 mb-6">Selecciona el servicio afectado</p>
            <div class="grid grid-cols-3 gap-3 max-h-[50vh] overflow-y-auto scrollbar-hide p-1">
                ${optionsHtml}
            </div>
            <button onclick="closeModal()" class="mt-6 text-xs font-bold text-gray-400 hover:text-gray-600">Cancelar</button>
        </div>
    `);
    lucide.createIcons();
};

        window.openClaimForm = (itemId) => {
            const item = CLAIM_CATALOG.find(x => x.id === itemId);
            if(!item) return;

            let fieldsHtml = '';
            
            // Campo Folio (Común para todos)
            let folioInput = `
                <div class="mt-3">
                    <label class="block text-xs font-bold text-gray-800 uppercase mb-1 ml-1">Folio de Compra <span class="text-rose-500">*</span></label>
                    <div class="relative">
                        <i data-lucide="hash" class="absolute left-3 top-3 w-4 h-4 text-gray-400"></i>
                        <input type="text" id="claim-folio" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 pl-10 text-sm font-bold text-gray-700 placeholder-gray-300" placeholder="Ingresa el folio exacto" required>
                    </div>
                </div>`;

            if (item.type === 'invite') {
                fieldsHtml = `
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">Correo para Invitación</label>
                    <div class="relative">
                        <i data-lucide="mail" class="absolute left-3 top-3 w-4 h-4 text-gray-400"></i>
                        <input type="email" id="claim-email" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 pl-10 text-sm font-bold text-gray-700 placeholder-gray-300" placeholder="ejemplo@gmail.com" required>
                    </div>
                </div>`;
            } else if (item.type === 'login') {
                fieldsHtml = `
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">Correo</label>
                        <div class="relative">
                            <i data-lucide="mail" class="absolute left-3 top-3 w-4 h-4 text-gray-400"></i>
                            <input type="email" id="claim-email" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 pl-10 text-sm font-bold text-gray-700 placeholder-gray-300" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">Contraseña</label>
                        <div class="relative">
                            <i data-lucide="lock" class="absolute left-3 top-3 w-4 h-4 text-gray-400"></i>
                            <input type="text" id="claim-pass" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 pl-10 text-sm font-bold text-gray-700 placeholder-gray-300" required>
                        </div>
                    </div>
                </div>`;
            } else if (item.type === 'whatsapp') {
                fieldsHtml = `
                <div>
                    <label class="block text-xs font-bold text-emerald-600 uppercase mb-1 ml-1">WhatsApp (Para entrega)</label>
                    <div class="relative">
                        <i data-lucide="message-circle" class="absolute left-3 top-3 w-4 h-4 text-emerald-500"></i>
                        <input type="number" id="claim-whatsapp" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 pl-10 text-sm font-bold text-gray-700 placeholder-gray-300" placeholder="Solo números" required>
                    </div>
                </div>`;
            } else if (item.type === 'imei') {
                // --- NUEVO CAMPO ESPECÍFICO PARA IMEI ---
                fieldsHtml = `
                <div>
                    <label class="block text-xs font-bold text-indigo-600 uppercase mb-1 ml-1">IMEI del celular a liberar</label>
                    <div class="relative">
                        <i data-lucide="smartphone" class="absolute left-3 top-3 w-4 h-4 text-indigo-500"></i>
                        <input type="number" id="claim-imei" class="neumo-inset w-full bg-transparent border-none rounded-xl p-3 pl-10 text-sm font-bold text-gray-700 placeholder-gray-300" placeholder="Ej: 3520..." required>
                    </div>
                    <p class="text-[9px] text-gray-400 mt-1 ml-2">Marca *#06# en tu celular para verlo.</p>
                </div>`;
            }

            openModal(`
            <div class="text-left bounce-enter p-2">
                <div class="flex items-center gap-3 mb-6 bg-gray-50 p-3 rounded-2xl border border-gray-100">
                    <button onclick="openClaimModal()" class="w-8 h-8 flex items-center justify-center bg-white rounded-full text-gray-400 hover:text-gray-600 shadow-sm"><i data-lucide="arrow-left" class="w-4 h-4"></i></button>
                    <div>
                        <h3 class="text-lg font-bold text-gray-800 leading-tight">${item.name}</h3>
                        <p class="text-xs text-fuchsia-500 font-bold uppercase">Solicitud de Garantía</p>
                    </div>
                </div>
                
                <form onsubmit="submitClaim(event, '${item.id}', '${item.type}', '${item.name}')">
                    ${fieldsHtml}
                    ${folioInput}
                    
                    <button type="submit" id="btn-claim-submit" class="neumo-button w-full bg-gray-900 text-white font-bold py-3.5 rounded-xl shadow-lg mt-8 flex items-center justify-center gap-2 hover:bg-black transition-transform active:scale-95">
                        <span>Verificar y Reclamar</span>
                        <i data-lucide="send" class="w-4 h-4"></i>
                    </button>
                </form>
            </div>
            `);
            lucide.createIcons();
        };

              // ======================================================
        // ENVIAR RECLAMO (VALIDACIÓN ESTRICTA: 1 USO POR FOLIO)
        // ======================================================
        window.submitClaim = async (e, itemId, type, itemName) => {
            e.preventDefault();
            const btn = document.getElementById('btn-claim-submit');
            
            if(btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full"></span> Verificando...';
            }

            try {
                // 1. Obtener Folio
                const folioEl = document.getElementById('claim-folio');
                if (!folioEl) throw new Error('Error interno: Falta campo Folio');
                const folioInput = folioEl.value.trim();
                if (!folioInput) throw new Error('El Folio es obligatorio');

                // --- PASO A: BUSCAR EL FOLIO EN INVENTARIO ---
                const inventoryRef = collection(db, 'artifacts', appId, 'public', 'data', 'inventory_items');
                const qFolio = query(inventoryRef, where('folio', '==', folioInput));
                const folioSnapshot = await getDocs(qFolio);

                if (folioSnapshot.empty) {
                    throw new Error('❌ El Folio ingresado NO EXISTE en el sistema.');
                }
                
                const itemData = folioSnapshot.docs[0].data();

                // --- PASO B: VALIDAR QUE SEA LA MISMA PLATAFORMA ---
                const inventoryName = (itemData.serviceName || '').trim().toLowerCase();
                const claimingName = itemName.trim().toLowerCase();

                if (inventoryName !== claimingName) {
                    throw new Error(`⛔ Folio incorrecto para este servicio.\nEste folio es de: "${itemData.serviceName}"`);
                }

                // --- PASO C: VALIDAR SI YA FUE USADO ---
                const reportsRef = collection(db, 'artifacts', appId, 'public', 'data', 'reports');
                const qUsage = query(reportsRef, where('folio', '==', folioInput));
                const usageSnap = await getDocs(qUsage);

                if (!usageSnap.empty) {
                    const existingReport = usageSnap.docs[0].data();
                    const status = existingReport.status;
                    if (status === 'unread' || status === 'pending') {
                        throw new Error('⚠️ Ya enviaste una solicitud con este Folio y está en revisión.');
                    } else {
                        throw new Error('🚫 Este Folio YA FUE CANJEADO anteriormente. No es reutilizable.');
                    }
                }

                // --- PASO D: VALIDAR EXPIRACIÓN (FECHA) ---
                if (itemData.expiryDate) {
                    const today = new Date();
                    const expDate = new Date(itemData.expiryDate + 'T23:59:59');
                    if (today > expDate) {
                        throw new Error('⛔ Este Folio ya ha EXPIRADO. La garantía ha terminado.');
                    }
                }

                // --- PREPARAR DATOS PARA ENVÍO ---
                let details = { folio: folioInput };
                let descriptionText = `SOLICITUD DE CANJE/GARANTÍA\nProducto: ${itemName}\nFolio: ${folioInput}\n\n`;

                if (type === 'invite') {
                    const emailEl = document.getElementById('claim-email');
                    const email = emailEl.value;
                    if (!email.includes('@')) throw new Error('Correo inválido');
                    details.email = email;
                    descriptionText += `Correo Invitación: ${email}`;
                
                } else if (type === 'login') {
                    const emailEl = document.getElementById('claim-email');
                    const passEl = document.getElementById('claim-pass');
                    const email = emailEl.value;
                    const pass = passEl.value;
                    details.email = email;
                    details.password = pass;
                    descriptionText += `Datos Cuenta:\nCorreo: ${email}\nPass: ${pass}`;
                
                } else if (type === 'whatsapp') {
                    const waEl = document.getElementById('claim-whatsapp');
                    const wa = waEl.value;
                    if (wa.length < 7) throw new Error('Número WhatsApp inválido');
                    details.whatsapp = wa;
                    descriptionText += `Contacto WhatsApp: ${wa}`;

                } else if (type === 'imei') {
                    // --- NUEVA LÓGICA PARA IMEI ---
                    const imeiEl = document.getElementById('claim-imei');
                    const imei = imeiEl.value.trim();
                    if (imei.length < 14) throw new Error('El IMEI debe tener al menos 14 o 15 dígitos.');
                    details.imei = imei; // Guardamos como campo 'imei', no 'whatsapp'
                    descriptionText += `IMEI a Liberar: ${imei}`;
                }

                // --- ENVIAR REPORTE ---
                await addDoc(reportsRef, { 
                    uid: currentUser.uid, 
                    email: currentUser.email, 
                    type: 'claim', 
                    serviceId: itemId,
                    serviceName: itemName, 
                    claimData: details, 
                    description: descriptionText,
                    folio: folioInput, 
                    status: 'unread', 
                    timestamp: serverTimestamp() 
                });

                showToast('✅ Solicitud enviada correctamente.', 'success');
                closeModal();

            } catch (err) {
                showToast(err.message, 'error');
                if(btn) {
                    btn.disabled = false;
                    btn.innerHTML = `<span>Verificar y Reclamar</span> <i data-lucide="send" class="w-4 h-4"></i>`;
                    lucide.createIcons();
                }
            }
        };
        
              // ==========================================
        // SISTEMA CHAT LIVE (Con Notificaciones Numéricas)
        // ==========================================
        let chatUnsubscribe = null;
        let currentAdminName = "Soporte"; 
        let isChatActiveGlobal = false;

        // 1. INICIALIZAR Y CONTAR NOTIFICACIONES
        window.initChatSystem = function() {
            // A. Escuchar Configuración Global (ON/OFF)
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'config'), (docSnap) => {
                isChatActiveGlobal = docSnap.exists() ? docSnap.data().isChatLiveActive : false;
                
                const btn = document.getElementById('btn-chat-live');
                const adminSwitch = document.getElementById('admin-chat-toggle');
                const statusLabel = document.getElementById('admin-chat-status-label');

                if (btn) {
                    if (isChatActiveGlobal || isAdmin) {
                        btn.classList.remove('hidden');
                        btn.style.opacity = (!isChatActiveGlobal && isAdmin) ? "0.5" : "1";
                    } else {
                        btn.classList.add('hidden');
                    }
                }

                if (adminSwitch) {
                    adminSwitch.checked = isChatActiveGlobal;
                    if(statusLabel) {
                        statusLabel.innerText = isChatActiveGlobal ? "Chat ACTIVADO" : "Chat DESACTIVADO";
                        statusLabel.className = isChatActiveGlobal ? "text-xs font-bold text-emerald-500" : "text-xs font-bold text-gray-400";
                    }
                }
            });

            // B. Escuchar NOTIFICACIONES (Badge Numérico)
            if(currentUser) {
                const badge = document.getElementById('chat-badge');
                
                if (isAdmin) {
                    // --- Lógica ADMIN: Cuenta chats con novedades ---
                    const q = query(collection(db, 'artifacts', appId, 'chats'), where('hasUnreadAdmin', '==', true));
                    onSnapshot(q, (snap) => {
                        const count = snap.size; // Número de usuarios esperando
                        updateBadgeUI(count);
                    });
                } else {
                    // --- Lógica USUARIO: Cuenta mensajes individuales ---
                    // Escuchar mensajes donde el emisor es 'admin' y NO se han leído
                    const q = query(collection(db, 'artifacts', appId, 'chats', currentUser.uid, 'messages'), 
                                    where('sender', '==', 'admin'), 
                                    where('read', '==', false));
                    
                    onSnapshot(q, (snap) => {
                        const count = snap.size; // Número de mensajes sin leer
                        updateBadgeUI(count);
                    });
                }
            }
        }

        // Función auxiliar para actualizar el numerito rojo
        function updateBadgeUI(count) {
            const badge = document.getElementById('chat-badge');
            if(!badge) return;
            
            if (count > 0) {
                badge.innerText = count > 99 ? '99+' : count;
                badge.classList.remove('hidden');
                badge.classList.add('animate-bounce'); // Pequeño rebote al llegar notificación
                setTimeout(() => badge.classList.remove('animate-bounce'), 1000);
            } else {
                badge.classList.add('hidden');
            }
        }

        // 2. ABRIR CHAT
        window.openChatLiveUser = () => {
            const isMainAdmin = currentUser && currentUser.email === "mrandroidtutorialeshd@gmail.com";
            
            if (isAdmin || isMainAdmin) { 
                openAdminChatPanel(); 
                return; 
            }
            
            if (!isChatActiveGlobal) { 
                showToast('El chat no está disponible por el momento.', 'info'); 
                return; 
            }
            openChatWindowUI(currentUser.uid, 'user');
        };

        // 3. INTERFAZ DE CHAT (ACTUALIZADA: Muestra Correo en Título Admin)
window.openChatWindowUI = (targetUid, role, adminDisplayName = 'Soporte', chatUserEmail = null) => {
    const isUserView = role === 'user';
    
    // Si soy admin, el título es el Email. Si no hay email, pone "Chat con Usuario".
    // Si soy usuario, el título es "Soporte en Línea".
    const chatTitle = isUserView ? 'Soporte en Línea' : (chatUserEmail || 'Chat con Usuario');
    const chatSubtitle = isUserView ? 'Respuesta rápida' : (chatUserEmail ? 'Usuario Atendido' : targetUid.substring(0,15)+'...');

    openModal(`
        <div class="flex flex-col h-full bg-[#f3f4f6] relative w-full">
            <div class="bg-[#1e1b4b] p-4 flex items-center justify-between shadow-md z-10 text-white flex-shrink-0">
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center border border-white/20">
                            <i data-lucide="${isUserView ? 'headset' : 'user'}" class="w-5 h-5 text-white"></i>
                        </div>
                        <div class="absolute bottom-0 right-0 online-dot border-2 border-[#1e1b4b]"></div>
                    </div>
                    <div>
                        <h3 class="font-bold text-sm tracking-wide">${chatTitle}</h3>
                        <p class="text-[10px] text-indigo-200">${chatSubtitle}</p>
                    </div>
                </div>
                <button onclick="${isUserView ? 'closeModal()' : 'openAdminChatPanel()'}" class="bg-white/10 p-2 rounded-full hover:bg-white/20">
                    <i data-lucide="${isUserView ? 'x' : 'arrow-left'}" class="w-5 h-5"></i>
                </button>
            </div>

            <div id="chat-msgs" class="flex-1 overflow-y-auto p-4 flex flex-col gap-1 bg-[#eef2f6]">
                <div class="text-center mt-10"><span class="animate-spin inline-block w-5 h-5 border-2 border-indigo-500 border-t-transparent rounded-full"></span></div>
            </div>

            <div class="p-3 bg-white border-t flex gap-2 flex-shrink-0 items-center shadow-lg relative z-20">
                <input type="text" id="chat-input" class="flex-1 bg-gray-100 rounded-full px-4 text-sm outline-none focus:ring-2 focus:ring-indigo-500 border-none h-10 text-gray-800" placeholder="Escribe un mensaje..." onkeypress="if(event.key==='Enter') doSendMsg('${targetUid}', '${role}')">
                <button onclick="doSendMsg('${targetUid}', '${role}')" class="bg-indigo-600 hover:bg-indigo-700 text-white p-2 rounded-full shadow-lg transition-transform active:scale-95 flex items-center justify-center w-10 h-10 flex-shrink-0 cursor-pointer">
                    <i data-lucide="send" class="w-4 h-4 ml-0.5"></i>
                </button>
            </div>
        </div>
    `);
    
    const mc = document.getElementById('modal-card');
    const content = document.getElementById('modal-content');
    const defaultClose = document.querySelector('#modal-card > button');
    
    if(mc) mc.className = "neumo-card w-full max-w-md relative shadow-2xl transform transition-all scale-100 opacity-100 h-[85vh] flex flex-col overflow-hidden bg-white rounded-[2rem]";
    if(content) content.className = "w-full h-full p-0 flex flex-col";
    if(defaultClose) defaultClose.classList.add('hidden');
    
    lucide.createIcons();
    loadMessages(targetUid);
};


        // 4. CARGAR MENSAJES Y BORRAR NOTIFICACIONES
        window.loadMessages = (uid) => {
            const container = document.getElementById('chat-msgs');
            if(chatUnsubscribe) chatUnsubscribe();
            
            const q = collection(db, 'artifacts', appId, 'chats', uid, 'messages');
            
            chatUnsubscribe = onSnapshot(q, (snap) => {
                if(!document.getElementById('chat-msgs')) return;
                
                let messages = [];
                let unreadMessagesIds = []; // Lista para marcar como leídos en bloque

                snap.forEach(doc => {
                    const data = doc.data();
                    messages.push({ id: doc.id, ...data });
                    
                    // --- Lógica para detectar mensajes NO leídos ---
                    // Si soy USUARIO y el mensaje es del ADMIN y no está leído -> Lo anoto para marcarlo leído
                    if (!isAdmin && data.sender === 'admin' && data.read === false) {
                        unreadMessagesIds.push(doc.id);
                    }
                });

                // Ordenar
                messages.sort((a, b) => {
                    const tA = a.timestamp ? a.timestamp.toMillis() : Date.now();
                    const tB = b.timestamp ? b.timestamp.toMillis() : Date.now();
                    return tA - tB;
                });

                // --- MARCAR COMO LEÍDOS (Limpiar notificación) ---
                // Si soy Usuario y tengo mensajes pendientes, los marco como read=true
                if (!isAdmin && unreadMessagesIds.length > 0) {
                    unreadMessagesIds.forEach(msgId => {
                        updateDoc(doc(db, 'artifacts', appId, 'chats', uid, 'messages', msgId), { read: true }).catch(err => console.log("Error update read", err));
                    });
                }
                
                // Si soy Admin, marco el chat completo como leído
                if (isAdmin) {
                    updateDoc(doc(db, 'artifacts', appId, 'chats', uid), { hasUnreadAdmin: false }).catch(()=>{});
                }

                // Renderizado
                container.innerHTML = '';
                
                if(messages.length === 0) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full opacity-40 space-y-2 mt-8">
                            <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center text-gray-500">
                                <i data-lucide="message-square" class="w-6 h-6"></i>
                            </div>
                            <p class="text-xs text-gray-500 font-medium">No hay mensajes aún</p>
                        </div>`;
                } else {
                    messages.forEach(m => {
                        const isMe = (isAdmin && m.sender === 'admin') || (!isAdmin && m.sender === 'user');
                        const alignClass = isMe ? 'justify-end' : 'justify-start';
                        const itemsAlign = isMe ? 'items-end' : 'items-start';
                        const bubbleClass = isMe 
                            ? 'bg-indigo-600 text-white rounded-2xl rounded-tr-sm shadow-md' 
                            : 'bg-white text-gray-800 border border-gray-200 rounded-2xl rounded-tl-sm shadow-sm';

                        let adminLabel = '';
                        if (m.sender === 'admin' && !isMe) {
                            adminLabel = `<span class="text-[10px] text-indigo-600 font-bold mb-1 ml-1 block">${m.adminName || 'Soporte'}</span>`;
                        }

                        const time = m.timestamp ? m.timestamp.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                        const timeColor = isMe ? 'text-indigo-200' : 'text-gray-400';

                        const msgHtml = `
                        <div class="flex w-full ${alignClass} mb-2 fade-in">
                            <div class="max-w-[80%] flex flex-col ${itemsAlign}">
                                ${adminLabel}
                                <div class="px-4 py-2.5 text-sm ${bubbleClass} relative break-words leading-relaxed">
                                    ${m.text}
                                </div>
                                <span class="text-[9px] ${timeColor} mt-1 mx-1">${time}</span>
                            </div>
                        </div>`;

                        container.insertAdjacentHTML('beforeend', msgHtml);
                    });
                }
                
                lucide.createIcons();
                setTimeout(() => container.scrollTop = container.scrollHeight, 100);
            
            }, (error) => {
                console.error("Error chat:", error);
            });
        }

        // 5. ENVIAR MENSAJE
        window.doSendMsg = async (uid, role) => {
            const input = document.getElementById('chat-input');
            if (!input) return;
            const text = input.value.trim();
            if(!text) return;
            
            input.disabled = true; 
            
            const msg = { text, sender: role, timestamp: serverTimestamp(), read: false };
            if(role === 'admin') msg.adminName = currentAdminName;

            try {
                await addDoc(collection(db, 'artifacts', appId, 'chats', uid, 'messages'), msg);
                await setDoc(doc(db, 'artifacts', appId, 'chats', uid), {
                    lastMessage: text,
                    lastTimestamp: serverTimestamp(),
                    userEmail: role === 'user' ? currentUser.email : null,
                    hasUnreadAdmin: role === 'user',
                    hasUnreadUser: role === 'admin'
                }, { merge: true });
                
                input.value = '';
                input.disabled = false;
                input.focus();
            } catch(e) {
                console.error("Error envío:", e);
                showToast("Error al enviar.", "error");
                input.disabled = false;
            }
        };

        // 6. PANEL DE ADMINISTRADOR
        window.openAdminChatPanel = () => {
            const isMainAdmin = currentUser.email === "mrandroidtutorialeshd@gmail.com";
            
            const switchHtml = isMainAdmin ? `
                <div class="bg-gray-900 text-white p-4 rounded-xl mb-4 flex justify-between items-center shadow-lg flex-shrink-0">
                    <div>
                        <div class="font-bold text-sm">Estado del Chat</div>
                        <div id="admin-chat-status-label" class="text-xs text-gray-400">Cargando...</div>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="admin-chat-toggle" class="sr-only peer" onchange="toggleGlobalChat(this.checked)">
                        <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500"></div>
                    </label>
                </div>` : '';

            openModal(`
                <div class="flex flex-col h-full bg-white rounded-[2rem] bounce-enter p-4 w-full relative">
                    <div class="flex justify-between items-center mb-4 flex-shrink-0">
                        <h2 class="text-xl font-black text-gray-800">Administrar Chats</h2>
                        <button onclick="closeModal()" class="bg-gray-100 p-2 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>
                    ${switchHtml}
                    <div id="admin-chat-list" class="flex-1 overflow-y-auto space-y-2">
                        <div class="text-center py-10 opacity-50">Cargando conversaciones...</div>
                    </div>
                </div>
            `);
            
            const mc = document.getElementById('modal-card');
            if(mc) mc.className = "neumo-card w-full max-w-md p-0 relative shadow-2xl transform transition-all scale-100 opacity-100 h-[85vh] flex flex-col overflow-hidden bg-white rounded-[2rem]";
            
            lucide.createIcons();

            if(isMainAdmin) {
                setTimeout(() => {
                    const sw = document.getElementById('admin-chat-toggle');
                    const lbl = document.getElementById('admin-chat-status-label');
                    if(sw) sw.checked = isChatActiveGlobal;
                    if(lbl) {
                        lbl.innerText = isChatActiveGlobal ? "Chat ACTIVADO" : "Chat DESACTIVADO";
                        lbl.className = isChatActiveGlobal ? "text-xs font-bold text-emerald-500" : "text-xs font-bold text-gray-400";
                    }
                }, 100);
            }

            const q = collection(db, 'artifacts', appId, 'chats');
            onSnapshot(q, (snap) => {
                const list = document.getElementById('admin-chat-list');
                if(!list) return;
                
                let chats = [];
                snap.forEach(doc => chats.push({ id: doc.id, ...doc.data() }));
                
                chats.sort((a,b) => (b.lastTimestamp ? b.lastTimestamp.toMillis() : 0) - (a.lastTimestamp ? a.lastTimestamp.toMillis() : 0));

                list.innerHTML = '';
                if(chats.length === 0) { list.innerHTML = '<p class="text-center text-gray-400 mt-10 text-xs">No hay chats activos.</p>'; return; }
                
                chats.forEach(c => {
                    const hasUnread = c.hasUnreadAdmin;
                    list.innerHTML += `
                        <div onclick="preOpenAdminIdentity('${c.id}', '${c.userEmail || 'Usuario'}')" class="p-3 rounded-xl border ${hasUnread ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-gray-100'} cursor-pointer hover:shadow-md flex justify-between items-center transition-all">
                            <div class="overflow-hidden">
                                <div class="font-bold text-sm text-gray-800 truncate w-48">${c.userEmail || 'Usuario'}</div>
                                <div class="text-xs text-gray-500 truncate w-48">${c.lastMessage || 'Adjunto...'}</div>
                            </div>
                            ${hasUnread ? `<div class="bg-rose-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full animate-pulse shadow-sm">NUEVO</div>` : '<i data-lucide="chevron-right" class="w-4 h-4 text-gray-300"></i>'}
                        </div>`;
                });
                lucide.createIcons();
            });
        };

        // 7. TOGGLE GLOBAL
        window.toggleGlobalChat = async (val) => {
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'config'), { isChatLiveActive: val }, { merge: true });
                showToast(val ? 'Chat Habilitado' : 'Chat Deshabilitado', 'success');
                const lbl = document.getElementById('admin-chat-status-label');
                if(lbl) {
                    lbl.innerText = val ? "Chat ACTIVADO" : "Chat DESACTIVADO";
                    lbl.className = val ? "text-xs font-bold text-emerald-500" : "text-xs font-bold text-gray-400";
                }
            } catch(e) { console.error(e); }
        };

                // 8. PRE-APERTURA ADMIN (Selector de Identidad con Opciones)
window.preOpenAdminIdentity = (uid, email) => {
    openModal(`
        <div class="flex flex-col h-full bg-white relative p-6 w-full">
            <button onclick="openAdminChatPanel()" class="absolute top-4 right-4 bg-gray-100 p-2 rounded-full hover:bg-gray-200 transition-colors"><i data-lucide="x" class="w-4 h-4"></i></button>
            
            <div class="text-center mt-2 mb-6">
                <div class="w-16 h-16 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-3 shadow-sm border border-indigo-100">
                    <i data-lucide="shield-check" class="w-8 h-8"></i>
                </div>
                <h3 class="font-black text-xl text-gray-800">Identidad del Admin</h3>
                <p class="text-xs text-gray-400 mt-1">Atendiendo a: <span class="font-bold text-indigo-600">${email || 'Usuario'}</span></p>
            </div>

            <button onclick="confirmIdentity('${uid}', '${currentAdminName}', '${email}')" class="w-full bg-white border-2 border-indigo-50 hover:border-indigo-500 hover:bg-indigo-50 p-4 rounded-2xl mb-6 flex items-center justify-between group transition-all shadow-sm">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-bold text-sm group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                        <i data-lucide="user" class="w-5 h-5"></i>
                    </div>
                    <div class="text-left">
                        <span class="block text-[10px] text-gray-400 font-bold uppercase tracking-wider mb-0.5">Conservar nombre</span>
                        <span class="block text-lg font-black text-gray-800 group-hover:text-indigo-700 leading-none">${currentAdminName}</span>
                    </div>
                </div>
                <div class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center group-hover:bg-indigo-600 group-hover:text-white transition-all">
                    <i data-lucide="arrow-right" class="w-4 h-4 text-gray-300 group-hover:text-white"></i>
                </div>
            </button>

            <div class="relative flex py-2 items-center mb-6">
                <div class="flex-grow border-t border-gray-100"></div>
                <span class="flex-shrink-0 mx-4 text-gray-300 text-[10px] font-bold uppercase tracking-widest">O cambiar identidad</span>
                <div class="flex-grow border-t border-gray-100"></div>
            </div>

            <div class="relative group">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <i data-lucide="edit-3" class="w-5 h-5 text-gray-300 group-focus-within:text-indigo-500 transition-colors"></i>
                </div>
                <input type="text" id="new-identity-input" placeholder="Escribe nuevo nombre aquí..." class="pl-12 pr-24 w-full bg-gray-50 border border-gray-200 rounded-2xl py-4 text-sm font-bold focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 outline-none transition-all text-gray-800">
                <button onclick="confirmNewIdentity('${uid}', '${email}')" class="absolute inset-y-1.5 right-1.5 bg-gray-900 text-white px-5 rounded-xl text-xs font-bold hover:bg-black transition-transform active:scale-95 shadow-md flex items-center gap-1">
                    Usar <i data-lucide="check" class="w-3 h-3"></i>
                </button>
            </div>
        </div>
    `);
    const mc = document.getElementById('modal-card');
    if(mc) mc.className = "neumo-card w-full max-w-sm p-0 relative shadow-2xl transform transition-all scale-100 opacity-100 flex flex-col overflow-hidden bg-white rounded-[2.5rem] h-auto min-h-[480px]";
    lucide.createIcons();
};

window.confirmNewIdentity = (uid, userEmail) => {
    const input = document.getElementById('new-identity-input');
    const newName = input.value.trim();
    if(!newName) {
        input.focus();
        input.classList.add('ring-2', 'ring-rose-500');
        setTimeout(() => input.classList.remove('ring-rose-500', 'ring-2'), 1000);
        return;
    }
    confirmIdentity(uid, newName, userEmail);
};

window.confirmIdentity = (uid, nameToUse, userEmail) => {
    if(nameToUse) currentAdminName = nameToUse;
    openChatWindowUI(uid, 'admin', nameToUse, userEmail); 
};

        
        // --- MOSTRAR FORMULARIO DE REEMPLAZO ---
window.showReplacementForm = (rid, uid) => {
    const container = document.getElementById('replacement-form-container');
    const normalArea = document.getElementById('normal-reply-area');
    
    // Ocultamos el área normal de respuesta para enfocar en el reemplazo
    normalArea.classList.add('hidden');
    container.classList.remove('hidden');

    container.innerHTML = `
        <div class="bg-indigo-50 p-4 rounded-2xl border border-indigo-100 mb-4">
            <div class="flex justify-between items-center mb-3">
                <h4 class="font-black text-indigo-700 text-sm flex items-center gap-2"><i data-lucide="refresh-cw" class="w-4 h-4"></i> Datos de Reposición</h4>
                <button onclick="openReplyModal('${rid}', '${uid}')" class="text-xs text-gray-400 font-bold hover:text-gray-600">Cancelar</button>
            </div>
            
            <p class="text-[10px] text-indigo-400 mb-3 leading-tight">Esto actualizará la compra original. El usuario deberá usar estos nuevos datos.</p>

            <div class="space-y-3">
                <input type="text" id="rep-new-email" class="neumo-inset w-full bg-white border-none rounded-xl p-2 text-xs font-bold text-gray-700" placeholder="Nuevo Correo">
                <input type="text" id="rep-new-pass" class="neumo-inset w-full bg-white border-none rounded-xl p-2 text-xs font-bold text-gray-700" placeholder="Nueva Contraseña">
                <div class="grid grid-cols-2 gap-2">
                    <input type="text" id="rep-new-profile" class="neumo-inset w-full bg-white border-none rounded-xl p-2 text-xs font-bold text-gray-700" placeholder="Nuevo Perfil (Opcional)">
                    <input type="text" id="rep-new-pin" class="neumo-inset w-full bg-white border-none rounded-xl p-2 text-xs font-bold text-gray-700" placeholder="Nuevo PIN (Opcional)">
                </div>
            </div>

            <button onclick="executeAccountReplacement('${rid}', '${uid}')" class="neumo-button w-full bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg mt-4 hover:bg-indigo-700 transition-all flex items-center justify-center gap-2">
                <i data-lucide="save" class="w-4 h-4"></i> Confirmar Remplazo
            </button>
        </div>
    `;
    lucide.createIcons();
};

// ==========================================
// EJECUTAR REEMPLAZO (FINAL: FORMATO ORDENADO)
// ==========================================
window.executeAccountReplacement = async (reportId, uid) => {
    const newEmail = document.getElementById('rep-new-email').value.trim();
    const newPass = document.getElementById('rep-new-pass').value.trim();
    const newProfile = document.getElementById('rep-new-profile').value.trim();
    const newPin = document.getElementById('rep-new-pin').value.trim();

    if (!newEmail || !newPass) return showToast('Correo y Contraseña son obligatorios', 'error');

    const btn = document.querySelector('button[onclick^="executeAccountReplacement"]');
    btn.disabled = true; btn.innerHTML = "Procesando...";

    try {
        const report = window.adminReportsCache.find(x => x.id === reportId);
        if (!report || !report.relatedTransactionId) throw new Error("No se encontró la compra vinculada.");

        // 1. Referencia a la transacción original
        const txRef = doc(db, 'artifacts', appId, 'users', uid, 'transactions', report.relatedTransactionId);
        const txSnap = await getDoc(txRef);
        if(!txSnap.exists()) throw new Error("Transacción no existe.");
        
        const currentDetails = txSnap.data().details || {};
        const serviceName = currentDetails.serviceName || 'Cuenta';
        
        // --- CAPTURAMOS DATOS ANTIGUOS (FORMATO LISTA VERTICAL) ---
        // Usamos \n para que cada dato quede en una línea nueva
        const oldAccountString = 
`Plataforma: ${serviceName}
Correo: ${currentDetails.email || 'N/A'}
Contraseña: ${currentDetails.password || 'N/A'}
Perfil: ${currentDetails.profileName || 'N/A'}
Pin: ${currentDetails.pin || 'N/A'}`;

        // 2. Preparar los nuevos datos
        const updatedDetails = {
            ...currentDetails,
            email: newEmail,
            password: newPass,
            profileName: newProfile || currentDetails.profileName,
            pin: newPin || currentDetails.pin,
            isReplacement: true,
            replacementDate: serverTimestamp()
        };

        // --- PASO A: ACTUALIZAR LA COMPRA ---
        await updateDoc(txRef, {
            details: updatedDetails,
            description: txSnap.data().description + ' (Reposición)'
        });

        // --- PASO B: ACTUALIZAR EL REPORTE (CHAT) ---
        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reports', reportId), {
            status: 'resolved',
            // Ajustamos el mensaje para que se vea limpio con los saltos de línea
            adminReply: `✅ REEMPLAZO EXITOSO (${serviceName}).\n\n🔻 CUENTA REEMPLAZADA:\n${oldAccountString}\n\n✨ DATOS NUEVOS:\nCorreo: ${newEmail}\nPass: ${newPass}\nPerfil: ${newProfile || 'N/A'}\nPIN: ${newPin || 'N/A'}\n\nRevisa tu ticket original.`,
            resolvedAt: serverTimestamp(),
            wasReplaced: true
        });

        // --- PASO C: NOTIFICACIÓN (BANDEJA/CAMPANA) ---
        await addDoc(collection(db, 'artifacts', appId, 'users', uid, 'transactions'), {
            type: 'support_reply',
            amount: 0,
            description: 'Cuenta Reemplazada',
            // Mismo formato limpio aquí
            message: `Hola, tu reporte sobre **${serviceName}** ha sido resuelto mediante un REEMPLAZO.\n\n🔻 CUENTA REEMPLAZADA:\n${oldAccountString}\n\n✨ DATOS NUEVOS:\nCorreo: ${newEmail}\nContraseña: ${newPass}\nPerfil: ${newProfile || 'N/A'}\nPIN: ${newPin || 'N/A'}`,
            timestamp: serverTimestamp(),
            relatedReportId: reportId,
            reportServiceName: serviceName 
        });

        showToast('Remplazo exitoso', 'success');
        closeModal();
        if(window.loadAdminReports) window.loadAdminReports();

    } catch (e) {
        console.error(e);
        showToast('Error: ' + e.message, 'error');
        btn.disabled = false; btn.innerText = "Reintentar";
    }
};

    // ======================================================
    // SISTEMA SPOTLIGHT ADS (POP-UP INICIO) - PRO
    // ======================================================
    
    let spotlightData = [];
    let spotlightInterval;
    let currentSpotlightIndex = 0;
    let slTouchStart = 0;
    let slTouchEnd = 0;

    // 1. Inicializar (Llamar esto en onAuthStateChanged)
    window.initSpotlight = () => {
    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'spotlight_ads'), orderBy('createdAt', 'desc'));
    
    onSnapshot(q, (snapshot) => {
        spotlightData = [];
        snapshot.forEach(doc => spotlightData.push({ id: doc.id, ...doc.data() }));

        // 1. ESTO MUESTRA EL ANUNCIO A TODOS (Clientes, VIP, etc.)
        if(spotlightData.length > 0) {
            renderSpotlightPopup();
        }

        // 2. ESTO ACTUALIZA EL PANEL DE CONTROL (Solo si eres Admin y estás en tu panel)
        if(isAdmin && document.getElementById('admin-spotlight-list')) {
            renderAdminSpotlightList();
        }
    });
};


    // 2. Renderizar Pop-up Usuario
    function renderSpotlightPopup() {
        const modal = document.getElementById('startup-modal');
        const track = document.getElementById('startup-track');
        const indicators = document.getElementById('startup-indicators');
        
        if(!modal || !track) return;

        // Mostrar modal (Quitamos hidden)
        modal.classList.remove('hidden');
        modal.classList.add('flex');

        // Construir HTML Carrusel
        let html = '';
        let dots = '';
        
        spotlightData.forEach((ad, index) => {
            // Imagen full cover
            html += `
            <div class="min-w-full h-full relative flex-shrink-0">
                <img src="${ad.imageUrl}" class="w-full h-full object-cover" draggable="false">
                ${ad.link ? `<a href="${ad.link}" target="_blank" class="absolute bottom-8 left-1/2 -translate-x-1/2 bg-white/90 text-gray-900 px-6 py-3 rounded-full text-xs font-black uppercase tracking-widest shadow-xl hover:scale-105 transition-transform flex items-center gap-2">Ver Más <i data-lucide="arrow-right" class="w-3 h-3"></i></a>` : ''}
            </div>`;
            
            dots += `<div id="sl-dot-${index}" class="w-2 h-2 rounded-full bg-white/50 transition-all duration-300"></div>`;
        });

        // Clonar el primero al final para efecto infinito (si hay más de 1)
        if(spotlightData.length > 1) {
            html += `
            <div class="min-w-full h-full relative flex-shrink-0">
                <img src="${spotlightData[0].imageUrl}" class="w-full h-full object-cover">
            </div>`;
        }

        track.innerHTML = html;
        if(indicators) indicators.innerHTML = dots;
        
        // Reiniciar variables
        currentSpotlightIndex = 0;
        updateSpotlightSlider();
        startSpotlightAuto();
        
        // Eventos Táctiles (Swipe)
        track.addEventListener('touchstart', (e) => {
            slTouchStart = e.changedTouches[0].screenX;
            clearInterval(spotlightInterval);
        }, {passive: true});
        
        track.addEventListener('touchend', (e) => {
            slTouchEnd = e.changedTouches[0].screenX;
            handleSpotlightSwipe();
            startSpotlightAuto();
        }, {passive: true});

        lucide.createIcons();
    }

    // 3. Lógica del Slider
    function updateSpotlightSlider() {
        const track = document.getElementById('startup-track');
        if(!track) return;
        
        track.style.transition = 'transform 0.5s cubic-bezier(0.25, 1, 0.5, 1)';
        track.style.transform = `translateX(-${currentSpotlightIndex * 100}%)`;

        // Actualizar puntos
        const totalReal = spotlightData.length;
        for(let i=0; i<totalReal; i++) {
            const dot = document.getElementById(`sl-dot-${i}`);
            if(dot) {
                // El punto activo corresponde al índice actual (ajustando el clon)
                const isActive = (currentSpotlightIndex % totalReal) === i;
                dot.className = isActive ? "w-6 h-2 rounded-full bg-white shadow-md transition-all" : "w-2 h-2 rounded-full bg-white/40 transition-all";
            }
        }
    }

    function nextSpotlight() {
        if(spotlightData.length < 2) return;
        const track = document.getElementById('startup-track');
        currentSpotlightIndex++;
        updateSpotlightSlider();

        // Si llegamos al clon
        if(currentSpotlightIndex === spotlightData.length) {
            setTimeout(() => {
                track.style.transition = 'none';
                currentSpotlightIndex = 0;
                track.style.transform = `translateX(0%)`;
            }, 500);
        }
    }

    function prevSpotlight() {
        if(spotlightData.length < 2) return;
        const track = document.getElementById('startup-track');
        if(currentSpotlightIndex === 0) {
            currentSpotlightIndex = spotlightData.length - 1;
        } else {
            currentSpotlightIndex--;
        }
        updateSpotlightSlider();
    }

    function startSpotlightAuto() {
        clearInterval(spotlightInterval);
        spotlightInterval = setInterval(nextSpotlight, 3000); // 3 Segundos
    }

    function handleSpotlightSwipe() {
        if (slTouchStart - slTouchEnd > 50) nextSpotlight();
        if (slTouchEnd - slTouchStart > 50) prevSpotlight();
    }

    window.closeStartupModal = () => {
        clearInterval(spotlightInterval);
        const m = document.getElementById('startup-modal');
        m.classList.remove('flex');
        m.classList.add('hidden');
    };

    // --- FUNCIONES ADMINISTRADOR ---

    window.renderAdminSpotlightList = () => {
        const list = document.getElementById('admin-spotlight-list');
        if(!list) return;
        
        let html = '';
        if(spotlightData.length === 0) {
            html = '<div class="col-span-2 text-center py-10 opacity-50"><i data-lucide="image-off" class="w-10 h-10 mx-auto text-gray-300 mb-2"></i><p class="text-xs text-gray-400">No hay anuncios activos</p></div>';
        } else {
            spotlightData.forEach(ad => {
                html += `
                <div class="relative group rounded-2xl overflow-hidden aspect-[3/4] shadow-md border border-gray-100">
                    <img src="${ad.imageUrl}" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors"></div>
                    <button onclick="deleteSpotlight('${ad.id}')" class="absolute top-2 right-2 bg-white text-rose-500 p-1.5 rounded-full shadow-lg scale-0 group-hover:scale-100 transition-transform">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                    ${ad.link ? '<div class="absolute bottom-2 left-2 bg-indigo-600 text-white text-[9px] font-bold px-2 py-1 rounded-lg shadow-sm">LINK ACTIVO</div>' : ''}
                </div>`;
            });
        }
        list.innerHTML = html;
        lucide.createIcons();
    };

    window.openAddSpotlightModal = () => {
        openModal(`
        <div class="text-left bounce-enter">
            <div class="w-12 h-12 bg-rose-100 text-rose-600 rounded-2xl flex items-center justify-center mb-4 neumo-inset">
                <i data-lucide="megaphone" class="w-6 h-6"></i>
            </div>
            <h3 class="text-lg font-bold text-gray-800 mb-1">Nuevo Anuncio Pop-up</h3>
            <p class="text-xs text-gray-400 mb-4">Esta imagen aparecerá al abrir la app.</p>
            
            <form onsubmit="saveSpotlight(event)" class="space-y-3">
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">URL de la Imagen (Vertical recomendada)</label>
                    <input type="url" id="sl-img" class="neumo-inset w-full rounded-xl p-3 text-sm border-none bg-transparent" placeholder="https://..." required>
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-indigo-400 uppercase mb-1">Enlace de Acción (Opcional)</label>
                    <input type="url" id="sl-link" class="neumo-inset w-full rounded-xl p-3 text-sm border-none bg-transparent" placeholder="https://tu-web.com">
                </div>
                <button type="submit" class="neumo-button w-full bg-rose-600 text-white font-bold py-3 rounded-xl shadow-lg mt-2 hover:bg-rose-700">Publicar Ahora</button>
            </form>
        </div>`);
        lucide.createIcons();
    };

    window.saveSpotlight = async (e) => {
        e.preventDefault();
        const img = document.getElementById('sl-img').value;
        const link = document.getElementById('sl-link').value;
        
        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'spotlight_ads'), {
                imageUrl: img,
                link: link || null,
                createdAt: serverTimestamp()
            });
            showToast('Anuncio publicado con éxito', 'success');
            closeModal();
        } catch(err) {
            showToast('Error: ' + err.message, 'error');
        }
    };

    window.deleteSpotlight = async (id) => {
        if(confirm("¿Eliminar este anuncio?")) {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'spotlight_ads', id));
            showToast('Anuncio eliminado', 'success');
        }
    };
    
        // --- FUNCIONES GESTIÓN DOCUMENTOS ---
    window.markDocumentCompleted = async (id) => {
        if(!confirm("¿Marcar trámite como completado?")) return;
        try {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'document_requests', id), {
                status: 'completed'
            });
            showToast('Documento marcado como listo', 'success');
        } catch(e) { showToast('Error', 'error'); }
    };

    window.deleteDocumentRequest = async (id) => {
        if(!confirm("¿Eliminar este registro permanentemente?")) return;
        try {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'document_requests', id));
            showToast('Registro eliminado', 'success');
        } catch(e) { showToast('Error', 'error'); }
    };
    
// ======================================================
// 1. FUNCIÓN PARA ABRIR EL TICKET (SOLUCIÓN: PERFIL VISIBLE)
// ======================================================
window.openTicket = (itemStr, buyerEmail, priceDisplay) => {
    try {
        const item = JSON.parse(decodeURIComponent(itemStr));
        const date = item.soldAt ? new Date(item.soldAt.seconds * 1000).toLocaleString() : 'Fecha desconocida';
        
        let credentialsHtml = '';
        
        // --- LISTA INTELIGENTE DE CAMPOS ---
        // Ahora busca 'profile', 'profileName' y 'perfil' para asegurar que salga el nombre
        const fieldsToShow = [
            // 1. Correos
            { key: 'accountEmail', label: 'Email (Plataforma)', icon: 'at-sign' },
            { key: 'email', label: 'Email (Plataforma)', icon: 'at-sign' }, 
            
            // 2. Contraseña
            { key: 'password', label: 'Contraseña', icon: 'key' },

            // 3. PERFIL (Busca cualquiera de estas 3 opciones)
            { key: 'profile', label: 'Nombre Perfil', icon: 'smile' },
            { key: 'profileName', label: 'Nombre Perfil', icon: 'smile' },
            { key: 'perfil', label: 'Nombre Perfil', icon: 'smile' },

            // 4. PIN
            { key: 'pin', label: 'PIN de Acceso', icon: 'lock' },

            // 5. Resto de datos
            { key: 'screen', label: 'Dispositivo / Pantalla', icon: 'monitor' },
            { key: 'expirationDate', label: 'Vencimiento', icon: 'calendar' }
        ];

        const processedValues = new Set();

        fieldsToShow.forEach(field => {
            // Verificamos que el dato exista y tenga texto
            if(item[field.key] && item[field.key].toString().trim() !== '') {
                let value = item[field.key];
                
                // Evitamos duplicados (por si tienes guardado profile y profileName con el mismo dato)
                if (processedValues.has(value)) return;
                processedValues.add(value);

                if(field.key === 'expirationDate' && typeof value === 'object' && value.seconds) {
                    value = new Date(value.seconds * 1000).toLocaleDateString();
                }

                credentialsHtml += `
                <div class="bg-gray-50 p-3 rounded-xl border border-dashed border-gray-300 mb-2 hover:bg-teal-50 hover:border-teal-200 transition-colors group">
                    <p class="text-[10px] text-gray-400 uppercase font-bold mb-1 flex items-center gap-1 group-hover:text-teal-600">
                        <i data-lucide="${field.icon}" class="w-3 h-3"></i>
                        ${field.label}
                    </p>
                    <div class="flex justify-between items-center">
                        <p class="text-sm font-mono font-bold text-gray-800 select-all break-all">${value}</p>
                        ${field.key !== 'expirationDate' ? 
                            `<i data-lucide="copy" class="w-4 h-4 text-gray-300 cursor-pointer hover:text-teal-500 hover:scale-110 transition-transform active:scale-90" onclick="navigator.clipboard.writeText('${value}'); showToast('Copiado', 'success')"></i>` 
                            : ''}
                    </div>
                </div>`;
            }
        });

        // Diseño del TICKET (Sin cambios)
        const html = `
        <div class="bg-white rounded-[2rem] overflow-hidden max-w-sm mx-auto shadow-2xl bounce-enter relative">
            <div class="bg-gray-900 p-6 text-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-teal-400 via-indigo-500 to-purple-500"></div>
                <div class="w-16 h-16 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-3 backdrop-blur-sm">
                    <i data-lucide="receipt" class="w-8 h-8 text-teal-400"></i>
                </div>
                <h3 class="text-white font-black text-xl tracking-wider">TICKET DE VENTA</h3>
                <p class="text-gray-400 text-[10px] uppercase tracking-widest mt-1">ID: #${item.id.slice(-6).toUpperCase()}</p>
            </div>

            <div class="p-6 relative">
                <div class="absolute top-[-10px] left-0 w-full h-4 bg-white" style="clip-path: polygon(0 50%, 5% 0, 10% 50%, 15% 0, 20% 50%, 25% 0, 30% 50%, 35% 0, 40% 50%, 45% 0, 50% 50%, 55% 0, 60% 50%, 65% 0, 70% 50%, 75% 0, 80% 50%, 85% 0, 90% 50%, 95% 0, 100% 50%, 100% 100%, 0 100%);"></div>

                <div class="text-center mb-6">
                    <p class="text-xs text-gray-400 font-bold uppercase mb-1">Producto</p>
                    <h2 class="text-2xl font-black text-gray-800 leading-none mb-2">${item.serviceName}</h2>
                    <span class="inline-block bg-teal-100 text-teal-700 px-3 py-1 rounded-full text-sm font-black shadow-sm border border-teal-200">${priceDisplay}</span>
                </div>

                <div class="space-y-4">
                    <div class="flex justify-between items-end border-b border-gray-100 pb-2">
                        <div>
                            <p class="text-[10px] text-gray-400 uppercase font-bold">Cliente</p>
                            <p class="text-xs font-bold text-gray-700">${buyerEmail}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] text-gray-400 uppercase font-bold">Fecha</p>
                            <p class="text-xs font-bold text-gray-700">${date.split(',')[0]}</p>
                        </div>
                    </div>

                    <div>
                        <p class="text-xs font-black text-gray-900 uppercase mb-3 flex items-center gap-2">
                            <i data-lucide="package-check" class="w-3 h-3 text-teal-500"></i>
                            Datos de la Plataforma
                        </p>
                        <div class="max-h-[250px] overflow-y-auto pr-1 scrollbar-hide">
                            ${credentialsHtml || '<p class="text-xs text-gray-400 italic text-center py-4">No hay datos adicionales registrados.</p>'}
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-4 bg-gray-50 border-t border-gray-100">
                <button onclick="openGeneralHistory()" class="w-full py-3 rounded-xl bg-gray-900 text-white text-sm font-bold shadow-lg shadow-gray-200 hover:bg-black transition-all transform active:scale-95">
                    Volver al Historial
                </button>
            </div>
        </div>`;

        openModal(html);
        lucide.createIcons();

    } catch(e) {
        showToast('Error al abrir ticket', 'error');
        console.error(e);
    }
}


// ======================================================
// 2. HISTORIAL GENERAL (ACTUALIZADO CON CLIC)
// ======================================================
window.openGeneralHistory = async () => {
    openModal(`
        <div class="text-center py-12 bounce-enter">
            <span class="animate-spin inline-block w-10 h-10 border-4 border-teal-500 border-t-transparent rounded-full mb-3"></span>
            <p class="text-xs font-black text-teal-600 uppercase tracking-widest">Cargando ventas...</p>
        </div>
    `);

    try {
        const productsSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'profiles'));
        const productsMap = {};
        productsSnap.forEach(doc => {
            const p = doc.data();
            if (p.name) productsMap[p.name.trim().toLowerCase()] = p; 
        });

        const q = query(
            collection(db, 'artifacts', appId, 'public', 'data', 'inventory_items'), 
            where('status', '==', 'sold'), 
            orderBy('soldAt', 'desc'), 
            limit(50)
        );
        
        const snapshot = await getDocs(q);
        const historyItems = [];
        const userIds = new Set();

        snapshot.forEach(doc => {
            const data = doc.data();
            historyItems.push({ id: doc.id, ...data });
            if(data.soldTo) userIds.add(data.soldTo);
        });

        const userMap = {};
        if(userIds.size > 0) {
            const ids = Array.from(userIds);
            const userPromises = ids.map(uid => getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'all_users', uid)));
            const userSnaps = await Promise.all(userPromises);
            userSnaps.forEach(snap => {
                if(snap.exists()) userMap[snap.id] = snap.data();
            });
        }

        const rolePriceFields = {
            'client': 'priceClient', 'vip': 'priceVip', 'reseller': 'priceReseller', 'lider': 'priceLeader'
        };

        let html = `
        <div class="flex flex-col h-[80vh] bg-white rounded-[2rem] overflow-hidden bounce-enter relative">
            <div class="bg-teal-600 p-6 flex-shrink-0 shadow-lg z-10 text-white flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-black tracking-tight">Historial General</h3>
                    <p class="text-[10px] text-teal-100 font-medium uppercase tracking-widest">Toque un item para ver Ticket</p>
                </div>
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                    <i data-lucide="scroll-text" class="w-5 h-5 text-white"></i>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto scrollbar-hide p-4 space-y-3 bg-gray-50">`;

        if(historyItems.length === 0) {
            html += `<div class="text-center py-20 opacity-50"><p class="font-bold text-gray-400">Sin ventas</p></div>`;
        } else {
            historyItems.forEach(item => {
                const user = userMap[item.soldTo] || {};
                const email = user.email || 'Usuario Desconocido';
                const userRole = user.role || 'client';
                const date = item.soldAt ? item.soldAt.toDate().toLocaleString() : 'N/A';
                
                let finalPrice = 0;
                const productNameKey = (item.serviceName || '').trim().toLowerCase();
                const product = productsMap[productNameKey];

                if (product) {
                    const priceField = rolePriceFields[userRole] || 'priceClient';
                    finalPrice = Number(product[priceField] || 0);
                } else {
                    finalPrice = Number(item.price || 0);
                }
                if (item.soldPrice) finalPrice = Number(item.soldPrice);

                const priceDisplay = `$${finalPrice.toLocaleString()}`;
                const initial = (item.serviceName || '?').substring(0,1).toUpperCase();
                
                // --- PREPARAR DATOS PARA EL TICKET ---
                // Codificamos el objeto item a un string seguro para pasarlo en el onclick
                const itemStr = encodeURIComponent(JSON.stringify(item));

                let roleBadgeColor = 'bg-gray-100 text-gray-500';
                if(userRole === 'reseller') roleBadgeColor = 'bg-indigo-100 text-indigo-600';
                if(userRole === 'lider') roleBadgeColor = 'bg-amber-100 text-amber-600';
                if(userRole === 'vip') roleBadgeColor = 'bg-purple-100 text-purple-600';

                // Agregamos onclick y cursor-pointer
                html += `
                <div onclick="openTicket('${itemStr}', '${email}', '${priceDisplay}')" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col gap-3 relative group hover:shadow-lg hover:-translate-y-1 transition-all cursor-pointer">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-center gap-1.5 mb-1">
                                <i data-lucide="user" class="w-3 h-3 text-teal-500"></i>
                                <span class="text-[9px] font-bold uppercase px-1.5 py-0.5 rounded border border-gray-200 ${roleBadgeColor}">
                                    ${userRole}
                                </span>
                            </div>
                            <p class="text-xs font-black text-gray-800 break-all leading-tight">${email}</p>
                        </div>
                        <div class="text-right bg-teal-50 px-3 py-1.5 rounded-lg border border-teal-100 min-w-[70px]">
                            <span class="text-[9px] font-bold text-teal-500 uppercase block">Precio</span>
                            <span class="text-sm font-black text-teal-700 block">${priceDisplay}</span>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-3 border-t border-gray-50 pt-2">
                        <div class="w-10 h-10 rounded-xl bg-indigo-50 flex items-center justify-center text-indigo-600 font-bold text-xs flex-shrink-0 border border-indigo-100 group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                            ${initial}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs font-bold text-gray-700 truncate">${item.serviceName}</p>
                            <div class="flex items-center gap-1 text-[10px] text-gray-400 mt-0.5">
                                <i data-lucide="mouse-pointer-click" class="w-3 h-3"></i>
                                <span>Ver Ticket</span>
                            </div>
                        </div>
                    </div>
                </div>`;
            });
        }
        
        html += `</div>
            <div class="p-4 bg-white border-t border-gray-200 z-20">
                <button onclick="closeModal()" class="w-full py-3.5 rounded-xl text-xs font-bold text-gray-500 bg-gray-100 hover:bg-gray-200 transition-colors">Cerrar Historial</button>
            </div>
        </div>`;

        openModal(html);
        lucide.createIcons();

    } catch (e) {
        console.error(e);
        showToast('Error: ' + e.message, 'error');
        closeModal();
    }
};

// ======================================================
// PANEL ADMIN DOCUMENTOS (ETIQUETAS INTELIGENTES TOTALES)
// ======================================================
let docsListener = null;

window.openDocumentsPanel = () => {
    // 1. Estructura Visual
    openModal(`
    <div class="flex flex-col h-[85vh] bg-white rounded-[2rem] overflow-hidden bounce-enter relative">
        <div class="bg-gray-900 p-6 flex-shrink-0 shadow-lg z-10 text-white flex justify-between items-center">
            <div>
                <h3 class="text-xl font-black tracking-tight text-white">Solicitudes de Documentos</h3>
                <p class="text-[10px] text-gray-400 font-medium uppercase tracking-widest">Panel de Gestión</p>
            </div>
            <div class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center backdrop-blur-sm">
                <i data-lucide="file-check" class="w-5 h-5 text-emerald-400"></i>
            </div>
        </div>
        
        <div id="modal-docs-list" class="flex-1 overflow-y-auto scrollbar-hide p-4 space-y-3 bg-gray-50 relative">
            <div class="flex flex-col items-center justify-center h-full">
                <span class="animate-spin inline-block w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full mb-3"></span>
                <p class="text-xs font-bold text-gray-400">Cargando...</p>
            </div>
        </div>

        <div class="p-4 bg-white border-t border-gray-200 z-20">
            <button onclick="closeDocumentsPanel()" class="w-full py-3.5 rounded-xl text-xs font-bold text-gray-500 bg-gray-100 hover:bg-gray-200 transition-colors">Cerrar Panel</button>
        </div>
    </div>
    `);
    
    if(window.lucide) lucide.createIcons();

    // 2. Conexión y Lógica
    if(docsListener) docsListener(); 

    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'document_requests'));
    const container = document.getElementById('modal-docs-list');

    docsListener = onSnapshot(q, (snapshot) => {
        if (!document.getElementById('modal-docs-list')) return;

        let docs = [];
        snapshot.forEach(doc => { docs.push({ id: doc.id, ...doc.data() }); });

        // Ordenar: Más recientes primero
        docs.sort((a, b) => {
            const tA = a.timestamp ? a.timestamp.seconds : 0;
            const tB = b.timestamp ? b.timestamp.seconds : 0;
            return tB - tA;
        });

        if (docs.length === 0) {
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center py-20 opacity-50 h-full">
                    <i data-lucide="folder-open" class="w-16 h-16 text-gray-300 mb-3"></i>
                    <p class="text-sm text-gray-400 font-bold">No hay solicitudes pendientes</p>
                </div>`;
        } else {
            let html = '';
            docs.forEach(d => {
                let dateStr = "Fecha desconocida";
                if(d.timestamp && d.timestamp.seconds) {
                    dateStr = new Date(d.timestamp.seconds * 1000).toLocaleString();
                }

                const isPending = d.status === 'pending';
                const statusColor = isPending ? 'bg-amber-100 text-amber-600 border-amber-200' : 'bg-green-100 text-green-600 border-green-200';
                const statusText = isPending ? 'PENDIENTE' : 'ENVIADO';

                // --- LÓGICA DE ETIQUETAS DINÁMICAS (ADMIN) ---
                const sName = (d.serviceName || '').toLowerCase();
                let labelData = "DATO / CURP"; // Default

                if (sName.includes('cfe') || sName.includes('luz')) {
                    labelData = "NÚMERO DE SERVICIO";
                } else if (sName.includes('antecedentes') || sName.includes('penales')) {
                    labelData = "DATOS DEL SOLICITANTE";
                } else if (sName.includes('permiso') && (sName.includes('circular') || sName.includes('placas'))) {
                    labelData = "DATOS VEHÍCULO / DUEÑO";
                } else if (sName.includes('covid') || sName.includes('vacunacion')) {
                    labelData = "NOMBRE Y CURP";
                } else if (sName.includes('semanas') && sName.includes('cotizadas')) {
                    labelData = "CURP Y NSS";
                } else if (sName.includes('imei') || sName.includes('liberacion') || sName.includes('movil')) {
                    labelData = "IMEI / SERIE";
                }

                html += `
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col gap-4 relative group hover:shadow-md transition-all">
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600 border border-indigo-100">
                                <i data-lucide="user" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <p class="text-xs font-black text-gray-800">${d.serviceName || 'Trámite'}</p>
                                <p class="text-[10px] text-gray-400 font-bold truncate max-w-[150px]">${d.buyerEmail || 'Usuario'}</p>
                            </div>
                        </div>
                        <span class="text-[9px] font-bold px-2 py-1 rounded-md border ${statusColor} uppercase tracking-wide">
                            ${statusText}
                        </span>
                    </div>
                    
                    <div class="bg-gray-50 p-3 rounded-xl border border-gray-200 relative overflow-hidden">
                        <p class="text-[9px] text-gray-400 uppercase font-bold mb-1">${labelData}</p>
                        <p class="text-sm font-black text-gray-800 font-mono select-all break-all leading-snug">${d.curp || 'No especificado'}</p>
                        
                        <button onclick="navigator.clipboard.writeText('${d.curp || ''}').then(()=>showToast('Copiado'))" class="absolute top-2 right-2 p-1.5 bg-white text-gray-400 hover:text-indigo-600 rounded-lg shadow-sm transition-colors">
                            <i data-lucide="copy" class="w-4 h-4"></i>
                        </button>
                    </div>

                    <div class="flex items-center justify-between pt-2 border-t border-gray-50">
                        <p class="text-[10px] text-gray-400 font-bold flex items-center gap-1">
                            <i data-lucide="clock" class="w-3 h-3"></i> ${dateStr}
                        </p>
                        <div class="flex gap-2">
                            ${isPending ? `
                            <button onclick="window.adminDeliverDocument('${d.id}', '${d.serviceName}', '${d.uid}')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-[10px] font-bold shadow-md hover:bg-indigo-700 flex items-center gap-2">
                                <i data-lucide="send" class="w-3 h-3"></i> Entregar
                            </button>` : `
                            <button disabled class="bg-gray-100 text-gray-400 px-4 py-2 rounded-lg text-[10px] font-bold cursor-not-allowed flex items-center gap-2">
                                <i data-lucide="check-circle" class="w-3 h-3"></i> Enviado
                            </button>`}
                            
                            <button onclick="deleteDocumentRequest('${d.id}')" class="p-2 text-rose-300 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-colors">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }
        if(window.lucide) lucide.createIcons();

    }, (error) => {
        console.error("Error cargando documentos:", error);
        container.innerHTML = `<p class="text-red-500 text-center p-4">Error: ${error.message}</p>`;
    });
};

window.closeDocumentsPanel = () => {
    if(docsListener) docsListener();
    closeModal();
};


// ======================================================
// NOTIFICACIONES ROBUSTAS PARA ADMIN (SOLUCIÓN FINAL)
// ======================================================
let docsListenerRef = null;
let audioNotification = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3'); 

function initAdminNotifications() {
    // 1. Conectamos a la colección de solicitudes
    // Usamos limit(100) para no sobrecargar, ordenamos por creación si es posible
    // Si no tienes el campo timestamp, esto simplemente traerá 100 documentos cualesquiera
    const q = query(
        collection(db, 'artifacts', appId, 'public', 'data', 'document_requests'), 
        limit(100) 
    );

    docsListenerRef = onSnapshot(q, (snapshot) => {
        // 2. FILTRADO MANUAL (Más seguro)
        // Contamos cuántos documentos NO tienen status "completed"
        // Esto detecta 'pending', 'revision', o si no tienen status siquiera.
        const pendingDocs = snapshot.docs.filter(doc => {
            const data = doc.data();
            return data.status !== 'completed'; 
        });

        const count = pendingDocs.length;
        const badge = document.getElementById('badge-docs-admin');

        // 3. ACTUALIZAR EL GLOBO ROJO
        if(badge) {
            badge.innerText = count; // Poner el número
            
            if(count > 0) {
                // Mostrar si hay pendientes
                badge.classList.remove('hidden');
                badge.style.display = 'flex'; 
            } else {
                // Ocultar si todo está limpio
                badge.classList.add('hidden');
                badge.style.display = 'none';
            }
        }

        // 4. SONIDO Y AVISO (Detectar cambios)
        snapshot.docChanges().forEach((change) => {
            if (change.type === "added") {
                const data = change.doc.data();
                // Solo avisar si el documento agregado NO está completado
                if(data.status !== 'completed') {
                    // Evitamos que suene al cargar la página por primera vez (opcional)
                    // Si prefieres que suene siempre, deja esto así:
                    try { 
                        audioNotification.play().catch(e => console.log("Audio bloqueado por navegador")); 
                        showToast(`📄 Nueva solicitud pendiente`, 'info');
                    } catch(e) {}
                }
            }
        });
    }, (error) => {
        console.error("Error en notificaciones:", error);
    });
}

// ======================================================
// INICIADOR AUTOMÁTICO
// ======================================================
// Esto verifica si el usuario tiene permiso y arranca el sistema
auth.onAuthStateChanged(async (user) => {
    if (user) {
        try {
            const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'all_users', user.uid));
            if(snap.exists()) {
                const role = snap.data().role;
                // Si es Admin, Owner o CEO -> ENCENDER NOTIFICACIONES
                if(['admin', 'owner', 'ceo'].includes(role)) {
                    console.log("✅ Iniciando sistema de notificaciones...");
                    initAdminNotifications();
                }
            }
        } catch(e) {
            console.error("Error verificando rol:", e);
        }
    }
});

// ======================================================
// 1. ABRIR PANEL RENOVACIONES (CORREGIDO Y CONECTADO)
// ======================================================
window.openRenewalsPanel = () => {
    // A. Estructura Visual
    openModal(`
    <div class="flex flex-col h-[85vh] bg-white rounded-[2rem] overflow-hidden bounce-enter relative">
        <div class="bg-amber-500 p-6 flex-shrink-0 shadow-lg z-10 text-white flex justify-between items-center">
            <div>
                <h3 class="text-xl font-black tracking-tight text-white">Renovaciones</h3>
                <p class="text-[10px] text-amber-100 font-medium uppercase tracking-widest">Solicitudes de Usuarios</p>
            </div>
            <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                <i data-lucide="refresh-cw" class="w-5 h-5 text-white"></i>
            </div>
        </div>
        
        <div id="smart-renewals-list" class="flex-1 overflow-y-auto scrollbar-hide p-4 space-y-3 bg-gray-50 relative">
            <div class="flex flex-col items-center justify-center h-full opacity-50">
                <span class="animate-spin inline-block w-8 h-8 border-4 border-amber-500 border-t-transparent rounded-full mb-3"></span>
                <p class="text-xs font-bold text-gray-400">Buscando solicitudes...</p>
            </div>
        </div>

        <div class="p-4 bg-white border-t border-gray-200 z-20">
            <button onclick="closeSmartRenewals()" class="w-full py-3.5 rounded-xl text-xs font-bold text-gray-500 bg-gray-100 hover:bg-gray-200 transition-colors">Cerrar Panel</button>
        </div>
    </div>
    `);
    lucide.createIcons();

    // B. CONEXIÓN CORRECTA (A la colección 'reports')
    // Filtramos solo los que sean type == 'renewal'
    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'reports'), where('type', '==', 'renewal'));
    const container = document.getElementById('smart-renewals-list');

    // Variable global para poder cerrar el listener luego si es necesario
    window.renewalsSmartListener = onSnapshot(q, (snapshot) => {
        if(!document.getElementById('smart-renewals-list')) return;

        const pendingDocs = [];
        snapshot.forEach(doc => {
            const d = doc.data();
            // Filtramos: Solo mostramos lo que NO esté resuelto ni rechazado
            if(d.status !== 'resolved' && d.status !== 'rejected') {
                pendingDocs.push({ id: doc.id, ...d });
            }
        });

        // Ordenar por fecha (Javascript)
        pendingDocs.sort((a, b) => {
            const timeA = a.timestamp ? a.timestamp.seconds : 0;
            const timeB = b.timestamp ? b.timestamp.seconds : 0;
            return timeB - timeA; // Más recientes arriba
        });

        // Actualizar Badge del menú
        const badge = document.getElementById('badge-renewals-smart');
        if(badge) {
            badge.innerText = pendingDocs.length;
            if(pendingDocs.length > 0) badge.classList.remove('hidden');
            else badge.classList.add('hidden');
        }

        if (pendingDocs.length === 0) {
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center py-20 opacity-50 h-full">
                    <i data-lucide="check-circle" class="w-16 h-16 text-gray-300 mb-3"></i>
                    <p class="text-sm text-gray-400 font-bold">No hay renovaciones pendientes</p>
                </div>`;
            lucide.createIcons();
            return;
        }

        let html = '';
        pendingDocs.forEach(data => {
            const date = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleString() : 'Reciente';
            
            // Intentamos extraer el nombre del servicio de la descripción
            // Formato usual: "Solicitud de renovación para: NETFLIX..."
            let serviceName = "Servicio";
            if (data.description) {
                const lines = data.description.split('\n');
                if (lines[0] && lines[0].includes(':')) {
                    serviceName = lines[0].split(':')[1].trim();
                } else {
                    serviceName = lines[0]; // Fallback
                }
            }

            html += `
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex flex-col gap-3 relative group hover:shadow-md transition-all">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-[10px] text-gray-400 font-bold uppercase mb-0.5">Renovar Servicio</p>
                        <h4 class="text-sm font-black text-gray-800">${serviceName}</h4>
                        <p class="text-xs text-amber-600 font-bold mt-1">${data.email || 'Usuario'}</p>
                    </div>
                    <span class="bg-amber-100 text-amber-700 px-2 py-1 rounded text-[9px] font-black uppercase tracking-wide border border-amber-200">PENDIENTE</span>
                </div>
                
                <div class="bg-gray-50 p-3 rounded-xl border border-dashed border-gray-200">
                    <p class="text-[10px] text-gray-400 uppercase font-bold mb-1">Detalle Solicitud</p>
                    <p class="text-xs text-gray-600 italic line-clamp-3">${data.description || 'Sin detalles'}</p>
                </div>

                <div class="flex items-center gap-2 mt-2">
                    <button onclick="approveSmartRenewal('${data.id}', '${data.uid}', '${serviceName}', '${data.email}')" class="flex-1 py-3 rounded-xl bg-gray-900 text-white text-xs font-bold shadow-lg hover:bg-green-600 transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="dollar-sign" class="w-4 h-4"></i> Aprobar y Cobrar
                    </button>
                    
                    <button onclick="rejectSmartRenewal('${data.id}')" class="p-3 rounded-xl bg-red-50 text-red-500 hover:bg-red-100 border border-red-100 transition-colors" title="Rechazar">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
                <p class="text-[9px] text-gray-300 text-center mt-2 font-mono">${date}</p>
            </div>`;
        });

        container.innerHTML = html;
        lucide.createIcons();

    }, (error) => {
        console.error("Error renovaciones:", error);
        container.innerHTML = `<div class="text-center py-10 text-red-500 font-bold text-xs">Error: ${error.message}</div>`;
    });
};

window.closeSmartRenewals = () => {
    // Cerramos modal sin destruir el listener para que el globo rojo siga vivo
    closeModal();
};


// ======================================================
// 2. LÓGICA DE APROBACIÓN Y RECHAZO (CONECTADO A REPORTS)
// ======================================================

window.approveSmartRenewal = async (reportId, userId, serviceName, userEmail) => {
    if(!confirm(`¿Deseas renovar "${serviceName}" para ${userEmail}?\n\n⚠️ SE DESCONTARÁ EL SALDO AL USUARIO.`)) return;
    
    // Feedback visual inmediato
    openModal(`
        <div class="text-center py-12">
            <span class="animate-spin inline-block w-10 h-10 border-4 border-amber-500 border-t-transparent rounded-full mb-3"></span>
            <p class="text-xs font-bold text-amber-600 uppercase animate-pulse">Procesando cobro...</p>
        </div>
    `);

    try {
        // A. Buscar usuario para ver su ROL y SALDO
        const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'all_users', userId);
        const walletRef = doc(db, 'artifacts', appId, 'users', userId, 'wallet', 'main');
        
        const [userSnap, walletSnap] = await Promise.all([getDoc(userRef), getDoc(walletRef)]);
        
        if (!userSnap.exists()) throw new Error("Usuario no encontrado.");
        
        const userData = userSnap.data();
        const balance = walletSnap.exists() ? (Number(walletSnap.data().balance) || 0) : 0;
        const role = userData.role || 'client'; 

        // B. Buscar el precio del servicio según el ROL
        const productsSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'profiles'));
        let price = 0;
        let found = false;

        // Buscamos el producto por nombre (aproximado)
        productsSnap.forEach(doc => {
            const prod = doc.data();
            if (prod.name && serviceName && prod.name.trim().toLowerCase().includes(serviceName.trim().toLowerCase())) {
                // Seleccionamos el precio correcto según rol
                if(role === 'lider' && prod.priceLeader) price = Number(prod.priceLeader);
                else if(role === 'reseller' && prod.priceReseller) price = Number(prod.priceReseller);
                else if(role === 'vip' && prod.priceVip) price = Number(prod.priceVip);
                else price = Number(prod.priceClient || prod.price || 0);
                found = true;
            }
        });

        if (!found) console.warn("Producto no encontrado exacto, precio base 0");

        // C. VERIFICAR SALDO
        if (balance < price) {
            throw new Error(`❌ SALDO INSUFICIENTE.\nEl usuario tiene $${balance} y la renovación cuesta $${price}.`);
        }

        // D. EJECUTAR COBRO Y ACTUALIZACIÓN
        await runTransaction(db, async (t) => {
            // 1. Descontar saldo
            t.update(walletRef, { balance: balance - price });

            // 2. Marcar REPORTE como RESUELTO
            const reportRef = doc(db, 'artifacts', appId, 'public', 'data', 'reports', reportId);
            t.update(reportRef, { 
                status: 'resolved', 
                adminReply: 'Renovación APROBADA y COBRADA.',
                resolvedAt: serverTimestamp() 
            });

            // 3. Crear registro en historial del usuario
            const txRef = doc(collection(db, 'artifacts', appId, 'users', userId, 'transactions'));
            t.set(txRef, { 
                type: 'renewal', 
                amount: price, 
                description: `Renovación: ${serviceName}`, 
                timestamp: serverTimestamp(), 
                status: 'approved' 
            });
        });

        showToast(`✅ Renovado con éxito. Se cobraron $${price}`, 'success');
        
        // Recargar el panel para ver que ya no está la solicitud
        window.openRenewalsPanel(); 

    } catch (e) {
        closeModal();
        alert("⛔ ERROR:\n" + e.message);
        // Reabrimos el panel para no perder contexto
        window.openRenewalsPanel(); 
    }
};

window.rejectSmartRenewal = async (reportId) => {
    if(!confirm("¿Rechazar esta solicitud?")) return;
    
    try {
        // Actualizamos el reporte a "rejected"
        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reports', reportId), {
            status: 'rejected',
            adminReply: 'Renovación Rechazada por falta de stock o datos incorrectos.',
            rejectedAt: serverTimestamp()
        });
        showToast('Solicitud rechazada', 'info');
    } catch(e) {
        showToast('Error al rechazar: ' + e.message, 'error');
    }
};


// Iniciar escuchas si es admin
auth.onAuthStateChanged(user => {
    if(user) {
        getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'all_users', user.uid)).then(s => {
            if(s.exists() && ['admin','owner','ceo'].includes(s.data().role)) {
                // Forzar inicio de escucha para el globo rojo
                if(window.renewalsSmartListener === null) {
                    // Llamamos a la función "invisiblemente" para activar el listener
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'renewal_requests'), where('status', '==', 'pending'));
                    onSnapshot(q, (snap) => {
                        const badge = document.getElementById('badge-renewals-smart');
                        if(badge) {
                            badge.innerText = snap.size;
                            badge.classList.toggle('hidden', snap.size === 0);
                            if(snap.size > 0) badge.style.display = 'flex';
                        }
                    });
                }
            }
        });
    }
});

        // ======================================================
        // SISTEMA DE VALIDACIÓN DE RECARGA (CON ALERTA < $100)
        // ======================================================

        // 1. Ventana Emergente Amigable (Comisión)
        window.openCommissionAlert = (amount) => {
            openModal(`
                <div class="text-center bounce-enter pt-4 px-2">
                    <div class="w-20 h-20 bg-amber-50 rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-white shadow-xl animate-pulse">
                        <i data-lucide="piggy-bank" class="w-10 h-10 text-amber-500"></i>
                    </div>
                    
                    <h3 class="text-xl font-black text-gray-800 mb-2">¡Un pequeño aviso! 🌟</h3>
                    
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm text-left space-y-3 mb-6">
                        <p class="text-sm text-gray-600 leading-relaxed font-medium">
                            Hola 👋. Te recordamos que la recarga mínima ya es de <b class="text-emerald-600">$100 pesos</b> para que sea totalmente <b>GRATIS</b>.
                        </p>
                        
                        <div class="bg-rose-50 p-3 rounded-xl border border-rose-100 flex gap-3 items-start">
                            <i data-lucide="info" class="w-5 h-5 text-rose-500 mt-0.5 flex-shrink-0"></i>
                            <p class="text-xs text-rose-600 font-bold leading-snug">
                                Al recargar <span class="text-rose-800 underline">$${amount}</span>, el banco cobrará una comisión operativa de $20 pesos.
                            </p>
                        </div>
                    </div>

                    <div class="grid gap-3">
                        <button onclick="executeRecharge(${amount})" class="w-full bg-gray-900 text-white font-bold py-3.5 rounded-xl shadow-lg hover:bg-black transition-transform active:scale-95 flex items-center justify-center gap-2">
                            <span>Aceptar y Continuar</span>
                            <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </button>
                        
                        <button onclick="openChargeModal()" class="w-full bg-white text-indigo-600 font-bold py-3 rounded-xl border border-indigo-100 hover:bg-indigo-50 transition-colors">
                            Cambiar Monto (Ahorrar comisión)
                        </button>
                    </div>
                </div>
            `);
            lucide.createIcons();
        };

        // 2. Nueva Lógica Principal (Validación)
        // Esta función reemplaza a la que tenías conectada al botón "Generar Solicitud"
        window.processRecharge = (val) => {
            const amount = Number(val);
            
            if (!amount || amount <= 0) {
                showToast('Por favor ingresa un monto válido', 'error');
                return;
            }

            // --- REGLA: Si es menor a 100, mostrar alerta amable ---
            if (amount < 100) {
                openCommissionAlert(amount); // Muestra la alerta, no procesa aún
            } else {
                executeRecharge(amount); // Pasa directo si es >= 100
            }
        };

        // 3. Ejecución Real de la Recarga (Tu lógica original movida aquí)
        // Esta función contiene TODA tu lógica de Firebase, Strikes y Timer original.
        window.executeRecharge = async (amt) => {
            // Recuperamos el botón del modal anterior (si existe) o simulamos carga
            let btn = document.getElementById('confirm-btn');
            
            // Si estamos en el modal de alerta, el botón 'confirm-btn' no existe, 
            // así que buscamos el botón de la alerta actual para ponerle spinner
            if (!btn) {
                btn = document.querySelector('button[onclick^="executeRecharge"]');
            }

            if(btn) {
                const originalText = btn.innerText;
                btn.innerHTML = '<span class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full"></span> Procesando...';
                btn.disabled = true;
            }

            try {
                // 1. Verificar sanciones previas (Lógica original)
                const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'all_users', currentUser.uid);
                const userSnap = await getDoc(userDocRef);
                let strikes = userSnap.data().rechargeStrikes || 0;
                let lastStrike = userSnap.data().lastStrikeDate ? userSnap.data().lastStrikeDate.toDate() : new Date();

                // Resetear strikes si es un día nuevo
                const today = new Date();
                if(lastStrike.getDate() !== today.getDate() || lastStrike.getMonth() !== today.getMonth()) {
                    strikes = 0;
                    await updateDoc(userDocRef, { rechargeStrikes: 0 });
                }

                // 2. Crear la solicitud en Firebase
                const txRef = await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions'), {
                    type: 'deposit',
                    amount: Number(amt),
                    description: 'Recarga Pendiente (En proceso)',
                    timestamp: serverTimestamp(),
                    status: 'Pending'
                });

                const reqRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'pending_recharges'), {
                    uid: currentUser.uid,
                    email: currentUser.email,
                    amount: Number(amt),
                    status: 'pending',
                    timestamp: serverTimestamp(),
                    userTxId: txRef.id,
                    expiresAt: new Date(Date.now() + 10 * 60 * 1000) // 10 minutos validez
                });

                showToast('Solicitud iniciada. Tienes 10 minutos.', 'info');

                // 3. Abrir Modal con Timer (Tu función original de la App)
                showPaymentModalWithTimer(reqRef.id, txRef.id, Number(amt), strikes);

            } catch (e) {
                console.error("Error en recarga:", e);
                showToast('Error al procesar solicitud', 'error');
                if(btn) {
                    btn.disabled = false;
                    btn.innerText = "Reintentar";
                }
            }
        };
        
                // ======================================================
        // SISTEMA DE COMISIONES (REFERIDOS 10%)
        // ======================================================
        window.processReferralCommission = async (buyerUid, purchaseAmount) => {
            try {
                // 1. Obtener datos del comprador para ver quien lo invitó
                const buyerRef = doc(db, 'artifacts', appId, 'public', 'data', 'all_users', buyerUid);
                const buyerSnap = await getDoc(buyerRef);
                
                if (!buyerSnap.exists()) return;
                
                const buyerData = buyerSnap.data();
                const referrerId = buyerData.referredBy; // El UID del que lo invitó

                // Si NO tiene referido, terminamos aquí.
                if (!referrerId) return;

                // 2. Calcular el 10%
                const commission = purchaseAmount * 0.10;
                
                // Evitar comisiones de $0 o errores
                if (commission <= 0) return;

                console.log(`Procesando comisión de $${commission} para el usuario: ${referrerId}`);

                // 3. Buscar al Patrocinador (Referrer)
                const referrerRef = doc(db, 'artifacts', appId, 'public', 'data', 'all_users', referrerId);
                const referrerSnap = await getDoc(referrerRef);

                if (referrerSnap.exists()) {
                    const currentBalance = referrerSnap.data().balance || 0;
                    const newBalance = currentBalance + commission;

                    // A. Darle el dinero al patrocinador
                    await updateDoc(referrerRef, {
                        balance: newBalance
                    });

                    // B. Registrar la transacción en su historial para que sepa de dónde vino el dinero
                    await addDoc(collection(db, 'artifacts', appId, 'users', referrerId, 'transactions'), {
                        type: 'referral_bonus', // Tipo especial para identificar ganancias
                        amount: commission,
                        description: `Comisión (10%) por compra de tu referido`,
                        timestamp: serverTimestamp(),
                        status: 'completed'
                    });
                }

            } catch (error) {
                console.error("Error al procesar comisión de referido:", error);
                // No mostramos error al usuario final para no interrumpir su experiencia de compra
            }
        };
        
  // ==========================================
// VISTA DE DOCUMENTOS (USUARIO - ETIQUETAS INTELIGENTES)
// ==========================================
window.renderDocumentsView = async () => {
    document.getElementById('user-view').classList.add('hidden');
    document.getElementById('admin-view').classList.add('hidden');
    const docView = document.getElementById('documents-view');
    docView.classList.remove('hidden');
    
    docView.innerHTML = '<div class="text-center py-10"><span class="animate-spin inline-block w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full"></span><p class="text-xs text-gray-400 mt-2">Cargando...</p></div>';

    try {
        const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'document_requests'), where('uid', '==', currentUser.uid));
        const snapshot = await getDocs(q);

        let docsList = [];
        snapshot.forEach(doc => { docsList.push(doc.data()); });

        docsList.sort((a, b) => {
            const timeA = a.timestamp ? a.timestamp.seconds : 0;
            const timeB = b.timestamp ? b.timestamp.seconds : 0;
            return timeB - timeA;
        });

        let html = `
        <div class="flex items-center gap-3 mb-6">
            <button onclick="switchView('user')" class="bg-gray-100 p-2 rounded-xl hover:bg-gray-200 transition-colors"><i data-lucide="arrow-left" class="w-5 h-5 text-gray-600"></i></button>
            <h2 class="text-2xl font-black text-gray-800">Mis Documentos</h2>
        </div>
        <div class="space-y-4">`;

        if (docsList.length === 0) {
            html += `
            <div class="flex flex-col items-center justify-center py-16 opacity-50 text-center">
                <i data-lucide="folder-open" class="w-12 h-12 text-gray-300 mb-3"></i>
                <h3 class="text-sm font-bold text-gray-500">Sin documentos</h3>
                <p class="text-xs text-gray-400 mt-1">Tus solicitudes aparecerán aquí.</p>
            </div>`;
        } else {
            docsList.forEach(d => {
                const isReady = d.status === 'completed';
                const statusColor = isReady ? 'text-emerald-600 bg-emerald-50 border-emerald-100' : 'text-amber-600 bg-amber-50 border-amber-100';
                const statusIcon = isReady ? 'check-circle-2' : 'clock';
                const statusText = isReady ? 'DISPONIBLE' : 'EN PROCESO';

                // --- LÓGICA DE ETIQUETAS DINÁMICAS (USUARIO) ---
                const sName = (d.serviceName || '').toLowerCase();
                let labelUser = "DATO / CURP ENVIADO:"; // Default
                let iconUser = "scan-line";

                if (sName.includes('cfe') || sName.includes('luz')) {
                    labelUser = "NÚMERO DE SERVICIO ENVIADO:";
                    iconUser = "zap";
                } else if (sName.includes('antecedentes') || sName.includes('penales')) {
                    labelUser = "DATOS DE SOLICITUD ENVIADOS:";
                    iconUser = "file-text";
                } else if (sName.includes('permiso') && (sName.includes('circular') || sName.includes('placas'))) {
                    labelUser = "DATOS DEL VEHÍCULO ENVIADOS:";
                    iconUser = "car";
                } else if (sName.includes('covid') || sName.includes('vacunacion')) {
                    labelUser = "NOMBRE Y CURP ENVIADOS:";
                    iconUser = "activity";
                } else if (sName.includes('semanas') && sName.includes('cotizadas')) {
                    labelUser = "CURP Y NSS ENVIADOS:";
                    iconUser = "briefcase";
                } else if (sName.includes('imei') || sName.includes('liberacion') || sName.includes('movil')) {
                    labelUser = "CÓDIGO IMEI ENVIADO:";
                    iconUser = "smartphone";
                }

                html += `
                <div class="neumo-card p-5 rounded-2xl relative overflow-hidden bg-white border border-gray-100 group transition-all hover:shadow-md">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-2xl bg-indigo-50 text-indigo-600 flex items-center justify-center neumo-inset shadow-sm flex-shrink-0">
                                <i data-lucide="file-text" class="w-6 h-6"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-gray-800 text-sm leading-tight mb-1">${d.serviceName}</h3>
                                <div class="flex items-center gap-1.5">
                                    <i data-lucide="calendar" class="w-3 h-3 text-gray-400"></i>
                                    <p class="text-[10px] text-gray-400 font-medium font-mono">${d.timestamp ? d.timestamp.toDate().toLocaleDateString() : 'Reciente'}</p>
                                </div>
                            </div>
                        </div>
                        <span class="text-[9px] font-black px-2.5 py-1 rounded-lg border ${statusColor} tracking-widest shadow-sm flex items-center gap-1">
                            <i data-lucide="${statusIcon}" class="w-3 h-3"></i> ${statusText}
                        </span>
                    </div>

                    <div class="mb-4 px-4 py-3 bg-gray-50 rounded-xl border border-gray-200 relative overflow-hidden">
                        <p class="text-[9px] text-gray-400 font-bold uppercase tracking-widest mb-1">${labelUser}</p>
                        <p class="text-sm font-black text-gray-800 font-mono select-all tracking-wide break-words leading-snug">${d.curp || 'No especificado'}</p>
                        <i data-lucide="${iconUser}" class="absolute right-3 top-1/2 -translate-y-1/2 w-8 h-8 text-gray-200 -z-0"></i>
                    </div>
                    
                    ${isReady && d.downloadUrl ? `
                        <div class="pt-2 border-t border-gray-100">
                            <button onclick="openSafeUrl('${d.downloadUrl}')" class="w-full bg-gray-900 text-white font-bold py-3.5 rounded-xl shadow-lg hover:bg-black flex items-center justify-center gap-2 transition-all active:scale-95 group-hover:shadow-xl">
                                <i data-lucide="download-cloud" class="w-5 h-5"></i>
                                <span>Descargar Archivo</span>
                            </button>
                        </div>` 
                    : `
                        <div class="mt-3 bg-amber-50/50 p-3 rounded-xl border border-amber-100/50 flex items-center gap-3">
                            <div class="animate-spin w-4 h-4 border-2 border-amber-200 border-t-amber-500 rounded-full flex-shrink-0"></div>
                            <p class="text-xs text-amber-700 font-medium leading-tight">Estamos trabajando en tu solicitud...</p>
                        </div>`}
                </div>`;
            });
        }

        html += '</div>';
        docView.innerHTML = html;
        lucide.createIcons();

    } catch (e) {
        console.error(e);
        docView.innerHTML = `<div class="text-center py-10 text-red-500">Error: ${e.message}</div>`;
    }
};

// 2. MODAL DE ENTREGA (ADMIN)
window.openDocumentDeliveryModal = (reqId, uid, sName) => {
    openModal(`
        <div class="text-left bounce-enter pt-4">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-3 neumo-card neumo-inset border border-indigo-200">
                    <i data-lucide="file-check" class="w-8 h-8"></i>
                </div>
                <h3 class="text-xl font-black text-gray-800 uppercase tracking-tight">Entregar Documento</h3>
                <p class="text-xs text-gray-500 font-medium">${sName}</p>
            </div>
            
            <form onsubmit="confirmDocumentDelivery(event, '${reqId}', '${uid}', '${sName}')" class="space-y-5 bg-gray-50 p-5 rounded-2xl border border-gray-100">
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1 ml-1">Enlace de Descarga (PDF/Imagen)</label>
                    <div class="relative group">
                        <i data-lucide="link" class="absolute left-3 top-3.5 w-4 h-4 text-gray-400 group-focus-within:text-indigo-500 transition-colors"></i>
                        <input type="url" id="delivery-link" class="w-full bg-white border border-gray-200 rounded-xl py-3 pl-10 pr-4 text-sm font-bold text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all shadow-sm" placeholder="https://ejemplo.com/archivo.pdf" required>
                    </div>
                    <p class="text-[9px] text-gray-400 mt-1.5 ml-1">Pega aquí el link de Google Drive, Mediafire o directo.</p>
                </div>
                
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3.5 rounded-xl shadow-lg hover:bg-indigo-700 flex items-center justify-center gap-2 transform active:scale-95 transition-all">
                    <span>Confirmar Entrega</span>
                    <i data-lucide="send" class="w-4 h-4"></i>
                </button>
            </form>
            
            <button onclick="closeModal()" class="w-full mt-4 text-xs font-bold text-gray-400 hover:text-gray-600 py-2">Cancelar</button>
        </div>
    `);
    lucide.createIcons();
};

// 3. PROCESAR ENTREGA (ADMIN)
window.confirmDocumentDelivery = async (e, reqId, uid, sName) => {
    e.preventDefault();
    const link = document.getElementById('delivery-link').value;
    const btn = e.target.querySelector('button');
    const originalContent = btn.innerHTML;
    
    btn.disabled = true; 
    btn.innerHTML = '<span class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full"></span> Enviando...';
    
    try {
        // A. Actualizar la solicitud a COMPLETADO
        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'document_requests', reqId), {
            status: 'completed',
            downloadUrl: link,
            completedAt: serverTimestamp()
        });
        
        // B. Crear Notificación en Campana con botón directo
        await addDoc(collection(db, 'artifacts', appId, 'users', uid, 'transactions'), {
            type: 'document_ready', 
            amount: 0,
            description: 'Documento Listo',
            details: {
                serviceName: sName,
                downloadUrl: link
            },
            timestamp: serverTimestamp(),
            isRead: false
        });

        showToast('¡Documento entregado exitosamente!', 'success');
        closeModal();
    } catch (err) {
        console.error(err);
        showToast('Error: ' + err.message, 'error');
        btn.disabled = false; 
        btn.innerHTML = originalContent;
    }
};

// ==========================================
// ENTREGA DE DOCUMENTOS (CON NOTIFICACIÓN AL USUARIO)
// ==========================================
window.adminDeliverDocument = async (docId, serviceName, buyerUid) => {
    const link = prompt(`Ingresa el LINK de descarga para: ${serviceName}`);
    
    if (!link || link.trim() === "") return;

    try {
        showToast('Enviando documento...', 'info');
        
        // 1. Marcar como completado en el Admin
        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'document_requests', docId), {
            status: 'completed',
            downloadUrl: link.trim(),
            completedAt: serverTimestamp()
        });

        // 2. ENVIAR NOTIFICACIÓN AL USUARIO (Punto Rojo)
        // Intentamos usar el ID que pasamos, si no, lo buscamos en el documento
        let targetUid = buyerUid;
        if (!targetUid || targetUid === 'undefined') {
            const docSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'document_requests', docId));
            if (docSnap.exists()) targetUid = docSnap.data().uid;
        }

        if (targetUid) {
            await addDoc(collection(db, 'artifacts', appId, 'users', targetUid, 'transactions'), {
                type: 'document_ready', // Tipo especial para activar la alerta
                amount: 0,
                description: `Documento Listo: ${serviceName}`,
                details: {
                    serviceName: serviceName,
                    downloadUrl: link.trim(),
                    isDocument: true
                },
                timestamp: serverTimestamp(),
                isRead: false // Esto activa el punto rojo en la campana
            });
        }

        showToast('¡Documento entregado exitosamente!', 'success');
        
    } catch (error) {
        console.error(error);
        showToast('Error al entregar: ' + error.message, 'error');
    }
};

// ==========================================
// FUNCIÓN PARA ABRIR LINKS EXTERNOS (CORRIGE EL ERROR DE URL)
// ==========================================
window.openSafeUrl = (url) => {
    if (!url) return;
    let finalUrl = url.trim();
    // Si el link NO empieza con http o https, se lo agregamos
    if (!/^https?:\/\//i.test(finalUrl)) {
        finalUrl = 'https://' + finalUrl;
    }
    window.open(finalUrl, '_blank');
};

// ==========================================
// VALIDACIÓN ESPECIAL: SEMANAS COTIZADAS
// ==========================================
window.validateSemanasAndPurchase = (id, name, price, category) => {
    const curpInput = document.getElementById('input-sem-curp');
    const nssInput = document.getElementById('input-sem-nss');
    const hiddenInput = document.getElementById('purchase-curp'); // El que lee el sistema
    
    if (!curpInput || !nssInput) return;
    
    const curp = curpInput.value.trim().toUpperCase();
    const nss = nssInput.value.trim();

    // 1. Validar que no estén vacíos
    if (curp.length < 5 || nss.length < 5) {
        showToast('⚠️ Debes llenar CURP y NSS correctamente.', 'error');
        if(curp.length < 5) curpInput.focus();
        else nssInput.focus();
        return;
    }

    // 2. Unir los datos en el input oculto para que el sistema los procese
    // El admin recibirá: "CURP: XXXX... / NSS: YYYY..."
    hiddenInput.value = `CURP: ${curp} / NSS: ${nss}`;

    // 3. Procesar compra normalmente
    window.processPurchase(id, name, price, category);
};

// ==========================================
// VALIDACIÓN ESPECIAL: CERTIFICADO COVID
// ==========================================
window.validateCovidAndPurchase = (id, name, price, category) => {
    const nameInput = document.getElementById('input-covid-nombre');
    const curpInput = document.getElementById('input-covid-curp');
    const hiddenInput = document.getElementById('purchase-curp'); // Input oculto para el sistema
    
    if (!nameInput || !curpInput) return;
    
    const nombre = nameInput.value.trim().toUpperCase();
    const curp = curpInput.value.trim().toUpperCase();

    // 1. Validar campos
    if (nombre.length < 3 || curp.length < 5) {
        showToast('⚠️ Completa el Nombre y la CURP.', 'error');
        if(nombre.length < 3) nameInput.focus();
        else curpInput.focus();
        return;
    }

    // 2. Unir datos para el admin
    // Resultado: "NOMBRE: Juan Perez / CURP: XXXX..."
    hiddenInput.value = `NOMBRE: ${nombre} / CURP: ${curp}`;

    // 3. Procesar
    window.processPurchase(id, name, price, category);
};

// ==========================================
// VALIDACIÓN ESPECIAL: ANTECEDENTES NO PENALES
// ==========================================
window.validateAntecedentesAndPurchase = (id, name, price, category) => {
    // 1. Obtener referencias a los 7 campos
    const iNombres = document.getElementById('input-ant-nombres');
    const iPaterno = document.getElementById('input-ant-paterno');
    const iMaterno = document.getElementById('input-ant-materno');
    const iFecha   = document.getElementById('input-ant-fecha');
    const iCurp    = document.getElementById('input-ant-curp');
    const iClave   = document.getElementById('input-ant-clave');
    const iDom     = document.getElementById('input-ant-domicilio');
    const hiddenInput = document.getElementById('purchase-curp'); // Input oculto del sistema

    if (!iNombres || !iPaterno || !iFecha || !iCurp || !iDom) return;

    // 2. Limpiar y estandarizar valores
    const vNombres = iNombres.value.trim().toUpperCase();
    const vPaterno = iPaterno.value.trim().toUpperCase();
    const vMaterno = iMaterno ? iMaterno.value.trim().toUpperCase() : '';
    const vFecha   = iFecha.value.trim();
    const vCurp    = iCurp.value.trim().toUpperCase();
    const vClave   = iClave ? iClave.value.trim().toUpperCase() : 'SIN DATO';
    const vDom     = iDom.value.trim().toUpperCase();

    // 3. Validación básica (que no estén vacíos los importantes)
    if (vNombres.length < 2 || vPaterno.length < 2 || vCurp.length < 5 || vDom.length < 5) {
        showToast('⚠️ Por favor completa todos los campos obligatorios.', 'error');
        return;
    }

    // 4. Empaquetar datos para el Administrador
    // Formato: "NOM: Juan Perez / NAC: 01-01-90 / CURP: XXX / INE: 123 / DOM: Calle..."
    hiddenInput.value = `NOM: ${vNombres} ${vPaterno} ${vMaterno} / NAC: ${vFecha} / CURP: ${vCurp} / INE: ${vClave} / DOM: ${vDom}`;

    // 5. Proceder con la compra
    window.processPurchase(id, name, price, category);
};

// ==========================================
// VALIDACIÓN ESPECIAL: PERMISO CIRCULACIÓN
// ==========================================
window.validatePermisoCirculacionAndPurchase = (id, name, price, category) => {
    // 1. Referencias
    const iSerie   = document.getElementById('input-permiso-serie');
    const iMotor   = document.getElementById('input-permiso-motor');
    const iMarca   = document.getElementById('input-permiso-marca');
    const iModelo  = document.getElementById('input-permiso-modelo');
    const iLinea   = document.getElementById('input-permiso-linea');
    const iColor   = document.getElementById('input-permiso-color');
    const iNombre  = document.getElementById('input-permiso-nombre');
    const iDir     = document.getElementById('input-permiso-direccion');
    const hiddenInput = document.getElementById('purchase-curp'); // Input del sistema

    if (!iSerie || !iMotor || !iMarca || !iModelo || !iLinea || !iColor || !iNombre || !iDir) return;

    // 2. Limpieza de valores
    const vSerie  = iSerie.value.trim().toUpperCase();
    const vMotor  = iMotor.value.trim().toUpperCase();
    const vMarca  = iMarca.value.trim().toUpperCase();
    const vModelo = iModelo.value.trim().toUpperCase();
    const vLinea  = iLinea.value.trim().toUpperCase();
    const vColor  = iColor.value.trim().toUpperCase();
    const vNombre = iNombre.value.trim().toUpperCase();
    const vDir    = iDir.value.trim().toUpperCase();

    // 3. Validación
    if (vSerie.length < 3 || vMarca.length < 2 || vNombre.length < 5 || vDir.length < 5) {
        showToast('⚠️ Completa todos los campos obligatorios.', 'error');
        return;
    }

    // 4. Unir datos para el admin
    // Formato: SERIE: XXX / MOTOR: YYY / AUTO: Marca Modelo Linea Color / DUEÑO: Nombre / DIR: Dirección
    hiddenInput.value = `SERIE: ${vSerie} / MOTOR: ${vMotor} / AUTO: ${vMarca} ${vModelo} ${vLinea} ${vColor} / DUEÑO: ${vNombre} / DIR: ${vDir}`;

    // 5. Procesar
    window.processPurchase(id, name, price, category);
};
        
    </script>
</body>
</html>
