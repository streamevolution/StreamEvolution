<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Revolution Wax - Lealtad</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* COLORES DE IDENTIDAD */
            --primary-blue: #2c5aa0;
            --primary-red: #848482;
            
            /* NUEVO COLOR AMARILLO MOSTAZA (simulando la botella) */
            --primary-yellow: #848482; 
            
            /* COLORES MINIMALISTAS CLAROS */
            --bg-body: #f8f9fa;
            --surface-white: #ffffff;
            --text-main: #1f2937;
            --text-secondary: #6b7280;
            --border-light: #e5e7eb;
            
            /* SOMBRAS */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            padding-bottom: 80px;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* TRANSICIONES */
        button, .btn-register-red, .btn-transfer, .station-item, .city-list-item, .ad-slide, .nav-item {
            transition: all 0.2s ease;
        }
        button:active, .btn-register-red:active, .btn-transfer:active, .station-item:active, .city-list-item:active, .ad-slide:active {
            transform: scale(0.97);
        }

        /* UTILIDADES */
        .hidden { display: none !important; }
        .flex-center { display: flex; justify-content: center; align-items: center; }
        
        /* === ESTILOS PARA BOTONES FLOTANTES DE COMPRA === */
        .floating-action-container {
            position: fixed;
            bottom: 100px; /* Separado del bottom-nav */
            right: 20px;
            z-index: 99;
            display: none; /* Se mostrar谩 solo en #app-view */
            flex-direction: column;
            align-items: flex-end;
        }

        /* ESTILO BOTN PRINCIPAL (MS DELGADO) */
        .fab-main {
            /* Dimensiones Reducidas */
            width: 130px; 
            height: 40px; 
            border-radius: 20px; 
            
            background-color: var(--primary-blue); 
            color: white;
            border: none;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px; 
            font-weight: 600;
            transition: transform 0.3s ease, background-color 0.3s ease;
        }
        
        /* Contenedor para alinear 铆cono y texto */
        .fab-content {
            display: flex;
            align-items: center;
            gap: 5px; 
        }
        
        /* Estilo al presionar */
        .fab-main.active {
            transform: scale(1.05);
            background-color: #1f427d; 
        }

        .fab-options {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            margin-bottom: 15px;
            /* Animaci贸n para aparecer y desaparecer */
            transition: transform 0.3s ease, opacity 0.3s ease;
            transform: translateY(10px) scale(0.9);
            opacity: 0;
            pointer-events: none; /* Desactivado por defecto */
        }
        
        .fab-options.open {
            transform: translateY(0) scale(1);
            opacity: 1;
            pointer-events: auto; /* Activado al abrir */
        }

        .fab-option-btn {
            display: flex;
            align-items: center;
            background-color: var(--surface-white);
            color: var(--text-main);
            padding: 10px 15px;
            border-radius: 10px;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-md);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            margin-bottom: 10px;
            transition: background-color 0.2s;
        }

        .fab-option-btn i {
            margin-right: 8px;
            color: var(--primary-red);
        }
        /* === FIN ESTILOS BOTONES FLOTANTES === */


        /* VISTAS */
        .view-section {
            min-height: 100vh;
            display: none;
            background-color: var(--bg-body);
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* 1. LOGIN */
        #login-view { display: flex; flex-direction: column; background: var(--surface-white); }
        .login-header { 
            background: var(--surface-white);
            padding: 60px 20px 40px 20px; 
            text-align: center; 
        }
        .login-card { 
            background: var(--surface-white); 
            margin: 0 25px; 
            padding: 30px; 
            border-radius: 24px; 
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-lg); 
        }

        /* 2. REGISTRO */
        #register-view { background-color: var(--bg-body); position: relative; padding-bottom: 150px; }
        .reg-header { 
            background-color: var(--surface-white); 
            padding: 40px 20px 20px 20px; 
            display: flex; align-items: center; 
            border-bottom: 1px solid var(--border-light);
        }
        .reg-title { flex-grow: 1; text-align: center; font-size: 18px; font-weight: 600; margin-right: 24px; color: var(--text-main); }
        .back-btn { font-size: 22px; cursor: pointer; color: var(--text-main); }
        .reg-form-container { padding: 20px 25px; }
        
        .pill-input { 
            width: 100%; padding: 16px; border: 1px solid var(--border-light); border-radius: 12px; 
            box-sizing: border-box; font-size: 15px; margin-bottom: 15px; outline: none; 
            background: var(--surface-white); color: var(--text-main); font-family: inherit;
        }
        .pill-input:focus { border-color: var(--primary-blue); }

        .phone-group { display: flex; align-items: center; background: var(--surface-white); border: 1px solid var(--border-light); border-radius: 12px; padding: 6px 16px; margin-bottom: 15px; }
        .phone-input-field { border: none; outline: none; flex-grow: 1; font-size: 15px; margin-left: 10px; background: transparent; }
        
        .btn-register-red { 
            background-color: var(--primary-red); color: white; border: none; width: 100%; 
            padding: 16px; border-radius: 12px; font-size: 16px; font-weight: 600; 
            cursor: pointer; box-shadow: 0 4px 10px rgba(224, 43, 58, 0.2); margin-top: 10px; 
        }
        
        .bottom-curve-bg { display: none; }

        /* 3. HOME - FONDO AMARILLO SOLICITADO */
        .home-header { 
            background-color: var(--primary-yellow); /* CAMBIO AQU: Rojo a Amarillo */
            color: var(--text-main); /* Cambiamos el color de texto a oscuro para contraste */
            padding: 20px 20px 100px 20px; 
            position: relative; 
            clip-path: polygon(0 0, 100% 0, 100% 85%, 0 100%); 
            box-shadow: var(--shadow-md);
        }
        .home-top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .menu-icon { font-size: 24px; cursor: pointer; color: var(--text-main); } /* Ajuste de color del 铆cono */
        .page-title { font-size: 18px; font-weight: 500; }
        .greeting-text { font-size: 18px; font-weight: 400; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* CARD PUNTOS (AZUL Y GRIS CLARO) */
        .balance-card { 
            background: white; 
            margin: -80px 20px 20px 20px; 
            border-radius: 20px; 
            position: relative; 
            overflow: hidden; 
            box-shadow: var(--shadow-lg); 
            min-height: 210px; 
            z-index: 10; 
        }
        /* CAMBIO AQUI: AZUL y GRIS CLARO */
        .balance-card-bg { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(115deg, var(--primary-blue) 55%, #d1d5db 55.1%); 
            z-index: 1; 
        }
                .card-content { position: relative; z-index: 2; padding: 20px; color: white; min-height: 100%; box-sizing: border-box; }
        .card-brand { font-size: 12px; opacity: 0.9; margin-bottom: 10px; }
        .balance-label { font-size: 12px; font-weight: bold; margin-bottom: 5px; text-transform: uppercase; }
        .balance-amount { font-size: 36px; font-weight: bold; line-height: 1; }
        .balance-unit { font-size: 14px; margin-bottom: 0px; }
        .card-footer-text { font-size: 12px; opacity: 0.8; position: absolute; bottom: 65px; left: 20px; display: block; }
                .mascot-img { position: absolute; right: 15px; top: 50px; width: 110px; height: auto; z-index: 3; transform: none; }
        
        .btn-transfer { 
            background-color: var(--primary-red); color: white; border: 1px solid rgba(255,255,255,0.5); 
            border-radius: 25px; padding: 10px 0; font-weight: bold; font-size: 16px; 
            position: absolute; bottom: 15px; left: 5%; width: 90%; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; z-index: 5; 
        }

        /* --- PUBLICIDAD INFINITA (IMAGEN COMPLETA - COVER) --- */
        .ads-section { margin: 25px 20px 10px 20px; position: relative; overflow: hidden; border-radius: 16px; }
        .ads-slider-container { display: flex; overflow-x: scroll; gap: 15px; padding-bottom: 10px; scrollbar-width: none; scroll-behavior: auto; white-space: nowrap; }
        .ads-slider-container::-webkit-scrollbar { display: none; }
        
        .ad-slide { 
            flex: 0 0 100%; 
            height: 180px; 
            border-radius: 16px; 
            overflow: hidden; 
            box-shadow: var(--shadow-md); 
            position: relative; 
            cursor: pointer; 
            display: inline-block; 
            background-color: white;
        }
        
        .ad-image { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            display: block; 
        }

        .movements-section { padding: 0 20px; margin-top: 20px; }
        .mov-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .mov-title { font-weight: 600; color: var(--text-main); font-size: 16px; }
        .mov-link { color: var(--primary-blue); font-size: 14px; text-decoration: none; cursor: pointer; }
        .empty-state { text-align: center; margin-top: 50px; color: var(--text-secondary); font-size: 14px; }
        
        /* ESTILO: ITEM DE MOVIMIENTO */
        .movement-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-light);
        }
        .mov-icon-box {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 15px;
            font-size: 18px;
            color: white;
            flex-shrink: 0;
        }
        .mov-detail {
            flex-grow: 1;
        }
        .mov-title-detail {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-main);
            margin-bottom: 2px;
        }
        .mov-date {
            font-size: 12px;
            color: var(--text-secondary);
        }
        .mov-amount {
            font-weight: 700;
            font-size: 16px;
        }

        /* 4. CATLOGO & CENTROS & VALES (NUEVOS) */
        .catalog-header { 
            background-color: var(--surface-white); color: var(--text-main); padding: 15px 20px; 
            display: flex; align-items: center; justify-content: space-between; 
            box-shadow: var(--shadow-sm); position: sticky; top: 0; z-index: 50;
        }
        .catalog-title { font-size: 18px; font-weight: 600; }
        .bag-icon-wrapper { position: relative; cursor: pointer; }
        .bag-badge { position: absolute; top: -5px; right: -5px; background-color: var(--primary-red); color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 10px; display: flex; justify-content: center; align-items: center; }
        
        .center-card { background: var(--surface-white); padding: 20px; display: flex; justify-content: space-between; align-items: center; margin: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .center-info h3 { margin: 0; font-size: 16px; font-weight: bold; color: var(--text-main); }
        .center-info p { margin: 5px 0 0 0; font-size: 14px; color: #666; font-weight: 400; }
        .gas-btn { width: 45px; height: 45px; background-color: var(--primary-red); border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; font-size: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; }

        .products-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; padding: 20px; background-color: var(--bg-body); }
        .red-product-card { background-color: var(--surface-white); border-radius: 12px; padding: 12px; display: flex; flex-direction: column; color: var(--text-main); box-shadow: var(--shadow-sm); position: relative; border: 1px solid var(--border-light); }
        .prod-img-box { background-color: #f3f4f6; border-radius: 8px; height: 110px; display: flex; justify-content: center; align-items: center; margin-bottom: 10px; position: relative; }
        .prod-img-box img { max-width: 80%; max-height: 90%; object-fit: contain; }
        .cart-float-btn { position: absolute; top: 5px; right: 5px; width: 30px; height: 30px; border-radius: 50%; background-color: var(--primary-blue); color: white; display: flex; justify-content: center; align-items: center; font-size: 14px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .prod-title { font-size: 13px; font-weight: 600; text-transform: uppercase; color: var(--text-main); }
        .prod-desc { font-size: 11px; opacity: 0.7; color: var(--text-secondary); }
        .prod-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 5px; }
        .prod-price { font-size: 15px; font-weight: 700; color: var(--primary-blue); }
        .prod-disp { font-size: 11px; color: var(--text-secondary); }

        /* LISTAS - SOLUCIN PANTALLA BLANCA */
        .centers-list { 
            padding: 0; 
            background-color: var(--surface-white); 
            min-height: 100vh;
            color: var(--text-main) !important;
        }
        
        .station-item, .city-list-item { 
            background: var(--surface-white) !important; 
            padding: 15px 20px; 
            display: flex; 
            align-items: center; 
            cursor: pointer; 
            border-bottom: 1px solid var(--border-light); 
            margin-bottom: 0;
            color: var(--text-main) !important; 
        }
        .station-item:hover, .city-list-item:hover { background-color: #f9fafb !important; }
        
        .station-icon-simple, .city-icon { 
            color: var(--primary-blue); 
            font-size: 22px; 
            margin-right: 20px; 
            width: 40px; 
            height: 40px; 
            display:flex; 
            align-items:center; 
            justify-content:center; 
            background: #eef2ff; 
            border-radius: 10px; 
            flex-shrink: 0;
        }
        .station-text, .city-name { 
            font-size: 16px; 
            color: var(--text-main) !important; 
            font-weight: 500; 
            display: flex; 
            flex-direction: column; 
            flex-grow: 1;
        }
        .station-addr { 
            font-size: 13px; 
            color: #666666 !important; 
            margin-top: 3px; 
            font-weight: normal; 
        }

        /* ESTILO PARA CABECERA DE CIUDAD EN LISTA DE CENTROS */
        .city-separator {
            padding: 15px 20px;
            background-color: #f3f4f6; /* Fondo gris claro */
            font-size: 16px;
            font-weight: 700;
            color: var(--primary-blue);
            margin: 0;
            border-top: 1px solid var(--border-light);
            text-transform: uppercase;
        }

        /* VISTA UBICACIONES HEADER */
        .locations-header { 
            background-color: var(--surface-white); 
            padding: 15px 20px; 
            display: flex; align-items: center; gap: 15px; 
            color: var(--text-main); 
            box-shadow: var(--shadow-sm);
        }
        /* MODIFICADO: Estilo para el buscador en Centers View */
        .search-container { 
            padding: 10px 20px;
            background-color: var(--surface-white);
            border-bottom: 1px solid var(--border-light);
            position: sticky;
            top: 50px; /* Debajo del header fijo */
            z-index: 40;
        }
        .search-input { 
            width: 100%; 
            background: #f3f4f6; 
            border: none; 
            border-radius: 20px; 
            padding: 10px 20px; 
            color: var(--text-main); 
            font-size: 15px; 
            outline: none; 
        }
        .search-input::placeholder { color: #9ca3af; }


        /* 6. CARRITO */
        #cart-items-container { padding: 20px; padding-bottom: 200px; }
        .cart-item { display: flex; align-items: center; background: var(--surface-white); margin-bottom: 15px; padding: 15px; border-radius: 16px; box-shadow: var(--shadow-sm); }
        .cart-img { width: 60px; height: 60px; object-fit: contain; margin-right: 15px; background: #f9fafb; border-radius: 8px; }
        .cart-info { flex-grow: 1; }
        .cart-title { font-weight: 600; font-size: 14px; text-transform: uppercase; margin-bottom: 2px; color: var(--text-main); }
        .cart-price { font-weight: 700; font-size: 14px; color: var(--primary-blue); margin-bottom: 2px; }
        .cart-disp { font-size: 12px; color: var(--text-secondary); }
        .qty-controls { display: flex; align-items: center; gap: 10px; }
        .qty-btn { width: 28px; height: 28px; border-radius: 50%; background-color: #f3f4f6; color: var(--text-main); border: none; font-size: 16px; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .qty-num { font-size: 15px; font-weight: 600; width: 15px; text-align: center; }
        .cart-bottom-sheet { position: fixed; bottom: 0; left: 0; width: 100%; background-color: var(--surface-white); border-top-left-radius: 30px; border-top-right-radius: 30px; padding: 25px 30px; box-sizing: border-box; box-shadow: 0 -5px 30px rgba(0,0,0,0.05); z-index: 100; }
        .cart-summary-row { display: flex; justify-content: space-between; margin-bottom: 25px; padding: 0 10px; }
        .summary-col { text-align: center; }
        .summary-label { font-size: 14px; font-weight: 500; margin-bottom: 5px; color: var(--text-secondary); }
        .summary-val { font-size: 16px; font-weight: 600; color: var(--text-main); }
        .summary-total { font-size: 16px; color: var(--primary-red); font-weight: 700; }
        .btn-canjear-wide { width: 100%; background-color: var(--primary-red); color: white; border: none; padding: 15px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* 7. TRANSFER CODE */
        #transfer-code-view { flex-direction: column; background-color: var(--surface-white); }
        #transfer-code-view .transfer-content { flex-grow: 1; display: flex; flex-direction: column; align-items: center; padding: 60px 20px; text-align: center; }
        #transfer-code-view .shield-container { font-size: 100px; color: var(--primary-red); margin-bottom: 10px; }
        
        #transfer-code-view .code-pill { background-color: #f3f4f6; color: var(--text-main); width: 100%; max-width: 320px; padding: 20px; border-radius: 16px; font-size: 22px; font-weight: 700; letter-spacing: 4px; margin-bottom: 30px; box-shadow: none; border: 1px solid var(--border-light); }
        #transfer-code-view .copy-code-btn { background: none; border: none; color: var(--primary-blue); font-size: 16px; cursor: pointer; display: flex; align-items: center; gap: 8px; margin-bottom: auto; }
        #transfer-code-view .transfer-disclaimer { margin-bottom: 30px; font-size: 12px; color: var(--text-secondary); } /* Agregado margen inferior para el disclaimer */
        #transfer-code-view .btn-exit-red { background-color: var(--primary-red); color: white; border: none; width: 100%; max-width: 320px; padding: 15px; border-radius: 12px; font-size: 18px; font-weight: 600; cursor: pointer; }

        /* 8. VERIFICAR DESTINATARIO */
        #verify-view { flex-direction: column; background-color: var(--bg-body); min-height: 100vh; display: none; position: relative; }
        #verify-view .verify-content { flex-grow: 1; padding: 40px 30px; display: flex; flex-direction: column; align-items: center; text-align: center; }
        #verify-view .icon-card-wrapper { position: relative; margin-bottom: 30px; }
        #verify-view .red-id-card { background-color: var(--primary-red); width: 160px; height: 100px; border-radius: 12px; position: relative; display: flex; justify-content: flex-end; padding: 10px; box-sizing: border-box; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        #verify-view .search-user-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 80px; color: var(--primary-blue); background: white; border-radius: 50%; width: 80px; height: 80px; display: flex; justify-content: center; align-items: center; border: 4px solid var(--bg-body); z-index: 10; }
        #verify-view .input-verify-wrapper { width: 100%; margin-bottom: 5px; position: relative; }
        #verify-view .input-verify-label { position: absolute; top: -10px; left: 15px; background: var(--bg-body); padding: 0 5px; font-size: 12px; color: var(--text-secondary); font-weight: 500; }
        #verify-view .input-verify { width: 100%; padding: 15px; border: 1px solid var(--primary-blue); border-radius: 12px; background: transparent; font-size: 16px; box-sizing: border-box; outline: none; color: var(--text-main); }
        #verify-view .btn-verify-red { background-color: var(--primary-red); color: white; border: none; width: 100%; padding: 15px; border-radius: 12px; font-size: 16px; font-weight: 500; cursor: pointer; box-shadow: 0 4px 10px rgba(224, 43, 58, 0.3); }

        /* 9. ADMIN */
        .admin-tabs { display: flex; background: var(--surface-white); border-bottom: 1px solid var(--border-light); overflow-x: auto; }
        .admin-tab { flex: 1; padding: 15px; text-align: center; font-weight: 600; color: var(--text-secondary); cursor: pointer; border-bottom: 3px solid transparent; min-width: 80px; font-size: 14px; }
        .admin-tab.active { color: var(--primary-blue); border-bottom-color: var(--primary-blue); }
        .admin-content { padding: 20px; }
        .admin-card { background: var(--surface-white); padding: 20px; border-radius: 16px; box-shadow: var(--shadow-sm); margin-bottom: 20px; border: 1px solid var(--border-light); }
        .admin-form input, .admin-form select, .admin-form textarea { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid var(--border-light); border-radius: 8px; box-sizing: border-box; background: #fcfcfc; font-family: inherit; }
        .admin-btn { background: var(--primary-blue); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: 600; }
        
                .admin-list-item-new { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; /* Cambiado a flex-start en el JS para la vista de usuarios */
            background: var(--surface-white); 
            padding: 10px 15px; 
            margin-bottom: 8px; 
            border-radius: 12px; 
            border: 1px solid var(--border-light); 
        }

        /* Nuevo estilo para la lista de productos del admin */
        .admin-product-item, .admin-voucher-item {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }
        .admin-product-thumb, .admin-voucher-thumb {
            width: 40px;
            height: 40px;
            object-fit: contain;
            border-radius: 4px;
            margin-right: 10px;
            background: #f3f4f6;
        }
        .admin-product-info, .admin-voucher-info {
            flex-grow: 1;
            font-size: 14px;
        }
        .admin-product-info b, .admin-voucher-info b {
            font-size: 15px;
        }
        .admin-actions-group {
            display: flex;
            gap: 5px;
        }
        .admin-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 5px;
        }

        /* SIDEBAR, NAV, MODALS */
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; opacity: 0; transition: opacity 0.3s ease; }
        .sidebar { position: fixed; top: 0; left: -100%; width: 80%; max-width: 300px; height: 100%; background-color: var(--surface-white); color: var(--text-main); z-index: 1001; transition: left 0.3s ease; display: flex; flex-direction: column; }
        .sidebar.open { left: 0; }
        .sidebar-overlay.open { display: block; opacity: 1; }
        .sidebar-header { padding: 40px 20px 30px 20px; display: flex; align-items: center; background: #f9fafb; border-bottom: 1px solid var(--border-light); }
        .sidebar-avatar { width: 60px; height: 60px; background: white; border-radius: 50%; padding: 5px; margin-right: 15px; border: 2px solid var(--primary-red); display: flex; justify-content: center; align-items: center; }
        .sidebar-avatar img { width: 40px; height: auto; }
        .sidebar-user-info h3 { margin: 0; font-size: 16px; font-weight: 600; text-transform: uppercase; color: var(--text-main); }
        .sidebar-user-info p { margin: 5px 0 0 0; font-size: 13px; color: var(--text-secondary); }
        .sidebar-menu { flex-grow: 1; padding: 20px 0; overflow-y: auto; }
        .menu-item { display: flex; align-items: center; padding: 15px 25px; color: var(--text-main); text-decoration: none; font-size: 15px; transition: background 0.2s; cursor: pointer; font-weight: 500; }
        .menu-item:hover { background: #f3f4f6; }
        .menu-item i { width: 25px; color: var(--primary-blue); margin-right: 15px; font-size: 18px; }
        .menu-item.logout { margin-top: auto; color: var(--primary-red); }
        .menu-item.logout i { color: var(--primary-red); }

        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--surface-white); display: flex; justify-content: space-around; align-items: center; padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 100; border-top: 1px solid var(--border-light); }
        .nav-item { background: none; border: none; cursor: pointer; color: #9ca3af; font-size: 20px; display: flex; flex-direction: column; align-items: center; transition: color 0.2s; }
        .nav-item.active { color: var(--primary-red); }
        .qr-btn-wrapper { background-color: var(--primary-blue); width: 55px; height: 55px; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-top: -30px; box-shadow: 0 4px 10px rgba(44, 90, 160, 0.4); border: 4px solid var(--bg-body); cursor: pointer; transition: transform 0.2s; }
        .qr-btn-wrapper i { color: white; font-size: 24px; }

        .modal { display: none; position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .modal-content { background: var(--surface-white); margin: 15% auto; padding: 25px; width: 85%; max-width: 400px; border-radius: 20px; position: relative; box-shadow: var(--shadow-md); }
        .close-icon { position: absolute; right: 20px; top: 15px; font-size: 24px; cursor: pointer; color: var(--text-main); }
        
        #ad-detail-view { background: var(--bg-body); z-index: 2000; }
        .ad-detail-hero-img { width: 100%; height: 250px; object-fit: cover; }
                .ad-detail-content { 
            padding: 20px; 
            background: var(--bg-body); /* CAMBIO: Usamos el mismo color del fondo de la app */
            border-top-left-radius: 0; /* ELIMINADO: Quita el borde redondeado */
            border-top-right-radius: 0; /* ELIMINADO: Quita el borde redondeado */
            margin-top: 0; /* ELIMINADO: Quita el efecto de solapamiento (el corte) */
            position: relative; 
            min-height: 50vh; 
        }
        .ad-detail-title { color: var(--primary-red); font-size: 20px; font-weight: bold; margin-bottom: 10px; line-height: 1.3; }
        .ad-detail-date { color: var(--primary-red); font-size: 13px; margin-bottom: 20px; font-weight: 600; }
        .ad-detail-desc { color: var(--text-main); font-size: 15px; line-height: 1.6; white-space: pre-wrap; }

        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg-body); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .spinner { border: 4px solid #e5e7eb; border-top: 4px solid var(--primary-blue); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
                /* --- ESTILOS NUEVOS PARA EL QR PERSONAL --- */
        #personal-qr-modal .modal-content {
            overflow: visible; /* Permite que la X salga del cuadro */
            text-align: center;
            padding-top: 40px;
            border-radius: 20px;
        }

        .close-btn-float {
            position: absolute;
            top: -15px;
            right: -15px;
            background-color: var(--primary-red);
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            border: 3px solid var(--surface-white);
            z-index: 10;
        }

        .qr-timer-text {
            font-size: 18px; 
            font-weight: 700; 
            color: #000; 
            margin-bottom: 20px;
            text-transform: uppercase;
        }

        #personal-qr-display {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 10px auto;
            padding: 10px;
            background: white;
        }
        
        /* ESTILOS PARA EL NUEVO MODAL DE ALERTA */
        #custom-alert-modal .modal-content {
            padding: 40px 25px 25px 25px;
            text-align: center;
        }
        .custom-alert-icon {
            font-size: 48px;
            color: var(--primary-blue);
            margin-bottom: 15px;
        }
        .custom-alert-message {
            font-size: 16px;
            color: var(--text-main);
            margin-bottom: 25px;
            font-weight: 500;
        }
        .btn-alert-ok {
            background-color: var(--primary-red);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }


        /* --- ESTILOS ESPECFICOS PARA VALES --- */
        #vouchers-view .red-voucher-card {
            background-color: var(--surface-white); 
            border-radius: 12px; 
            padding: 12px; 
            display: flex; 
            flex-direction: column; 
            color: var(--text-main); 
            box-shadow: var(--shadow-sm); 
            position: relative; 
            border: 1px solid var(--border-light);
            text-align: center;
        }

        .voucher-image-container {
            height: 120px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
            background-color: #fef2f2; /* Light Red/Pink Background */
            border-radius: 8px;
            overflow: hidden;
        }

        .voucher-image-container img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .voucher-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary-red);
            margin-bottom: 5px;
        }

        .voucher-description {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            height: 30px;
            overflow: hidden;
        }

        .voucher-price-btn {
            background-color: var(--primary-blue);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.2s;
        }

        .voucher-price-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

    </style>
</head>
<body>

    <div id="loading-overlay"><div class="spinner"></div></div>

    <div id="login-view" class="view-section">
        <div class="login-header">
            <img src="https://i.postimg.cc/3W5Sj9KD/1759816774563.png" style="width: 80px; border-radius:50%; background:white; padding:5px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
            <h2 style="margin: 20px 0 5px 0; color: var(--text-main);">Bienvenido</h2>
            <p style="margin: 0; color: var(--text-secondary);">Lealtad Revolution Wax</p>
        </div>
        <div class="login-card">
            <h3 style="text-align:center; color: var(--primary-blue); margin-bottom: 20px;">Iniciar Sesi贸n</h3>
            <form id="login-form">
                <input type="email" id="login-email" class="pill-input" placeholder="Correo electr贸nico" required>
                <input type="password" id="login-pass" class="pill-input" placeholder="Contrase帽a" required>
                <p id="login-error" style="color:red; display:none; text-align:center; font-size:14px;"></p>
                <button type="submit" class="btn-register-red" style="background:var(--primary-blue);">ENTRAR</button>
            </form>
            <div style="text-align: center; margin-top: 20px;">
            <button onclick="goToRegister()" style="background:none; border:none; color: var(--text-secondary); cursor:pointer;">驴No tienes cuenta? <span style="color:var(--primary-blue); font-weight:600;">Reg铆strate</span></button>
            <br><br>
            <button onclick="forgotPassword()" style="background:none; border:none; color: #999; cursor:pointer; font-size:13px;">Olvid茅 mi contrase帽a</button>
            
            <br><br> 
            <button onclick="window.open('https://www.mediafire.com/file/2m7y1kb06q1a8he/RevolutionWaxPuntos.apk/file', '_blank')" 
                style="background:var(--primary-red); color:white; border:none; width:80%; padding:10px; border-radius:12px; font-size:14px; font-weight:600; cursor:pointer; box-shadow: 0 4px 10px rgba(224, 43, 58, 0.2); transition: all 0.2s ease;">
                <i class="fab fa-android" style="margin-right: 5px;"></i> Descargar Aplicaci贸n Android
            </button>
            </div>
    </div>
</div>


    <div id="register-view" class="view-section">
        <div class="reg-header">
            <i class="fas fa-arrow-left back-btn" onclick="goToLogin()"></i>
            <div class="reg-title">Registro</div>
        </div>
        <div class="reg-form-container">
            <form id="register-form">
                <input type="text" id="reg-name" class="pill-input" placeholder="Nombre completo" required>
                <div class="phone-group">
                    <img src="https://flagcdn.com/w20/mx.png" alt="MX" style="width:20px;">
                    <span style="font-weight:bold; margin-left:5px; color:#555;">+52</span>
                    <input type="tel" id="reg-phone" class="phone-input-field" placeholder="N煤mero celular" required maxlength="10">
                    <span style="font-size:12px; color:#999;">0/10</span>
                </div>
                <input type="email" id="reg-email" class="pill-input" placeholder="Correo electr贸nico" required>
                <input type="password" id="reg-pass" class="pill-input" placeholder="Contrase帽a" required minlength="6">
                <input type="text" id="reg-dob" class="pill-input" placeholder="Fecha de Nacimiento (DD/MM/AAAA)" onfocus="(this.type='date')" onblur="(this.type='text')">
                <input type="text" id="reg-city" class="pill-input" placeholder="Ciudad">
                
                <div style="display:flex; justify-content:space-around; margin:15px 0; color:#666;">
                    <label><input type="radio" name="gender" value="Masculino"> Masculino</label>
                    <label><input type="radio" name="gender" value="Femenino"> Femenino</label>
                    <label><input type="radio" name="gender" value="Otro"> Otro</label>
                </div>

                <p id="reg-error" style="color:red; display:none; text-align:center; font-size:14px;"></p>
                <button type="submit" class="btn-register-red">Registrarme</button>
            </form>
        </div>
    </div>

    <div id="app-view" class="view-section">
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-avatar">
                    <img src="https://i.postimg.cc/3W5Sj9KD/1759816774563.png" alt="Avatar">
                </div>
                <div class="sidebar-user-info">
                    <h3 id="sidebar-name">USUARIO</h3>
                    <p id="sidebar-phone">+52 000 000 0000</p>
                </div>
            </div>
            <div class="sidebar-divider"></div>
            <div class="sidebar-menu">
                <div id="admin-menu-item" class="menu-item hidden" onclick="goToAdmin()">
                    <i class="fas fa-user-shield" style="color:#fbbf24;"></i> Panel Administrador
                </div>
                
                <div class="menu-item" onclick="startCatalogFlow()"><i class="fas fa-desktop"></i> Cat谩logo de productos</div>
                <div class="menu-item" onclick="goToVouchers()"><i class="fas fa-gift"></i> Vales de Gasolina</div> 
                
                <div class="menu-item" onclick="goToLocations()"><i class="fas fa-map-marker-alt"></i> Ubicaciones</div>
                
                <div class="menu-item" onclick="window.open('https://revolutionwax.pages.dev/Index', '_blank')"><i class="fas fa-shopping-cart"></i> Comprar</div>
                
                <div class="menu-item" onclick="goToMovementsHistory()"><i class="fas fa-list-ul"></i> Movimientos</div>
                <div class="menu-item" onclick="openProfileModal()"><i class="fas fa-user"></i> Perfil</div>
                <div class="menu-item" onclick="showCustomAlert('癸 No hay avisos nuevos')"><i class="fas fa-info-circle"></i> Avisos</div>
                
                <div class="menu-item" onclick="window.open('https://wa.me/524499328985', '_system')"><i class="fas fa-headset"></i> Soporte</div>
                
                <div class="menu-item logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Cerrar sesi贸n</div>
            </div>
        </div>

        <div class="home-header">
            <div class="home-top-bar">
                <i class="fas fa-bars menu-icon" onclick="openSidebar()"></i>
                <div class="page-title">Inicio</div>
                <div style="width:24px;"></div> 
            </div>
            <div class="greeting-text">Hola, <span id="user-name-display">USUARIO</span></div>
        </div>

        <div class="balance-card">
            <div class="balance-card-bg"></div>
            <div class="card-content">
                                <div class="card-brand">Revolution Wax Puntos</div>
                <div style="text-align: center; margin-top: 25px;"> <div class="balance-label">SALDO DISPONIBLE</div>
                    <div class="balance-amount" id="saldo-amount">0.00</div>
                    <div class="balance-unit">Puntos</div>
                </div>
                <img src="https://i.postimg.cc/3W5Sj9KD/1759816774563.png" class="mascot-img" alt="Mascota">
            </div>
            <button class="btn-transfer" onclick="openVerifyView()">Transferir puntos</button>
        </div>

        <div id="ads-carousel-container" class="ads-section hidden">
             <div class="ads-slider-container" id="ads-track-content">
                 </div>
        </div>

        <div class="movements-section">
            <div class="mov-header">
                <div class="mov-title">ltimos movimientos</div>
                <div class="mov-link" onclick="goToMovementsHistory()">Ver todos</div>
            </div>
            <div id="recent-movements-container">
                <div class="empty-state">Cargando movimientos...</div>
            </div>
        </div>

        <div class="bottom-nav">
            <button class="nav-item" onclick="window.open('https://www.facebook.com/RevolutionWaxRW', '_blank')"><i class="fab fa-facebook"></i></button>
            <button class="nav-item" onclick="startCatalogFlow()"><i class="fas fa-gas-pump"></i></button>
            <div class="qr-btn-wrapper" onclick="openPersonalQR()"><i class="fas fa-qrcode"></i></div>
            
            <button class="nav-item" onclick="openTransferCode()"><i class="fas fa-shield-alt"></i></button>
            
            <button class="nav-item" onclick="openProfileModal()"><i class="fas fa-user"></i></button>
        </div>
    </div>

    <div id="ad-detail-view" class="view-section">
        <div class="locations-header">
            <i class="fas fa-arrow-left" style="font-size:20px; cursor:pointer;" onclick="goToApp()"></i>
            <div style="flex-grow:1; text-align:center; font-size:18px;">Publicidad</div>
            <div style="width:20px;"></div>
        </div>
        <img id="ad-detail-img" class="ad-detail-hero-img" src="">
        <div class="ad-detail-content">
            <div id="ad-detail-title" class="ad-detail-title"></div>
            <div id="ad-detail-date" class="ad-detail-date">Sin fecha de vigencia</div>
            <div id="ad-detail-desc" class="ad-detail-desc"></div>
        </div>
    </div>

    <div id="movements-history-view" class="view-section">
        <div class="catalog-header">
            <i class="fas fa-arrow-left" style="color:var(--text-main); font-size:20px; cursor:pointer;" onclick="goToApp()"></i>
            <div class="catalog-title">Historial de Movimientos</div>
            <div style="width:20px;"></div>
        </div>
        <div style="padding: 20px;">
            <p style="font-size: 14px; color: var(--text-secondary);">Detalle de todas tus transacciones.</p>
            <div id="full-movements-container">
                 <div class="empty-state">Cargando historial completo...</div>
            </div>
        </div>
    </div>
    <div id="catalog-view" class="view-section">
        <div class="catalog-header">
            <i class="fas fa-arrow-left" style="color:var(--text-main); font-size:20px; cursor:pointer;" onclick="goToCenters()"></i>
            <div class="catalog-title">Cat谩logo de productos</div>
            <div class="bag-icon-wrapper" onclick="openCart('products')">
                <i class="fas fa-shopping-bag" style="color:var(--text-main); font-size:20px;"></i>
                <div class="bag-badge" id="cart-count">0</div>
            </div>
        </div>
        <div class="center-card">
            <div class="center-info">
                <h3>Centro de canje</h3>
                <p id="selected-center-label">Seleccione un centro de canje</p>
            </div>
            <div class="gas-btn" onclick="goToCenters()">
                <i class="fas fa-gas-pump"></i>
            </div>
        </div>
        <div id="catalog-grid" class="products-grid"></div>
    </div>

    <div id="vouchers-view" class="view-section">
        <div class="catalog-header">
            <i class="fas fa-arrow-left" style="color:var(--text-main); font-size:20px; cursor:pointer;" onclick="goToApp()"></i>
            <div class="catalog-title">Vales de Gasolina</div>
            <div class="bag-icon-wrapper" onclick="openCart('vouchers')">
                <i class="fas fa-tags" style="color:var(--primary-red); font-size:20px;"></i>
                <div class="bag-badge" id="vouchers-cart-count">0</div>
            </div>
        </div>
        <div class="center-card">
            <div class="center-info">
                <h3>Canje de Vales</h3>
                <p id="vouchers-info">Seleccione el valor de su vale</p>
            </div>
            <div class="gas-btn" style="background-color: var(--primary-blue);">
                <i class="fas fa-gas-pump"></i>
            </div>
        </div>
        <div id="vouchers-grid" class="products-grid">
            </div>
    </div>


    <div id="centers-view" class="view-section">
        <div class="catalog-header">
            <i class="fas fa-arrow-left" style="color:var(--text-main); font-size:20px; cursor:pointer;" onclick="goToApp()"></i>
            <div class="catalog-title">Buscar centro de distribuci贸n</div>
            <div style="color:var(--text-main); cursor:pointer;" onclick="goToApp()"><i class="fas fa-times"></i></div>
        </div>
        
        <div class="search-container">
            <input type="text" id="center-search-input" class="search-input" placeholder="Buscar gasolinera o punto de canje" onkeyup="filterCenters()">
        </div>
        
        <div class="centers-list" id="centers-list-container">
             </div>
    </div>

    <div id="cart-view" class="view-section">
        <div class="catalog-header">
            <i class="fas fa-arrow-left" style="color:var(--text-main); font-size:20px; cursor:pointer;" onclick="closeCart()"></i>
            <div class="catalog-title" id="cart-title-display">Carrito de productos</div>
            <div style="width:20px;"></div>
        </div>
        <div id="cart-items-container"></div>
        <div class="cart-bottom-sheet">
            <div class="cart-summary-row">
                <div class="summary-col">
                    <div class="summary-label">Disponible:</div>
                    <div class="summary-val" id="cart-balance-display">0.00</div>
                </div>
                <div class="summary-col">
                    <div class="summary-label">Total:</div>
                    <div class="summary-total" id="cart-total-display">0.00</div>
                </div>
            </div>
            <button class="btn-canjear-wide" onclick="processCheckout()">Canjear</button>
        </div>
    </div>

    <div id="transfer-code-view" class="view-section" style="flex-direction:column;">
        <div class="catalog-header">
            <i class="fas fa-arrow-left" style="color:var(--text-main); font-size:20px; cursor:pointer;" onclick="goToApp()"></i>
            <div class="catalog-title">C贸digo de transferencia</div>
            <div style="width:20px;"></div>
        </div>
        <div class="transfer-content">
            <div class="shield-container"><i class="fas fa-shield-alt"></i></div>
            <p class="transfer-instruction">Tu c贸digo de seguridad para transferencia es:</p>
            <div class="code-pill"><span id="transfer-code-display">0 9 1 7 6 6 8 7 8 5 5</span></div>
            <button class="copy-code-btn" onclick="copyCode()"><i class="far fa-copy"></i> Copiar codigo</button>
            <p class="transfer-disclaimer">Este c贸digo funge 煤nicamente como identificador para recibir transferencia de puntos</p>
            <button class="btn-exit-red" onclick="goToApp()">Salir</button>
        </div>
    </div>

        <div id="verify-view" class="view-section" style="flex-direction:column;">
        <div class="catalog-header">
            <i class="fas fa-arrow-left" style="color:var(--text-main); font-size:20px; cursor:pointer;" onclick="exitVerifyView()"></i>
            <div class="catalog-title">Verificar destinatario</div>
            <div style="width:20px;"></div>
        </div>
        <div class="verify-content">
            <div class="icon-card-wrapper">
                <div class="red-id-card">
                    <div class="card-lines">
                        <div class="line long"></div>
                        <div class="line long"></div>
                        <div class="line short"></div>
                        <div class="line short"></div>
                        <div class="line long"></div>
                    </div>
                </div>
                <div class="search-user-icon" id="verify-icon-status">
                    <i class="fas fa-user"></i>
                </div>
            </div>

            <p class="verify-instruction" id="verify-instruction-text">
                Introduce el c贸digo proporcionado por el destinatario para verificar su informaci贸n
            </p>

            <div id="step-verify-user">
                <div class="input-verify-wrapper">
                    <span class="input-verify-label">C贸digo del destinatario</span>
                    <input type="text" id="input-dest-code" class="input-verify" placeholder="Ej: 1234567890">
                    <i class="fas fa-address-card icon-input-right"></i>
                </div>
                <button class="btn-verify-red" onclick="verifyRecipientUser()">Verificar Usuario</button>
            </div>
            
            <div id="step-transfer-amount" class="hidden" style="width: 100%; margin-top: 20px;">
                <h3 style="color:var(--primary-blue); margin-bottom: 5px;" id="dest-name-display">Usuario Encontrado</h3>
                <p style="color:green; font-size:14px; margin-bottom: 15px;">Usuario verificado correctamente</p>
                
                <div class="input-verify-wrapper">
                    <span class="input-verify-label">Puntos a transferir</span>
                    <input type="number" id="input-transfer-amount" class="input-verify" placeholder="0.00">
                    <i class="fas fa-coins icon-input-right"></i>
                </div>
                
                <button class="btn-verify-red" onclick="executeTransfer()" style="background-color: var(--primary-blue); margin-top: 15px;">
                    CONFIRMAR ENVO
                </button>
                <button onclick="resetTransferView()" style="background:none; border:none; color:#666; margin-top:15px; cursor:pointer; width:100%;">Cancelar operaci贸n</button>
            </div>
        </div>
        
        <div class="bottom-curve-bg" style="position:absolute; bottom:0; width:100%; height:100px; background-color:var(--primary-red); border-top-left-radius:100%; border-top-right-radius:100%; z-index:-1;"></div>
    </div>

            <div id="locations-view" class="view-section">
        <div class="locations-header">
            <i class="fas fa-arrow-left" style="font-size:20px; cursor:pointer; color:var(--text-main);" onclick="backFromLocations()"></i>
            
            <div style="flex-grow: 1;">
                <input type="text" id="city-search-input" class="search-input" placeholder="Buscar estado" onkeyup="filterCities()">
            </div>
            
            <i class="fas fa-times" style="font-size:20px; cursor:pointer; color:var(--text-main);" onclick="goToApp()"></i>
        </div>

        <div id="loc-cities-container"></div>
        <div id="loc-stations-container" class="hidden"></div>
    </div>
    
    <div id="admin-view" class="view-section">
        <div class="catalog-header">
            <i class="fas fa-arrow-left" style="color:var(--text-main); font-size:20px; cursor:pointer;" onclick="goToApp()"></i>
            <div class="catalog-title">Panel Administrador</div>
                    <div style="padding: 10px 20px; text-align:center;">
            <button class="btn-register-red" onclick="openScanner()" style="background: #333; display:flex; justify-content:center; align-items:center; gap:10px;">
                <i class="fas fa-camera"></i> ESCANEAR CLIENTE (ADMIN)
            </button>
        </div>
            <div style="width:20px;"></div>
        </div>
        <div class="admin-tabs">
            <div class="admin-tab" onclick="switchAdminTab('cities', this)">Ciudades</div>
            <div class="admin-tab active" onclick="switchAdminTab('centers', this)">Centros</div>
            <div class="admin-tab" onclick="switchAdminTab('products', this)">Productos</div>
            <div class="admin-tab" onclick="switchAdminTab('vouchers', this)">Vales</div>
            <div class="admin-tab" onclick="switchAdminTab('ads', this)">Publicidad</div>
            <div class="admin-tab" onclick="switchAdminTab('users', this)">Usuarios</div>
        </div>
        
        <div id="admin-tab-cities" class="admin-content hidden">
            <div class="admin-card">
                <h3>Agregar Ciudad / Estado</h3>
                <div class="admin-form">
                    <input type="text" id="admin-city-name" placeholder="Nombre (Ej: HIDALGO)">
                    <button class="admin-btn" onclick="adminAddCity()">Guardar Ciudad</button>
                </div>
            </div>
            <h3>Ciudades Registradas</h3>
            <div id="admin-cities-list"></div>
        </div>

        <div id="admin-tab-centers" class="admin-content">
            <div class="admin-card">
                <h3>Agregar Gasolinera</h3>
                <div class="admin-form">
                    <label style="font-size:12px; color:#666;">Selecciona la ciudad:</label>
                    <select id="admin-center-city-select" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; margin-bottom:10px;"></select>
                    
                    <input type="text" id="admin-center-name" placeholder="Nombre de la Gasolinera">
                    <input type="text" id="admin-center-address" placeholder="Direcci贸n">
                    <button class="admin-btn" onclick="adminAddCenter()">Guardar Centro</button>
                </div>
            </div>
            <h3>Gasolineras Registradas</h3>
            <div id="admin-centers-list"></div>
        </div>

                <div id="admin-tab-products" class="admin-content hidden">
            <div class="admin-card">
                <h3>Agregar Producto Global</h3>
                <div class="admin-form">
                    <input type="text" id="admin-prod-name" placeholder="Nombre del Producto">
                    <input type="number" id="admin-prod-cost" placeholder="Costo en Puntos">
                    <input type="text" id="admin-prod-img" placeholder="URL Imagen">
                    <input type="text" id="admin-prod-disp" placeholder="Disponibilidad (ej: 5)">
                    <button class="admin-btn" onclick="adminAddProduct()">Guardar Producto</button>
                </div>
            </div>
            <h3>Productos Registrados (Global)</h3>
            <div id="admin-products-list"></div>
        </div>
        
        <div id="admin-tab-vouchers" class="admin-content hidden">
            <div class="admin-card">
                <h3>Agregar Vale de Gasolina</h3>
                <div class="admin-form">
                    <input type="text" id="admin-voucher-title" placeholder="T铆tulo (Ej: Vale $100 Gasolina)">
                    <input type="text" id="admin-voucher-desc" placeholder="Descripci贸n breve (Ej: Canjeable por 5 Litros)">
                    <input type="number" id="admin-voucher-cost" placeholder="Costo en Puntos (Ej: 200)">
                    <input type="text" id="admin-voucher-img" placeholder="URL Imagen (Icono de Vale/Gasolina)">
                    <button class="admin-btn" onclick="adminAddVoucher()">Guardar Vale</button>
                </div>
            </div>
            <h3>Vales de Gasolina Activos</h3>
            <div id="admin-vouchers-list"></div>
        </div>


        <div id="admin-tab-ads" class="admin-content hidden">
            <div class="admin-card">
                <h3>Agregar Publicidad</h3>
                <div class="admin-form">
                    <input type="text" id="admin-ad-img-url" placeholder="URL de la imagen (Banner)">
                    <input type="text" id="admin-ad-title" placeholder="T铆tulo (Destacado Rojo)">
                    <textarea id="admin-ad-desc" placeholder="Descripci贸n detallada..." rows="4"></textarea>
                    <button class="admin-btn" onclick="adminAddAd()">Agregar Publicidad</button>
                </div>
            </div>
            <h3>Publicidad Activa</h3>
            <div id="admin-ads-list"></div>
        </div>

        <div id="admin-tab-users" class="admin-content hidden">
            <h3>Usuarios Registrados</h3>
            <div id="admin-users-list"></div>
        </div>
    </div>
    
    <div id="edit-product-modal" class="modal">
        <div class="modal-content">
            <span class="close-icon" onclick="closeModal('edit-product-modal')">&times;</span>
            <h3 style="color:var(--primary-blue); text-align:center;">Editar Producto</h3>
            <div style="text-align: center; margin-bottom: 15px;">
                <img id="edit-prod-current-img" style="width: 80px; height: 80px; object-fit: contain; background: #f3f4f6; border-radius: 8px;">
            </div>
            <div class="admin-form">
                <input type="text" id="edit-prod-name" placeholder="Nombre del Producto">
                <input type="number" id="edit-prod-cost" placeholder="Costo en Puntos">
                <input type="text" id="edit-prod-img" placeholder="URL Imagen">
                <input type="text" id="edit-prod-disp" placeholder="Disponibilidad (ej: 5)">
                <button class="admin-btn" onclick="adminSaveEditedProduct()">Guardar Cambios</button>
            </div>
        </div>
    </div>
    
    <div id="edit-voucher-modal" class="modal">
        <div class="modal-content">
            <span class="close-icon" onclick="closeModal('edit-voucher-modal')">&times;</span>
            <h3 style="color:var(--primary-red); text-align:center;">Editar Vale de Gasolina</h3>
            <div style="text-align: center; margin-bottom: 15px;">
                <img id="edit-voucher-current-img" style="width: 80px; height: 80px; object-fit: contain; background: #fef2f2; border-radius: 8px;">
            </div>
            <div class="admin-form">
                <input type="text" id="edit-voucher-title" placeholder="T铆tulo del Vale">
                <input type="text" id="edit-voucher-desc" placeholder="Descripci贸n breve">
                <input type="number" id="edit-voucher-cost" placeholder="Costo en Puntos">
                <input type="text" id="edit-voucher-img" placeholder="URL Imagen">
                <button class="admin-btn" onclick="adminSaveEditedVoucher()" style="background-color: var(--primary-red);">Guardar Cambios</button>
            </div>
        </div>
    </div>
    
    <div id="edit-center-modal" class="modal">
    <div class="modal-content">
        <span class="close-icon" onclick="closeModal('edit-center-modal')">&times;</span>
        <h3 style="color:var(--primary-blue); text-align:center;">Editar Gasolinera</h3>
        
        <input type="hidden" id="edit-center-id">
        
        <div class="admin-form">
            <label style="font-size:12px; color:#666;">Selecciona la ciudad:</label>
            <select id="edit-center-city-select" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; margin-bottom:10px;"></select>
            
            <input type="text" id="edit-center-name" placeholder="Nombre de la Gasolinera">
            <input type="text" id="edit-center-address" placeholder="Direcci贸n">
            
            <button class="admin-btn" onclick="adminSaveEditedCenter()" style="margin-top: 15px;">Guardar Cambios</button>
        </div>
    </div>
</div>


        <div id="personal-qr-modal" class="modal">
        <div class="modal-content">
            <div class="close-btn-float" onclick="closeModal('personal-qr-modal')">&times;</div>
            
            <h3 style="font-size: 24px; font-weight: 800; margin: 0 0 10px 0; color:black; text-transform: uppercase;">QR PERSONAL</h3>
            
            <div class="qr-timer-text">
                QR expira en <span id="qr-timer-countdown" style="color:black;">5:00</span> min
            </div>

            <div id="personal-qr-display"></div>

            <p style="font-size: 13px; color: #555; margin-top: 20px; line-height: 1.4;">
                Recuerda mostrar tu QR personal al Asesor al momento de tu compra para registrar tu recompensa y empieces a acomular puntos.
            </p>
        </div>
    </div>
    
    <div id="scanner-modal" class="modal">
        <div class="modal-content">
            <span class="close-icon" onclick="closeModal('scanner-modal')">&times;</span> 
            
            <h3 style="color:#2c5aa0; text-align:center;">Escanear Cliente</h3>
            
            <div id="qr-reader" style="width:100%; min-height: 250px;"></div>
            
            <p id="scan-status" style="text-align:center; font-size:12px; margin-top:10px;">Cargando c谩mara...</p>
        </div>
    </div>

<div id="add-points-modal" class="modal">
        <div class="modal-content">
            <h3 style="color:#2c5aa0; text-align:center;">Escanear Cliente</h3>
            
            <div style="padding: 10px 0; text-align: center; font-size: 16px;">
                <p style="margin: 5px 0 15px 0;">
                    <i class="fas fa-user-circle" style="color: #2c5aa0; margin-right: 5px;"></i> 
                    **CLIENTE DETECTADO:** <span id="modal-client-name" style="font-weight: 700;">--</span>
                </p>
                <p style="margin: 15px 0 5px 0;">
                    <i class="fas fa-coins" style="color: #848482; margin-right: 5px;"></i> 
                    Ingresa la cantidad de puntos a sumar:
                </p>
                
                <input type="number" id="modal-points-input" class="pill-input" placeholder="0.00" style="width: 80%; margin: 10px auto; text-align: center; font-size: 18px;">
            </div>
            
            <div style="display: flex; justify-content: space-around; margin-top: 20px;">
                <button class="btn-register-red" onclick="closeModal('add-points-modal')" style="background:#ccc; width:45%;">
                    Cancelar
                </button>
                <button class="btn-register-red" onclick="confirmPointAddition()" style="background:var(--primary-blue); width:45%;">
                    Aceptar
                </button>
            </div>
        </div>
    </div>
<div id="profile-modal" class="modal">
        <div class="modal-content">
            <span class="close-icon" onclick="closeModal('profile-modal')">&times;</span>
            <h3 style="color:var(--primary-blue); text-align:center;">Mi Perfil</h3>
            <div style="text-align:center; margin-bottom:20px;">
                <img src="https://i.postimg.cc/3W5Sj9KD/1759816774563.png" style="width:80px; height:80px; border-radius:50%; border:2px solid var(--primary-blue); padding:5px;">
            </div>
            <div id="profile-details" style="font-size:14px; color:#333;">
                <p><strong>Nombre:</strong> <span id="p-name">--</span></p>
                <p><strong>Email:</strong> <span id="p-email">--</span></p>
                <p><strong>Tel茅fono:</strong> <span id="p-phone">--</span></p>
                <p><strong>Ciudad:</strong> <span id="p-city">--</span></p>
                <p><strong>Puntos:</strong> <span id="p-points" style="color:green; font-weight:bold;">0</span></p>
            </div>
            <button class="btn-register-red" onclick="closeModal('profile-modal')" style="margin-top:15px; background:#666;">Cerrar</button>
        </div>
    </div>
    
    <div id="custom-alert-modal" class="modal">
        <div class="modal-content">
            <div class="custom-alert-icon"><i class="fas fa-info-circle"></i></div>
            <div id="custom-alert-message" class="custom-alert-message"></div>
            <button class="btn-alert-ok" onclick="closeModal('custom-alert-modal')">ACEPTAR</button>
        </div>
    </div>

    <div id="edit-ad-modal" class="modal">
        <div class="modal-content">
            <span class="close-icon" onclick="closeModal('edit-ad-modal')">&times;</span>
            <h3 style="color:var(--primary-blue); text-align:center;">Editar Publicidad</h3>
            <div class="admin-form">
                <input type="text" id="edit-ad-img-url" placeholder="URL de la imagen (Banner)">
                <input type="text" id="edit-ad-title" placeholder="T铆tulo (Destacado Rojo)">
                <textarea id="edit-ad-desc" placeholder="Descripci贸n detallada..." rows="4"></textarea>
                <label style="font-size:12px; color:#666; display:block; margin-top:10px; margin-bottom:5px; text-align:left;">Fecha de Vigencia (Opcional)</label>
                <input type="date" id="edit-ad-validity-date">
                <button class="admin-btn" onclick="saveEditedAd()">Guardar Cambios</button>
            </div>
        </div>
    </div>
    
    <div id="floating-buy-container" class="floating-action-container">
        <div id="fab-options" class="fab-options">
            <button class="fab-option-btn" 
                onclick="window.open('https://listado.mercadolibre.com.mx/_CustId_195578470?item_id=MLM2268124191&category_id=MLM172378&seller_id=195578470&client=recoview-selleritems&recos_listing=true#origin=vip&component=sellerData&typeSeller=classic', '_blank'); toggleFabOptions()">
                <i class="fas fa-tag"></i> Mercado Libre
            </button>
            <button class="fab-option-btn" 
                onclick="window.open('https://revolutionwax.pages.dev/Index', '_blank'); toggleFabOptions()">
                <i class="fas fa-globe"></i> Nuestra P谩gina
            </button>
        </div>
        <button id="fab-main" class="fab-main" onclick="toggleFabOptions()">
            <div class="fab-content">
                <i class="fas fa-shopping-cart"></i>
                Comprar
            </div>
        </button>
    </div>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyASnbNSNMik10Pww4tDUuVqarrMS665MTE", authDomain: "revolutionwaxpuntos.firebaseapp.com", projectId: "revolutionwaxpuntos", storageBucket: "revolutionwaxpuntos.firebasestorage.app", messagingSenderId: "847366317146", appId: "1:847366317146:web:8b2ee82713437b34972463" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'revolutionwax-v1';
        const USERS_PATH = `artifacts/${APP_ID}/public/data/users`; 
        const CENTERS_PATH = `artifacts/${APP_ID}/public/data/centers`;
        const CITIES_PATH = `artifacts/${APP_ID}/public/data/cities`;
        const ADS_PATH = `artifacts/${APP_ID}/public/data/ads`;
        const VOUCHERS_PATH = `artifacts/${APP_ID}/public/data/vouchers`; 
        const MOVEMENTS_PATH = `artifacts/${APP_ID}/public/data/movements`; 
const PRODUCTS_PATH = `artifacts/${APP_ID}/public/data/products`;  
        
        const ADMIN_EMAIL = "mrandroidtutorialeshd@gmail.com";

        let currentUser = null;
        let html5QrCode = null;
        let userUnsub = null;
        let userDataCache = {};
        let selectedCenterId = null;
        let selectedCenterName = null;
        let cart = []; 
        let cartType = 'products'; 
        let allCities = {}; 
        let allCenters = []; 
        let adsInterval = null;
        let allAdsCache = [];
        
        // --- Variables de Edici贸n Admin ---
        let currentEditingAdId = null; 
        let currentEditingProdId = null;
        let currentEditingProdCenterId = null;
        let currentEditingVoucherId = null; 
        
        // Variables para control de carrusel
        let isInteracting = false;
        let resumeTimeout = null;
        
        // Variable para almacenar datos del cliente escaneado (NECESARIO PARA EL NUEVO MODAL)
        window.currentScannedUser = null; 


        // --- SISTEMA DE NAVEGACIN ---
        const ALL_VIEWS = [
            'login-view', 'register-view', 'app-view', 
            'catalog-view', 'centers-view', 'cart-view', 
            'transfer-code-view', 'verify-view', 'admin-view', 'locations-view', 'ad-detail-view', 
            'vouchers-view', 'movements-history-view' , 'add-points-modal' // Agregamos el nuevo modal para que hideAll lo oculte
        ];

        // --- FUNCIN DE ALERTA PERSONALIZADA ---
        function showCustomAlert(message) {
            document.getElementById('custom-alert-message').innerHTML = message;
            document.getElementById('custom-alert-modal').style.display = 'block';
        }
        
        function hideAll() {
            ALL_VIEWS.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.style.display = 'none';
            });
            document.getElementById('sidebar-overlay').classList.remove('open');
            document.getElementById('sidebar').classList.remove('open');
            closeModal('custom-alert-modal'); 
            
            // Ocultar bot贸n flotante al cambiar de vista
            document.getElementById('floating-buy-container').style.display = 'none';
        }

        function showView(id) {
            hideAll();
            const el = document.getElementById(id);
            if(el) {
                if (id === 'login-view' || id === 'verify-view' || id === 'transfer-code-view') {
                    el.style.display = 'flex';
                } else {
                    el.style.display = 'block';
                }
                
                // Mostrar bot贸n flotante solo en la vista principal
                if (id === 'app-view') {
                    document.getElementById('floating-buy-container').style.display = 'flex';
                }
            }
        }

        function goToRegister() { showView('register-view'); }
        function goToLogin() { showView('login-view'); }
        function goToApp() { showView('app-view'); }

        function startCatalogFlow() {
            selectedCenterId = null;
            // Limpiamos el buscador al entrar al flujo de cat谩logo
            const searchInput = document.getElementById('center-search-input');
            if (searchInput) searchInput.value = '';
            goToCenters();
        }

        function goToCenters() {
            showView('centers-view');
            loadCentersList();
        }
        
        function goToVouchers() {
            showView('vouchers-view');
            loadVouchersGrid();
        }
        
        function goToMovementsHistory() {
            showView('movements-history-view');
            loadFullMovementsHistory();
        }

        function goToLocations() {
            showView('locations-view');
            document.getElementById('loc-cities-container').classList.remove('hidden');
            document.getElementById('loc-stations-container').classList.add('hidden');
            document.getElementById('city-search-input').value = '';
            loadLocationsCities();
        }

        function backFromLocations() {
            const stationsDiv = document.getElementById('loc-stations-container');
            if(!stationsDiv.classList.contains('hidden')) {
                stationsDiv.classList.add('hidden');
                document.getElementById('loc-cities-container').classList.remove('hidden');
            } else {
                goToApp();
            }
        }

        function goToAdmin() {
            showView('admin-view');
            switchAdminTab('centers', document.querySelector('.admin-tab:nth-child(2)')); 
        }

        function selectCenter(id, name) {
            selectedCenterId = id;
            selectedCenterName = name;
            showCatalogWithProducts();
        }

        function showCatalogWithProducts() {
            showView('catalog-view');
            const label = document.getElementById('selected-center-label');
            label.textContent = selectedCenterName;
            loadCatalogGrid();
        }
                
        function loadCatalogGrid() {
    const grid = document.getElementById('catalog-grid');
    grid.innerHTML = '<div style="width:100%; text-align:center; padding:20px;">Cargando premios...</div>';

    // *** CAMBIO: Carga desde la colecci贸n global de productos ***
    db.collection(PRODUCTS_PATH).get() 
    .then(snap => {
        grid.innerHTML = '';
        
        if (snap.empty) {
            grid.innerHTML = '<div style="width:100%; text-align:center; padding:20px;">No hay productos disponibles para canjear.</div>';
            return;
        }

        snap.forEach(doc => {
            const p = doc.data();
            
            const prodObj = {
                id: doc.id,
                name: p.name,
                cost: Number(p.cost),
                img: p.img,
                disp: p.disp,
                type: 'product',
            };
            const prodJson = JSON.stringify(prodObj).replace(/"/g, "&quot;");

            grid.innerHTML += `
                <div class="red-product-card">
                    <div class="prod-img-box">
                        <img src="${p.img || 'https://via.placeholder.com/100'}" style="max-width:80%; max-height:90%;" onerror="this.style.display='none'">
                        <div class="cart-float-btn" onclick="addToCart(${prodJson})">
                            <i class="fas fa-plus"></i>
                        </div>
                    </div>
                    <div class="prod-title">${p.name}</div>
                    <div class="prod-desc">Canjeable por puntos</div>
                    <div class="prod-footer">
                        <div class="prod-price">${p.cost} pts</div>
                        <div class="prod-disp">Disp: ${p.disp || 0}</div>
                    </div>
                </div>
            `;
        });
    });
}
        
        function loadVouchersGrid() {
            const grid = document.getElementById('vouchers-grid');
            grid.innerHTML = '<div style="width:100%; text-align:center; padding:20px;">Cargando vales...</div>';
            
            db.collection(VOUCHERS_PATH).get()
            .then(snap => {
                grid.innerHTML = '';
                if (snap.empty) {
                    grid.innerHTML = '<div style="width:100%; text-align:center; padding:20px;">No hay vales de gasolina disponibles.</div>';
                    return;
                }

                snap.forEach(doc => {
                    const v = doc.data();
                    const voucherObj = {
                        id: doc.id,
                        name: v.title,
                        cost: Number(v.cost),
                        img: v.imageUrl,
                        disp: 999, 
                        type: 'voucher'
                    };
                    const voucherJson = JSON.stringify(voucherObj).replace(/"/g, "&quot;");
                    const userPoints = userDataCache.points || 0;
                    const isDisabled = userPoints < v.cost;
                    const buttonText = isDisabled ? `Faltan ${(v.cost - userPoints).toFixed(2)} pts` : `Canjear por ${v.cost} pts`;
                    
                    grid.innerHTML += `
                        <div class="red-voucher-card">
                            <div class="voucher-image-container">
                                <img src="${v.imageUrl || 'https://via.placeholder.com/100?text=Vale'}" alt="Vale">
                            </div>
                            <div class="voucher-title">${v.title}</div>
                            <div class="voucher-description">${v.description}</div>
                            <button class="voucher-price-btn" 
                                onclick="addToCart(${voucherJson})" 
                                ${isDisabled ? 'disabled' : ''}>
                                ${buttonText}
                            </button>
                        </div>
                    `;
                });
            });
        }


        // FUNCIONES ESPECFICAS
        function openTransferCode() {
            showView('transfer-code-view');
            let code = (userDataCache && userDataCache.transferCode) ? userDataCache.transferCode : "SIN CDIGO";
            let formatted = code.replace(/(\d{4})/g, '$1 ').trim();
            document.getElementById('transfer-code-display').textContent = formatted;
        }

        function openVerifyView() {
            showView('verify-view');
        }

        function copyCode() {
            const code = document.getElementById('transfer-code-display').textContent.replace(/\s/g, '');
            const tempInput = document.createElement("input");
            tempInput.value = code;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand("copy");
            document.body.removeChild(tempInput);
            showCustomAlert("C贸digo copiado: " + code);
        }

        // --- MANEJO DE MOVIMIENTOS ---
        
        /**
         * Registra una transacci贸n en la base de datos de movimientos.
         */
        function logTransaction(userId, amount, type, description, otherUserId = null) {
            if (!userId) return;

            db.collection(MOVEMENTS_PATH).add({
                userId: userId,
                amount: amount,
                type: type,
                description: description,
                otherUserId: otherUserId,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).catch(e => console.error("Error al loggear movimiento:", e));
        }
        
        function formatMovementDate(timestamp) {
            if (!timestamp || typeof timestamp.toDate !== 'function') {
                return 'Cargando...';
            }
            const date = timestamp.toDate();
            const dateStr = date.toLocaleDateString('es-MX', { day: '2-digit', month: 'short', year: 'numeric' });
            const timeStr = date.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
            return `${dateStr} ${timeStr}`;
        }
        
        /**
         * Maneja errores de Firestore, especialmente si falta un 铆ndice.
         */
        function handleMovementError(e, container) {
            console.error("Error al cargar movimientos:", e);
            if (e.code === 'failed-precondition' && e.message.includes('The query requires an index')) {
                // Si el error indica que falta un 铆ndice
                const match = e.message.match(/https:\/\/console\.firebase\.google\.com\/project\/[^\/]+\/database\/firestore\/indexes\?create_index=([^&]+)/);
                let indexLink = match ? decodeURIComponent(match[1]) : null;

                let errorMessage = `
                    <div style="text-align:center; padding:20px; color:var(--primary-red); border: 1px solid var(--primary-red); border-radius: 8px; margin-top: 15px;">
                        <i class="fas fa-exclamation-triangle" style="margin-bottom: 10px; font-size: 24px;"></i><br>
                        <strong>ERROR DE CONEXIN: FALTA NDICE</strong><br>
                        <p style="font-size:13px; color:var(--text-main);">
                            Para ver tus movimientos, el administrador debe crear un 铆ndice en Firebase Firestore.<br>
                            Si eres el administrador, haz clic para crearlo:
                        </p>
                        ${indexLink ? `<a href="${indexLink}" target="_blank" style="color:var(--primary-blue); font-weight:bold; text-decoration:underline; font-size:14px;">CREAR NDICE REQUERIDO</a>` : `<p style="font-size:13px; color:var(--text-main);">URL del 铆ndice no encontrada. Debe ser un 铆ndice compuesto en la colecci贸n <span style="font-weight:bold;">movements</span> (userId ASC, timestamp DESC).</p>`}
                    </div>
                `;
                container.innerHTML = errorMessage;
            } else {
                container.innerHTML = '<div class="empty-state" style="color:red;">Error al cargar movimientos. Por favor, intenta m谩s tarde.</div>';
            }
        }


        function renderMovementItem(movement) {
            const amount = movement.amount.toFixed(2);
            let icon = 'fas fa-question';
            let title = 'Movimiento Desconocido';
            let color = 'gray';

            switch (movement.type) {
                case 'accumulated':
                    icon = 'fas fa-gas-pump';
                    title = 'Puntos Acumulados';
                    color = 'green';
                    break;
                case 'transferred':
                    icon = 'fas fa-arrow-up';
                    title = 'Puntos Transferidos';
                    color = 'var(--primary-red)';
                    break;
                case 'received':
                    icon = 'fas fa-arrow-down';
                    title = 'Puntos Recibidos';
                    color = 'var(--primary-blue)';
                    break;
                case 'redeemed_product':
                case 'redeemed_voucher':
                    icon = 'fas fa-gift';
                    title = 'Premio Canjeado';
                    color = 'var(--primary-red)';
                    break;
                case 'new_account':
                    icon = 'fas fa-user-plus';
                    title = 'Cuenta Creada';
                    color = 'var(--primary-blue)';
                    break;
            }

            const amountSign = movement.amount > 0 ? '+' : (movement.amount < 0 ? '' : '');
            const amountColor = movement.amount > 0 ? 'green' : (movement.amount < 0 ? 'var(--primary-red)' : 'gray');
            const formattedDate = formatMovementDate(movement.timestamp);
            const amountDisplay = movement.amount === 0 ? '--' : `${amountSign}${amount} pts`;

            return `
                <div class="movement-item">
                    <div class="mov-icon-box" style="background-color: ${color};">
                        <i class="${icon}"></i>
                    </div>
                    <div class="mov-detail">
                        <div class="mov-title-detail">${title}</div>
                        <div class="mov-date">${formattedDate} - ${movement.description}</div>
                    </div>
                    <div class="mov-amount" style="color: ${amountColor};">
                        ${amountDisplay}
                    </div>
                </div>
            `;
        }

        function loadRecentMovements() {
            if (!currentUser) return;
            const container = document.getElementById('recent-movements-container');
            container.innerHTML = '<div class="empty-state">Cargando movimientos recientes...</div>';

            db.collection(MOVEMENTS_PATH)
                .where('userId', '==', currentUser.uid)
                .orderBy('timestamp', 'desc')
                .limit(5)
                .get()
                .then(snap => {
                    container.innerHTML = '';
                    if (snap.empty) {
                        container.innerHTML = '<div class="empty-state">No hay transacciones disponibles</div>';
                        return;
                    }
                    snap.forEach(doc => {
                        container.innerHTML += renderMovementItem(doc.data());
                    });
                })
                .catch(e => {
                    handleMovementError(e, container); 
                });
        }
        
        function loadFullMovementsHistory() {
            if (!currentUser) return;
            const container = document.getElementById('full-movements-container');
            container.innerHTML = '<div class="empty-state">Cargando historial completo...</div>';

            db.collection(MOVEMENTS_PATH)
                .where('userId', '==', currentUser.uid)
                .orderBy('timestamp', 'desc')
                .get()
                .then(snap => {
                    container.innerHTML = '';
                    if (snap.empty) {
                        container.innerHTML = '<div class="empty-state">No hay transacciones disponibles</div>';
                        return;
                    }
                    snap.forEach(doc => {
                        container.innerHTML += renderMovementItem(doc.data());
                    });
                })
                .catch(e => {
                    handleMovementError(e, container); 
                });
        }


        // --- CARRITO MODIFICADO PARA SOPORTAR PRODUCTOS Y VALES ---
        function addToCart(item) {
            // Si el carrito actual es de un tipo diferente, vaciarlo
            if (cart.length > 0 && cartType !== item.type) {
                if (!confirm(`Ya tienes art铆culos en tu carrito de ${cartType === 'products' ? 'productos' : 'vales'}. 驴Deseas vaciarlo y agregar este ${item.type === 'product' ? 'producto' : 'vale'}?`)) {
                    return;
                }
                cart = [];
            }
            cartType = item.type;

            const existing = cart.find(p => p.id === item.id && p.type === item.type);
            if (existing) {
                if (item.type === 'voucher') {
                    // Los vales no se acumulan, es canje directo de 1 unidad
                    showCustomAlert("Solo puedes canjear un vale de gasolina a la vez. Ve a tu carrito para canjear.");
                    return;
                }
                existing.qty++;
            } else {
                cart.push({ ...item, qty: 1 });
            }
            updateCartBadges();
            showCustomAlert(`${item.name} agregado al carrito.`);
        }

        function updateCartBadges() {
            const count = cart.reduce((sum, item) => sum + item.qty, 0);
            document.getElementById('cart-count').textContent = cartType === 'products' ? count : 0;
            document.getElementById('vouchers-cart-count').textContent = cartType === 'vouchers' ? count : 0;
        }

        function openCart(type) {
            if(type === 'products' && selectedCenterId === null) {
                showCustomAlert("Debes seleccionar un centro de canje primero.");
                goToCenters();
                return;
            }

            if(cart.length === 0) {
                showCustomAlert("El carrito est谩 vac铆o.");
                return;
            }

            cartType = type;
            showView('cart-view');
            document.getElementById('cart-title-display').textContent = cartType === 'products' ? 'Carrito de Productos' : 'Carrito de Vales';
            renderCartItems();
        }

        function closeCart() { 
            if(cartType === 'products') {
                showCatalogWithProducts();
            } else {
                goToVouchers();
            }
        }

        function renderCartItems() {
            const container = document.getElementById('cart-items-container');
            container.innerHTML = '';
            let total = 0;
            if (cart.length === 0) container.innerHTML = '<p style="text-align:center; padding:20px;">El carrito est谩 vac铆o.</p>';
            cart.forEach((item, index) => {
                total += item.cost * item.qty;
                const canChangeQty = item.type === 'product';
                
                container.innerHTML += `
                    <div class="cart-item">
                        <img src="${item.img || 'https://via.placeholder.com/150'}" class="cart-img">
                        <div class="cart-info">
                            <div class="cart-title">${item.name}</div>
                            <div class="cart-price">${item.cost.toLocaleString('en-US', {minimumFractionDigits: 2})} pts</div>
                            <div class="cart-disp">${item.type === 'product' ? `Disp. ${item.disp}` : 'Canje 煤nico'}</div>
                        </div>
                        <div class="qty-controls">
                            ${canChangeQty ? `<button class="qty-btn" onclick="updateQty(${index}, -1)">-</button>` : ''}
                            <div class="qty-num">${item.qty}</div>
                            ${canChangeQty ? `<button class="qty-btn" onclick="updateQty(${index}, 1)">+</button>` : ''}
                        </div>
                    </div>
                `;
            });
            document.getElementById('cart-balance-display').textContent = (userDataCache.points || 0).toLocaleString('en-US', {minimumFractionDigits: 2});
            document.getElementById('cart-total-display').textContent = total.toLocaleString('en-US', {minimumFractionDigits: 2});
        }

        function updateQty(index, change) {
            cart[index].qty += change;
            if (cart[index].qty <= 0) cart.splice(index, 1);
            updateCartBadges();
            renderCartItems();
        }

        function processCheckout() {
            if (cart.length === 0) return showCustomAlert("El carrito est谩 vac铆o");
            const totalCost = cart.reduce((sum, item) => sum + (item.cost * item.qty), 0);
            const userPoints = userDataCache.points || 0;
            if (userPoints < totalCost) return showCustomAlert(`Saldo insuficiente.`);
            
            const action = cartType === 'products' ? 'Canjear' : 'Generar Vale';
            const locationDetail = cartType === 'products' ? ` en ${selectedCenterName}` : '';
            
            if (confirm(`驴${action} ${cart.length} art铆culos por ${totalCost} puntos${locationDetail}?`)) {
                db.runTransaction(async (transaction) => {
                    const ref = db.doc(`${USERS_PATH}/${currentUser.uid}`);
                    const d = await transaction.get(ref);
                    const currentPoints = d.data().points || 0;
                    if (currentPoints < totalCost) throw "Saldo insuficiente";
                    transaction.update(ref, { points: currentPoints - totalCost });
                }).then(() => {
                    let msg = `Hola Revolution Wax, he realizado el siguiente canje de ${cartType === 'products' ? 'productos' : 'VALES'}:\n\n`;
                    
                    if (cartType === 'products') {
                        msg += `Lugar: ${selectedCenterName}\n`;
                        cart.forEach(i => msg += `- ${i.qty}x ${i.name} (${i.cost} pts)\n`);
                        logTransaction(currentUser.uid, -totalCost, 'redeemed_product', `Canje de productos en ${selectedCenterName}`);
                    } else {
                        // VALE: Generar c贸digo 煤nico para cada vale canjeado
                        cart.forEach(i => {
                            const uniqueCode = Math.random().toString(36).substring(2, 10).toUpperCase();
                            msg += `\n VALE DE GASOLINA: ${i.name}\n`;
                            msg += `C贸digo de Canje nico: **${uniqueCode}**\n`;
                            msg += `Costo: ${i.cost} pts\n`;
                            // Guardar en Firebase una colecci贸n de vales canjeados (para rastreo)
                            db.collection(`transactions/${currentUser.uid}/vouchers`).add({
                                voucherId: i.id,
                                name: i.name,
                                cost: i.cost,
                                uniqueCode: uniqueCode,
                                redeemed: false,
                                date: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            logTransaction(currentUser.uid, -i.cost, 'redeemed_voucher', `Canje de Vale: ${i.name}`);
                        });
                        msg += "\n*El usuario debe canjear este(os) c贸digo(s) directamente con el administrador o en la caja.";
                    }
                    
                    msg += `\n\nTotal Puntos Descontados: ${totalCost}`;
                    msg += `\nUsuario: ${currentUser.email}`;
                    
                    cart = [];
                    updateCartBadges();
                    window.open(`https://wa.me/5217719624236?text=${encodeURIComponent(msg)}`);
                    goToApp();
                }).catch(err => showCustomAlert("Error: " + err));
            }
        }

        // SIDEBAR
        function openSidebar() { 
            document.getElementById('sidebar').classList.add('open'); 
            document.getElementById('sidebar-overlay').classList.add('open'); 
        }
        function closeSidebar() { 
            document.getElementById('sidebar').classList.remove('open'); 
            document.getElementById('sidebar-overlay').classList.remove('open'); 
        }
        function openProfileModal() {
            if(userDataCache) {
                document.getElementById('p-name').textContent = userDataCache.username || "Usuario";
                document.getElementById('p-email').textContent = userDataCache.email || "--";
                document.getElementById('p-phone').textContent = userDataCache.phone || "--";
                document.getElementById('p-city').textContent = userDataCache.city || "--";
                document.getElementById('p-points').textContent = userDataCache.points || "0";
            }
            document.getElementById('profile-modal').style.display = 'block';
            closeSidebar();
        }

        // AUTH
        auth.onAuthStateChanged(async (user) => {
            document.getElementById('loading-overlay').style.display = 'none';
            if (user) {
                try { await user.reload(); } catch(e){}
                user = auth.currentUser;

                if (!user.emailVerified) {
                    currentUser = null;
                    goToLogin();
                    return; 
                }

                currentUser = user;
                loadUserData();
                loadAdsCarousel();

                if (user.email === ADMIN_EMAIL) {
                    document.getElementById('admin-menu-item').classList.remove('hidden');
                } else {
                    document.getElementById('admin-menu-item').classList.add('hidden');
                }
                goToApp();
            } else {
                currentUser = null;
                goToLogin();
            }
        });

        document.getElementById('login-form').addEventListener('submit', e => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            auth.signInWithEmailAndPassword(email, pass)
            .then(async (cred) => {
                if (!cred.user.emailVerified) {
                    auth.signOut();
                    throw new Error("Debes verificar tu correo electr贸nico para ingresar.");
                }
            })
            .catch(err => {
                document.getElementById('login-error').innerText = err.message;
                document.getElementById('login-error').style.display = 'block';
            });
        });

                document.getElementById('register-form').addEventListener('submit', e => {
    e.preventDefault();
    const name = document.getElementById('reg-name').value;
    const phone = document.getElementById('reg-phone').value;
    const email = document.getElementById('reg-email').value;
    const pass = document.getElementById('reg-pass').value;
    const dob = document.getElementById('reg-dob').value;
    const city = document.getElementById('reg-city').value;
    let gender = "No especificado";
    document.getElementsByName('gender').forEach(r => { if(r.checked) gender = r.value; });

    // GENERAMOS EL CDIGO
    const transferCode = Math.floor(1000000000 + Math.random() * 9000000000).toString();

    // 1. CREAR USUARIO EN AUTH
    auth.createUserWithEmailAndPassword(email, pass).then((cred) => {
        
        // 2. GUARDAR EN BASE DE DATOS INMEDIATAMENTE
        // Usamos return para asegurar que la promesa se complete antes de seguir
        return db.collection(USERS_PATH).doc(cred.user.uid).set({
            username: name, 
            email: email, 
            phone: phone, 
            dob: dob, 
            city: city, 
            gender: gender,
            transferCode: transferCode, 
            points: 0, 
            joined: firebase.firestore.FieldValue.serverTimestamp() // Fecha de registro
        }).then(() => {
            // 3. REGISTRAR MOVIMIENTO INICIAL
            logTransaction(cred.user.uid, 0, 'new_account', 'Creaci贸n de cuenta de lealtad');
            
            // 4. ENVIAR CORREO Y CERRAR
            cred.user.sendEmailVerification().catch(err => console.log("Error enviando email verif", err));
            
            showCustomAlert("Cuenta creada con 茅xito. Ya puedes iniciar sesi贸n.");
            auth.signOut(); // Cerramos sesi贸n SOLO despu茅s de guardar los datos
            goToLogin();
        });

    }).catch(err => {
        console.error("Error en registro:", err);
        document.getElementById('reg-error').innerText = err.message;
        document.getElementById('reg-error').style.display = 'block';
    });
});

            
    function logout() { 
        if(userUnsub) userUnsub(); 
        closeSidebar(); 
        
        document.getElementById('login-email').value = "";
        document.getElementById('login-pass').value = "";
        
        document.getElementById('login-error').style.display = 'none';

        auth.signOut(); 
    }

                
        function loadUserData() {
            if(!currentUser) return;
            userUnsub = db.doc(`${USERS_PATH}/${currentUser.uid}`).onSnapshot(doc => {
                if(doc.exists) {
                    const d = doc.data();
                    userDataCache = d;

                    if (!d.transferCode) {
                        const newCode = Math.floor(1000000000 + Math.random() * 9000000000).toString();
                        db.doc(`${USERS_PATH}/${currentUser.uid}`).update({ 
                            transferCode: newCode 
                        });
                        console.log("C贸digo generado autom谩ticamente para usuario antiguo.");
                    }

                    document.getElementById('user-name-display').innerText = (d.username || "Usuario").toUpperCase();
                    document.getElementById('saldo-amount').innerText = (d.points || 0).toFixed(2);
                    document.getElementById('sidebar-name').innerText = (d.username || "Usuario").toUpperCase();
                    document.getElementById('sidebar-phone').innerText = d.phone ? "+52 " + d.phone : "Sin n煤mero";
                    
                    updateCartBadges();
                    loadRecentMovements(); 
                }
            });
        }


        // --- PUBLICIDAD MEJORADA (SIN PELEAS, LOOP) ---
        function loadAdsCarousel() {
            const container = document.getElementById('ads-carousel-container');
            const track = document.getElementById('ads-track-content');
            
            db.collection(ADS_PATH).orderBy('createdAt', 'desc').get().then(snap => {
                if(snap.empty) {
                    container.classList.add('hidden');
                    return;
                }
                
                let ads = [];
                snap.forEach(doc => { ads.push({ id: doc.id, ...doc.data() }); });
                allAdsCache = ads; 

                let adsHtml = '';
                ads.forEach((ad, index) => {
                    adsHtml += `<div class="ad-slide" onclick="openAdDetails('${index}')"><img src="${ad.imageUrl}" class="ad-image" alt="Publicidad"></div>`;
                });

                // DUPLICAR 4 VECES PARA ASEGURAR LOOP SUAVE
                track.innerHTML = adsHtml + adsHtml + adsHtml + adsHtml; 
                container.classList.remove('hidden');

                // L贸gica de Scroll sin peleas
                isInteracting = false;
                
                track.addEventListener('touchstart', () => { isInteracting = true; });
                track.addEventListener('mousedown', () => { isInteracting = true; });
                
                track.addEventListener('touchend', () => { 
                    isInteracting = false; 
                    // Reiniciar auto-scroll despu茅s de 2 segundos de soltar
                    if(resumeTimeout) clearTimeout(resumeTimeout);
                    resumeTimeout = setTimeout(() => { isInteracting = false; }, 2000);
                });
                track.addEventListener('mouseup', () => { 
                    isInteracting = false; 
                    if(resumeTimeout) clearTimeout(resumeTimeout);
                    resumeTimeout = setTimeout(() => { isInteracting = false; }, 2000);
                });

                // RequestAnimationFrame loop
                const scrollLoop = () => {
                    if (!isInteracting) {
                        track.scrollLeft += 1; // Velocidad suave
                        // Check limites para salto infinito
                        if (track.scrollLeft >= (track.scrollWidth / 2)) {
                            track.scrollLeft = 0; // Salto instant谩neo al inicio
                        }
                    }
                    requestAnimationFrame(scrollLoop);
                };
                
                // Iniciar loop
                requestAnimationFrame(scrollLoop);
            });
        }

                function openAdDetails(index) {
            // Usamos modulo para evitar error por duplicados
            const ad = allAdsCache[index % allAdsCache.length]; 
            if(ad) {
                document.getElementById('ad-detail-img').src = ad.imageUrl;
                document.getElementById('ad-detail-title').innerText = ad.title || "Publicidad";
                document.getElementById('ad-detail-desc').innerText = ad.description || "Sin descripci贸n adicional.";

                // L贸gica de fecha de vigencia
                const dateDisplay = document.getElementById('ad-detail-date');
                if (ad.validityDate) {
                    // Formato DD/MM/AAAA para mejor lectura
                    const [year, month, day] = ad.validityDate.split('-');
                    dateDisplay.innerText = `VIGENCIA: ${day}/${month}/${year}`;
                } else {
                    dateDisplay.innerText = "SIN FECHA DE VIGENCIA";
                }

                showView('ad-detail-view');
            }
        }

        // --- ADMIN FUNCIONES MODIFICADAS PARA PRODUCTOS Y VALES ---
        function switchAdminTab(tab, btn) {
    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.admin-content').forEach(c => c.classList.add('hidden'));
    if(btn) btn.classList.add('active');
    document.getElementById(`admin-tab-${tab}`).classList.remove('hidden');
    
    if(tab === 'centers') { adminLoadCenters(); adminLoadCitiesForSelect(); }
    if(tab === 'cities') adminLoadCities();
    if(tab === 'products') adminLoadProductsList(); // MODIFICADO
    if(tab === 'vouchers') adminLoadVouchers(); 
    if(tab === 'users') adminLoadUsers();
    if(tab === 'ads') adminLoadAds();
}

        // Funciones auxiliares Admin
        function adminAddCity() { const name = document.getElementById('admin-city-name').value.toUpperCase(); if(!name) return showCustomAlert("Nombre requerido."); db.collection(CITIES_PATH).add({name}).then(()=>{showCustomAlert("Ciudad guardada OK"); document.getElementById('admin-city-name').value=''; adminLoadCities();}); }
        function adminLoadCities() { const l=document.getElementById('admin-cities-list'); l.innerHTML='...'; db.collection(CITIES_PATH).get().then(s=>{l.innerHTML=''; s.forEach(d=>{l.innerHTML+=`<div class="admin-list-item-new"><b>${d.data().name}</b><button onclick="adminDeleteCity('${d.id}')" style="color:red;border:none;bg:none;">X</button></div>`})}); }
        function adminDeleteCity(id) { if(confirm("驴Borrar ciudad?")) db.doc(`${CITIES_PATH}/${id}`).delete().then(adminLoadCities); }
        function adminLoadCitiesForSelect() { const s=document.getElementById('admin-center-city-select'); s.innerHTML='...'; db.collection(CITIES_PATH).get().then(snap=>{let o='<option value="">Ciudad</option>'; snap.forEach(d=>o+=`<option value="${d.id}">${d.data().name}</option>`); s.innerHTML=o;}); }
        
        // SE AGREGA LA LIMPIEZA DE INPUTS AQU
        function adminAddCenter() { 
            const cid=document.getElementById('admin-center-city-select').value; 
            const n=document.getElementById('admin-center-name').value; 
            const a=document.getElementById('admin-center-address').value; 
            if(!n||!cid) return showCustomAlert("Faltan datos"); 
            db.collection(CENTERS_PATH).add({name:n, address:a, cityId:cid}).then(()=>{
                showCustomAlert("Centro agregado"); 
                document.getElementById('admin-center-name').value = '';
                document.getElementById('admin-center-address').value = '';
                adminLoadCenters();
            }); 
        }
        
                // SE AGREGA LA LIMPIEZA DE INPUTS AQU (Funci贸n adminAddCenter existente, solo como referencia de ubicaci贸n)
        function adminAddCenter() { 
            // ... (c贸digo existente de adminAddCenter) ...
            db.collection(CENTERS_PATH).add({name:n, address:a, cityId:cid}).then(()=>{
                showCustomAlert("Centro agregado"); 
                document.getElementById('admin-center-name').value = '';
                document.getElementById('admin-center-address').value = '';
                adminLoadCenters();
            }); 
        }

        // **********************************************
        // ********** COMIENZO DEL CDIGO FALTANTE **********

        function adminAddProduct() { 
            // ELIMINADA la lectura del selector de centro (cid)
            const n = document.getElementById('admin-prod-name').value; 
            const c = document.getElementById('admin-prod-cost').value; 
            const i = document.getElementById('admin-prod-img').value; 
            const d = document.getElementById('admin-prod-disp').value; 
            
            // VALIDACIN: Requiere nombre y costo (debe ser > 0)
            if(!n) return showCustomAlert("Nombre de producto requerido"); 
            if(!c || isNaN(Number(c)) || Number(c) <= 0) return showCustomAlert("Costo en puntos requerido y debe ser mayor a 0."); 
            
            // Guarda en la colecci贸n de Productos Globales
            db.collection(PRODUCTS_PATH).add({
                name: n, 
                cost: Number(c), // Aseguramos que se guarde como n煤mero
                img: i, 
                disp: d
            }).then(()=>{
                showCustomAlert("Producto agregado OK"); 
                // Limpiar inputs
                document.getElementById('admin-prod-name').value = '';
                document.getElementById('admin-prod-cost').value = '';
                document.getElementById('admin-prod-img').value = '';
                document.getElementById('admin-prod-disp').value = '';
                adminLoadProductsList(); // Recargar la lista de productos
            }).catch(error => {
                showCustomAlert("Error al guardar: " + error.message);
                console.error("Error al a帽adir producto:", error);
            }); 
        }

        // ********** FIN DEL CDIGO FALTANTE **********
        // **********************************************

                function adminLoadCenters() { 
            const l = document.getElementById('admin-centers-list'); 
            l.innerHTML = '<div style="text-align:center;">Cargando centros de distribuci贸n por ciudad...</div>';
            
            // 1. Cargar todas las ciudades para mapear ID a Nombre
            db.collection(CITIES_PATH).get().then(citySnap => {
                const cityMap = {};
                citySnap.forEach(doc => {
                    cityMap[doc.id] = doc.data().name;
                });

                // 2. Cargar todos los centros
                db.collection(CENTERS_PATH).get().then(centerSnap => {
                    
                    // 3. Agrupar centros por cityId
                    const groupedCenters = {};
                    centerSnap.forEach(doc => {
                        const center = { id: doc.id, ...doc.data() };
                        const cityId = center.cityId;
                        if (!groupedCenters[cityId]) {
                            groupedCenters[cityId] = [];
                        }
                        groupedCenters[cityId].push(center);
                    });

                    // 4. Renderizar la lista agrupada
                    l.innerHTML = ''; 
                    
                    if (centerSnap.empty) {
                        l.innerHTML = '<div style="text-align:center;">No hay centros de distribuci贸n registrados.</div>';
                        return;
                    }
                    
                    // Ordenar por nombre de ciudad
                    const sortedCityIds = Object.keys(groupedCenters).sort((a, b) => {
                        const nameA = cityMap[a] || 'Z Desconocida';
                        const nameB = cityMap[b] || 'Z Desconocida';
                        return nameA.localeCompare(nameB);
                    });

                    sortedCityIds.forEach(cityId => {
                        const cityName = cityMap[cityId] || 'CIUDAD DESCONOCIDA';
                        const centers = groupedCenters[cityId];

                        // Usa el estilo de separador de ciudad que ya tienes en la app
                        l.innerHTML += `<p class="city-separator" style="padding: 10px 15px; margin-top: 15px;">${cityName} (${centers.length})</p>`;
                        
                        centers.forEach(c => {
                                                                                    l.innerHTML += `
                                <div class="admin-list-item-new">
                                    <div>
                                        <b>${c.name}</b><br>
                                        <span style="font-size:12px; color:#666;">${c.address || 'Sin direcci贸n'}</span>
                                    </div>
                                    <div class="admin-actions-group">
                                        <button class="admin-action-btn" style="color:var(--primary-blue);" onclick="adminOpenEditCenterModal('${c.id}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="admin-action-btn" style="color:var(--primary-red);" onclick="adminDeleteCenter('${c.id}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                    });

                }).catch(e => {
                    l.innerHTML = `<div style="text-align:center; color:red;">Error al cargar centros: ${e.message}</div>`;
                    console.error("Error al cargar centros:", e);
                });

            }).catch(e => {
                l.innerHTML = `<div style="text-align:center; color:red;">Error al cargar ciudades: ${e.message}</div>`;
                console.error("Error al cargar ciudades:", e);
            });
        }
        
                // FUNCIN AUXILIAR: Carga las ciudades en el <select> (para Agregar y Editar)
        // Ya existe esta funci贸n en el c贸digo base, pero la reescribimos para asegurar 
        // que soporte la selecci贸n de una ciudad por defecto para edici贸n.
        function adminLoadCitiesForSelect(selectElementId, selectedCityId = null) {
            const select = document.getElementById(selectElementId);
            if (!select) return; 

            select.innerHTML = '<option value="">Cargando ciudades...</option>';

            db.collection(CITIES_PATH).get().then(snap => {
                select.innerHTML = '<option value="">Selecciona la ciudad:</option>';
                snap.forEach(doc => {
                    const city = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = city.name;
                    if (selectedCityId && doc.id === selectedCityId) {
                        option.selected = true; // Selecciona la ciudad actual del centro
                    }
                    select.appendChild(option);
                });
            }).catch(e => {
                console.error("Error al cargar ciudades para select:", e);
                select.innerHTML = '<option value="">Error al cargar ciudades</option>';
            });
        }
        
        // FUNCIN 1 DE EDICIN: Abrir Modal y Llenar Campos
        function adminOpenEditCenterModal(id) {
            db.doc(`${CENTERS_PATH}/${id}`).get().then(doc => {
                if (!doc.exists) {
                    return showCustomAlert("Centro no encontrado.");
                }
                const center = doc.data();

                // 1. Guardar el ID para usarlo al guardar
                document.getElementById('edit-center-id').value = id;
                
                // 2. Llenar los campos de texto
                document.getElementById('edit-center-name').value = center.name || '';
                document.getElementById('edit-center-address').value = center.address || '';
                
                // 3. Cargar y seleccionar la ciudad actual
                adminLoadCitiesForSelect('edit-center-city-select', center.cityId);

                // 4. Abrir el modal
                document.getElementById('edit-center-modal').style.display = 'block';

            }).catch(e => {
                console.error("Error al cargar centro para edici贸n:", e);
                showCustomAlert("Error al cargar centro para edici贸n.");
            });
        }

        // FUNCIN 2 DE EDICIN: Guardar Cambios en Firebase
        function adminSaveEditedCenter() {
            const id = document.getElementById('edit-center-id').value;
            const cid = document.getElementById('edit-center-city-select').value;
            const n = document.getElementById('edit-center-name').value;
            const a = document.getElementById('edit-center-address').value;

            if (!n || !cid) {
                return showCustomAlert("El nombre y la ciudad son obligatorios.");
            }

            const updates = {
                name: n,
                address: a,
                cityId: cid
            };

            db.doc(`${CENTERS_PATH}/${id}`).update(updates).then(() => {
                showCustomAlert("Centro actualizado con 茅xito.");
                closeModal('edit-center-modal');
                adminLoadCenters(); // Recargar la lista agrupada y actualizada
            }).catch(e => {
                console.error("Error al actualizar centro:", e);
                showCustomAlert("Error al guardar cambios: " + e.message);
            });
        }

        
        // MODIFICADO: Muestra lista con opciones de Edici贸n
        function adminLoadProductsList() { 
    // ELIMINADAS las l铆neas de lectura del selector de centro
    const l=document.getElementById('admin-products-list'); 
    l.innerHTML='<div style="text-align:center;">Cargando productos...</div>'; 
    
    // *** CAMBIO: Consulta PRODUCTS_PATH ***
    db.collection(PRODUCTS_PATH).get().then(s=>{
        l.innerHTML=''; 
        if (s.empty) {
            l.innerHTML = '<div style="text-align:center;">No hay productos disponibles.</div>';
            return;
        }
        s.forEach(d=>{
            const p = d.data();
            // productData solo necesita id y data, ya no el centerId
            const productData = JSON.stringify({id: d.id, ...p}).replace(/"/g, "&quot;");

            l.innerHTML+=`
                <div class="admin-list-item-new">
                    <div class="admin-product-item">
                        <img src="${p.img || 'https://via.placeholder.com/40'}" class="admin-product-thumb" onerror="this.onerror=null; this.src='https://via.placeholder.com/40'">
                        <div class="admin-product-info">
                            <b>${p.name}</b><br>
                            ${p.cost} pts | Disp: ${p.disp || 0}
                        </div>
                    </div>
                    <div class="admin-actions-group">
                        <button class="admin-action-btn" style="color:var(--primary-blue);" onclick='adminOpenEditProductModal(${productData})'>
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                        <button class="admin-action-btn" style="color:var(--primary-red);" onclick="adminDelProd('${d.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        })
    }); 
}

        // NUEVA FUNCIN: Abrir modal de edici贸n de producto
        function adminOpenEditProductModal(product) {
    // ELIMINADA la l铆nea: currentEditingProdCenterId = product.centerId;
    currentEditingProdId = product.id;
    
    document.getElementById('edit-prod-name').value = product.name || '';
    document.getElementById('edit-prod-cost').value = product.cost || '';
    document.getElementById('edit-prod-img').value = product.img || '';
    document.getElementById('edit-prod-disp').value = product.disp || '';
    document.getElementById('edit-prod-current-img').src = product.img || 'https://via.placeholder.com/80';
    
    document.getElementById('edit-product-modal').style.display = 'block';
}
        
        // NUEVA FUNCIN: Guardar producto editado
        function adminSaveEditedProduct() {
    // ELIMINADA la l铆nea: const cid = currentEditingProdCenterId;
    const pid = currentEditingProdId;
    const name = document.getElementById('edit-prod-name').value;
    const cost = document.getElementById('edit-prod-cost').value;
    const img = document.getElementById('edit-prod-img').value;
    const disp = document.getElementById('edit-prod-disp').value;
    
    if (!name || !cost || !pid) return showCustomAlert("Faltan datos esenciales para guardar.");

    const updates = {
        name: name,
        cost: Number(cost),
        img: img,
        disp: disp
    };

    // *** CAMBIO: Usa PRODUCTS_PATH ***
    db.collection(PRODUCTS_PATH).doc(pid).update(updates)
        .then(() => {
            showCustomAlert("Producto actualizado con 茅xito.");
            closeModal('edit-product-modal');
            adminLoadProductsList(); // Recargar lista
        })
        .catch(error => {
            console.error("Error al actualizar producto:", error);
            showCustomAlert("Error al actualizar: " + error.message);
        });
}


        // MODIFICADA para aceptar solo el ID del producto y usar PRODUCTS_PATH
function adminDelProd(p) { 
    if(confirm("驴Borrar producto?")) {
        db.collection(PRODUCTS_PATH).doc(p).delete().then(adminLoadProductsList); 
    }
}
        
        // --- ADMIN VALES FUNCIONES (MODIFICADAS) ---
        function adminAddVoucher() {
            const title = document.getElementById('admin-voucher-title').value;
            const desc = document.getElementById('admin-voucher-desc').value;
            const cost = Number(document.getElementById('admin-voucher-cost').value);
            const img = document.getElementById('admin-voucher-img').value;
            
            if(!title || !cost || cost <= 0) return showCustomAlert("T铆tulo y Costo (mayor a 0) son requeridos.");
            
            db.collection(VOUCHERS_PATH).add({
                title: title,
                description: desc,
                cost: cost,
                imageUrl: img || 'https://i.postimg.cc/mD3V9y7T/gas-voucher.png'
            }).then(() => {
                showCustomAlert("Vale de Gasolina agregado");
                document.getElementById('admin-voucher-title').value = '';
                document.getElementById('admin-voucher-desc').value = '';
                document.getElementById('admin-voucher-cost').value = '';
                document.getElementById('admin-voucher-img').value = '';
                adminLoadVouchers();
            });
        }

        function adminLoadVouchers() {
            const list = document.getElementById('admin-vouchers-list');
            list.innerHTML = 'Cargando...';
            db.collection(VOUCHERS_PATH).get().then(snap => {
                list.innerHTML=''; 
                if (snap.empty) {
                    list.innerHTML = '<div style="text-align:center;">No hay vales de gasolina registrados.</div>';
                    return;
                }
                snap.forEach(doc => {
                    const v = doc.data();
                    const voucherData = JSON.stringify({id: doc.id, ...v}).replace(/"/g, "&quot;");

                    list.innerHTML += `
                        <div class="admin-list-item-new">
                            <div class="admin-voucher-item">
                                <img src="${v.imageUrl || 'https://via.placeholder.com/40'}" class="admin-voucher-thumb" onerror="this.onerror=null; this.src='https://via.placeholder.com/40'">
                                <div class="admin-voucher-info">
                                    <b>${v.title}</b><br>
                                    Costo: ${v.cost} pts
                                </div>
                            </div>
                            <div class="admin-actions-group">
                                <button class="admin-action-btn" style="color:var(--primary-red);" onclick='adminOpenEditVoucherModal(${voucherData})'>
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                                <button class="admin-action-btn" style="color:var(--primary-red);" onclick="adminDeleteVoucher('${doc.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
            });
        }

        // NUEVA FUNCIN: Abrir modal de edici贸n de vale
        function adminOpenEditVoucherModal(voucher) {
            currentEditingVoucherId = voucher.id;
            
            document.getElementById('edit-voucher-title').value = voucher.title || '';
            document.getElementById('edit-voucher-desc').value = voucher.description || '';
            document.getElementById('edit-voucher-cost').value = voucher.cost || '';
            document.getElementById('edit-voucher-img').value = voucher.imageUrl || '';
            document.getElementById('edit-voucher-current-img').src = voucher.imageUrl || 'https://via.placeholder.com/80?text=Vale';
            
            document.getElementById('edit-voucher-modal').style.display = 'block';
        }
        
        // NUEVA FUNCIN: Guardar vale editado
        function adminSaveEditedVoucher() {
            const vid = currentEditingVoucherId;
            const title = document.getElementById('edit-voucher-title').value;
            const desc = document.getElementById('edit-voucher-desc').value;
            const cost = document.getElementById('edit-voucher-cost').value;
            const img = document.getElementById('edit-voucher-img').value;
            
            if (!title || !cost || !vid) return showCustomAlert("Faltan datos esenciales para guardar.");

            const updates = {
                title: title,
                description: desc,
                cost: Number(cost),
                imageUrl: img
            };

            db.collection(VOUCHERS_PATH).doc(vid).update(updates)
                .then(() => {
                    showCustomAlert("Vale de Gasolina actualizado con 茅xito.");
                    closeModal('edit-voucher-modal');
                    adminLoadVouchers(); // Recargar lista
                })
                .catch(error => {
                    console.error("Error al actualizar vale:", error);
                    showCustomAlert("Error al actualizar: " + error.message);
                });
        }


        function adminDeleteVoucher(id) {
            if(confirm("驴Borrar este vale de gasolina?")) {
                db.doc(`${VOUCHERS_PATH}/${id}`).delete().then(adminLoadVouchers);
            }
        }
        
        // ADMIN ADS
        function adminAddAd() {
            const imgUrl = document.getElementById('admin-ad-img-url').value;
            const title = document.getElementById('admin-ad-title').value;
            const desc = document.getElementById('admin-ad-desc').value;
            if(!imgUrl) return showCustomAlert("URL imagen requerida.");
            db.collection(ADS_PATH).add({imageUrl: imgUrl, title: title, description: desc, validityDate: '', createdAt: firebase.firestore.FieldValue.serverTimestamp()}).then(() => {
                showCustomAlert("Publicidad agregada OK"); document.getElementById('admin-ad-img-url').value=''; adminLoadAds(); loadAdsCarousel();
            });
        }

                function adminLoadAds() {
            const list = document.getElementById('admin-ads-list');
            list.innerHTML = 'Cargando...';
            db.collection(ADS_PATH).orderBy('createdAt', 'desc').get().then(snap => {
                list.innerHTML = '';
                snap.forEach(doc => {
                    const ad = { id: doc.id, ...doc.data() };
                    const adJson = JSON.stringify(ad).replace(/"/g, "&quot;"); // Crear un JSON seguro para pasar

                    list.innerHTML += `
                        <div class="admin-list-item-new" style="align-items: flex-start;">
                            <div><img src="${ad.imageUrl}" style="height:60px;border-radius:8px;"><br><b>${ad.title||''}</b></div>
                            <div>
                                <button onclick='adminOpenEditModal(${adJson})' class="admin-action-btn" style="color:blue;">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                                <button onclick="adminDeleteAd('${doc.id}')" class="admin-action-btn" style="color:red;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>`;
                });
            });
        }

                function adminOpenEditModal(ad) {
            currentEditingAdId = ad.id;
            document.getElementById('edit-ad-img-url').value = ad.imageUrl;
            document.getElementById('edit-ad-title').value = ad.title;
            document.getElementById('edit-ad-desc').value = ad.description;
            // CAMBIO: Asignar la fecha de vigencia
            document.getElementById('edit-ad-validity-date').value = ad.validityDate || ''; 
            
            document.getElementById('edit-ad-modal').style.display = 'block';
        }

                function saveEditedAd() {
            if(!currentEditingAdId) return;
            const imgUrl = document.getElementById('edit-ad-img-url').value;
            const title = document.getElementById('edit-ad-title').value;
            const desc = document.getElementById('edit-ad-desc').value;
            // CAMBIO: Leer la fecha de vigencia
            const validityDate = document.getElementById('edit-ad-validity-date').value; 
            
            db.doc(`${ADS_PATH}/${currentEditingAdId}`).update({
                imageUrl: imgUrl, 
                title: title, 
                description: desc, 
                // CAMBIO: Guardar la fecha
                validityDate: validityDate 
            }).then(() => {
                showCustomAlert("Actualizado"); closeModal('edit-ad-modal'); adminLoadAds(); loadAdsCarousel();
            });
        }

        function adminDeleteAd(id) { if(confirm("驴Borrar publicidad?")) db.doc(`${ADS_PATH}/${id}`).delete().then(() => { adminLoadAds(); loadAdsCarousel(); }); }
        
                function adminLoadUsers() { 
            const l = document.getElementById('admin-users-list'); 
            l.innerHTML = '<div style="text-align:center;">Cargando usuarios...</div>'; 
            
            db.collection(USERS_PATH).get().then(s => {
                l.innerHTML = ''; 
                if (s.empty) {
                    l.innerHTML = '<div style="text-align:center; padding:20px;">No hay usuarios registrados.</div>';
                    return;
                }
                
                s.forEach(d => { 
                    const u = d.data(); 
                    let joinedDate = 'N/A';
                    if (u.joined && u.joined.toDate) {
                        joinedDate = u.joined.toDate().toLocaleDateString('es-MX');
                    }
                    
                    l.innerHTML += `
                        <div class="admin-list-item-new" style="flex-direction: row; align-items: center; padding: 15px; justify-content: space-between;">
                            <div style="flex-grow:1;">
                                <div style="font-size: 16px; font-weight: 700; color: var(--primary-blue); margin-bottom: 5px;">${u.username || 'Sin Nombre'}</div>
                                <div style="font-size: 14px; color: var(--text-main); margin-bottom: 3px;">
                                    <strong>Puntos:</strong> <span style="color:green; font-weight:bold;">${u.points || 0} pts</span>
                                </div>
                                <div style="font-size: 13px; color: var(--text-secondary);">
                                    <p style="margin: 2px 0;"><strong>Correo:</strong> ${u.email || 'N/A'}</p>
                                    <p style="margin: 2px 0;"><strong>Registro:</strong> ${joinedDate}</p>
                                </div>
                            </div>
                            
                            <button onclick="adminDeleteUser('${d.id}', '${u.username}')" style="background:none; border:none; cursor:pointer; color:var(--primary-red); font-size:20px; padding:10px;">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    `;
                })
            }).catch(error => {
                console.error("Error cargando usuarios:", error);
                l.innerHTML = '<div style="text-align:center; color:red;">Error al cargar lista.</div>';
            }); 
        }
        
                function adminDeleteUser(userId, userName) {
            if(confirm(`驴Est谩s SEGURO de eliminar los datos de ${userName}? \n\nEsta acci贸n borrar谩 sus puntos y su registro de la app, pero NO borrar谩 su acceso (login) si a煤n existe.`)) {
                
                // Borrar el documento de la base de datos
                db.collection(USERS_PATH).doc(userId).delete().then(() => {
                    showCustomAlert(`Usuario ${userName} eliminado correctamente.`);
                    adminLoadUsers(); // Recargar la lista para ver el cambio
                }).catch(error => {
                    showCustomAlert("Error al eliminar: " + error.message);
                });
            }
        }


        // --- CARGA DE CENTROS AGRUPADOS POR CIUDAD (MODIFICADO para usar cache) ---
        async function loadCentersList() {
            const list = document.getElementById('centers-list-container');
            list.innerHTML = '<p class="city-separator" style="text-align:center; color:var(--text-secondary); background:var(--bg-body); font-weight:normal;">Cargando ciudades y sucursales...</p>';
            
            try {
                // 1. Si no hay ciudades en cach茅, cargarlas
                if (Object.keys(allCities).length === 0) {
                    const citiesSnapshot = await db.collection(CITIES_PATH).get();
                    citiesSnapshot.forEach(doc => {
                        allCities[doc.id] = doc.data().name;
                    });
                }

                // 2. Cargar y cachear todos los centros si la cach茅 est谩 vac铆a
                if (allCenters.length === 0) {
                    const centersSnapshot = await db.collection(CENTERS_PATH).get();
                    allCenters = centersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }

                // 3. Mostrar la lista completa inicialmente (sin filtro)
                renderGroupedCenters(allCenters);

            } catch (error) {
                console.error("Error al cargar centros agrupados:", error);
                list.innerHTML = '<p class="city-separator" style="text-align:center; color:var(--primary-red); background:var(--bg-body); font-weight:normal;">Error al cargar centros. Verifica tu conexi贸n o configuraci贸n de Firebase.</p>';
            }
        }
        
        // NUEVA FUNCIN: Filtrar centros
        function filterCenters() {
            const searchTerm = document.getElementById('center-search-input').value.toLowerCase().trim();
            
            if (searchTerm.length > 0 && searchTerm.length < 2) return; // Esperar al menos 2 caracteres o nada
            
            if (searchTerm.length === 0) {
                // Mostrar todos los centros si el campo est谩 vac铆o
                renderGroupedCenters(allCenters);
                return;
            }

            const filteredCenters = allCenters.filter(c => 
                c.name.toLowerCase().includes(searchTerm) || 
                (c.address && c.address.toLowerCase().includes(searchTerm)) ||
                (allCities[c.cityId] && allCities[c.cityId].toLowerCase().includes(searchTerm)) // Permite buscar por ciudad
            );
            
            renderGroupedCenters(filteredCenters, searchTerm);
        }

        // FUNCIN: Renderizar centros agrupados (usada por loadCentersList y filterCenters)
        // FUNCIN: Renderizar centros agrupados (usada por loadCentersList y filterCenters)
function renderGroupedCenters(centersToRender, searchTerm = null) {
    const list = document.getElementById('centers-list-container');
    list.innerHTML = ''; // Limpiar lista
    
    if (centersToRender.length === 0 && searchTerm) {
            list.innerHTML = `<p class="city-separator" style="text-align:center; color:var(--text-secondary); background:var(--bg-body); font-weight:normal;">No se encontraron centros para "${searchTerm}".</p>`;
            return;
    } else if (centersToRender.length === 0 && !searchTerm) {
        list.innerHTML = '<p class="city-separator" style="text-align:center; color:var(--text-secondary); background:var(--bg-body); font-weight:normal;">No hay centros de canje registrados.</p>';
        return;
    }

    const groupedCenters = {};
    centersToRender.forEach(c => {
        const cityId = c.cityId;
        if (!groupedCenters[cityId]) {
            groupedCenters[cityId] = [];
        }
        groupedCenters[cityId].push(c);
    });

    let html = '';
    
    // Si hay b煤squeda, mostramos los resultados sin cabeceras de ciudad separadas (m谩s compacto)
    if (searchTerm) {
            html += `<p class="city-separator" style="background:#fff3e0; color:var(--primary-red);">Resultados de b煤squeda (${centersToRender.length})</p>`;
            centersToRender.forEach(c => {
                const cityName = allCities[c.cityId] || 'Ciudad Desconocida';
                html += `
                    <div class="station-item" onclick="selectCenter('${c.id}', '${c.name}')">
                        <div class="station-icon-simple"><i class="fas fa-gas-pump"></i></div>
                        <div class="station-text">
                            <span>${c.name}</span>
                            <span class="station-addr">${c.address || 'Sin direcci贸n'} (${cityName})</span>
                        
                        </div>
                    </div>
                `;
            });
    } else {
        // Modo normal: Agrupado por Ciudad
        const sortedCityIds = Object.keys(groupedCenters).sort((a, b) => {
            const nameA = allCities[a] || 'Z Desconocida';
            const nameB = allCities[b] || 'Z Desconocida';
            return nameA.localeCompare(nameB);
        });
        
        sortedCityIds.forEach(cityId => {
            const cityName = allCities[cityId] || 'CIUDAD DESCONOCIDA';
            const centers = groupedCenters[cityId];

            // --- AQU EST EL CAMBIO: Se agrega (${centers.length}) ---
            html += `<p class="city-separator">${cityName} (${centers.length})</p>`;
            
            centers.forEach(c => {
                html += `
                    <div class="station-item" onclick="selectCenter('${c.id}', '${c.name}')">
                        <div class="station-icon-simple"><i class="fas fa-gas-pump"></i></div>
                    <div class="station-text">
                        <span>${c.name}</span>
                        <span class="station-addr">${c.address || 'Sin direcci贸n'}</span>
                    </div>
                </div>
            `;
        });
    });
    }

    list.innerHTML = html;
}

        // --- FUNCIONES DE UBICACIONES (SOLUCIN PANTALLA BLANCA) ---
        function loadLocationsCities() {
            const list = document.getElementById('loc-cities-container');
            // Texto expl铆citamente negro y negrita
            list.innerHTML = '<div style="text-align:center; padding:30px; color:black; font-weight:bold; font-size:16px;">Cargando estados...</div>';
            
            db.collection(CITIES_PATH).get().then(snap => {
                list.innerHTML = '';
                if(snap.empty) {
                    list.innerHTML = '<p style="text-align:center; padding:30px; color:black;">No hay estados registrados a煤n.</p>';
                    return;
                }
                
                allCities = {};
                let cityArray = [];
                snap.forEach(doc => {
                    const city = { id: doc.id, name: doc.data().name };
                    allCities[doc.id] = city.name;
                    cityArray.push(city);
                });
                renderCities(cityArray);
            });
        }

        function renderCities(cities) {
            const list = document.getElementById('loc-cities-container');
            list.innerHTML = '';
            cities.forEach(c => {
                list.innerHTML += `
                    <div class="city-list-item" onclick="selectLocationCity('${c.id}', '${c.name}')">
                        <i class="fas fa-gas-pump city-icon"></i>
                        <div class="city-name">${c.name}</div>
                    </div>
                `;
            });
        }

        function filterCities() {
            const term = document.getElementById('city-search-input').value.toLowerCase();
            const filtered = Object.keys(allCities)
                            .map(id => ({ id: id, name: allCities[id] }))
                            .filter(c => c.name.toLowerCase().includes(term));
            renderCities(filtered);
        }

        function selectLocationCity(cityId, cityName) {
            document.getElementById('loc-cities-container').classList.add('hidden');
            const stationsContainer = document.getElementById('loc-stations-container');
            stationsContainer.classList.remove('hidden');
            stationsContainer.innerHTML = '<div style="text-align:center; padding:30px; color:black; font-weight:bold;">Cargando gasolineras...</div>';

            db.collection(CENTERS_PATH).where('cityId', '==', cityId).get().then(snap => {
                stationsContainer.innerHTML = '';
                stationsContainer.innerHTML += `<div style="padding:15px; background:#f4f6f9; color:#000; font-weight:bold;"> ${cityName}</div>`;
                
                if(snap.empty) {
                    stationsContainer.innerHTML += '<p style="text-align:center; padding:20px; color:black;">No hay gasolineras registradas en este estado.</p>';
                    return;
                }

                snap.forEach(doc => {
                    const c = doc.data();
                    stationsContainer.innerHTML += `
                        <div class="station-item" style="cursor:default;">
                            <div class="station-icon-simple"><i class="fas fa-map-marker-alt"></i></div>
                            <div class="station-text">
                                <span>${c.name}</span>
                                <span class="station-addr">${c.address || ''}</span>
                            </div>
                        </div>
                    `;
                });
            });
        }

        // SCANNER (MODIFICADO PARA USAR EL MODAL PERSONALIZADO)
        function openScanner() { 
            if (!currentUser || currentUser.email !== ADMIN_EMAIL) {
                return showCustomAlert("Acceso denegado: Solo administradores.");
            }
            
            document.getElementById('scanner-modal').style.display='block'; 
            document.getElementById('scan-status').textContent = 'Cargando c谩mara...';
            
            if (!html5QrCode) {
                 // Crear nueva instancia de Html5Qrcode al abrir el modal
                 html5QrCode = new Html5Qrcode("qr-reader"); 
            }

            // Opciones de configuraci贸n
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrCode.start(
                { facingMode: "environment" }, 
                config, 
                (decodedText, decodedResult) => {
                    // xito al escanear: detenemos la c谩mara y procesamos.
                    processCode(decodedText); 
                },
                (errorMessage) => {
                    // Fallo o lectura continua sin 茅xito
                    document.getElementById('scan-status').textContent = 'Listo para escanear...';
                }
            )
            .catch((err) => {
                // Error al iniciar la c谩mara (Ej: Falta de permisos)
                document.getElementById('scan-status').textContent = 'Error al iniciar la c谩mara: ' + (err.message || 'Verifique permisos.');
                console.error("Error al iniciar el esc谩ner:", err);
            });
        }

        function processCode(code) {
            code = code.trim(); // Limpiar espacios vac铆os
            
            // Cierre manual del modal del esc谩ner
            closeModal('scanner-modal');

            // 2. VERIFICAR SI ES UN USUARIO (Los IDs de usuario son largos, +20 caracteres)
            if (code.length > 20) {
                document.getElementById('loading-overlay').style.display = 'flex';
                
                // Buscar usuario en la base de datos
                db.collection(USERS_PATH).doc(code).get().then(doc => {
                    
                    if (doc.exists) {
                        const userData = doc.data();
                        
                        // ALMACENAR DATOS DEL CLIENTE Y ABRIR MODAL PERSONALIZADO (Reemplazo del prompt nativo)
                        window.currentScannedUser = { id: code, name: userData.username || "Cliente" };

                        document.getElementById('loading-overlay').style.display = 'none';
                        
                        // 3. ABRIR MODAL PERSONALIZADO (REEMPLAZA EL PROMPT NATIVO)
                        document.getElementById('modal-client-name').textContent = userData.username || "Cliente";
                        document.getElementById('modal-points-input').value = ''; // Limpiar input
                        document.getElementById('add-points-modal').style.display = 'block';

                    } else {
                        document.getElementById('loading-overlay').style.display = 'none';
                        showCustomAlert("锔 El c贸digo escaneado no corresponde a un usuario registrado.");
                    }
                }).catch(e => {
                    document.getElementById('loading-overlay').style.display = 'none';
                    showCustomAlert("Error de conexi贸n: " + e);
                });
            } 
            // CDIGO VIEJO (Por si escanean un cup贸n de papel antiguo o c贸digos cortos)
            else {
                const ptsMap = {"RW50":50, "RW100":100, "BONO":20}; 
                const pts = ptsMap[code] || 0; 
                if(pts > 0) { 
                    db.doc(`${USERS_PATH}/${currentUser.uid}`).update({points: firebase.firestore.FieldValue.increment(pts)})
                    .then(() => {
                        logTransaction(currentUser.uid, pts, 'accumulated', `Bono por c贸digo: ${code}`);
                        showCustomAlert(`+${pts} PUNTOS AGREGADOS A TU CUENTA PERSONAL`);
                    });
                } else { 
                    showCustomAlert("锔 C贸digo QR no reconocido"); 
                } 
            }
        }
        
        // FUNCIN NUEVA: L贸gica para sumar puntos desde el modal personalizado
        function confirmPointAddition() {
            closeModal('add-points-modal'); // Cerrar el modal

            // Obtener los datos del cliente guardados temporalmente y el valor del input
            const ptsInput = document.getElementById('modal-points-input').value;
            const pts = parseFloat(ptsInput);
            
            // Validar datos
            if (isNaN(pts) || pts <= 0) {
                return showCustomAlert("锔 Cantidad inv谩lida. Debes ingresar un n煤mero mayor a 0.");
            }

            // Usamos los datos guardados en el paso 2
            const { id: scannedId, name: scannedName } = window.currentScannedUser;
            
            // 4. CONFIRMAR ACCIN 
            const confirmacion = confirm(`驴Est谩s seguro de abonar ${pts} puntos a ${scannedName}?`);

            if (confirmacion) {
                document.getElementById('loading-overlay').style.display = 'flex';
                
                // 5. ACTUALIZAR BASE DE DATOS (INCREMENTAR)
                db.doc(`${USERS_PATH}/${scannedId}`).update({
                    points: firebase.firestore.FieldValue.increment(pts)
                }).then(() => {
                    document.getElementById('loading-overlay').style.display = 'none';
                    
                    // 6. REGISTRAR MOVIMIENTO
                    logTransaction(scannedId, pts, 'accumulated', `Abono por admin`);
                    
                    showCustomAlert(` XITO\nSe han sumado ${pts} puntos correctamente a ${scannedName}.`);
                }).catch(err => {
                    document.getElementById('loading-overlay').style.display = 'none';
                    showCustomAlert(" Error al guardar en base de datos: " + err);
                });
            } else {
                showCustomAlert("Operaci贸n de abono cancelada.");
            }
        }


        /* --- FUNCIONES DE TRANSFERENCIA MODIFICADAS --- */

        // 1. Mostrar mi c贸digo
        function openTransferCode() {
            showView('transfer-code-view');
            let code = (userDataCache && userDataCache.transferCode) ? userDataCache.transferCode : "SIN CDIGO";
            let formatted = code.replace(/(\d{4})/g, '$1 ').trim();
            document.getElementById('transfer-code-display').textContent = formatted;
        }

        let foundRecipientId = null; 

        // 2. Buscar al otro usuario
        function verifyRecipientUser() {
            const codeInput = document.getElementById('input-dest-code').value.replace(/\s/g, ''); 
            
            if(codeInput.length < 5) return showCustomAlert("C贸digo inv谩lido");
            if(userDataCache.transferCode === codeInput) return showCustomAlert("No puedes enviarte puntos a ti mismo");

            const btn = document.querySelector('#step-verify-user .btn-verify-red');
            btn.innerText = "Buscando...";

            db.collection(USERS_PATH).where('transferCode', '==', codeInput).get().then(snap => {
                btn.innerText = "Verificar Usuario";
                if(snap.empty) return showCustomAlert("Usuario no encontrado.");

                const destDoc = snap.docs[0];
                const destData = destDoc.data();
                foundRecipientId = destDoc.id; 
                foundRecipientName = destData.username; // Guardar nombre del destinatario

                document.getElementById('step-verify-user').classList.add('hidden');
                document.getElementById('step-transfer-amount').classList.remove('hidden');
                document.getElementById('dest-name-display').innerText = destData.username;
                document.getElementById('verify-instruction-text').innerText = "Ingresa la cantidad a enviar";
                
                document.getElementById('verify-icon-status').innerHTML = '<i class="fas fa-check" style="color:green;"></i>';
                document.getElementById('verify-icon-status').style.borderColor = "green";
            }).catch(err => {
                 btn.innerText = "Verificar Usuario";
                 showCustomAlert("Error al buscar usuario: " + err.message);
            });
        }

        // 3. Hacer la transferencia (MODIFICADA PARA REGISTRAR MOVIMIENTOS)
        function executeTransfer() {
            const amount = Number(document.getElementById('input-transfer-amount').value);
            const myPoints = userDataCache.points || 0;
            const recipientName = document.getElementById('dest-name-display').innerText;

            if(amount <= 0 || isNaN(amount)) return showCustomAlert("Cantidad inv谩lida.");
            if(amount > myPoints) return showCustomAlert("Saldo insuficiente.");
            if(!foundRecipientId) return showCustomAlert("Error de destinatario.");

            if(!confirm(`驴Transferir ${amount} puntos a ${recipientName}?`)) return; // USANDO NATIVE CONFIRM

            const myRef = db.doc(`${USERS_PATH}/${currentUser.uid}`);
            const destRef = db.doc(`${USERS_PATH}/${foundRecipientId}`);

            db.runTransaction(async (t) => {
                const myDoc = await t.get(myRef);
                const destDoc = await t.get(destRef);
                
                const newMyPoints = (myDoc.data().points || 0) - amount;
                if(newMyPoints < 0) throw "Saldo insuficiente";

                const newDestPoints = (destDoc.data().points || 0) + amount;

                t.update(myRef, { points: newMyPoints });
                t.update(destRef, { points: newDestPoints });
            }).then(() => {
                
                // REGISTRAR AMBOS MOVIMIENTOS
                // 1. Movimiento del remitente
                logTransaction(currentUser.uid, -amount, 'transferred', `Transferencia a ${recipientName}`, foundRecipientId);
                
                // 2. Movimiento del destinatario
                logTransaction(foundRecipientId, amount, 'received', `Recibido de ${userDataCache.username || currentUser.email}`, currentUser.uid);
                
                showCustomAlert("Transferencia exitosa");
                resetTransferView();
                goToApp();
            }).catch(e => showCustomAlert("Error: " + e));
        }

        function resetTransferView() {
            document.getElementById('input-dest-code').value = "";
            document.getElementById('input-transfer-amount').value = "";
            document.getElementById('step-verify-user').classList.remove('hidden');
            document.getElementById('step-transfer-amount').classList.add('hidden');
            document.getElementById('verify-icon-status').innerHTML = '<i class="fas fa-user"></i>';
            document.getElementById('verify-icon-status').style.borderColor = "var(--bg-body)";
            document.getElementById('verify-instruction-text').innerText = "Introduce el c贸digo proporcionado por el destinatario para verificar su informaci贸n";
            foundRecipientId = null;
        }

    function exitVerifyView() {
        document.getElementById('input-dest-code').value = "";
        document.getElementById('input-transfer-amount').value = "";
        document.getElementById('step-verify-user').classList.remove('hidden');
        document.getElementById('step-transfer-amount').classList.add('hidden');
        document.getElementById('verify-icon-status').innerHTML = '<i class="fas fa-user"></i>';
        document.getElementById('verify-icon-status').style.borderColor = "var(--bg-body)";
        document.getElementById('verify-instruction-text').innerText = "Introduce el c贸digo proporcionado por el destinatario para verificar su informaci贸n";
        goToApp();
    }

        // --- FUNCIONES NUEVAS PARA QR PERSONAL Y ADMIN ---
        let qrTimerInterval = null;

        function openPersonalQR() {
            if(!currentUser) return showCustomAlert("Debes iniciar sesi贸n");
            document.getElementById('personal-qr-modal').style.display = 'block';
            
            // Limpiar QR anterior
            const container = document.getElementById('personal-qr-display');
            container.innerHTML = '';
            
            // Crear QR con el ID 煤nico del usuario
            new QRCode(container, {
                text: currentUser.uid, 
                width: 180,
                height: 180,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            // Cuenta regresiva de 5 minutos
            startQRTimer(5 * 60);
        }

        function startQRTimer(duration) {
            let timer = duration, minutes, seconds;
            const display = document.getElementById('qr-timer-countdown');
            if(qrTimerInterval) clearInterval(qrTimerInterval);
            
            qrTimerInterval = setInterval(function () {
                minutes = parseInt(timer / 60, 10);
                seconds = parseInt(timer % 60, 10);
                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;
                display.textContent = minutes + ":" + seconds;

                if (--timer < 0) {
                    clearInterval(qrTimerInterval);
                    closeModal('personal-qr-modal');
                    showCustomAlert("El c贸digo QR ha expirado.");
                }
            }, 1000);
        }
            
    function closeModal(id) {
        const modal = document.getElementById(id);
        if (modal) {
            modal.style.display = 'none';
        }

        if (id === 'personal-qr-modal') {
            if (typeof qrTimerInterval !== 'undefined' && qrTimerInterval) {
                clearInterval(qrTimerInterval);
                qrTimerInterval = null;
            }
        }

        if (id === 'scanner-modal') {
            if (html5QrCode && html5QrCode.isScanning) {
                // Detener la c谩mara expl铆citamente y luego limpiar la instancia
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    html5QrCode = null; // CRTICO: Permite que openScanner inicialice una instancia limpia
                    document.getElementById('scan-status').textContent = 'C谩mara detenida.';
                }).catch(err => {
                    // Si falla la detenci贸n (ej: ya estaba detenida), al menos la limpiamos
                    console.warn("Advertencia al detener la c谩mara QR:", err);
                    if (html5QrCode) {
                        html5QrCode.clear();
                        html5QrCode = null;
                    }
                    document.getElementById('scan-status').textContent = 'C谩mara detenida.';
                });
            } else if (html5QrCode) {
                 // Si no est谩 escaneando pero la instancia existe, solo la limpiamos
                html5QrCode.clear();
                html5QrCode = null;
                document.getElementById('scan-status').textContent = 'C谩mara detenida.';
            }
        }
        
        // Asegurar que las opciones del FAB se cierren
        if (id === 'edit-product-modal' || id === 'edit-voucher-modal' || id === 'edit-ad-modal') {
             // No hacemos nada para el FAB al cerrar estos modales
        } else {
             toggleFabOptions(false);
        }
    }        
    
    // === FUNCIN NUEVA: TOGGLE FAB OPTIONS ===
    function toggleFabOptions(forceOpen) {
        const fabMain = document.getElementById('fab-main');
        const fabOptions = document.getElementById('fab-options');
        
        let isOpen = fabOptions.classList.contains('open');

        if (forceOpen === true) {
             isOpen = false; // Forzar apertura
        } else if (forceOpen === false) {
             isOpen = true; // Forzar cierre
        }

        if (isOpen) {
            // Cerrar
            fabOptions.classList.remove('open');
            fabMain.classList.remove('active');
        } else {
            // Abrir
            fabOptions.classList.add('open');
            fabMain.classList.add('active');
        }
    }
    // === FIN FUNCIN NUEVA ===
    
            function adminDeleteCenter(id) { 
            if(confirm("驴Borrar centro?")) 
                // Esto borra y luego recarga la lista agrupada
                db.doc(`${CENTERS_PATH}/${id}`).delete().then(adminLoadCenters); 
        }
    </script>
</body>
</html>
