<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Evolution</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #F8FAFC; -webkit-tap-highlight-color: transparent; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* --- ANIMACIONES --- */
        .loader-text {
            background: linear-gradient(to right, #1e293b 0%, #475569 50%, #1e293b 100%);
            -webkit-background-clip: text;
            background-clip: text;
            background-size: 200% auto;
            animation: shine 3s linear infinite;
        }
        @keyframes shine { to { background-position: 200% center; } }
        
        .pulse-ring { animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(1.2); opacity: 0; }
        }

        .fade-in { animation: fadeIn 0.4s ease-in-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .slide-up { animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(100%); } to { opacity: 1; transform: translateY(0); } }

        .bounce-enter { animation: bounceIn 0.6s cubic-bezier(0.215, 0.610, 0.355, 1.000) both; }
        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }

        .btn-animate { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-animate:active { transform: scale(0.95); }
        
        .admin-card { transition: all 0.3s ease; }
        .admin-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.08); }
    </style>
</head>
<body class="text-slate-800 overflow-x-hidden min-h-screen relative bg-slate-50 selection:bg-amber-200">

    <div id="toast-container" class="fixed top-4 right-4 z-[100] flex flex-col gap-2 pointer-events-none"></div>

    <div id="global-loader" class="fixed inset-0 bg-slate-50 z-[90] flex flex-col items-center justify-center transition-opacity duration-700">
        <div class="relative flex items-center justify-center mb-6">
            <div class="absolute w-24 h-24 bg-amber-400/20 rounded-full pulse-ring"></div>
            <div class="absolute w-16 h-16 bg-amber-400/40 rounded-full pulse-ring" style="animation-delay: 0.5s;"></div>
            <div class="relative w-12 h-12 bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl shadow-xl flex items-center justify-center text-white font-bold text-xl z-10">SE</div>
        </div>
        <div class="text-center space-y-1">
            <h1 class="text-2xl font-black tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-slate-800 via-slate-600 to-slate-800 loader-text">STREAM EVOLUTION</h1>
            <p class="text-[10px] uppercase tracking-[0.3em] text-slate-400 font-medium animate-pulse">Cargando Ecosistema</p>
        </div>
    </div>

    <div id="auth-container" class="min-h-screen flex flex-col items-center justify-center p-6 hidden bg-white">
        <div class="mb-10 text-center bounce-enter">
            <div class="w-16 h-16 bg-slate-900 rounded-2xl flex items-center justify-center text-white font-bold shadow-2xl text-2xl mx-auto mb-5 transform rotate-3">SE</div>
            <h1 class="text-3xl font-black text-slate-800 tracking-tight">STREAM <span class="text-amber-500">EVOLUTION</span></h1>
            <p class="text-slate-400 text-sm mt-2 font-medium">Acceso al Portal Digital</p>
        </div>

        <div class="w-full max-w-sm space-y-6 slide-up" style="animation-delay: 0.1s;">
            <form id="login-form" class="space-y-4 auth-view">
                <div class="relative group">
                    <i data-lucide="mail" class="absolute left-4 top-3.5 w-5 h-5 text-slate-300 transition-colors group-focus-within:text-amber-500"></i>
                    <input type="email" id="login-email" class="w-full bg-slate-50 border border-slate-200 rounded-2xl py-3.5 pl-12 pr-4 text-slate-700 font-medium focus:outline-none focus:border-amber-400 focus:bg-white transition-all placeholder:text-slate-300" placeholder="Correo electrónico" required>
                </div>
                <div class="relative group">
                    <i data-lucide="lock" class="absolute left-4 top-3.5 w-5 h-5 text-slate-300 transition-colors group-focus-within:text-amber-500"></i>
                    <input type="password" id="login-password" class="w-full bg-slate-50 border border-slate-200 rounded-2xl py-3.5 pl-12 pr-4 text-slate-700 font-medium focus:outline-none focus:border-amber-400 focus:bg-white transition-all placeholder:text-slate-300" placeholder="Contraseña" required>
                </div>
                <div class="text-right">
                    <button type="button" onclick="switchAuthView('forgot')" class="text-xs text-slate-400 font-bold hover:text-amber-500 transition-colors">¿Olvidaste tu contraseña?</button>
                </div>
                <button type="submit" class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl shadow-xl shadow-slate-900/20 hover:bg-slate-800 hover:shadow-2xl btn-animate flex justify-center items-center gap-2 mt-2">
                    <span>Ingresar</span> <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </button>
                <div class="text-center text-sm text-slate-500 mt-6">
                    ¿Nuevo aquí? <button type="button" onclick="switchAuthView('register')" class="text-amber-500 font-bold hover:underline ml-1">Crear Cuenta</button>
                </div>
            </form>

            <form id="register-form" class="space-y-4 hidden auth-view">
                <h2 class="text-xl font-bold text-slate-800 mb-2">Registro</h2>
                <input type="email" id="reg-email" class="w-full bg-slate-50 border border-slate-200 rounded-2xl py-3.5 px-4" placeholder="Correo electrónico" required>
                <input type="password" id="reg-password" class="w-full bg-slate-50 border border-slate-200 rounded-2xl py-3.5 px-4" placeholder="Contraseña" required>
                <input type="password" id="reg-confirm-password" class="w-full bg-slate-50 border border-slate-200 rounded-2xl py-3.5 px-4" placeholder="Confirmar contraseña" required>
                <button type="submit" class="w-full bg-amber-400 text-slate-900 font-bold py-4 rounded-2xl shadow-lg btn-animate">Registrarse</button>
                <div class="text-center text-sm text-slate-500 mt-4"><button type="button" onclick="switchAuthView('login')" class="text-slate-900 font-bold hover:underline">Volver al Login</button></div>
            </form>
            
             <form id="forgot-form" class="space-y-4 hidden auth-view">
                <button type="button" onclick="switchAuthView('login')" class="text-slate-400 flex items-center gap-1 mb-4 text-xs font-bold"><i data-lucide="arrow-left" class="w-3 h-3"></i> ATRÁS</button>
                <h2 class="text-xl font-bold text-slate-800">Recuperar Acceso</h2>
                <input type="email" id="forgot-email" class="w-full bg-slate-50 border border-slate-200 rounded-2xl py-3.5 px-4" placeholder="Tu correo registrado" required>
                <button type="submit" class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl shadow-lg btn-animate">Enviar Correo</button>
            </form>
        </div>
    </div>

    <div id="dashboard-container" class="hidden relative min-h-screen pb-20">
        
        <div id="app-modal" class="fixed inset-0 z-[80] hidden items-center justify-center p-4">
            <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
            <div id="modal-card" class="bg-white rounded-[2rem] w-full max-w-md p-0 relative shadow-2xl transform transition-all scale-100 opacity-100 max-h-[90vh] flex flex-col overflow-hidden border border-slate-100">
                <button onclick="closeModal()" class="absolute top-4 right-4 text-slate-400 hover:text-rose-500 z-50 bg-white/90 rounded-full p-1.5 shadow-sm hover:rotate-90 transition-transform duration-300"><i data-lucide="x" class="w-5 h-5"></i></button>
                <div id="modal-content" class="overflow-y-auto scrollbar-hide p-6 w-full h-full"></div>
            </div>
        </div>

        <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-40 border-b border-slate-100 px-5 py-3 flex items-center justify-between shadow-sm">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="p-2.5 rounded-xl bg-slate-50 text-slate-600 hover:bg-slate-100 btn-animate"><i data-lucide="menu" class="w-5 h-5"></i></button>
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-slate-900 rounded-lg flex items-center justify-center text-white font-bold text-xs">SE</div>
                    <h1 class="text-sm font-bold text-slate-700 tracking-tight">STREAM<span class="text-amber-500">EVO</span></h1>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div id="online-badge" class="text-[10px] bg-emerald-50 text-emerald-600 px-2.5 py-1 rounded-full font-bold flex items-center gap-1.5 border border-emerald-100"><div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div> ONLINE</div>
                <button onclick="openNotifications()" class="p-2 text-slate-400 hover:text-amber-500 transition-colors relative">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                    <span id="notification-dot" class="absolute top-2 right-2 w-2 h-2 bg-rose-500 rounded-full border border-white hidden animate-bounce"></span>
                </button>
            </div>
        </header>

        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-slate-900/20 backdrop-blur-sm z-50 opacity-0 pointer-events-none transition-opacity duration-300"></div>
        <aside id="sidebar" class="fixed top-0 left-0 h-full w-72 bg-white shadow-2xl z-50 transition-transform duration-300 -translate-x-full flex flex-col">
            <div class="p-6 border-b border-slate-50">
                <h2 class="font-bold text-lg text-slate-800">Mi Cuenta</h2>
                <p class="text-xs text-slate-400 truncate font-mono mt-1" id="sidebar-email">Cargando...</p>
            </div>
            <div class="p-4 space-y-2 overflow-y-auto flex-1 scrollbar-hide">
                <div id="user-menu-items">
                    <div onclick="switchView('user'); toggleSidebar();" class="flex items-center gap-3 p-3.5 rounded-xl bg-amber-50 text-amber-700 font-semibold cursor-pointer hover:bg-amber-100 transition-all"><i data-lucide="home" class="w-5 h-5"></i><span class="text-sm">Inicio</span></div>
                    <button onclick="openReportModal(); toggleSidebar();" class="w-full flex items-center gap-3 p-3.5 rounded-xl text-slate-500 hover:bg-slate-50 hover:text-slate-800 transition-all"><i data-lucide="life-buoy" class="w-5 h-5"></i><span class="text-sm font-medium">Reportar Fallo</span></button>
                    <button onclick="openSupportReplies(); toggleSidebar();" class="w-full flex items-center gap-3 p-3.5 rounded-xl text-slate-500 hover:bg-slate-50 hover:text-slate-800 transition-all">
                        <i data-lucide="message-circle-question" class="w-5 h-5"></i>
                        <span class="text-sm font-medium">Respuestas Soporte</span>
                    </button>
                    <button onclick="openNotifications(); toggleSidebar();" class="w-full flex items-center gap-3 p-3.5 rounded-xl text-slate-500 hover:bg-slate-50 hover:text-slate-800 transition-all"><i data-lucide="clock" class="w-5 h-5"></i><span class="text-sm font-medium">Movimientos</span></button>
                    <button onclick="openRenewalModal(); toggleSidebar();" class="w-full flex items-center gap-3 p-3.5 rounded-xl text-slate-500 hover:bg-slate-50 hover:text-slate-800 transition-all">
                        <i data-lucide="refresh-cw" class="w-5 h-5"></i><span class="text-sm font-medium">Renovar</span>
                    </button>
                </div>
                
                <div id="admin-menu-items" class="hidden">
                    <div onclick="switchView('admin'); returnToAdminDashboard(); toggleSidebar();" class="flex items-center gap-3 p-3.5 rounded-xl bg-slate-800 text-white font-semibold cursor-pointer mb-4 shadow-lg shadow-slate-300/50">
                        <i data-lucide="layout-grid" class="w-5 h-5 text-amber-400"></i>
                        <span class="text-sm">Panel Admin</span>
                    </div>
                    <div onclick="switchView('user'); toggleSidebar();" class="flex items-center gap-3 p-3.5 rounded-xl text-slate-600 font-medium cursor-pointer hover:bg-slate-50 transition-all">
                        <i data-lucide="shopping-bag" class="w-5 h-5"></i>
                        <span class="text-sm">Vista Tienda</span>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-slate-50">
                <button onclick="handleLogout()" class="w-full flex items-center justify-center gap-2 p-3 rounded-xl text-rose-500 hover:bg-rose-50 font-bold transition-colors text-sm"><i data-lucide="log-out" class="w-4 h-4"></i> Cerrar Sesión</button>
            </div>
        </aside>

        <main id="user-view" class="px-5 py-6 space-y-8 max-w-md mx-auto md:max-w-4xl">
            <section class="flex justify-between items-center gap-3 overflow-x-auto pb-2 scrollbar-hide bounce-enter" style="animation-delay: 0.1s;">
                <div class="flex-1 min-w-[110px] bg-slate-800 text-white rounded-[1.5rem] py-5 px-4 flex flex-col items-center justify-center shadow-xl shadow-slate-200 border border-slate-700 relative overflow-hidden group">
                    <div class="absolute -top-6 -right-6 w-16 h-16 bg-white/10 rounded-full group-hover:scale-150 transition-transform duration-500"></div>
                    <span class="text-[10px] uppercase tracking-widest opacity-60 mb-1 font-medium">Tu Saldo</span>
                    <span id="balance-display" class="font-bold text-xl text-emerald-400 tracking-tight">--</span>
                </div>
                <div class="flex-1 min-w-[110px] bg-white text-slate-700 rounded-[1.5rem] py-5 px-4 flex flex-col items-center justify-center border border-slate-100 shadow-sm relative overflow-hidden">
                    <span class="text-[10px] uppercase tracking-widest opacity-50 mb-1 font-medium">Ahorro</span>
                    <span id="profit-display" class="font-bold text-xl tracking-tight">--</span>
                </div>
                <button onclick="openChargeModal()" class="flex-none w-[70px] bg-amber-400 text-slate-900 rounded-[1.5rem] py-4 flex flex-col items-center justify-center shadow-lg shadow-amber-200 hover:bg-amber-300 btn-animate">
                    <i data-lucide="plus" class="w-6 h-6 mb-1"></i>
                </button>
            </section>

            <section class="relative w-full h-44 rounded-[2rem] overflow-hidden shadow-lg group cursor-pointer bounce-enter" style="animation-delay: 0.2s;">
                <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1593784991095-a205069470b6?q=80&w=2070&auto=format&fit=crop')] bg-cover bg-center transition-transform duration-700 group-hover:scale-110"></div>
                <div class="absolute inset-0 bg-gradient-to-r from-slate-900/90 via-slate-900/60 to-transparent flex items-center px-8">
                    <div class="z-10 max-w-[70%]">
                        <span class="bg-amber-400 text-slate-900 px-2.5 py-1 rounded-lg text-[10px] font-bold uppercase tracking-wider mb-3 inline-block shadow-sm">Destacado</span>
                        <h3 class="text-white font-black text-xl leading-tight mb-2">Entretenimiento Premium</h3>
                        <p class="text-slate-300 text-xs mb-4 font-medium">Las mejores plataformas al mejor precio.</p>
                    </div>
                </div>
            </section>

            <section class="bounce-enter" style="animation-delay: 0.3s;">
                <div class="flex items-center justify-between mb-5">
                    <h3 class="font-bold text-slate-800 text-lg flex items-center gap-2"><i data-lucide="grid" class="w-4 h-4 text-amber-500"></i> Servicios</h3>
                </div>
                <div id="categories-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="col-span-2 text-center py-10 text-slate-400 animate-pulse text-xs">Cargando servicios...</div>
                </div>
            </section>
        </main>

        <main id="admin-view" class="hidden px-5 py-6 space-y-6 max-w-md mx-auto md:max-w-4xl bounce-enter">
            <div id="admin-dashboard-grid" class="space-y-6">
                <div class="bg-slate-800 text-white p-8 rounded-[2rem] shadow-2xl shadow-slate-200 relative overflow-hidden">
                    <div class="absolute right-0 top-0 w-48 h-48 bg-amber-400 rounded-full blur-3xl opacity-10 transform translate-x-10 -translate-y-10"></div>
                    <h2 class="text-2xl font-bold mb-1 relative z-10">Panel de Control</h2>
                    <p class="text-slate-400 text-sm relative z-10">Gestión integral del ecosistema</p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div onclick="enterAdminModule('requests')" class="admin-card bg-white p-5 rounded-3xl border border-slate-100 flex flex-col items-center justify-center cursor-pointer h-40 relative overflow-hidden group">
                        <div class="w-12 h-12 bg-amber-50 text-amber-500 rounded-2xl flex items-center justify-center mb-3 group-hover:scale-110 transition-transform"><i data-lucide="dollar-sign" class="w-6 h-6"></i></div>
                        <span class="font-bold text-slate-700 text-sm">Pagos</span>
                        <div id="badge-requests" class="absolute top-4 right-4 bg-rose-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full hidden shadow-sm">0</div>
                    </div>

                    <div onclick="enterAdminModule('support')" class="admin-card bg-white p-5 rounded-3xl border border-slate-100 flex flex-col items-center justify-center cursor-pointer h-40 relative overflow-hidden group">
                        <div class="w-12 h-12 bg-blue-50 text-blue-500 rounded-2xl flex items-center justify-center mb-3 group-hover:scale-110 transition-transform"><i data-lucide="message-square" class="w-6 h-6"></i></div>
                        <span class="font-bold text-slate-700 text-sm">Soporte</span>
                        <div id="badge-support" class="absolute top-4 right-4 bg-rose-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full hidden shadow-sm">0</div>
                    </div>

                    <div onclick="enterAdminModule('categories')" class="admin-card col-span-2 bg-gradient-to-r from-slate-800 to-slate-700 p-5 rounded-3xl shadow-lg flex items-center justify-between cursor-pointer group px-8">
                         <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-white/10 text-amber-400 rounded-2xl flex items-center justify-center backdrop-blur-sm"><i data-lucide="layers" class="w-6 h-6"></i></div>
                            <div class="text-left">
                                <span class="font-bold text-white text-lg block">Gestionar Servicios</span>
                                <span class="text-xs text-slate-300">Agregar o editar categorías (Botones)</span>
                            </div>
                        </div>
                        <i data-lucide="chevron-right" class="text-white/50 group-hover:translate-x-1 transition-transform"></i>
                    </div>

                    <div onclick="enterAdminModule('users')" class="admin-card bg-white p-5 rounded-3xl border border-slate-100 flex flex-col items-center justify-center cursor-pointer h-32 group">
                        <div class="w-10 h-10 bg-slate-50 text-slate-600 rounded-full flex items-center justify-center mb-2 group-hover:bg-slate-100 transition-colors"><i data-lucide="users" class="w-5 h-5"></i></div>
                        <span class="font-bold text-slate-700 text-xs">Usuarios</span>
                    </div>

                    <div onclick="enterAdminModule('inventory')" class="admin-card bg-white p-5 rounded-3xl border border-slate-100 flex flex-col items-center justify-center cursor-pointer h-32 group">
                        <div class="w-10 h-10 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center mb-2 group-hover:bg-indigo-100 transition-colors"><i data-lucide="archive" class="w-5 h-5"></i></div>
                        <span class="font-bold text-slate-700 text-xs">Cuentas</span>
                    </div>

                    <div onclick="enterAdminModule('stock')" class="admin-card bg-white p-5 rounded-3xl border border-slate-100 flex flex-col items-center justify-center cursor-pointer h-32 group col-span-2">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-emerald-50 text-emerald-600 rounded-full flex items-center justify-center group-hover:bg-emerald-100 transition-colors"><i data-lucide="package" class="w-5 h-5"></i></div>
                            <div class="text-left">
                                <span class="font-bold text-slate-700 text-sm block">Productos (Vitrina)</span>
                                <span class="text-[10px] text-slate-400">Items visibles para el usuario</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="admin-modules-container" class="hidden">
                <button onclick="returnToAdminDashboard()" class="mb-6 flex items-center gap-2 text-slate-400 hover:text-slate-800 font-bold text-xs uppercase tracking-wider transition-colors btn-animate">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i> Volver al Panel
                </button>

                <section id="admin-categories-section" class="hidden bounce-enter">
                    <div class="flex justify-between items-center mb-6">
                        <div><h3 class="font-bold text-slate-800 text-xl">Mis Servicios</h3><p class="text-xs text-slate-400">Categorías visibles</p></div>
                        <button onclick="openAddCategoryModal()" class="bg-slate-800 text-white px-4 py-2.5 rounded-xl text-xs font-bold flex items-center gap-2 hover:bg-slate-700 shadow-md btn-animate"><i data-lucide="plus" class="w-4 h-4"></i> Crear Nueva</button>
                    </div>
                    <div id="admin-categories-list" class="grid grid-cols-2 gap-4"><p class="col-span-2 text-center text-slate-400 py-10">Cargando servicios...</p></div>
                </section>

                <section id="admin-requests-section" class="hidden bounce-enter">
                    <h3 class="font-bold text-slate-800 mb-4 text-xl">Solicitudes de Saldo</h3>
                    <div id="admin-requests-list" class="space-y-3"></div>
                </section>
                
                <section id="admin-users-section" class="hidden bounce-enter">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-800 text-xl">Usuarios</h3>
                        <button onclick="openAddUserModal()" class="bg-emerald-500 text-white px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-1 hover:bg-emerald-600 shadow-md btn-animate"><i data-lucide="user-plus" class="w-4 h-4"></i> Nuevo</button>
                    </div>
                    <div id="admin-users-list" class="space-y-3"></div>
                </section>

                <section id="admin-stock-section" class="hidden bounce-enter">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-800 text-xl">Productos</h3>
                        <button onclick="openAddProductModal()" class="bg-slate-800 text-white px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-1 hover:bg-slate-700 shadow-md btn-animate"><i data-lucide="plus" class="w-4 h-4"></i> Agregar</button>
                    </div>
                    <div id="admin-stock-list" class="space-y-3"></div>
                </section>

                <section id="admin-inventory-section" class="hidden bounce-enter">
                    <div class="flex justify-between items-center mb-4">
                        <div><h3 class="font-bold text-slate-800 text-xl">Inventario</h3><p class="text-xs text-slate-400">Cuentas a entregar</p></div>
                        <button onclick="openAddInventoryModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-1 hover:bg-indigo-700 shadow-md btn-animate"><i data-lucide="archive" class="w-4 h-4"></i> Cargar Item</button>
                    </div>
                    <div id="admin-inventory-list" class="space-y-3"></div>
                </section>

                <section id="admin-support-section" class="hidden bounce-enter">
                    <h3 class="font-bold text-slate-800 text-xl mb-4">Mesa de Ayuda</h3>
                    <div id="admin-support-list" class="space-y-3"></div>
                </section>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, addDoc, query, orderBy, limit, serverTimestamp, setDoc, getDoc, runTransaction, updateDoc, deleteDoc, where, getDocs, increment } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- CONFIGURACIÓN ---
        const firebaseConfig = {
          apiKey: "AIzaSyBYaYm2LDE6QM_K5Dii74sfZCYYd1eQfvY",
          authDomain: "ventasstre-a24b7.firebaseapp.com",
          projectId: "ventasstre-a24b7",
          storageBucket: "ventasstre-a24b7.firebasestorage.app",
          messagingSenderId: "197117622028",
          appId: "1:197117622028:web:ae6380faf72f965a41fb29",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "mi-ecosistema-v1";
        const ADMIN_EMAIL = "mrandroidtutorialeshd@gmail.com";

        let currentUser = null;
        let isAdmin = false;
        window.userTransactions = [];
        window.globalNotifications = []; 
        window.adminPendingRequests = []; 
        window.adminPendingReports = [];
        window.adminReportsCache = []; 
        window.categoriesCache = []; 
        window.currentUserHistory = [];

        // Audio
        const alertSound = new Audio("https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3");
        window.playNotificationSound = () => { try { alertSound.currentTime = 0; alertSound.play().catch(e=>{}); } catch(e){} };

        // --- AUTH OBSERVER ---
        onAuthStateChanged(auth, async (user) => {
            const loader = document.getElementById('global-loader');
            const authContainer = document.getElementById('auth-container');
            const dashboardContainer = document.getElementById('dashboard-container');
            
            if (user) {
                const userStatusRef = doc(db, 'artifacts', appId, 'public', 'data', 'all_users', user.uid);
                const userStatusSnap = await getDoc(userStatusRef);
                
                if (userStatusSnap.exists() && userStatusSnap.data().suspended === true) {
                    await signOut(auth);
                    showToast('Cuenta suspendida por administración.', 'error');
                    return;
                }

                currentUser = user;
                isAdmin = user.email === ADMIN_EMAIL;
                document.getElementById('sidebar-email').textContent = user.email;
                
                await initCategories();

                if (isAdmin) {
                    document.getElementById('user-menu-items').classList.add('hidden');
                    document.getElementById('admin-menu-items').classList.remove('hidden');
                    initAdminPanel();
                    switchView('admin'); 
                } else {
                    document.getElementById('user-menu-items').classList.remove('hidden');
                    document.getElementById('admin-menu-items').classList.add('hidden');
                    switchView('user');
                }

                await initUserData(user);
                initGlobalNotifications(); 
                
                authContainer.classList.add('hidden');
                dashboardContainer.classList.remove('hidden');
            } else {
                currentUser = null;
                isAdmin = false;
                dashboardContainer.classList.add('hidden');
                authContainer.classList.remove('hidden');
            }
            
            setTimeout(() => {
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 700);
            }, 1500);
        });

        // --- CATEGORÍAS DINÁMICAS ---
        async function initCategories() {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'categories')); 
            onSnapshot(q, (snapshot) => {
                window.categoriesCache = [];
                snapshot.forEach(doc => window.categoriesCache.push({ id: doc.id, ...doc.data() }));
                renderUserCategories();
                if(isAdmin) renderAdminCategories();
            });
        }

        function renderUserCategories() {
            const grid = document.getElementById('categories-grid');
            if (!grid) return;
            if (window.categoriesCache.length === 0) { grid.innerHTML = `<div class="col-span-full text-center text-slate-400 text-sm py-8">No hay servicios disponibles.</div>`; return; }
            let html = '';
            window.categoriesCache.forEach(cat => {
                const color = cat.color || 'slate';
                html += `<div onclick="openCategoryModule('${cat.slug || cat.id}', '${cat.name}')" class="bg-white rounded-[1.5rem] shadow-sm border border-slate-100 p-5 flex flex-col items-center justify-center cursor-pointer transition-all hover:shadow-xl hover:-translate-y-1 group h-36"><div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-${color}-100 to-${color}-50 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform duration-300 shadow-inner"><i data-lucide="${cat.icon || 'box'}" class="w-7 h-7 text-${color}-600"></i></div><span class="font-bold text-slate-600 text-xs text-center group-hover:text-slate-900 transition-colors uppercase tracking-wide">${cat.name}</span></div>`;
            });
            grid.innerHTML = html; lucide.createIcons();
        }

        function renderAdminCategories() {
            const list = document.getElementById('admin-categories-list');
            if(!list) return;
            let html = '';
            window.categoriesCache.forEach(cat => {
                html += `<div class="bg-white p-4 rounded-2xl border border-slate-100 flex flex-col gap-3 relative group"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-xl bg-${cat.color || 'slate'}-100 flex items-center justify-center text-${cat.color || 'slate'}-600"><i data-lucide="${cat.icon || 'box'}" class="w-5 h-5"></i></div><div><p class="font-bold text-slate-700 text-sm">${cat.name}</p><p class="text-[10px] text-slate-400 font-mono">slug: ${cat.slug}</p></div></div><button onclick="deleteCategory('${cat.id}')" class="absolute top-3 right-3 text-slate-300 hover:text-rose-500 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`;
            });
            list.innerHTML = html; lucide.createIcons();
        }

        window.openAddCategoryModal = () => {
            openModal(`<div class="text-left bounce-enter"><h3 class="text-xl font-bold text-slate-800 mb-4">Nuevo Servicio</h3><form onsubmit="saveCategory(event)" class="space-y-4"><div><label class="block text-xs font-bold text-slate-400 uppercase mb-1">Nombre</label><input type="text" id="cat-name" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm" required></div><div><label class="block text-xs font-bold text-slate-400 uppercase mb-1">Identificador (Slug)</label><input type="text" id="cat-slug" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm" required placeholder="ej: streaming"></div><div><label class="block text-xs font-bold text-slate-400 uppercase mb-1">Icono (Lucide)</label><input type="text" id="cat-icon" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm" required placeholder="ej: tv"></div><div><label class="block text-xs font-bold text-slate-400 uppercase mb-1">Color</label><select id="cat-color" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm"><option value="amber">Ámbar</option><option value="blue">Azul</option><option value="emerald">Esmeralda</option><option value="rose">Rosa</option><option value="purple">Púrpura</option><option value="indigo">Índigo</option></select></div><button type="submit" class="w-full bg-slate-900 text-white font-bold py-3 rounded-xl shadow-lg mt-2 btn-animate">Crear Categoría</button></form></div>`);
        };

        window.saveCategory = async (e) => { e.preventDefault(); try { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'categories'), { name: document.getElementById('cat-name').value, slug: document.getElementById('cat-slug').value.toLowerCase().trim(), icon: document.getElementById('cat-icon').value, color: document.getElementById('cat-color').value, createdAt: serverTimestamp() }); showToast('Categoría creada', 'success'); closeModal(); } catch(err) { showToast('Error', 'error'); } };
        window.deleteCategory = async (id) => { if(confirm("¿Eliminar categoría?")) try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'categories', id)); showToast('Eliminada', 'success'); } catch(err) { showToast('Error', 'error'); } };

        // --- DATOS USUARIO ---
        async function initUserData(user) {
            const walletRef = doc(db, 'artifacts', appId, 'users', user.uid, 'wallet', 'main');
            onSnapshot(walletRef, (doc) => { if (doc.exists()) { const data = doc.data(); document.getElementById('balance-display').textContent = `$${(data.balance || 0).toLocaleString()}`; document.getElementById('profit-display').textContent = `$${(data.profit || 0).toLocaleString()}`; } else setDoc(walletRef, { balance: 0, profit: 0 }); });
            const txRef = collection(db, 'artifacts', appId, 'users', user.uid, 'transactions');
            onSnapshot(query(txRef, orderBy('timestamp', 'desc'), limit(20)), (snapshot) => { window.userTransactions = []; snapshot.forEach((doc) => { window.userTransactions.push({id: doc.id, ...doc.data()}); }); updateNotificationDot(); });
        }

        function initGlobalNotifications() {
            onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'global_notifications'), orderBy('timestamp', 'desc'), limit(5)), (snapshot) => { window.globalNotifications = []; snapshot.forEach(doc => window.globalNotifications.push({id: doc.id, isGlobal:true, ...doc.data()})); updateNotificationDot(); });
        }
        function updateNotificationDot() { const dot = document.getElementById('notification-dot'); let hasAdmin = (window.adminPendingRequests?.length > 0) || (window.adminPendingReports?.length > 0); if (window.userTransactions.length > 0 || window.globalNotifications.length > 0 || (isAdmin && hasAdmin)) dot.style.display = 'block'; else dot.style.display = 'none'; }

        // --- ADMIN PANEL ---
        function initAdminPanel() {
            // Solicitudes
            onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'pending_recharges'), orderBy('timestamp', 'desc'), limit(50)), (snapshot) => {
                window.adminPendingRequests = []; let html = '';
                snapshot.forEach(doc => { const d = doc.data(); if(d.status === 'pending') { 
                    // Asignamos ID para poder aprobar
                    d.id = doc.id;
                    window.adminPendingRequests.push(d); 
                    html += `<div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-amber-400 flex flex-col md:flex-row justify-between items-center gap-3 slide-up"><div class="flex-1"><p class="font-bold text-slate-800 text-sm">${d.email}</p><span class="bg-amber-100 text-amber-700 text-[10px] font-bold px-2 py-1 rounded-full">Pendiente</span></div><div class="flex items-center gap-3"><span class="font-bold text-lg text-emerald-600">$${d.amount.toLocaleString()}</span><button onclick="event.stopPropagation(); window.approveRecharge('${doc.id}', '${d.uid}', ${d.amount}, '${d.userTxId}')" class="bg-slate-800 text-white px-3 py-2 rounded-lg text-xs font-bold hover:bg-slate-700 flex items-center gap-1 btn-animate z-10 relative">Aprobar</button></div></div>`; } 
                });
                document.getElementById('admin-requests-list').innerHTML = html || '<div class="text-center py-4 text-slate-400">Sin solicitudes</div>';
                const badge = document.getElementById('badge-requests'); if(window.adminPendingRequests.length>0){badge.textContent=window.adminPendingRequests.length; badge.classList.remove('hidden');} else badge.classList.add('hidden');
            });
            // Productos
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'profiles'), (snapshot) => {
                let html = ''; snapshot.forEach(doc => { const d = doc.data(); html += `<div class="bg-white p-3 rounded-2xl border border-slate-100 flex items-center gap-3 slide-up"><img src="${d.imageUrl}" class="w-12 h-12 rounded-lg object-cover bg-slate-100"><div class="flex-1 overflow-hidden"><div class="flex justify-between"><p class="font-bold text-sm text-slate-800 truncate">${d.name}</p><p class="font-bold text-xs text-emerald-600">$${d.price}</p></div><p class="text-[10px] text-slate-400 bg-slate-50 px-1.5 rounded inline-block mt-0.5">${d.category}</p><div class="mt-1 text-[10px]">Stock: <b>${d.stock||0}</b></div></div><div class="flex flex-col gap-1"><button onclick="openEditProductModal('${doc.id}')" class="p-2 text-blue-400 hover:bg-blue-50 rounded-lg"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="deleteProfile('${doc.id}')" class="p-2 text-rose-300 hover:bg-rose-50 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div>`; });
                document.getElementById('admin-stock-list').innerHTML = html || '<p class="text-center text-slate-400">Vacío</p>'; lucide.createIcons();
            });
            // Usuarios
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'all_users'), (snapshot) => {
                let html = ''; snapshot.forEach(doc => { const d = doc.data(); const susp = d.suspended === true; html += `<div onclick="openUserHistory('${d.uid}', '${d.email}')" class="bg-white p-3 rounded-xl border border-slate-100 flex flex-col gap-3 relative cursor-pointer hover:shadow-md transition-shadow group slide-up"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 font-bold text-xs">${d.email.substring(0,2).toUpperCase()}</div><div class="overflow-hidden flex-1"><p class="font-bold text-sm text-slate-700 truncate">${d.email}</p><p class="text-[10px] text-slate-400 font-mono">ID: ${d.uid.substring(0,8)}</p></div><i data-lucide="chevron-right" class="w-4 h-4 text-slate-300"></i></div><div class="flex gap-2 pt-2 border-t border-slate-50" onclick="event.stopPropagation();"><button onclick="openManualBalanceModal('${d.uid}', '${d.email}')" class="flex-1 bg-emerald-50 text-emerald-600 hover:bg-emerald-100 py-1.5 rounded-lg text-xs font-bold flex items-center justify-center gap-1"><i data-lucide="dollar-sign" class="w-3 h-3"></i> Cargar</button><button onclick="toggleSuspend('${doc.id}', ${!susp})" class="px-3 bg-slate-100 text-slate-500 hover:bg-slate-200 rounded-lg text-xs font-bold">${susp?'Activar':'Suspender'}</button></div></div>`; });
                document.getElementById('admin-users-list').innerHTML = html; lucide.createIcons();
            });
            // Inventario
            onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'inventory_items'), where('status', '==', 'available')), (snapshot) => {
                 let html = ''; snapshot.forEach(doc => { const i = doc.data(); html += `<div class="bg-white p-3 rounded-xl border border-slate-100 shadow-sm flex flex-col gap-2 slide-up"><div class="flex justify-between items-start"><div><p class="font-bold text-slate-800 text-sm">${i.serviceName}</p><p class="text-xs text-slate-500 mt-1">Expira: ${i.expiryDate}</p></div><button onclick="deleteInventoryItem('${doc.id}')" class="text-rose-400 hover:bg-rose-50 p-1.5 rounded-lg"><i data-lucide="trash" class="w-4 h-4"></i></button></div></div>`; });
                 document.getElementById('admin-inventory-list').innerHTML = html || '<p class="text-center text-slate-400">Inventario vacío</p>'; lucide.createIcons();
            });
            // Soporte
            onSnapshot(query(collection(db, 'artifacts', appId, 'public', 'data', 'reports'), orderBy('timestamp', 'desc')), (s) => {
                 window.adminPendingReports = []; window.adminReportsCache = []; let html = '';
                 s.forEach(doc => { const r = doc.data(); r.id = doc.id; window.adminReportsCache.push(r); if(r.status!=='replied') window.adminPendingReports.push(r);
                     html += `<div onclick="openReportDetails('${doc.id}')" class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm cursor-pointer mb-2"><div class="flex justify-between"><p class="font-bold text-xs text-slate-700">${r.email}</p><span class="text-[10px] uppercase ${r.status==='replied'?'text-emerald-500':'text-amber-500'} font-bold">${r.status}</span></div><p class="text-xs text-slate-500 mt-1 truncate">${r.description}</p><div class="mt-2 pt-2 border-t border-slate-50 flex justify-end"><button onclick="event.stopPropagation(); openReplyModal('${doc.id}', '${r.uid}')" class="text-xs text-blue-500 font-bold hover:underline">Responder</button></div></div>`;
                 });
                 document.getElementById('admin-support-list').innerHTML = html || '<p class="text-center text-slate-400">Sin reportes</p>';
                 const b = document.getElementById('badge-support'); if(window.adminPendingReports.length>0){b.textContent=window.adminPendingReports.length; b.classList.remove('hidden');} else b.classList.add('hidden');
            });
        }

        // --- FUNCIONES RESTAURADAS ---
        
        window.openAddInventoryModal = async () => {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'profiles')); const querySnapshot = await getDocs(q);
            let options = '<option value="">Selecciona un Artículo...</option>';
            querySnapshot.forEach((doc) => { const data = doc.data(); options += `<option value="${doc.id}" data-name="${data.name}">${data.name}</option>`; });
            openModal(` <div class="text-left bounce-enter"><h3 class="text-lg font-bold text-slate-800 mb-4">Agregar al Inventario</h3><form onsubmit="saveInventoryItem(event)" class="space-y-3"><div><label class="block text-[10px] font-bold text-slate-400 uppercase">Artículo</label><select id="inv-product-select" class="w-full bg-slate-50 border rounded-lg p-2 text-sm" required>${options}</select></div><div class="grid grid-cols-2 gap-2"><div><label class="block text-[10px] font-bold text-slate-400 uppercase">Correo</label><input type="email" id="inv-email" class="w-full bg-slate-50 border rounded-lg p-2 text-sm" required></div><div><label class="block text-[10px] font-bold text-slate-400 uppercase">Contraseña</label><input type="text" id="inv-pass" class="w-full bg-slate-50 border rounded-lg p-2 text-sm" required></div></div><div class="grid grid-cols-2 gap-2"><div><label class="block text-[10px] font-bold text-slate-400 uppercase">Expiración</label><input type="date" id="inv-expiry" class="w-full bg-slate-50 border rounded-lg p-2 text-sm"></div><div><label class="block text-[10px] font-bold text-slate-400 uppercase">Duración</label><select id="inv-duration" class="w-full bg-slate-50 border rounded-lg p-2 text-sm"><option>1 Mes</option><option>3 Meses</option><option>6 Meses</option></select></div></div><div><label class="block text-[10px] font-bold text-slate-400 uppercase">Términos</label><textarea id="inv-terms" class="w-full bg-slate-50 border rounded-lg p-2 text-sm h-16 resize-none"></textarea></div><button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl mt-2 hover:bg-indigo-700 btn-animate">Guardar</button></form></div> `);
        };
        window.saveInventoryItem = async (e) => { e.preventDefault(); try { const select = document.getElementById('inv-product-select'); const productId = select.value; const productName = select.options[select.selectedIndex].text; await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'inventory_items'), { productId, serviceName: productName, email: document.getElementById('inv-email').value, password: document.getElementById('inv-pass').value, expiryDate: document.getElementById('inv-expiry').value, duration: document.getElementById('inv-duration').value, terms: document.getElementById('inv-terms').value, createdAt: serverTimestamp(), status: 'available' }); const productRef = doc(db, 'artifacts', appId, 'public', 'data', 'profiles', productId); await updateDoc(productRef, { stock: increment(1) }); showToast('Item agregado', 'success'); closeModal(); } catch(e) { showToast('Error', 'error'); } };
        window.deleteInventoryItem = async (id) => { if(confirm("¿Borrar? Reducirá el stock.")) { const itemRef = doc(db, 'artifacts', appId, 'public', 'data', 'inventory_items', id); const s = await getDoc(itemRef); if (s.exists()) { await deleteDoc(itemRef); await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'profiles', s.data().productId), { stock: increment(-1) }); showToast('Eliminado', 'success'); } } };

        // Soporte
        window.openReportModal = () => { localStorage.removeItem('report_evidence'); openModal(`<div class="text-left bounce-enter"><div class="w-14 h-14 bg-rose-100 text-rose-500 rounded-full flex items-center justify-center mb-4 mx-auto"><i data-lucide="alert-triangle" class="w-7 h-7"></i></div><h3 class="text-xl font-bold text-slate-800 mb-2 text-center">Reportar Problema</h3><form onsubmit="submitReport(event)" class="space-y-4"><div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Tipo</label><select id="report-type" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm"><option value="account">Fallo de Cuenta</option><option value="payment">Pago no reflejado</option><option value="bug">Error de Sistema</option></select></div><div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Descripción</label><textarea id="report-desc" required class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm h-24 resize-none"></textarea></div><div><label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Adjuntar Foto</label><input type="file" accept="image/*" onchange="handleImageUpload(this)" class="w-full text-xs"></div><button type="submit" class="w-full bg-slate-800 text-white font-bold py-3 rounded-xl btn-animate">Enviar Reporte</button></form></div>`); };
        window.handleImageUpload = (input) => { if (input.files[0]) { const reader = new FileReader(); reader.onload = (e) => localStorage.setItem('report_evidence', e.target.result); reader.readAsDataURL(input.files[0]); } };
        window.submitReport = async (e) => { e.preventDefault(); const type = document.getElementById('report-type').value; const evidence = localStorage.getItem('report_evidence'); await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'reports'), { uid: currentUser.uid, email: currentUser.email, type, description: document.getElementById('report-desc').value, evidenceImage: evidence, timestamp: serverTimestamp(), status: 'unread' }); showToast('Reporte enviado', 'success'); closeModal(); };
        window.openReportDetails = (id) => { const r = window.adminReportsCache.find(x => x.id === id); if(!r) return; openModal(`<div class="text-left bounce-enter"><h3 class="font-bold text-slate-800 text-lg">Detalle Reporte</h3><p class="text-xs text-slate-500 mb-4">${r.email}</p><div class="bg-slate-50 p-3 rounded-xl border border-slate-100 text-sm whitespace-pre-wrap">${r.description}</div>${r.evidenceImage ? `<img src="${r.evidenceImage}" class="mt-4 w-full rounded-lg border border-slate-200">` : ''}<div class="flex gap-2 mt-4"><button onclick="openReplyModal('${id}', '${r.uid}')" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold">Responder</button><button onclick="closeModal()" class="flex-1 bg-slate-200 py-2 rounded-lg font-bold">Cerrar</button></div></div>`); };
        window.openReplyModal = (rid, uid) => { openModal(`<div class="bounce-enter"><h3 class="font-bold mb-2">Responder</h3><textarea id="rep-text" class="w-full border rounded-xl p-2 h-24"></textarea><button onclick="sendAdminReply('${rid}','${uid}')" class="w-full bg-blue-600 text-white font-bold py-2 rounded-xl mt-2">Enviar</button></div>`); };
        window.sendAdminReply = async (rid, uid) => { const msg = document.getElementById('rep-text').value; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reports', rid), { status: 'replied', adminReply: msg }); await addDoc(collection(db, 'artifacts', appId, 'users', uid, 'transactions'), { type: 'support_reply', amount: 0, description: 'Respuesta Soporte', message: msg, timestamp: serverTimestamp() }); showToast('Enviado', 'success'); closeModal(); };

        // Gestión Usuarios
        window.openAddUserModal = () => { openModal(` <div class="text-left bounce-enter"><h3 class="text-xl font-bold text-slate-800 mb-4">Agregar Usuario</h3><form onsubmit="registerUserByAdmin(event)" class="space-y-4"><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Correo</label><input type="email" id="new-user-email" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm" required></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Contraseña</label><input type="text" id="new-user-pass" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm" required minlength="6"></div><button type="submit" class="w-full bg-emerald-500 text-white font-bold py-3 rounded-xl shadow-lg mt-2 hover:bg-emerald-600 btn-animate">Crear</button></form></div> `); };
        window.registerUserByAdmin = async (e) => { e.preventDefault(); const email = document.getElementById('new-user-email').value; const password = document.getElementById('new-user-pass').value; try { const secondaryApp = initializeApp(firebaseConfig, "SecondaryApp"); const secondaryAuth = getAuth(secondaryApp); const cred = await createUserWithEmailAndPassword(secondaryAuth, email, password); await setDoc(doc(db, 'artifacts', appId, 'users', cred.user.uid, 'wallet', 'main'), { balance: 0, profit: 0, createdAt: serverTimestamp() }); await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'all_users', cred.user.uid), { email: email, uid: cred.user.uid, lastLogin: serverTimestamp(), suspended: false }, { merge: true }); await signOut(secondaryAuth); showToast('Usuario creado', 'success'); closeModal(); } catch (error) { showToast('Error: ' + error.message, 'error'); } };
        window.openManualBalanceModal = (uid, email) => { openModal(`<div class="text-center bounce-enter"><h3 class="text-xl font-bold text-slate-800 mb-1">Cargar Saldo Manual</h3><p class="text-xs text-slate-400 mb-4">${email}</p><input type="number" id="manual-amount" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-lg font-bold text-center mb-4" placeholder="$0"><button onclick="confirmManualBalance('${uid}')" class="w-full bg-emerald-500 text-white font-bold py-3 rounded-xl shadow-lg btn-animate">Confirmar Recarga</button></div>`); };
        window.confirmManualBalance = async (uid) => { const amt = Number(document.getElementById('manual-amount').value); if(!amt) return; const wRef = doc(db, 'artifacts', appId, 'users', uid, 'wallet', 'main'); await runTransaction(db, async (t) => { const s = await t.get(wRef); t.update(wRef, { balance: (s.data().balance||0) + amt }); const txRef = doc(collection(db, 'artifacts', appId, 'users', uid, 'transactions')); t.set(txRef, { type: 'deposit', amount: amt, description: 'Carga Manual Admin', timestamp: serverTimestamp(), prevBalance: s.data().balance, newBalance: (s.data().balance||0) + amt }); }); showToast('Saldo cargado', 'success'); closeModal(); };
        
        // --- ADMIN: EXPEDIENTE USUARIO MEJORADO ---
        window.openUserHistory = async (uid, email) => {
            // 1. Obtener Billetera
            const walletSnap = await getDoc(doc(db, 'artifacts', appId, 'users', uid, 'wallet', 'main'));
            const balance = walletSnap.exists() ? walletSnap.data().balance : 0;
            const joinedDate = walletSnap.exists() && walletSnap.data().createdAt ? walletSnap.data().createdAt.toDate().toLocaleDateString() : 'N/A';

            openModal(`
                <div class="h-[80vh] flex flex-col bounce-enter">
                    <div class="border-b border-slate-100 pb-4 mb-4">
                        <h3 class="font-bold text-xl text-slate-800 mb-1">Expediente de Usuario</h3>
                        <p class="text-sm text-slate-500 font-medium mb-4">${email}</p>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-emerald-50 p-3 rounded-xl border border-emerald-100">
                                <p class="text-[10px] font-bold text-emerald-600 uppercase tracking-wider">Saldo Actual</p>
                                <p class="text-lg font-black text-emerald-700">$${balance.toLocaleString()}</p>
                            </div>
                            <div class="bg-slate-50 p-3 rounded-xl border border-slate-200">
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Miembro desde</p>
                                <p class="text-sm font-bold text-slate-700">${joinedDate}</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto scrollbar-hide space-y-2" id="usr-hist-list">
                        <div class="text-center py-10"><div class="animate-spin w-6 h-6 border-2 border-slate-800 border-t-transparent rounded-full mx-auto"></div></div>
                    </div>
                </div>
            `);
            
            const q = query(collection(db,'artifacts',appId,'users',uid,'transactions'), orderBy('timestamp','desc')); 
            const s = await getDocs(q); 
            let h=''; 
            if(s.empty) h='<div class="text-center text-slate-400 py-10 text-xs">Sin movimientos.</div>';
            else {
                s.forEach(d=>{ const t=d.data(); h+=`<div class="p-3 border rounded-xl bg-slate-50 text-xs"><div class="flex justify-between"><p class="font-bold">${t.description}</p><span class="text-[10px] text-slate-400">${t.timestamp?.toDate().toLocaleString()}</span></div><p class="font-bold ${t.type==='deposit'?'text-emerald-600':'text-rose-600'} mt-1">${t.amount > 0 ? '$'+t.amount : 'Info'}</p></div>`}); 
            }
            document.getElementById('usr-hist-list').innerHTML=h; 
        };

        window.toggleSuspend = async (uid, val) => { await updateDoc(doc(db,'artifacts',appId,'public','data','all_users',uid), {suspended: val}); };

        // Producto
        window.openAddProductModal = () => { let optionsHTML = window.categoriesCache.length > 0 ? window.categoriesCache.map(c => `<option value="${c.slug}">${c.name}</option>`).join('') : `<option value="" disabled selected>Crea categorías primero</option>`; openModal(`<div class="text-left bounce-enter"><h3 class="text-xl font-bold text-slate-800 mb-4">Agregar Artículo</h3><form onsubmit="saveProduct(event)" class="space-y-4"><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Categoría</label><select id="p-category" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm" required>${optionsHTML}</select></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nombre</label><input type="text" id="p-name" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm" required></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">URL Imagen</label><input type="url" id="p-image" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm" required></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Precio</label><input type="number" id="p-price" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm" required></div></div><div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Descripción</label><textarea id="p-desc" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm h-20 resize-none"></textarea></div><button type="submit" class="w-full bg-slate-900 text-white font-bold py-3 rounded-xl shadow-lg mt-2 btn-animate">Guardar</button></form></div>`); };
        
        // --- GUARDADO ESTRICTO DE CATEGORÍA ---
        window.saveProduct = async (e) => { 
            e.preventDefault(); 
            // Obtenemos el valor directo del select (que es el slug)
            const selectedCategorySlug = document.getElementById('p-category').value;
            
            try { 
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'profiles'), { 
                    category: selectedCategorySlug, // Guarda el slug, ej: 'perfiles'
                    name: document.getElementById('p-name').value, 
                    imageUrl: document.getElementById('p-image').value, 
                    price: Number(document.getElementById('p-price').value), 
                    description: document.getElementById('p-desc').value, 
                    stock: 0, 
                    createdAt: serverTimestamp() 
                }); 
                showToast('Producto agregado correctamente', 'success'); 
                closeModal(); 
            } catch(err) { showToast('Error al guardar', 'error'); } 
        };
        
        window.openEditProductModal = async (pid) => { const d = (await getDoc(doc(db,'artifacts',appId,'public','data','profiles',pid))).data(); let optionsHTML = window.categoriesCache.map(c => `<option value="${c.slug}" ${c.slug===d.category?'selected':''}>${c.name}</option>`).join(''); openModal(`<div class="text-left bounce-enter"><h3 class="text-xl font-bold text-slate-800 mb-4">Editar</h3><form onsubmit="updateProduct(event, '${pid}')" class="space-y-4"><div><label class="text-xs font-bold uppercase">Nombre</label><input type="text" id="e-name" value="${d.name}" class="w-full border rounded-xl p-3 text-sm"></div><div><label class="text-xs font-bold uppercase">Precio</label><input type="number" id="e-price" value="${d.price}" class="w-full border rounded-xl p-3 text-sm"></div><div><label class="text-xs font-bold uppercase">Categoría</label><select id="e-cat" class="w-full border rounded-xl p-3 text-sm">${optionsHTML}</select></div><div><label class="text-xs font-bold uppercase">Imagen</label><input type="url" id="e-img" value="${d.imageUrl}" class="w-full border rounded-xl p-3 text-sm"></div><div><label class="text-xs font-bold uppercase">Descripción</label><textarea id="e-desc" class="w-full border rounded-xl p-3 h-20">${d.description}</textarea></div><button type="submit" class="w-full bg-slate-900 text-white font-bold py-3 rounded-xl">Guardar</button></form></div>`); };
        window.updateProduct = async (e, pid) => { e.preventDefault(); await updateDoc(doc(db,'artifacts',appId,'public','data','profiles',pid), { name: document.getElementById('e-name').value, price: Number(document.getElementById('e-price').value), category: document.getElementById('e-cat').value, imageUrl: document.getElementById('e-img').value, description: document.getElementById('e-desc').value }); showToast('Actualizado', 'success'); closeModal(); };

        // --- COMPRA Y NAVEGACIÓN (FILTRADO ESTRICTO) ---
        window.openCategoryModule = (categorySlug, title) => {
            const html = `<div class="relative h-full flex flex-col bg-slate-50"><div class="flex justify-between items-center mb-4 px-6 pt-6"><div><h3 class="text-2xl font-black text-slate-800 tracking-tight">${title}</h3><p class="text-xs text-slate-400 font-medium">Selecciona tu plan ideal</p></div></div><div class="overflow-y-auto flex-1 pb-24 px-4 scrollbar-hide"><div id="products-grid" class="grid grid-cols-2 gap-4 pb-4"><div class="col-span-full text-center py-20"><div class="inline-block w-8 h-8 border-4 border-slate-200 border-t-amber-500 rounded-full animate-spin"></div></div></div></div></div>`;
            document.getElementById('modal-content').innerHTML = html; const m = document.getElementById('app-modal'); const mc = document.getElementById('modal-card'); m.classList.remove('items-center', 'justify-center', 'p-4'); m.classList.add('items-end', 'justify-center', 'p-0'); mc.className = "bg-white w-full max-w-4xl h-[85vh] rounded-t-[2.5rem] relative shadow-[0_-10px_40px_rgba(0,0,0,0.1)] flex flex-col overflow-hidden slide-up border-t border-slate-100"; m.classList.remove('hidden'); m.classList.add('flex');
            
            // Consulta estricta usando el slug
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'profiles'), where('category', '==', categorySlug));
            
            onSnapshot(q, (snapshot) => {
                const grid = document.getElementById('products-grid'); if(!grid) return; if(snapshot.empty) { grid.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center py-12 opacity-50"><i data-lucide="package-open" class="w-12 h-12 mb-2"></i><p class="text-sm">No hay productos en ${title}.</p></div>`; lucide.createIcons(); return; }
                grid.innerHTML = ''; snapshot.forEach(doc => { const p = doc.data(); const safeDesc = encodeURIComponent(p.description || ''); let ribbon = ((p.stock||0) <= 0) ? `<div class="absolute inset-0 bg-white/80 backdrop-blur-[1px] z-20 flex items-center justify-center"><span class="bg-rose-500 text-white text-[10px] font-bold px-3 py-1 rounded-full rotate-[-10deg] shadow-lg">AGOTADO</span></div>` : (((p.stock||0) <= 3) ? `<div class="absolute top-2 right-2 bg-amber-400 text-slate-900 text-[10px] font-bold px-2 py-0.5 rounded-lg shadow-sm z-20">¡Pocos!</div>` : ''); const card = document.createElement('div'); card.className = "bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden cursor-pointer group hover:shadow-xl transition-all duration-300 relative bounce-enter"; card.innerHTML = `${ribbon}<div onclick="buyProduct('${doc.id}', '${p.name}', ${p.price}, ${p.stock||0}, '${safeDesc}', '${p.imageUrl}')" class="flex flex-col h-full"><div class="aspect-[4/3] overflow-hidden bg-slate-100 relative"><img src="${p.imageUrl}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" loading="lazy"><div class="absolute bottom-0 left-0 w-full h-1/2 bg-gradient-to-t from-black/50 to-transparent opacity-60"></div></div><div class="p-4 flex-1 flex flex-col justify-between"><div><h4 class="font-bold text-slate-800 text-sm leading-tight mb-1">${p.name}</h4><p class="text-[10px] text-slate-400 line-clamp-2">${p.description || 'Servicio digital premium'}</p></div><div class="flex justify-between items-center mt-3"><span class="bg-emerald-50 text-emerald-700 font-bold text-sm px-2.5 py-1 rounded-lg">$${p.price}</span><div class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center group-hover:bg-slate-900 group-hover:text-white transition-colors"><i data-lucide="shopping-bag" class="w-4 h-4"></i></div></div></div></div>`; grid.appendChild(card); }); lucide.createIcons();
            });
        };

        window.buyProduct = (id, name, price, stock, desc, imgUrl) => { 
            openModal(`
                <div class="text-center bounce-enter">
                    <div class="mx-auto mb-4 w-24 h-24 relative">
                        <img src="${imgUrl}" class="w-full h-full rounded-2xl object-cover shadow-md bg-slate-100">
                        <div class="absolute -bottom-2 -right-2 bg-slate-900 text-white p-1.5 rounded-xl shadow-lg border-2 border-white"><i data-lucide="shopping-bag" class="w-4 h-4"></i></div>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mb-1">${name}</h3>
                    <p class="text-emerald-500 font-bold text-lg mb-6">$${price.toLocaleString()}</p>
                    <div class="bg-slate-50 p-4 rounded-2xl text-left mb-6 border border-slate-100"><p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Incluye</p><p class="text-sm text-slate-600 leading-relaxed">${decodeURIComponent(desc)}</p></div>
                    <button onclick="processPurchase('${id}', '${name}',${price})" class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl shadow-xl hover:bg-slate-800 active:scale-95 transition-all btn-animate flex items-center justify-center gap-2" ${stock <= 0 ? 'disabled style="opacity:0.5; pointer-events:none;"' : ''}>${stock <= 0 ? 'Agotado' : `Confirmar Compra <i data-lucide="chevron-right" class="w-4 h-4"></i>`}</button>
                </div>
            `);
        };

        window.processPurchase = async (pid, name, price) => {
            if(!currentUser) return showToast('Inicia sesión', 'error');
            const btn = document.querySelector('button[onclick^="processPurchase"]'); btn.disabled = true; btn.innerHTML = `<span class="animate-spin">⌛</span>`;
            try {
                const qInv = query(collection(db, 'artifacts', appId, 'public', 'data', 'inventory_items'), where('productId', '==', pid), where('status', '==', 'available'), limit(1));
                const invSnap = await getDocs(qInv); if(invSnap.empty) throw new Error("Stock agotado");
                const item = invSnap.docs[0].data(); const itemId = invSnap.docs[0].id;

                await runTransaction(db, async (t) => {
                    const wRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'wallet', 'main'); const wSnap = await t.get(wRef);
                    // FIX DE SALDO: Asegurar conversión numérica estricta
                    const currentBalance = Number(wSnap.data().balance) || 0;
                    const cost = Number(price);
                    
                    if(currentBalance < cost) throw new Error("Saldo insuficiente");
                    
                    const pRef = doc(db, 'artifacts', appId, 'public', 'data', 'profiles', pid); const pSnap = await t.get(pRef);
                    t.update(wRef, { balance: (currentBalance - cost) });
                    t.update(doc(db, 'artifacts', appId, 'public', 'data', 'inventory_items', itemId), { status: 'sold', soldTo: currentUser.uid, soldAt: serverTimestamp() });
                    t.update(pRef, { stock: (pSnap.data().stock || 0) - 1 });
                    t.set(doc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions')), { type: 'purchase', amount: cost, description: `Compra: ${name}`, details: { serviceName: item.serviceName, email: item.email, password: item.password, expiryDate: item.expiryDate, duration: item.duration || '1 Mes', terms: item.terms || '' }, itemId: itemId, timestamp: serverTimestamp() });
                });
                showToast('¡Compra exitosa!', 'success'); showTicketModal({...item, serviceName: name});
            } catch (e) { let m = e.message || "Error"; if(m.includes("Saldo")) openChargeModal(); showToast(m, 'error'); closeModal(); }
        };

        window.showTicketModal = (item) => {
            const terms = item.terms || "Sin términos adicionales.";
            const safeTerms = encodeURIComponent(terms); 
            
            openModal(`
                <div class="text-center bounce-enter pt-4">
                    <div class="w-16 h-16 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce"><i data-lucide="check" class="w-8 h-8"></i></div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">¡Compra Exitosa!</h3>
                    <p class="text-xs text-slate-400 mb-6">Captura o copia tu ticket</p>
                    
                    <div class="bg-white border border-slate-200 rounded-2xl p-5 text-left space-y-4 shadow-sm relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-emerald-500"></div>
                        <div><p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Plataforma</p><p class="text-lg font-black text-slate-800">${item.serviceName}</p></div>
                        <div class="grid gap-3">
                            <div class="bg-slate-50 p-3 rounded-xl border border-slate-100"><p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Correo</p><p class="font-mono text-sm text-slate-800 font-bold select-all break-all">${item.email}</p></div>
                            <div class="bg-slate-50 p-3 rounded-xl border border-slate-100"><p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Contraseña</p><p class="font-mono text-sm text-slate-800 font-bold select-all">${item.password}</p></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 pt-2">
                            <div><p class="text-[10px] font-bold text-slate-400 uppercase">Expira</p><p class="text-sm font-bold text-slate-700">${item.expiryDate || 'N/A'}</p></div>
                            <div><p class="text-[10px] font-bold text-slate-400 uppercase">Duración</p><p class="text-sm font-bold text-slate-700">${item.duration || '1 Mes'}</p></div>
                        </div>
                        <div class="pt-3 border-t border-dashed border-slate-200"><p class="text-[10px] font-bold text-slate-400 uppercase mb-1">Términos y Condiciones</p><p class="text-[10px] text-slate-500 leading-relaxed italic">${terms}</p></div>
                    </div>

                    <div class="mt-6 space-y-3">
                        <button onclick="copyTicketData('${item.serviceName}', '${item.email}', '${item.password}', '${item.expiryDate}', '${item.duration || '1 Mes'}', '${safeTerms}')" class="w-full bg-slate-900 text-white font-bold py-3.5 rounded-xl shadow-lg btn-animate flex items-center justify-center gap-2"><i data-lucide="copy" class="w-4 h-4"></i> Copiar Ticket</button>
                        <button onclick="closeModal()" class="w-full text-slate-400 font-bold text-xs py-2 hover:text-slate-600">Cerrar</button>
                    </div>
                </div>
            `);
        };

        window.copyTicketData = (srv, mail, pass, exp, dur, encTerms) => {
            const terms = decodeURIComponent(encTerms);
            const text = `📦 *COMPRA EXITOSA - STREAM EVOLUTION*\n\n📌 *Plataforma:* ${srv}\n📧 *Correo:* ${mail}\n🔑 *Contraseña:* ${pass}\n📅 *Expira:* ${exp}\n⏳ *Duración:* ${dur}\n\n📜 *Términos:* ${terms}\n\n¡Gracias por tu preferencia!`;
            navigator.clipboard.writeText(text).then(() => showToast('¡Ticket copiado!', 'success')).catch(() => showToast('Error al copiar', 'error'));
        };
        
        // --- NOTIFICACIONES Y DETALLES (CORREGIDO) ---
        window.openNotifications = () => { 
            const d = document.getElementById('notification-dot'); if(d) d.style.display='none'; 
            let h=`<div class="text-center mb-4"><h3 class="text-xl font-bold text-slate-800">Notificaciones</h3><p class="text-xs text-slate-400">Actividad Reciente</p></div><div class="space-y-3">`; 
            let all=[...window.globalNotifications, ...window.userTransactions]; 
            if(isAdmin){all=[...all,...window.adminPendingRequests, ...window.adminPendingReports]} 
            all.sort((a,b)=>(b.timestamp?.toMillis()||0)-(a.timestamp?.toMillis()||0)); 
            
            if(all.length===0)h+=`<p class="text-center text-slate-400 py-8">Sin actividad reciente</p>`; 
            else all.forEach(t=>{ 
                // Lógica visual de estado
                let icon='circle', color='text-slate-400', bg='bg-slate-50';
                let desc = t.title||t.description||t.email;
                
                if(t.type==='deposit'){
                    if(t.status==='Pending'||t.status==='pending'||t.status==='Pendiente'){
                        icon='clock'; color='text-amber-500'; bg='bg-amber-50'; desc = 'Recarga Pendiente';
                    } else {
                        icon='check-circle'; color='text-emerald-500'; bg='bg-emerald-50'; desc = 'Recarga Exitosa';
                    }
                } else if(t.type==='purchase'){ icon='shopping-bag'; color='text-slate-600'; bg='bg-slate-100'; }
                else if(t.type==='support_reply'){ icon='message-circle'; color='text-blue-500'; bg='bg-blue-50'; }
                else if(t.isGlobal){ icon='bell'; color='text-indigo-500'; bg='bg-indigo-50'; }

                h+=`<div onclick="openTransactionDetail('${t.id}')" class="p-3 border border-slate-100 rounded-2xl flex justify-between items-center cursor-pointer hover:bg-slate-50 transition-colors group">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl ${bg} flex items-center justify-center ${color} shadow-sm group-hover:scale-110 transition-transform"><i data-lucide="${icon}" class="w-5 h-5"></i></div>
                        <div><p class="font-bold text-xs text-slate-700 line-clamp-1">${desc}</p><p class="text-[10px] text-slate-400">${t.timestamp?.toDate().toLocaleString()}</p></div>
                    </div>
                </div>`;
            }); 
            h+=`</div>`; 
            openModal(h); 
        };

        window.openTransactionDetail = (id) => {
            // Buscar en todas las listas posibles
            let t = window.userTransactions.find(x => x.id === id) || 
                    window.globalNotifications.find(x => x.id === id) || 
                    window.adminPendingRequests.find(x => x.id === id);
            
            if(!t) return;

            if(t.type === 'deposit') {
                let statusColor = 'text-emerald-500';
                let statusText = 'Éxito';
                
                if(t.status==='Pending'||t.status==='pending'||t.status==='Pendiente'){
                    statusColor = 'text-amber-500'; statusText = 'Pendiente';
                } else if (t.status === 'rejected') {
                    statusColor = 'text-rose-500'; statusText = 'Cancelado';
                }

                openModal(`
                    <div class="text-center bounce-enter pt-4">
                        <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="dollar-sign" class="w-8 h-8 text-slate-500"></i></div>
                        <h3 class="text-xl font-bold text-slate-800 mb-1">Detalle de Recarga</h3>
                        <p class="text-xs text-slate-400 mb-6">${t.timestamp?.toDate().toLocaleString()}</p>
                        <div class="bg-slate-50 border border-slate-200 rounded-2xl p-5 space-y-3 text-left">
                            <div class="flex justify-between"><span class="text-xs font-bold text-slate-400 uppercase">Monto</span><span class="font-bold text-emerald-600 text-lg">$${t.amount}</span></div>
                            <div class="flex justify-between"><span class="text-xs font-bold text-slate-400 uppercase">Estado</span><span class="font-bold ${statusColor} uppercase text-sm">${statusText}</span></div>
                            ${t.prevBalance ? `<div class="flex justify-between border-t border-slate-200 pt-2"><span class="text-xs text-slate-400">Saldo Anterior</span><span class="text-xs font-mono">$${t.prevBalance}</span></div>` : ''}
                        </div>
                        <button onclick="openNotifications()" class="mt-4 text-slate-400 text-xs font-bold hover:text-slate-800">Volver</button>
                    </div>
                `);
            } else if (t.type === 'purchase' && t.details) {
                showTicketModal({...t.details, serviceName: t.description});
            } else if (t.type === 'support_reply') {
                // Redirigir a la nueva vista detallada de soporte
                openSupportReplyDetail(t.id);
            } else {
                 openModal(`<div class="p-4 text-center"><p class="text-slate-500">${t.description || t.message || t.title}</p></div>`);
            }
        };

        // --- MODAL DE CARGA DE SALDO (Restaurado con datos bancarios) ---
        window.openChargeModal = () => { 
            openModal(`
                <div class="text-center bounce-enter">
                    <div class="w-16 h-16 bg-amber-100 text-amber-500 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="wallet" class="w-8 h-8"></i></div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">Cargar Saldo</h3>
                    <input type="number" id="charge-amount" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-lg font-bold text-center mb-4" placeholder="$0">
                    <button id="confirm-btn" onclick="processRecharge(document.getElementById('charge-amount').value)" class="w-full bg-amber-400 text-slate-900 font-bold py-3 rounded-xl shadow-lg btn-animate">Solicitar</button>
                    <div id="payment-info-container"></div>
                </div>
            `); 
        };

        window.processRecharge = async (amt) => { 
            if(!amt) return;
            const btn = document.getElementById('confirm-btn');
            const originalHTML = btn.innerHTML; 
            btn.innerHTML = `<div class="w-4 h-4 border-2 border-slate-900 border-t-transparent rounded-full animate-spin"></div>`; 
            btn.disabled = true; 
            
            try { 
                const txRef = await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions'), { type: 'deposit', amount: Number(amt), description: 'Recarga Pendiente', timestamp: serverTimestamp(), status: 'Pending' }); 
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'pending_recharges'), { uid: currentUser.uid, email: currentUser.email, amount: Number(amt), status: 'pending', timestamp: serverTimestamp(), userTxId: txRef.id }); 
                
                showToast('Solicitud enviada', 'success'); 
                
                // Actualizar UI con datos bancarios
                const infoContainer = document.getElementById('payment-info-container');
                infoContainer.innerHTML = `
                    <div class="mt-6 pt-6 border-t border-dashed border-slate-200 bounce-enter text-left">
                        <div class="bg-amber-50 border border-amber-100 rounded-xl p-4">
                            <p class="text-xs font-bold text-amber-600 uppercase tracking-wider mb-3 flex items-center gap-2"><i data-lucide="info" class="w-4 h-4"></i> Datos para Transferir</p>
                            <div class="space-y-2 text-sm text-slate-700">
                                <div class="flex justify-between"><span class="text-slate-500">Cuenta:</span><span class="font-mono font-bold select-all">123456789101</span></div>
                                <div class="flex justify-between"><span class="text-slate-500">Nombre:</span><span class="font-bold">Juan Zamora</span></div>
                                <div class="flex justify-between"><span class="text-slate-500">Concepto:</span><span class="font-bold">Donativo</span></div>
                                <div class="flex justify-between"><span class="text-slate-500">Referencia:</span><span class="bg-white px-2 py-0.5 rounded border border-amber-200 font-mono text-xs font-bold">RW${Math.floor(Math.random()*1000)}</span></div>
                            </div>
                        </div>
                        <p class="text-[10px] text-slate-400 text-center mt-3">Tu saldo se verá reflejado una vez validado el pago por el administrador.</p>
                    </div>`; 
                lucide.createIcons(); 
                
                btn.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i> Solicitud Enviada`; 
                btn.className = "w-full bg-emerald-100 text-emerald-700 font-bold py-3 rounded-xl shadow-none cursor-default flex items-center justify-center gap-2"; 
            } catch(e){ 
                showToast('Error al procesar', 'error'); 
                btn.innerHTML = originalHTML; 
                btn.disabled = false; 
            } 
        };

        // --- NUEVO: MEJORA RESPUESTAS SOPORTE (CLICKEABLES) ---
        window.openSupportReplies = () => {
            const replies = window.userTransactions.filter(t => t.type === 'support_reply');
            let html = `<div class="text-center mb-4 bounce-enter"><h3 class="text-xl font-bold text-slate-800">Respuestas de Soporte</h3><p class="text-xs text-slate-400">Toca para leer</p></div>`;
            
            if (replies.length === 0) {
                html += `<div class="flex flex-col items-center justify-center py-12 opacity-50"><i data-lucide="message-circle-off" class="w-12 h-12 mb-2 text-slate-300"></i><p class="text-sm text-slate-400">Sin respuestas nuevas</p></div>`;
            } else {
                html += `<div class="space-y-3">`;
                replies.forEach(r => {
                    const time = r.timestamp ? r.timestamp.toDate().toLocaleString() : 'Reciente';
                    // Ahora cada tarjeta es un botón
                    html += `
                        <div onclick="openSupportReplyDetail('${r.id}')" class="bg-blue-50 border border-blue-100 p-4 rounded-xl text-left cursor-pointer hover:bg-blue-100 transition-colors group relative">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-xs font-bold text-blue-600 uppercase bg-white/50 px-2 py-0.5 rounded flex items-center gap-1"><i data-lucide="mail-open" class="w-3 h-3"></i> Respuesta Admin</span>
                                <span class="text-[10px] text-slate-400">${time}</span>
                            </div>
                            <p class="text-sm text-slate-700 line-clamp-2 font-medium">${r.message}</p>
                            <div class="absolute right-3 bottom-3 opacity-0 group-hover:opacity-100 transition-opacity"><i data-lucide="chevron-right" class="w-4 h-4 text-blue-400"></i></div>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            openModal(html);
        };

        // --- NUEVO: DETALLE DE LA RESPUESTA ---
        window.openSupportReplyDetail = (id) => {
            const r = window.userTransactions.find(t => t.id === id);
            if(!r) return;
            openModal(`
                <div class="text-left bounce-enter p-1 h-[70vh] flex flex-col">
                    <div class="flex items-center gap-3 mb-6 border-b border-slate-100 pb-4">
                        <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center"><i data-lucide="message-circle" class="w-5 h-5"></i></div>
                        <div>
                            <h3 class="font-bold text-lg text-slate-800 leading-tight">Mensaje de Soporte</h3>
                            <p class="text-xs text-slate-400">${r.timestamp ? r.timestamp.toDate().toLocaleString() : ''}</p>
                        </div>
                    </div>
                    <div class="bg-slate-50 border border-slate-200 p-5 rounded-2xl text-sm text-slate-700 whitespace-pre-wrap flex-1 overflow-y-auto shadow-inner leading-relaxed font-medium">${r.message}</div>
                    <button onclick="openSupportReplies()" class="mt-4 w-full bg-slate-800 text-white py-3.5 rounded-xl font-bold shadow-lg btn-animate flex items-center justify-center gap-2"><i data-lucide="arrow-left" class="w-4 h-4"></i> Volver</button>
                </div>
            `);
        };

        // --- NUEVO: SISTEMA DE RENOVACIONES ---
        window.openRenewalModal = () => {
            openModal(`
                <div class="text-center bounce-enter">
                    <div class="w-16 h-16 bg-indigo-100 text-indigo-500 rounded-full flex items-center justify-center mx-auto mb-4"><i data-lucide="refresh-cw" class="w-8 h-8"></i></div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">Renovar Servicio</h3>
                    <p class="text-xs text-slate-400 mb-6 px-4">Ingresa el correo de la cuenta que compraste para verificar disponibilidad.</p>
                    
                    <form onsubmit="searchRenewal(event)" class="relative">
                        <i data-lucide="search" class="absolute left-4 top-3.5 w-5 h-5 text-slate-300"></i>
                        <input type="email" id="renew-email" class="w-full bg-slate-50 border border-slate-200 rounded-2xl py-3.5 pl-12 pr-4 text-slate-700 font-medium focus:outline-none focus:border-indigo-400 focus:bg-white transition-all placeholder:text-slate-300" placeholder="ej: cliente@correo.com" required>
                        <button type="submit" class="w-full bg-slate-900 text-white font-bold py-3.5 rounded-xl shadow-lg mt-4 btn-animate flex items-center justify-center gap-2">Buscar Suscripción</button>
                    </form>
                    
                    <div id="renewal-results" class="mt-6 text-left space-y-3 empty:hidden"></div>
                </div>
            `);
        };

        window.searchRenewal = (e) => {
            e.preventDefault();
            const emailQuery = document.getElementById('renew-email').value.trim().toLowerCase();
            const container = document.getElementById('renewal-results');
            container.innerHTML = '<div class="text-center py-4"><span class="animate-spin inline-block w-5 h-5 border-2 border-indigo-500 border-t-transparent rounded-full"></span></div>';

            // Buscar en transacciones de compra del usuario
            const matches = window.userTransactions.filter(t => 
                t.type === 'purchase' && 
                t.details && 
                t.details.email && 
                t.details.email.toLowerCase() === emailQuery
            );

            if (matches.length === 0) {
                container.innerHTML = `
                    <div class="bg-rose-50 border border-rose-100 p-4 rounded-xl text-center animate-pulse">
                        <p class="text-xs font-bold text-rose-600 mb-1">No encontrado</p>
                        <p class="text-[10px] text-slate-500">No tienes compras registradas con este correo.</p>
                    </div>`;
            } else {
                let html = '';
                matches.forEach(m => {
                    const isRenewable = "SÍ"; 
                    const platformName = m.details.serviceName || m.description.replace('Compra: ', '');
                    
                    html += `
                        <div class="bg-white border border-slate-200 p-4 rounded-2xl shadow-sm flex flex-col gap-3 slide-up">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-black text-slate-800 text-sm">${platformName}</p>
                                    <p class="text-[10px] text-slate-400 font-mono mt-0.5">${m.details.email}</p>
                                </div>
                                <span class="bg-indigo-50 text-indigo-600 text-[10px] font-bold px-2 py-1 rounded-lg border border-indigo-100">Renovable: ${isRenewable}</span>
                            </div>
                            
                            <div class="flex gap-2 mt-1">
                                <button onclick="requestRenewal('${m.id}', '${platformName}', '${m.details.email}')" class="flex-1 bg-slate-900 text-white py-2.5 rounded-xl text-xs font-bold hover:bg-slate-800 btn-animate">Solicitar Renovación</button>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
                lucide.createIcons();
            }
        };

        window.requestRenewal = async (txId, platform, email) => {
            if(!confirm(`¿Solicitar renovación para ${platform}?`)) return;
            try {
                 await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'reports'), { 
                    uid: currentUser.uid, 
                    email: currentUser.email, 
                    type: 'renewal', 
                    description: `Solicitud de renovación para: ${platform}\nCuenta: ${email}\nID Compra Original: ${txId}`, 
                    timestamp: serverTimestamp(), 
                    status: 'unread' 
                });
                showToast('Solicitud enviada al administrador', 'success');
                closeModal();
            } catch (e) {
                showToast('Error al solicitar', 'error');
            }
        };

        // --- UTILIDADES UI ---
        window.toggleSidebar = () => { const s=document.getElementById('sidebar'); const o=document.getElementById('sidebar-overlay'); if(s.classList.contains('-translate-x-full')){s.classList.remove('-translate-x-full');o.classList.remove('opacity-0','pointer-events-none');}else{s.classList.add('-translate-x-full');o.classList.add('opacity-0','pointer-events-none');} } 
        window.switchView = (v) => { const u=document.getElementById('user-view'); const a=document.getElementById('admin-view'); if(v==='admin'){u.classList.add('hidden');a.classList.remove('hidden');}else{a.classList.add('hidden');u.classList.remove('hidden');} }
        window.showToast = (m,t='info') => {const c=document.getElementById('toast-container');const el=document.createElement('div');const col={success:'bg-emerald-500 text-white',error:'bg-rose-500 text-white',info:'bg-slate-800 text-white'};el.className=`${col[t]} px-4 py-3 rounded-xl shadow-xl flex items-center gap-3 text-sm font-bold transform transition-all duration-300 translate-x-full pointer-events-auto border border-white/10 backdrop-blur-md`;el.innerHTML=`<span>${m}</span>`;c.appendChild(el);requestAnimationFrame(()=>el.classList.remove('translate-x-full'));setTimeout(()=>{el.classList.add('translate-x-full','opacity-0');setTimeout(()=>el.remove(),300);},3000);}
        window.closeModal = () => { const m=document.getElementById('app-modal'); m.classList.add('hidden'); m.classList.remove('flex'); };
        window.openModal = (h) => { document.getElementById('modal-content').innerHTML=h; const m=document.getElementById('app-modal'); m.classList.remove('hidden'); m.classList.add('flex'); lucide.createIcons(); };
        window.enterAdminModule = (m) => { document.getElementById('admin-dashboard-grid').classList.add('hidden'); document.getElementById('admin-modules-container').classList.remove('hidden'); document.querySelectorAll('section[id^="admin-"]').forEach(s=>s.classList.add('hidden')); document.getElementById(`admin-${m}-section`).classList.remove('hidden'); };
        window.returnToAdminDashboard = () => { document.getElementById('admin-dashboard-grid').classList.remove('hidden'); document.getElementById('admin-modules-container').classList.add('hidden'); };
        window.switchAuthView = (v) => { document.querySelectorAll('.auth-view').forEach(x=>x.classList.add('hidden')); document.getElementById(`${v==='login'?'login':v==='register'?'register':'forgot'}-form`).classList.remove('hidden'); };
        
        // APROBAR RECARGA (FUNCIÓN GLOBAL RESTAURADA Y FIX DE CLIC)
        window.approveRecharge = async (reqId, uid, amt, txId) => { 
            if(!confirm('¿Aprobar saldo de $' + amt + '?')) return; 
            
            const wRef = doc(db, 'artifacts', appId, 'users', uid, 'wallet', 'main'); 
            
            try {
                await runTransaction(db, async (t) => { 
                    const s = await t.get(wRef); 
                    // FIX DE SALDO: asegurar numero en la aprobación también
                    const currentBal = Number(s.exists() ? s.data().balance : 0) || 0;
                    t.update(wRef, { balance: currentBal + Number(amt) }); 
                }); 
                
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'pending_recharges', reqId), { status: 'approved' }); 
                
                if(txId) {
                    await updateDoc(doc(db, 'artifacts', appId, 'users', uid, 'transactions', txId), { status: 'Éxito' }); 
                }
                
                showToast('Saldo cargado correctamente', 'success'); 
            } catch(e) {
                console.error(e);
                showToast('Error al aprobar', 'error');
            }
        };

        window.deleteProfile = async (id) => { if(confirm("¿Borrar producto?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'profiles', id)); };

        // Listeners
        document.getElementById('login-form').addEventListener('submit', async(e)=>{e.preventDefault(); try{await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value); showToast('Bienvenido', 'success');}catch(e){showToast('Error credenciales', 'error');}});
        document.getElementById('register-form').addEventListener('submit', async(e)=>{e.preventDefault(); const p1=document.getElementById('reg-password').value; const p2=document.getElementById('reg-confirm-password').value; if(p1!==p2)return showToast('Contraseñas no coinciden','error'); try{const c=await createUserWithEmailAndPassword(auth, document.getElementById('reg-email').value, p1); await setDoc(doc(db,'artifacts',appId,'users',c.user.uid,'wallet','main'),{balance:0,profit:0}); showToast('Cuenta creada','success');}catch(e){showToast('Error registro','error');}});
        window.handleLogout = async () => { await signOut(auth); document.getElementById('sidebar').classList.add('-translate-x-full'); };
        document.addEventListener('DOMContentLoaded', () => { lucide.createIcons(); });
    </script>
</body>
</html>
