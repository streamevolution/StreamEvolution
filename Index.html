<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecosistema VNHE - Acceso Seguro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #F8FAFC; -webkit-tap-highlight-color: transparent; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .soft-3d-icon {
            box-shadow: inset 2px 2px 5px rgba(255, 255, 255, 0.7), inset -2px -2px 5px rgba(0, 0, 0, 0.05), 5px 5px 10px rgba(0, 0, 0, 0.05);
        }
        /* Animaciones de Entrada */
        .fade-in { animation: fadeIn 0.5s ease-in-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .auth-switch-enter { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

        /* Estilos de Inputs */
        .input-group:focus-within label { color: #F59E0B; }
        .input-group:focus-within i { color: #F59E0B; }
        .input-group input:focus { border-color: #F59E0B; box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.1); }
    </style>
</head>
<body class="text-slate-800 overflow-x-hidden min-h-screen relative bg-slate-50">

    <!-- TOAST NOTIFICATION CONTAINER -->
    <div id="toast-container" class="fixed top-4 right-4 z-[100] flex flex-col gap-2 pointer-events-none"></div>

    <!-- LOADER GLOBAL -->
    <div id="global-loader" class="fixed inset-0 bg-slate-50 z-[90] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="w-16 h-16 border-4 border-amber-200 border-t-amber-500 rounded-full animate-spin mb-4"></div>
        <p class="text-slate-400 font-medium tracking-widest text-sm animate-pulse">CARGANDO ECOSISTEMA...</p>
    </div>

    <!-- ========================================== -->
    <!-- 1. AUTH CONTAINER (LOGIN / REGISTER)       -->
    <!-- ========================================== -->
    <div id="auth-container" class="min-h-screen flex flex-col items-center justify-center p-6 hidden">
        
        <!-- Logo / Branding en Auth -->
        <div class="mb-8 text-center fade-in">
            <div class="w-16 h-16 bg-gradient-to-br from-amber-400 to-yellow-200 rounded-2xl flex items-center justify-center text-white font-bold shadow-lg text-2xl mx-auto mb-3 transform rotate-3">VN</div>
            <h1 class="text-2xl font-bold text-slate-800 tracking-wide">ECOSISTEMA <span class="text-amber-500">VNHE</span></h1>
            <p class="text-slate-400 text-sm mt-1">Gestiona tus servicios digitales</p>
        </div>

        <!-- Form Container -->
        <div class="bg-white w-full max-w-sm rounded-3xl shadow-xl p-8 fade-in" style="animation-delay: 0.1s;">
            
            <!-- LOGIN FORM -->
            <form id="login-form" class="space-y-5 auth-view">
                <h2 class="text-xl font-bold text-slate-700 mb-2">Iniciar Sesión</h2>
                
                <div class="input-group">
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-1">Correo Electrónico</label>
                    <div class="relative">
                        <i data-lucide="mail" class="absolute left-4 top-3.5 w-5 h-5 text-slate-300 transition-colors"></i>
                        <input type="email" id="login-email" class="w-full bg-slate-50 border border-slate-200 rounded-xl py-3 pl-12 pr-4 text-slate-700 font-medium focus:outline-none transition-all" placeholder="ejemplo@correo.com" required>
                    </div>
                </div>

                <div class="input-group">
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-1">Contraseña</label>
                    <div class="relative">
                        <i data-lucide="lock" class="absolute left-4 top-3.5 w-5 h-5 text-slate-300 transition-colors"></i>
                        <input type="password" id="login-password" class="w-full bg-slate-50 border border-slate-200 rounded-xl py-3 pl-12 pr-4 text-slate-700 font-medium focus:outline-none transition-all" placeholder="••••••••" required>
                    </div>
                    <div class="text-right mt-2">
                        <button type="button" onclick="switchAuthView('forgot')" class="text-xs text-amber-500 font-medium hover:underline">¿Olvidaste tu contraseña?</button>
                    </div>
                </div>

                <button type="submit" class="w-full bg-slate-800 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-slate-700 active:scale-95 transition-all flex justify-center items-center gap-2">
                    <span>Ingresar</span> <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </button>

                <div class="text-center text-sm text-slate-500 mt-4">
                    ¿No tienes cuenta? <button type="button" onclick="switchAuthView('register')" class="text-amber-500 font-bold hover:underline">Regístrate</button>
                </div>
            </form>

            <!-- REGISTER FORM -->
            <form id="register-form" class="space-y-5 hidden auth-view">
                <h2 class="text-xl font-bold text-slate-700 mb-2">Crear Cuenta</h2>
                
                <div class="input-group">
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-1">Correo Electrónico</label>
                    <div class="relative">
                        <i data-lucide="mail" class="absolute left-4 top-3.5 w-5 h-5 text-slate-300 transition-colors"></i>
                        <input type="email" id="reg-email" class="w-full bg-slate-50 border border-slate-200 rounded-xl py-3 pl-12 pr-4 text-slate-700 font-medium focus:outline-none transition-all" placeholder="tu@correo.com" required>
                    </div>
                </div>

                <div class="input-group">
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-1">Contraseña</label>
                    <div class="relative">
                        <i data-lucide="lock" class="absolute left-4 top-3.5 w-5 h-5 text-slate-300 transition-colors"></i>
                        <input type="password" id="reg-password" class="w-full bg-slate-50 border border-slate-200 rounded-xl py-3 pl-12 pr-4 text-slate-700 font-medium focus:outline-none transition-all" placeholder="Mínimo 6 caracteres" required minlength="6">
                    </div>
                </div>

                <div class="input-group">
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-1">Confirmar Contraseña</label>
                    <div class="relative">
                        <i data-lucide="check-circle" class="absolute left-4 top-3.5 w-5 h-5 text-slate-300 transition-colors"></i>
                        <input type="password" id="reg-confirm-password" class="w-full bg-slate-50 border border-slate-200 rounded-xl py-3 pl-12 pr-4 text-slate-700 font-medium focus:outline-none transition-all" placeholder="Repite tu contraseña" required>
                    </div>
                </div>

                <button type="submit" class="w-full bg-amber-400 text-slate-900 font-bold py-4 rounded-xl shadow-lg shadow-amber-200 hover:bg-amber-300 active:scale-95 transition-all flex justify-center items-center gap-2">
                    <i data-lucide="user-plus" class="w-4 h-4"></i> <span>Registrarse</span>
                </button>

                <div class="text-center text-sm text-slate-500 mt-4">
                    ¿Ya tienes cuenta? <button type="button" onclick="switchAuthView('login')" class="text-amber-600 font-bold hover:underline">Inicia Sesión</button>
                </div>
            </form>

            <!-- FORGOT PASSWORD FORM -->
            <form id="forgot-form" class="space-y-5 hidden auth-view">
                <button type="button" onclick="switchAuthView('login')" class="text-slate-400 hover:text-slate-600 flex items-center gap-1 mb-2 text-sm">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i> Volver
                </button>
                <h2 class="text-xl font-bold text-slate-700 mb-2">Recuperar Acceso</h2>
                <p class="text-sm text-slate-500 mb-4">Ingresa tu correo y te enviaremos un enlace para restablecer tu contraseña.</p>
                
                <div class="input-group">
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1 ml-1">Correo Registrado</label>
                    <div class="relative">
                        <i data-lucide="mail" class="absolute left-4 top-3.5 w-5 h-5 text-slate-300 transition-colors"></i>
                        <input type="email" id="forgot-email" class="w-full bg-slate-50 border border-slate-200 rounded-xl py-3 pl-12 pr-4 text-slate-700 font-medium focus:outline-none transition-all" placeholder="ejemplo@correo.com" required>
                    </div>
                </div>

                <button type="submit" class="w-full bg-slate-800 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-slate-700 active:scale-95 transition-all">
                    Enviar Enlace
                </button>
            </form>

        </div>
        <p class="mt-8 text-xs text-slate-400 text-center max-w-xs">Al continuar, aceptas los Términos de Servicio y Política de Privacidad de Ecosistema VNHE.</p>
    </div>


    <!-- ========================================== -->
    <!-- 2. MAIN APP CONTAINER (DASHBOARD)          -->
    <!-- ========================================== -->
    <div id="dashboard-container" class="hidden relative min-h-screen pb-20">
        
        <!-- MODAL GENÉRICO (Movido dentro del dashboard o global) -->
        <div id="app-modal" class="fixed inset-0 z-[80] hidden items-center justify-center p-4">
            <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onclick="closeModal()"></div>
            <div class="bg-white rounded-3xl w-full max-w-sm p-6 relative shadow-2xl transform transition-all scale-100 opacity-100">
                <button onclick="closeModal()" class="absolute top-4 right-4 text-slate-400 hover:text-rose-500">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
                <div id="modal-content">
                    <!-- Contenido dinámico aquí -->
                </div>
            </div>
        </div>

        <!-- HEADER -->
        <header class="bg-white/90 backdrop-blur-md sticky top-0 z-40 border-b border-slate-100 px-4 py-3 flex items-center justify-between shadow-sm">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="p-2 rounded-xl bg-slate-100 text-slate-600 hover:bg-slate-200 active:scale-95 transition-all">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-gradient-to-br from-amber-400 to-yellow-200 rounded-full flex items-center justify-center text-white font-bold shadow-sm text-sm">VN</div>
                    <h1 class="text-sm font-bold text-slate-700 tracking-wide">ECOSISTEMA <span class="text-amber-500">VNHE</span></h1>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <div class="text-[10px] bg-emerald-100 text-emerald-600 px-2 py-0.5 rounded-full font-bold flex items-center gap-1">
                    <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div> ONLINE
                </div>
                <button class="p-2 text-slate-400 hover:text-amber-500 transition-colors relative">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                    <span class="absolute top-2 right-2 w-2 h-2 bg-rose-500 rounded-full border border-white"></span>
                </button>
            </div>
        </header>

        <!-- SIDEBAR -->
        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-slate-900/20 backdrop-blur-sm z-50 opacity-0 pointer-events-none transition-opacity duration-300"></div>
        <aside id="sidebar" class="fixed top-0 left-0 h-full w-80 bg-white shadow-2xl z-50 transition-transform duration-300 -translate-x-full flex flex-col">
            <div class="p-5 flex justify-between items-center border-b border-slate-100 bg-slate-50">
                <div>
                    <h2 class="font-bold text-lg text-slate-800">Mi Cuenta</h2>
                    <p class="text-xs text-slate-400 truncate w-48" id="sidebar-email">Cargando...</p>
                </div>
                <button onclick="toggleSidebar()" class="p-2 hover:bg-rose-50 text-rose-400 rounded-full transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="p-4 space-y-1 overflow-y-auto flex-1 scrollbar-hide">
                <div class="flex items-center gap-4 p-3 rounded-xl bg-amber-50 text-amber-600 font-semibold cursor-pointer"><i data-lucide="home" class="w-5 h-5"></i><span class="text-sm">Inicio</span></div>
                <button onclick="showToast('Función de reporte simulada', 'info')" class="w-full flex items-center gap-4 p-3 rounded-xl text-slate-600 hover:bg-slate-50"><i data-lucide="alert-circle" class="w-5 h-5"></i><span class="text-sm font-medium">Reportar Fallo</span></button>
                <button onclick="showToast('Historial cargado en pantalla principal', 'success')" class="w-full flex items-center gap-4 p-3 rounded-xl text-slate-600 hover:bg-slate-50"><i data-lucide="trending-up" class="w-5 h-5"></i><span class="text-sm font-medium">Movimientos</span></button>
                <button onclick="showToast('Configuración no disponible', 'info')" class="w-full flex items-center gap-4 p-3 rounded-xl text-slate-600 hover:bg-slate-50"><i data-lucide="settings" class="w-5 h-5"></i><span class="text-sm font-medium">Configuración</span></button>
            </div>
            <div class="p-4 border-t border-slate-100">
                <button onclick="handleLogout()" class="w-full flex items-center justify-center gap-2 p-3 rounded-xl bg-rose-50 text-rose-600 hover:bg-rose-100 font-bold transition-colors">
                    <i data-lucide="log-out" class="w-5 h-5"></i> Cerrar Sesión
                </button>
            </div>
        </aside>

        <!-- DASHBOARD CONTENT -->
        <main class="px-4 py-6 space-y-8 max-w-md mx-auto md:max-w-3xl">
            
            <!-- BALANCES -->
            <section class="flex justify-between items-center gap-3 overflow-x-auto pb-2 scrollbar-hide fade-in" style="animation-delay: 0.1s;">
                <div class="flex-1 min-w-[100px] bg-slate-800 text-white rounded-3xl py-4 px-4 flex flex-col items-center justify-center shadow-lg shadow-slate-200">
                    <span class="text-[10px] uppercase tracking-wider opacity-70 mb-1">Saldo</span>
                    <span id="balance-display" class="font-bold text-lg text-emerald-400 transition-all duration-300">--</span>
                </div>
                <div class="flex-1 min-w-[100px] bg-white text-slate-700 rounded-3xl py-4 px-4 flex flex-col items-center justify-center border border-slate-200 shadow-sm">
                    <span class="text-[10px] uppercase tracking-wider opacity-70 mb-1">Ganancia</span>
                    <span id="profit-display" class="font-bold text-lg transition-all duration-300">--</span>
                </div>
                <button onclick="openChargeModal()" class="flex-1 min-w-[100px] bg-amber-400 text-slate-900 rounded-3xl py-4 px-4 flex flex-col items-center justify-center shadow-lg shadow-amber-200 hover:bg-amber-300 active:scale-95 transition-transform">
                    <i data-lucide="plus-circle" class="w-5 h-5 mb-1"></i>
                    <span class="font-bold text-xs">Cargar</span>
                </button>
            </section>

            <!-- BANNER -->
            <section class="relative w-full h-40 rounded-3xl overflow-hidden shadow-md group cursor-pointer fade-in" style="animation-delay: 0.2s;" onclick="openProductModal('Streaming Premium', 25000)">
                <div class="absolute inset-0 bg-gradient-to-r from-slate-800 via-slate-700 to-slate-600 flex items-center px-6">
                    <div class="z-10 w-3/4">
                        <span class="bg-amber-400 text-slate-900 px-2 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider mb-2 inline-block">Oferta</span>
                        <h3 class="text-white font-bold text-lg leading-tight mb-1">Plex + Emby</h3>
                        <p class="text-slate-300 text-xs mb-3">Acceso total por solo $25.000</p>
                        <div class="flex gap-2">
                            <div class="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center"><i data-lucide="play" class="w-3 h-3 text-white fill-white"></i></div>
                        </div>
                    </div>
                    <div class="absolute right-0 bottom-0 w-32 h-32 bg-amber-400 rounded-full blur-3xl opacity-20 translate-y-1/2 translate-x-1/4"></div>
                </div>
            </section>

            <!-- SERVICES GRID -->
            <section class="fade-in" style="animation-delay: 0.3s;">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-bold text-slate-800 text-lg border-b-2 border-amber-400 inline-block pb-1">Servicios</h3>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div onclick="openProductModal('Marketplace', 5000)" class="bg-white rounded-3xl shadow-sm border border-slate-100 p-6 flex flex-col items-center justify-center cursor-pointer active:scale-95 transition-all hover:shadow-md group">
                        <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-amber-100 to-orange-100 flex items-center justify-center mb-3 soft-3d-icon group-hover:scale-110 transition-transform"><i data-lucide="shopping-bag" class="w-7 h-7 text-orange-600"></i></div>
                        <span class="font-medium text-slate-600 text-sm text-center">Marketplace</span>
                    </div>
                    <div onclick="openProductModal('Lotería', 3000)" class="bg-white rounded-3xl shadow-sm border border-slate-100 p-6 flex flex-col items-center justify-center cursor-pointer active:scale-95 transition-all hover:shadow-md group">
                        <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-emerald-100 to-teal-100 flex items-center justify-center mb-3 soft-3d-icon group-hover:scale-110 transition-transform"><i data-lucide="dices" class="w-7 h-7 text-emerald-600"></i></div>
                        <span class="font-medium text-slate-600 text-sm text-center">Loterías</span>
                    </div>
                    <div onclick="openProductModal('Recargas', 10000)" class="bg-white rounded-3xl shadow-sm border border-slate-100 p-6 flex flex-col items-center justify-center cursor-pointer active:scale-95 transition-all hover:shadow-md group">
                        <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-blue-100 to-cyan-100 flex items-center justify-center mb-3 soft-3d-icon group-hover:scale-110 transition-transform"><i data-lucide="repeat" class="w-7 h-7 text-blue-600"></i></div>
                        <span class="font-medium text-slate-600 text-sm text-center">Recargas</span>
                    </div>
                    <div onclick="openProductModal('Paquetes', 15000)" class="bg-white rounded-3xl shadow-sm border border-slate-100 p-6 flex flex-col items-center justify-center cursor-pointer active:scale-95 transition-all hover:shadow-md group">
                        <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-purple-100 to-violet-100 flex items-center justify-center mb-3 soft-3d-icon group-hover:scale-110 transition-transform"><i data-lucide="package" class="w-7 h-7 text-purple-600"></i></div>
                        <span class="font-medium text-slate-600 text-sm text-center">Paquetes</span>
                    </div>
                </div>
            </section>

            <!-- HISTORIAL -->
            <section class="fade-in" style="animation-delay: 0.4s;">
                <h3 class="font-bold text-slate-800 text-lg mb-3 flex items-center gap-2">
                    <i data-lucide="history" class="w-5 h-5 text-slate-400"></i> Últimos Movimientos
                </h3>
                <div id="transactions-list" class="space-y-3 pb-4">
                    <div class="animate-pulse space-y-3">
                        <div class="h-16 bg-white rounded-2xl w-full"></div>
                        <div class="h-16 bg-white rounded-2xl w-full"></div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- SCRIPTS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged, 
            signInWithCustomToken,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            onSnapshot, 
            collection, 
            addDoc, 
            query, 
            orderBy, 
            limit, 
            serverTimestamp, 
            setDoc, 
            getDoc, 
            runTransaction 
        } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- CONFIGURACIÓN FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyBYaYm2LDE6QM_K5Dii74sfZCYYd1eQfvY",
          authDomain: "ventasstre-a24b7.firebaseapp.com",
          projectId: "ventasstre-a24b7",
          storageBucket: "ventasstre-a24b7.firebasestorage.app",
          messagingSenderId: "197117622028",
          appId: "1:197117622028:web:ae6380faf72f965a41fb29",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "mi-ecosistema-v1";

        let currentUser = null;

        // --- GESTIÓN DE ESTADO GLOBAL ---
        
        // Listener de Autenticación
        onAuthStateChanged(auth, async (user) => {
            const loader = document.getElementById('global-loader');
            const authContainer = document.getElementById('auth-container');
            const dashboardContainer = document.getElementById('dashboard-container');
            
            if (user) {
                // USUARIO LOGUEADO
                currentUser = user;
                console.log("Usuario detectado:", user.uid);
                
                // Actualizar Sidebar
                const emailDisplay = user.email || "Usuario Anónimo";
                document.getElementById('sidebar-email').textContent = emailDisplay;

                // Inicializar Datos de Usuario
                await initUserData(user);

                // Mostrar Dashboard
                authContainer.classList.add('hidden');
                dashboardContainer.classList.remove('hidden');
                
            } else {
                // USUARIO NO LOGUEADO
                currentUser = null;
                console.log("Sin usuario activo");

                // Mostrar Auth Screen
                dashboardContainer.classList.add('hidden');
                authContainer.classList.remove('hidden');
            }

            // Ocultar Loader Global
            loader.style.opacity = '0';
            setTimeout(() => loader.style.display = 'none', 500);
        });

        // Inicialización de Datos (Wallet & Transacciones)
        async function initUserData(user) {
            const walletRef = doc(db, 'artifacts', appId, 'users', user.uid, 'wallet', 'main');
            const walletSnap = await getDoc(walletRef);
            
            // Crear Billetera si es usuario nuevo
            if (!walletSnap.exists()) {
                await setDoc(walletRef, {
                    balance: 0, // Empiezan en 0 si es nuevo registro
                    profit: 0,
                    createdAt: serverTimestamp()
                });
            }

            // Escuchar Saldo
            onSnapshot(walletRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    updateBalanceUI(data.balance, data.profit);
                }
            });

            // Escuchar Movimientos
            const transactionsRef = collection(db, 'artifacts', appId, 'users', user.uid, 'transactions');
            const q = query(transactionsRef, orderBy('timestamp', 'desc'), limit(10));
            
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('transactions-list');
                if (snapshot.empty) {
                    list.innerHTML = `
                        <div class="text-center py-8 bg-white rounded-3xl border border-slate-100 border-dashed">
                            <div class="w-12 h-12 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-2 text-slate-300">
                                <i data-lucide="inbox" class="w-6 h-6"></i>
                            </div>
                            <p class="text-xs text-slate-400">Sin movimientos recientes.</p>
                        </div>`;
                    lucide.createIcons();
                } else {
                    list.innerHTML = '';
                    snapshot.forEach((doc) => {
                        const t = doc.data();
                        list.innerHTML += createTransactionHTML(t);
                    });
                    lucide.createIcons();
                }
            });
        }

        // --- FUNCIONES DE AUTENTICACIÓN (Expuestas a Window) ---

        window.handleLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const btn = e.submitter || e.target.querySelector('button[type="submit"]');
            
            setLoading(btn, true);

            try {
                await signInWithEmailAndPassword(auth, email, password);
                showToast("¡Bienvenido de nuevo!", "success");
                // onAuthStateChanged se encargará del redireccionamiento
            } catch (error) {
                console.error(error);
                handleAuthError(error);
                setLoading(btn, false);
            }
        };

        window.handleRegister = async (e) => {
            e.preventDefault();
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            const confirm = document.getElementById('reg-confirm-password').value;
            const btn = e.submitter || e.target.querySelector('button[type="submit"]');

            if (password !== confirm) {
                showToast("Las contraseñas no coinciden", "error");
                return;
            }

            setLoading(btn, true);

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                // Crear saldo inicial de bienvenida (opcional)
                const uid = userCredential.user.uid;
                await setDoc(doc(db, 'artifacts', appId, 'users', uid, 'wallet', 'main'), {
                    balance: 5000, // Bono de bienvenida
                    profit: 0,
                    createdAt: serverTimestamp()
                });
                
                await addDoc(collection(db, 'artifacts', appId, 'users', uid, 'transactions'), {
                    type: 'deposit',
                    amount: 5000,
                    description: 'Bono de Bienvenida',
                    timestamp: serverTimestamp(),
                    status: 'Aprobado'
                });

                showToast("¡Cuenta creada exitosamente!", "success");
            } catch (error) {
                console.error(error);
                handleAuthError(error);
                setLoading(btn, false);
            }
        };

        window.handleResetPassword = async (e) => {
            e.preventDefault();
            const email = document.getElementById('forgot-email').value;
            const btn = e.submitter || e.target.querySelector('button[type="submit"]');
            
            setLoading(btn, true);

            try {
                await sendPasswordResetEmail(auth, email);
                showToast("Enlace enviado a tu correo", "success");
                setTimeout(() => window.switchAuthView('login'), 3000);
            } catch (error) {
                handleAuthError(error);
            } finally {
                setLoading(btn, false);
            }
        };

        window.handleLogout = async () => {
            try {
                await signOut(auth);
                toggleSidebar(); // Cerrar sidebar
                showToast("Sesión cerrada", "info");
            } catch (error) {
                console.error(error);
            }
        };

        // --- HELPERS DE AUTH ---

        function handleAuthError(error) {
            let msg = "Ocurrió un error inesperado.";
            if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                msg = "Correo o contraseña incorrectos.";
            } else if (error.code === 'auth/email-already-in-use') {
                msg = "Este correo ya está registrado.";
            } else if (error.code === 'auth/weak-password') {
                msg = "La contraseña es muy débil (mínimo 6 caracteres).";
            } else if (error.code === 'auth/too-many-requests') {
                msg = "Demasiados intentos fallidos. Intenta más tarde.";
            }
            showToast(msg, "error");
        }

        function setLoading(btn, isLoading) {
            if (isLoading) {
                btn.dataset.originalText = btn.innerHTML;
                btn.innerHTML = `<div class="w-5 h-5 border-2 border-white/50 border-t-white rounded-full animate-spin"></div>`;
                btn.disabled = true;
            } else {
                btn.innerHTML = btn.dataset.originalText;
                btn.disabled = false;
            }
        }

        // --- FUNCIONES DE NEGOCIO (TRANSACCIONES) ---
        
        window.processRecharge = async (amount) => {
            if (!currentUser) return;
            const btn = document.getElementById('confirm-btn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `<div class="w-4 h-4 border-2 border-slate-900 border-t-transparent rounded-full animate-spin"></div>`;
            btn.disabled = true;

            try {
                const walletRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'wallet', 'main');
                const transactionsRef = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions');

                await runTransaction(db, async (transaction) => {
                    const sfDoc = await transaction.get(walletRef);
                    if (!sfDoc.exists()) throw "Cuenta no inicializada";
                    
                    const newBalance = (sfDoc.data().balance || 0) + Number(amount);
                    transaction.update(walletRef, { balance: newBalance });
                });

                await addDoc(transactionsRef, {
                    type: 'deposit',
                    amount: Number(amount),
                    description: 'Recarga de Saldo',
                    timestamp: serverTimestamp(),
                    status: 'Aprobado'
                });

                showToast(`¡Recarga de $${amount} exitosa!`, 'success');
                closeModal();
            } catch (e) {
                console.error(e);
                showToast('Error al recargar saldo', 'error');
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        };

        window.processPurchase = async (serviceName, price) => {
            if (!currentUser) return;
            const btn = document.getElementById('confirm-purchase-btn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `<div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>`;
            btn.disabled = true;

            try {
                const walletRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'wallet', 'main');
                const transactionsRef = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'transactions');

                await runTransaction(db, async (transaction) => {
                    const sfDoc = await transaction.get(walletRef);
                    if (!sfDoc.exists()) throw "Error cuenta";
                    
                    const currentBal = sfDoc.data().balance || 0;
                    if (currentBal < price) throw "Saldo insuficiente";

                    const newBalance = currentBal - Number(price);
                    const newProfit = (sfDoc.data().profit || 0) + (price * 0.05);

                    transaction.update(walletRef, { 
                        balance: newBalance,
                        profit: newProfit
                    });
                });

                await addDoc(transactionsRef, {
                    type: 'purchase',
                    amount: Number(price),
                    description: `Compra ${serviceName}`,
                    timestamp: serverTimestamp(),
                    status: 'Completado'
                });

                showToast(`¡Compra de ${serviceName} exitosa!`, 'success');
                closeModal();
            } catch (e) {
                if (e === "Saldo insuficiente") {
                    showToast('Saldo insuficiente. Por favor recarga.', 'error');
                } else {
                    console.error(e);
                    showToast('Error en la transacción', 'error');
                }
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        };

        // Función auxiliar UI para actualizar saldos
        function updateBalanceUI(balance, profit) {
            document.getElementById('balance-display').textContent = `$${(balance || 0).toLocaleString()}`;
            document.getElementById('profit-display').textContent = `$${(profit || 0).toLocaleString()}`;
        }

        // Función auxiliar UI para HTML de transacciones
        function createTransactionHTML(t) {
            const isPositive = t.type === 'deposit';
            const colorClass = isPositive ? 'text-emerald-600' : 'text-slate-800';
            const bgClass = isPositive ? 'bg-emerald-100' : 'bg-rose-50';
            const sign = isPositive ? '+' : '-';
            const icon = isPositive ? 'arrow-down-left' : 'shopping-bag';
            
            let timeStr = 'Reciente';
            if (t.timestamp) {
                const date = t.timestamp.toDate();
                timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }

            return `
                <div class="bg-white p-3 rounded-2xl border border-slate-100 flex items-center justify-between shadow-sm">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full ${bgClass} flex items-center justify-center text-${isPositive ? 'emerald' : 'rose'}-500">
                            <i data-lucide="${icon}" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <p class="text-sm font-bold text-slate-700">${t.description}</p>
                            <p class="text-[10px] text-slate-400">${timeStr} • ${t.status || 'Exitoso'}</p>
                        </div>
                    </div>
                    <span class="font-bold text-sm ${colorClass}">${sign}$${t.amount.toLocaleString()}</span>
                </div>
            `;
        }
        
        // Conectar formularios a funciones globales
        document.getElementById('login-form').addEventListener('submit', window.handleLogin);
        document.getElementById('register-form').addEventListener('submit', window.handleRegister);
        document.getElementById('forgot-form').addEventListener('submit', window.handleResetPassword);

    </script>

    <!-- UI INTERACTION SCRIPT -->
    <script>
        // Inicializar Iconos UI
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });

        // --- AUTH UI SWITCHING ---
        function switchAuthView(viewName) {
            const views = document.querySelectorAll('.auth-view');
            views.forEach(v => v.classList.add('hidden'));
            
            let targetId = '';
            if (viewName === 'login') targetId = 'login-form';
            if (viewName === 'register') targetId = 'register-form';
            if (viewName === 'forgot') targetId = 'forgot-form';
            
            const target = document.getElementById(targetId);
            target.classList.remove('hidden');
            target.classList.add('auth-switch-enter');
            setTimeout(() => target.classList.remove('auth-switch-enter'), 300);
        }

        // --- SIDEBAR & TOASTS ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const isOpen = !sidebar.classList.contains('-translate-x-full');
            
            if (isOpen) {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.remove('opacity-100', 'pointer-events-auto');
                overlay.classList.add('opacity-0', 'pointer-events-none');
            } else {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.add('opacity-100', 'pointer-events-auto');
                overlay.classList.remove('opacity-0', 'pointer-events-none');
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const colors = {
                success: 'bg-emerald-500 text-white',
                error: 'bg-rose-500 text-white',
                info: 'bg-slate-800 text-white'
            };
            const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'alert-triangle' : 'info';

            toast.className = `${colors[type]} px-4 py-3 rounded-xl shadow-lg flex items-center gap-3 text-sm font-medium transform transition-all duration-300 translate-x-full pointer-events-auto`;
            toast.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5"></i> <span>${message}</span>`;
            container.appendChild(toast);
            lucide.createIcons();

            requestAnimationFrame(() => toast.classList.remove('translate-x-full'));
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- MODALS ---
        function closeModal() {
            const modal = document.getElementById('app-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function openModal(contentHTML) {
            const modal = document.getElementById('app-modal');
            const content = document.getElementById('modal-content');
            content.innerHTML = contentHTML;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            lucide.createIcons();
        }

        function openChargeModal() {
            openModal(`
                <div class="text-center">
                    <div class="w-16 h-16 bg-amber-100 text-amber-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="wallet" class="w-8 h-8"></i>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mb-2">Cargar Saldo</h3>
                    <p class="text-slate-500 text-sm mb-6">Ingresa el monto a añadir a tu billetera virtual.</p>
                    <input type="number" id="charge-amount" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-lg font-bold text-center mb-4 focus:outline-none focus:border-amber-400 focus:ring-2 focus:ring-amber-200" placeholder="$0" value="10000">
                    <button id="confirm-btn" onclick="processRecharge(document.getElementById('charge-amount').value)" class="w-full bg-amber-400 text-slate-900 font-bold py-3 rounded-xl shadow-lg shadow-amber-200 hover:bg-amber-300 active:scale-95 transition-all">
                        Confirmar Recarga
                    </button>
                </div>
            `);
        }

        function openProductModal(name, price) {
            openModal(`
                <div class="text-center">
                    <div class="w-16 h-16 bg-blue-100 text-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="shopping-cart" class="w-8 h-8"></i>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mb-1">Comprar ${name}</h3>
                    <p class="text-slate-400 text-sm mb-6">Valor: <span class="text-slate-800 font-bold">$${price.toLocaleString()}</span></p>
                    
                    <div class="bg-slate-50 p-4 rounded-xl mb-6 text-left">
                        <p class="text-xs text-slate-400 uppercase tracking-wider mb-2">Detalles</p>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-slate-600">Servicio:</span>
                            <span class="font-medium">${name}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-600">Comisión:</span>
                            <span class="font-medium text-emerald-500">+$${(price * 0.05).toLocaleString()}</span>
                        </div>
                    </div>
                    <button id="confirm-purchase-btn" onclick="processPurchase('${name}', ${price})" class="w-full bg-slate-800 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-slate-700 active:scale-95 transition-all">
                        Confirmar Compra
                    </button>
                </div>
            `);
        }
    </script>
</body>
</html>

